System.register("chunks:///_virtual/GuildMapSceneView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./AudioMgr.ts","./GuildPinItem.ts","./NodeUtil.ts","./PlatformUtil.ts","./TimeUtil.ts","./index57.ts","./ChatDataCache.ts","./ChatDefine.ts","./RoleDataCache.ts","./GuildControl.ts","./GuildDataCache.ts","./GuildDefine.ts","./GuildMapScene.ts","./BaseSubView.ts"],(function(t){"use strict";var e,n,i,o,a,s,d,h,r,l,u,c,p,f,m,v,C,g,S,T,w,y,I,x,b,P,G,N,L;return{setters:[function(t){e=t.inheritsLoose,n=t.assertThisInitialized},function(t){i=t.cclegacy,o=t.Vec2,a=t.Vec3,s=t.Button,d=t.UITransform,h=t.Label,r=t.sys,l=t.NodeEventType,u=t.Sprite,c=t.Widget,p=t.Node,f=t.screen,m=t.Layout},function(t){v=t.audioMgr},function(t){C=t.GuildPinItem},function(t){g=t.default},function(t){S=t.PlatformUtil},function(t){T=t.default},null,function(t){w=t.ChatDataCache},function(t){y=t.ChatEventDefine,I=t.ChatDefine},function(t){x=t.RoleDataCache},function(t){b=t.default},function(t){P=t.default},function(t){G=t.GuildEventDefine},function(t){N=t.GuildMapScene},function(t){L=t.BaseSubView}],execute:function(){i._RF.push({},"a90e0MVqzZP4LuHZHAiCBEG","GuildMapSceneView",void 0);var H=new o,M=new a,B=(t("default",function(t){function i(){var e;return(e=t.call(this)||this).mapScene=void 0,e.allyName=void 0,e.allyLev=void 0,e.guildPinItem=void 0,e.faceOriScale=void 0,e.chatRoot=void 0,e.txtName=void 0,e.content=void 0,e.face=void 0,e.nodeHandle=void 0,e.nodeShow=void 0,e.utShow=void 0,e.utHandle=void 0,e.handleBall=void 0,e.ballPos=new a(0,0,0),e.startTouchPos=new a,e.startTouch=!1,e.treasurePanel=void 0,e.nodeTop=void 0,e.name="GuildMapSceneView",e.url="ui/module/guild/GuildMapSceneView",e.fullScreen=!0,e.mapScene=new N(n(e)),e}e(i,t);var m=i.prototype;return m.onInit=function(){var t=this,e=this.findChild("btnChatRoot");this.addComponentCallbackListener(e,s.EventType.CLICK,(function(){uiMgr.openView("ChatView",2)})),this.chatRoot=e;var n=g.findChild(e,"name/messageContent"),i=g.findChildComponent(e,"name",d);this.txtName=g.findChildComponent(e,"name",h),r.uiMirror?(n.setScale(-1,1,1),n.setPosition(-(i.width+7),-1.389)):n.setPosition(i.width+7,-1.389),this.txtName.node.on(l.SIZE_CHANGED,(function(){r.uiMirror?n.setPosition(-(i.width+7),-1.389):n.setPosition(i.width+7,-1.389)})),this.content=g.findChildComponent(e,"name/messageContent/content",h),this.face=g.findChildComponent(e,"name/messageContent/face",u),this.faceOriScale=this.face.node.scale,this.allyName=this.findChildComponent("Infobg/btnInfo-001/nameTxt",h),this.allyLev=this.findChildComponent("Infobg/btnInfo-001/levTxt",h),this.guildPinItem=new C(this,this.findChild("Infobg/btnInfo-001/GuildPinItem")),this.nodeTop=this.findChild("Infobg/btnInfo-001"),this.nodeTop.getComponent(c).scheduleOnce((function(){t.setTopPos()}),0),this.nodeHandle=this.findChild("nodeHandle"),r.uiMirror&&this.nodeHandle.setScale(-1,1,1),this.nodeShow=g.findChild(this.nodeHandle,"nodeShow"),this.utShow=this.nodeShow.getComponent(d),this.utHandle=this.nodeHandle.getComponent(d),this.handleBall=g.findChild(this.nodeHandle,"nodeShow/nodeBall"),this.addComponentCallbackListener(this.nodeHandle,p.EventType.TOUCH_START,(function(e){var n=e.getUILocation();M.set(n.x,n.y);var i=t.utHandle.convertToNodeSpaceAR(M);i.z=0,t.startTouchPos.set(i),t.startTouch=!0,e.preventSwallow=!0})),this.addComponentCallbackListener(this.nodeHandle,p.EventType.TOUCH_MOVE,(function(e){if(t.startTouch){var n=e.getUILocation();if(M.set(n.x,n.y),t.nodeShow.active){var i=t.utShow.convertToNodeSpaceAR(M);i.z=0,e.propagationStopped=!0,e.propagationImmediateStopped=!0;var o=i;return i.length()>50&&(o=i.normalize().multiplyScalar(50)),t.handleBall.position=o,t.mapScene.moveOwner(H.set(o.x,o.y)),void(t.ballPos=o)}var s=t.utHandle.convertToNodeSpaceAR(M);a.subtract(new a,t.startTouchPos,s).length()>50?(t.nodeShow.active=!0,t.nodeShow.position=t.startTouchPos,t.handleBall.position=a.ZERO,e.propagationStopped=!0,e.propagationImmediateStopped=!0):e.preventSwallow=!0}})),this.addComponentCallbackListener(this.nodeHandle,p.EventType.TOUCH_END,(function(e){if(t.startTouch=!1,t.nodeShow.active)return t.nodeShow.active=!1,e.propagationStopped=!0,e.propagationImmediateStopped=!0,void t.mapScene.moveOwner(o.ZERO);e.preventSwallow=!0})),this.treasurePanel=new B(this,this.findChild("nodeTreasure"))},m.setTopPos=function(){if(!GlobalDefine.IPAD){var t=this.nodeTop,e=720/f.windowSize.width*f.windowSize.height,n=S.getMeunButtonTopDelta()*e,i=new a(0,e-n,0),o=t.parent.getComponent(d).convertToNodeSpaceAR(i),s=t.getPosition();t.setPosition(new a(s.x,o.y-23.5,s.z))}},m.registerUpdateHandler=function(){var t=this;this.addEvent(y.InsertNewMsg,this.updateMessage,this),this.addEvent(y.UpdateChatMsg,this.updateMessage,this),this.addEvent(G.GUILD_BOX_SHOW,(function(){t.treasurePanel.showBoxBanner()})),this.addEvent(G.GUILD_INFO_UPDATE,this.setAliyInfo,this)},m.onAfterOpen=function(){v.playMusic("bgm_jiazu"),this.setAliyInfo(),this.mapScene.open()},m.onBeforeClose=function(){var t;IS(x).HasGuild()&&IS(b).send_29_25(),this.mapScene.close(),null==(t=this.treasurePanel)||t.close()},m.onDestroy=function(){this.mapScene.destroy()},m.onUpdate=function(t){this.mapScene.onUpdate(t)},m.updateMessage=function(t){if(void 0===t&&(t=null),!t||t.channel==I.Channel.Guild){var e=IS(w).GetChatInfo(I.Channel.Guild,0);if(e&&e.length>0){var n=e[e.length-1];if(this.txtName.string=""==n.name?"":r.uiMirror?"："+n.name:n.name+"：",n.type==I.ChatContentType.Conetnt||n.type==I.ChatContentType.Share||n.type==I.ChatContentType.Pic||n.type==I.ChatContentType.Voice){var i=n.content;this.face.node.active=!1,n.type==I.ChatContentType.Pic?this.content.string=GetLanguage(200179):n.type==I.ChatContentType.Voice?this.content.string=GetLanguage(999000624):this.content.string=i}else if(n.type==I.ChatContentType.Face){this.face.node.active=!0,this.content.string="";var o=IS(w).GetFaceIconByContent(n.content),s=o[0],d=o[1],h=this.faceOriScale.y*d.scale;this.face.node.scale=new a(h,h,h),this.loadIcon(this.face,"icon_chat",s)}this.txtName.node.active=!0}else this.txtName.string="",this.content.string=""}},m.setAliyInfo=function(){var t=IS(P).GetGuildInfo();this.allyName.string=t.name,this.allyLev.string="LV."+t.level,this.guildPinItem.SetItem(t.guild_flag)},i}(L)),function(){function t(t,e){this.node=void 0,this.view=void 0,this.txtTreasureNum=void 0,this.txtTreasureLimit=void 0,this.txtTime=void 0,this.nodeTime=void 0,this.title=void 0,this.treasuretimer=0,this.view=t,this.node=e,this.view.dealMirrorLayout(g.findChildComponent(e,"bg/nodeShow/nodeNum",m));var n=g.findChildComponent(e,"bg/nodeShow/nodeNum/txtnum",h),i=g.findChildComponent(e,"bg/nodeShow/nodeNum/txtlimit",h);this.txtTreasureNum=n,this.txtTreasureLimit=i,this.txtTime=g.findChildComponent(e,"bg/nodeShow/nodeTime/txtTime",h),this.nodeTime=g.findChild(e,"bg/nodeShow/nodeTime"),this.title=g.findChild(e,"bg/title",h)}var e=t.prototype;return e.showBoxBanner=function(){var t=this,e=IS(P).boxInfo;if(e)if(0!=e.round){this.node.active=!0;var n=this.txtTreasureNum,i=this.txtTreasureLimit,o=configTreasure_hunt.getDataByKey(e.cfg_id).pick_limit;i.string=o+"",n.string=e.my_open,0==this.treasuretimer&&(this.updateBoxTime(),this.treasuretimer=this.view.addTimer(1,-1,(function(){t.updateBoxTime()})))}else this.node.active=!1},e.updateBoxTime=function(){var t=IS(P).boxInfo,e=this.nodeTime,n=t.countdown-T.serverTime,i=T.formatDate(new Date(1e3*n),"ss");this.txtTime.string=i,e.active=!0,Number(i)>50?this.title.string=GetLanguage(999000519):this.title.string=GetLanguage(999000517),0==t.round&&(e.active=!1,this.title.string=GetLanguage(999000518),Number(i)<-10&&(this.node.active=!1,this.treasuretimer&&(this.view.removeTimer(this.treasuretimer),this.treasuretimer=0)))},e.close=function(){this.treasuretimer=0},t}());i._RF.pop()}}}));

