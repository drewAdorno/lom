System.register("chunks:///_virtual/MultiWaitView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./V2.ts","./NodeUtil.ts","./TimeUtil.ts","./index57.ts","./ChapterDefine.ts","./ChatDataCache.ts","./ChatDefine.ts","./CommonModel.ts","./MessageView.ts","./RoleDataCache.ts","./GuildWarControl.ts","./GuildWarDataCache.ts","./GuildWarDefine.ts","./BaseView.ts"],(function(e){"use strict";var t,n,i,o,a,s,h,d,l,r,c,f,u,C,p,m,v,g,y,S,T,w,M,x,P,_,E,I,L;return{setters:[function(e){t=e.inheritsLoose,n=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy,o=e.Button,a=e.Label,s=e.ProgressBar,h=e.UITransform,d=e.sys,l=e.NodeEventType,r=e.Sprite,c=e.Node,f=e.Vec3,u=e.randomRangeInt,C=e.Color},function(e){p=e.V2},function(e){m=e.default},function(e){v=e.default},null,function(e){g=e.ChapterEventDefine},function(e){y=e.ChatDataCache},function(e){S=e.ChatEventDefine,T=e.ChatDefine},function(e){w=e.CommonModel},function(e){M=e.default,x=e.TYPE_YES},function(e){P=e.RoleDataCache},function(e){_=e.default},function(e){E=e.GuildWarDataCache},function(e){I=e.GuildBossEventDefine},function(e){L=e.BaseView}],execute:function(){i._RF.push({},"64176K+8eJFLqp4svDZJdfd","MultiWaitView",void 0);e("default",function(e){function i(){var t;return(t=e.call(this)||this).txtChapter=void 0,t.txtTime=void 0,t.btnChatRoot=void 0,t.imgChatIcon=void 0,t.txtName=void 0,t.content=void 0,t.face=void 0,t.faceOriScale=void 0,t.pbTime=void 0,t.nodeHandle=void 0,t.handleBall=void 0,t.nodeShowParnet=void 0,t.nodeShowBlockParnet=void 0,t.imgFaceOriScale=void 0,t.isMoving=!1,t.modelList=[],t.nodeSelfModel=void 0,t.modelSelf=void 0,t.updateTime=0,t.imgFaceOriScale=void 0,t.ballPos=new f(0,0,0),t.countDown=void 0,t.enterMoving=!1,t.PlayerMap={},t.name="MultiWaitView",t.url="ui/module/guildwar/MultiWaitView",t.poolTime=3e3,t}t(i,e);var L=i.prototype;return L.onInit=function(){var e=this,t=this.findChild("btnExit");this.addComponentCallbackListener(t,o.EventType.CLICK,(function(){M.showBoxTip({title:GetLanguage(200143),tip:GetLanguage(200382),func:function(e){e==x&&IS(_).reqGuildBossExit()}})})),this.txtChapter=this.findChildComponent("nodeTop/txtChapter",a),this.txtTime=this.findChildComponent("nodeTop/time/txtTime",a),this.pbTime=this.findChildComponent("nodeTop/time/pbTime",s),this.nodeHandle=this.findChild("nodeHandle"),this.handleBall=this.findChild("nodeHandle/nodeBall"),this.nodeShowParnet=this.findChild("map107/BG1/nodeShow"),this.nodeShowBlockParnet=this.findChild("map107/BG1/nodeShow/nodeShow1");var n=this.findChild("btnChatRoot");this.addComponentCallbackListener(n,o.EventType.CLICK,(function(){uiMgr.openView("ChatView",2,null,null,null,1)})),this.imgChatIcon=m.findChild(n,"imgChatIcon");var i=m.findChild(n,"name/messageContent"),f=m.findChildComponent(n,"name",h);this.txtName=m.findChildComponent(n,"name",a),d.uiMirror?(i.setScale(-1,1,1),i.setPosition(-(f.width+7),-1.389)):i.setPosition(f.width+7,-1.389),this.txtName.node.on(l.SIZE_CHANGED,(function(){d.uiMirror?i.setPosition(-(f.width+7),-1.389):i.setPosition(f.width+7,-1.389)})),this.content=m.findChildComponent(n,"name/messageContent/content",a),this.face=m.findChildComponent(n,"name/messageContent/face",r),this.faceOriScale=this.face.node.scale,this.addComponentCallbackListener(this.nodeHandle,c.EventType.TOUCH_START,(function(){e.onHandleTouchStart()})),this.addComponentCallbackListener(this.nodeHandle,c.EventType.MOUSE_DOWN,(function(){e.onHandleTouchStart()})),this.addComponentCallbackListener(this.nodeHandle,c.EventType.TOUCH_MOVE,(function(t){e.onHandleTouchMove(t)})),this.addComponentCallbackListener(this.nodeHandle,c.EventType.MOUSE_MOVE,(function(t){e.onHandleTouchMove(t)})),this.addComponentCallbackListener(this.nodeHandle,c.EventType.TOUCH_END,(function(t){e.onHandleTouchEnd(t)})),this.addComponentCallbackListener(this.nodeHandle,c.EventType.TOUCH_CANCEL,(function(t){e.onHandleTouchEnd(t)})),this.addComponentCallbackListener(this.nodeHandle,c.EventType.MOUSE_UP,(function(t){e.onHandleTouchEnd(t)}))},L.onHandleTouchStart=function(){this.isMoving=!0},L.onHandleTouchMove=function(e){if(this.isMoving&&null!=e){var t=e.getUILocation(),n=new f(t.x,t.y,0),i=this.nodeHandle.getComponent(h).convertToNodeSpaceAR(n);if(Math.abs(i.x)<=50&&Math.abs(i.y)<=50)var o=i;else{var a=50*(i.dot(new f(1,0,0))/Math.sqrt(i.x*i.x+i.y*i.y)),s=Math.sqrt(2500-a*a);s=i.y>0?s:-s;o=new f(a,s,0)}this.handleBall.position=o,this.ballPos=o}},L.onHandleTouchEnd=function(e){this.isMoving&&(this.isMoving=!1,this.handleBall.position=new f(0,0,0),this.ballPos=new f(0,0,0))},L.onAfterOpen=function(){var e=this;this.txtChapter.string=GetLanguage_UI(999000345)+" "+IS(E).level,this.loadAllPlayer(),this.refreshTime(),this.countDown=this.addTimer(1,-1,(function(){e.refreshTime()}))},L.onUpdate=function(e){if(this.updateTime+=e,this.updateTime>=.16){if(this.updateTime=0,0==this.ballPos.x&&0==this.ballPos.y&&0==this.ballPos.z)return void(this.modelSelf&&(this.modelSelf.aniName="idle"));var t=new f(.4*this.ballPos.x,.4*this.ballPos.y,0),n=this.nodeSelfModel.position,i=this.nodeShowParnet.getComponent(h).contentSize,o=new f(Math.min(Math.max(n.x+t.x,0),i.width)-n.x,Math.min(Math.max(n.y+t.y,0),i.height)-n.y),a=this.nodeShowBlockParnet.position,s=this.nodeShowBlockParnet.getComponent(h).contentSize.width/2,d=new f(a.x-n.x-o.x,a.y-n.y-o.y,a.z-n.z-o.z),l=Math.sqrt(s*s-d.x*d.x),r=Math.sqrt(s*s-d.y*d.y),c=o;if(d.x<s&&Math.abs(d.y)<l){var u=new f(a.x-d.x,d.y>0?a.y-l:a.y+l,0);c=new f(u.x-n.x,u.y-n.y,u.z-n.z)}else if(d.y<s&&d.x<r){u=new f(a.x-r,a.y-d.y,0);c=new f(u.x-n.x,u.y-n.y,u.z-n.z)}this.modelMove(this.nodeSelfModel,c,.16)}},L.modelMove=function(e,t,n){var i=this,o=new f,a=new f(e.position.x,e.position.y);this.modelSelf&&(this.modelSelf.aniName="run",this.modelSelf.direction=t.x>=0?1:-1),this.addTween(0,1,n,(function(n,s){null!=i.node&&(o.set(a).add3f(t.x*s,t.y*s,0),e.position=o)})).start()},L.fixBlockPos=function(){for(var e,t=this.nodeShowBlockParnet.position,i=this.nodeShowBlockParnet.getComponent(h).contentSize.width/2,o=n(this.nodeShowParnet.children);!(e=o()).done;){var a=e.value,s=a.position,d=new f(t.x-s.x,t.y-s.y,0),l=Math.sqrt(i*i-d.x*d.x),r=Math.sqrt(i*i-d.y*d.y);d=d.x<i&&d.y<l?new f(t.x-d.x,t.y-l,0):d.y<i&&d.x<r?new f(t.x-r,t.y-d.y,0):s,a.position=d}},L.registerUpdateHandler=function(){this.addEvent(S.InsertNewMsg,this.updateMessage,this),this.addEvent(S.UpdateChatMsg,this.updateMessage,this),this.addEvent(I.TYPE_GUILD_WAR_WAIT_UPDATE,this.updatePlayerList,this),this.addEvent(g.CHAPTER_MAP_INIT,this.closeMapView,this)},L.closeMapView=function(){uiMgr.close("ChapterMapView")},L.loadAllPlayer=function(){if(0!=this.modelList.length)for(var e,t=n(this.modelList);!(e=t()).done;){var i=e.value;this.removeUnitModel(i)}var o=this.findChild("nodePlayer");this.nodeShowParnet.removeAllChildren();for(var s,d=this.nodeShowParnet.getComponent(h).contentSize,l=n(IS(E).memberList);!(s=l()).done;){var r=s.value,c=nodeInstantiate.instantiate(o);c.active=!0,c.parent=this.nodeShowParnet;var C=new f(u(0,d.width),u(0,d.height),0);c.position=C,this.loadRoleModel(r,c),m.findChildComponent(c,"txtName",a).string=r.role_name,Number(r.role_id)==IS(P).GetRoleId()?(m.findChild(c,"nodeSelf").active=!0,this.nodeSelfModel=c):m.findChild(c,"nodeSelf").active=!1,this.PlayerMap[r.role_id]=c}this.fixBlockPos()},L.updatePlayerList=function(e){for(var t,i=this.findChild("nodePlayer"),o=this.nodeShowParnet.getComponent(h).contentSize,s=n(e);!(t=s()).done;){var d=t.value;if(d.role_id in this.PlayerMap)return;var l=nodeInstantiate.instantiate(i);l.active=!0,l.parent=this.nodeShowParnet;var r=new f(u(0,o.width),u(0,o.height),0);l.position=r,this.loadRoleModel(d,l),m.findChildComponent(l,"txtName",a).string=d.role_name,Number(d.role_id)==IS(P).GetRoleId()&&(m.findChild(l,"nodeSelf").active=!0,this.nodeSelfModel=l),this.PlayerMap[d.role_id]=l}this.fixBlockPos()},L.loadRoleModel=function(e,t){for(var n=e.figure,i=n.hair_figure>0&&n.hair_figure||6,o=n.equip_list.length>0&&IS(w).GetKvListByK(n.equip_list,0)||0,a=n.equip_list.length>1&&IS(w).GetKvListByK(n.equip_list,1)||0,s=n.equip_list.length>2&&IS(w).GetKvListByK(n.equip_list,2)||0,h=n.mount_figure||0,d=m.findChild(t,"rolemodel"),l=n.skin_list||[],r=0,c=0;c<l.length;c++)2==l[c].k&&(r=l[c].v);var f=n.gender||1,u=this.addUnitModel({job:n.job_figure,parent:d,dressId:r,gender:f,color:i,weapon:o,ornaments:a,face:s,mount:h,shenqi:0},p.ZERO,1.5);this.modelList.push(u),this.modelSelf=this.getUnitModel(u)},L.refreshTime=function(){var e=IS(E).end_time-v.serverTime;this.txtTime.string=v.formatTimeToMS(e),this.pbTime.progress=1-e/600,e<1&&!this.enterMoving&&(this.enterMoving=!0,this.onHandleTouchEnd(null),this.sceneChange(e))},L.sceneChange=function(e){var t=this.findChildComponent("nodeBlock",r);t.color=new C(0,0,0,0),t.node.active=!0,this.addTween(0,1,e,(function(e,n){var i=new C(0,0,0,255*n);t.color=i})).start()},L.updateMessage=function(e){if(void 0===e&&(e=null),!e||e.channel==T.Channel.Guild){var t=IS(y).GetChatInfo(T.Channel.Guild,0);if(t&&t.length>0){var n=t[t.length-1];if(this.txtName.string=""==n.name?"":d.uiMirror?"："+n.name:n.name+"：",n.type==T.ChatContentType.Conetnt||n.type==T.ChatContentType.Share||n.type==T.ChatContentType.Pic||n.type==T.ChatContentType.Voice){var i=n.content;this.face.node.active=!1,n.type==T.ChatContentType.Pic?this.content.string=GetLanguage(200179):n.type==T.ChatContentType.Voice?this.content.string=GetLanguage(999000624):this.content.string=i}else if(n.type==T.ChatContentType.Face){this.face.node.active=!0,this.content.string="";var o=IS(y).GetFaceIconByContent(n.content),a=o[0],s=o[1],h=this.faceOriScale.y*s.scale;this.face.node.scale=new f(h,h,h),this.loadIcon(this.face,"icon_chat",a)}this.txtName.node.active=!0,this.showSceneChat(n)}else this.txtName.string="",this.content.string=""}},L.showSceneChat=function(e){var t=this.PlayerMap[e.role_id];if(null!=t){var n=m.findChildComponent(t,"nodeChat/nodeTxt/txtChat",a),i=m.findChildComponent(t,"nodeChat/nodeTxt/icon",r);if(this.imgFaceOriScale||(this.imgFaceOriScale=i.node.scale),e.type==T.ChatContentType.Conetnt||e.type==T.ChatContentType.Share){var o=e.content;e.name.length+o.length>30&&(o=o.substring(0,Math.max(1,30-e.name.length))+"..."),n.string=o,i.node.active=!1}else if(e.type==T.ChatContentType.Face){i.node.active=!0,n.string="";var s=IS(y).GetFaceIconByContent(e.content),h=s[0],d=s[1],l=this.imgFaceOriScale.y*d.scale;i.node.scale=new f(l,l,l),this.loadIcon(i,"icon_chat",h)}m.findChild(t,"nodeChat").active=!0,this.addTimer(2,1,(function(){m.findChild(t,"nodeChat").active=!1}))}},L.onBeforeClose=function(){if(this.PlayerMap={},this.nodeShowParnet.removeAllChildren(),0!=this.modelList.length){for(var e,t=n(this.modelList);!(e=t()).done;){var i=e.value;this.removeUnitModel(i)}this.modelList.length=0}},L.onDestroy=function(){},i}(L));i._RF.pop()}}}));

