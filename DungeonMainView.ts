System.register("chunks:///_virtual/DungeonMainView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIList.ts","./NodeUtil.ts","./StringUtil.ts","./TimeUtil.ts","./index57.ts","./ItemIcon.ts","./ConfigGlobal.ts","./AdDefine.ts","./AdModel.ts","./BagDefine.ts","./BagModel.ts","./ChatDataCache.ts","./ChatDefine.ts","./CommonModel.ts","./MessageView.ts","./PrivilegeDataCache.ts","./PrivilegeDefine.ts","./RoleDataCache.ts","./RoleDefine.ts","./ChapterDataCache.ts","./ChapterDefine.ts","./DungeonControl.ts","./DungeonDefine.ts","./BaseSubView.ts"],(function(t){"use strict";var e,i,n,o,s,a,d,h,r,c,l,u,C,f,p,g,v,m,_,y,T,D,I,E,A,R,L,S,G,B,P,b,w,x,K,O,M,N,k,H,U,V,W;return{setters:[function(t){e=t.inheritsLoose,i=t.createForOfIteratorHelperLoose},function(t){n=t.cclegacy,o=t.ScrollView,s=t.Label,a=t.Button,d=t.UITransform,h=t.NodeEventType,r=t.Sprite,c=t.isValid,l=t.Vec3,u=t.Layout,C=t.js,f=t.sys,p=t.HorizontalTextAlignment},function(t){g=t.SelectedType,v=t.ListItem},function(t){m=t.default},function(t){_=t.default},function(t){y=t.default},null,function(t){T=t.IconAseetType},function(t){D=t.ConfigGlobal},function(t){I=t.AdEventDefine},function(t){E=t.AdModel},function(t){A=t.BagEventDefine},function(t){R=t.BagModel},function(t){L=t.ChatDataCache},function(t){S=t.ChatEventDefine,G=t.ChatDefine},function(t){B=t.CommonModel},function(t){P=t.default},function(t){b=t.PrivilegeDataCache},function(t){w=t.PrivilegeEventDefine,x=t.PrivilegeCardEffect},function(t){K=t.RoleDataCache},function(t){O=t.RoleEventDefine},function(t){M=t.ChapterDataCache},function(t){N=t.ChapterEventDefine,k=t.DungeonDefine},function(t){H=t.default},function(t){U=t.DungeonEvent,V=t.DungeonIconMap},function(t){W=t.BaseSubView}],execute:function(){n._RF.push({},"e12244XgwBMfaJFZDILQW3L","DungeonMainView",void 0);t("DungeonMainView",function(t){function n(){var e;return(e=t.call(this)||this).scrollDungeonList=void 0,e.updateList=!1,e.txtTime=void 0,e.btnChatRoot=void 0,e.imgChatIcon=void 0,e.txtName=void 0,e.content=void 0,e.face=void 0,e.faceOriScale=void 0,e.channel=void 0,e.name="DungeonMainView",e.url="ui/module/dungeon/DungeonMainView",e}e(n,t);var u=n.prototype;return u.onInit=function(){var t=this,e=this.findChildComponent("BG/bg/scrollDungeon",o);this.scrollDungeonList=this.addUIList(e,Y),this.scrollDungeonList.selectedMode=g.SINGLE,this.txtTime=this.findChildComponent("BG/bg/title/txtTime",s),this.btnChatRoot=this.findChild("btnChatRoot"),this.addComponentCallbackListener(this.btnChatRoot,a.EventType.CLICK,(function(){uiMgr.openView("ChatView",t.channel)})),this.imgChatIcon=this.findChild("imgChatIcon");var i=this.findChild("btnChatRoot/name/messageContent"),n=this.findChildComponent("btnChatRoot/name",d);this.txtName=this.findChildComponent("btnChatRoot/name",s),this.txtName.node.on(h.SIZE_CHANGED,(function(){i.setPosition(n.width+7,-1.389)})),this.content=this.findChildComponent("btnChatRoot/name/messageContent/content",s),this.face=this.findChildComponent("btnChatRoot/name/messageContent/face",r),this.faceOriScale=this.face.node.scale},u.registerUpdateHandler=function(){this.addEvent(N.DUNGEON_UPDATE,this.onDungeonUpdate,this),this.addEvent(A.GOODS_INFO_UPDATE,this.onGoodsUpdate,this),this.addEvent(N.DUNGEON_ENTER,this.onDungeonEnter,this),this.addEvent(U.TYPE_WORLD_BOSS_INFO_CHANGE,this.onWorldBossInfoUpdate,this),this.addEvent(I.AD_INFO_UPDATE,this.onAdInfoUpdate,this),this.addEvent(O.ROLE_OPEN_FUNCTION_UPDATE,this.onRoleOpenFunctionUpdate,this),this.addEvent(S.InsertNewMsg,this.updateMessage,this),this.addEvent(S.UpdateChatMsg,this.updateMessage,this),this.addEvent(w.PRIVILEGE_CARD_UPDATE,this.onPrivilegeCardUpdate,this),this.addEvent(U.TYPE_WORLD_BOSS_INFO_UPDATE,this.reqRefreshWorldInfo,this),this.addEvent(N.DOUBLE_CHAPTER_ENTRANCE_INFO_BACK,this.onDoubleChapterEntraceInfoBack,this),this.addEvent(N.DOUBLE_CHAPTER_ENTRANCE_INFO_BACK,this.updateRed,this),this.addEvent(N.DOUBLE_CHAPTER_REWARD_UPDATE,this.updateRed,this)},u.onAfterOpen=function(){var t=this;this.findChildComponent("BG/bg/title/title",s).string=GetLanguage(201805);for(var e,n=configChapter_type.getDataByKey(k.CHAPTER_TYPE_WORLDBOSS),o=IS(K).CheckFuncOpen(n.open_id),a=[],d=i(IS(M).dungeonList);!(e=d()).done;){var h=e.value;if(configChapter_type.getDataByKey(h.type).order>0)if(h.type==k.CHAPTER_TYPE_WORLDBOSS&&o)IS(H).reqWorldBossInfo(),a.unshift(h);else if(h.type==k.CHAPTER_TYPE_DARK_TRIAL||h.type==k.CHAPTER_TYPE_DARK_TRIAL_2||h.type==k.CHAPTER_TYPE_DARK_TRIAL_3)for(var r,c=i(h.ext);!(r=c()).done;){var l=r.value,u=l.k,C=l.v;12==u&&1==C&&a.push(h)}else a.push(h)}a.sort((function(t,e){return configChapter_type.getDataByKey(t.type).order-configChapter_type.getDataByKey(e.type).order}));a.push({type:99,max_level:0,cur_level:0,day_times:0}),this.scrollDungeonList.datas=a,this.updateTime(),this.addTimer(1,-1,(function(){t.updateTime()})),this.updateMessage(),this.scrollDungeonList.updateAll()},u.onBeforeClose=function(){this.updateList=!1},u.onDestroy=function(){},u.onUpdate=function(t){if(this.updateList){for(var e,n=[],o=configChapter_type.getDataByKey(k.CHAPTER_TYPE_WORLDBOSS),s=IS(K).CheckFuncOpen(o.open_id),a=i(IS(M).dungeonList);!(e=a()).done;){var d=e.value;if(configChapter_type.getDataByKey(d.type).order>0)if(d.type==k.CHAPTER_TYPE_WORLDBOSS&&s)n.unshift(d);else if(d.type==k.CHAPTER_TYPE_DARK_TRIAL||d.type==k.CHAPTER_TYPE_DARK_TRIAL_2||d.type==k.CHAPTER_TYPE_DARK_TRIAL_3)for(var h,r=i(d.ext);!(h=r()).done;){var c=h.value,l=c.k,u=c.v;12==l&&1==u&&n.push(d)}else n.push(d)}n.sort((function(t,e){return configChapter_type.getDataByKey(t.type).order-configChapter_type.getDataByKey(e.type).order}));n.push({type:99,max_level:0,cur_level:0,day_times:0}),this.scrollDungeonList.datas=n,this.updateList=!1,this.scrollDungeonList.updateAll()}},u.updateTime=function(){var t=y.getNextDayTime()-y.serverTime;this.txtTime.string=y.msToHMS(1e3*t),this.scrollDungeonList.items.forEach((function(t,e,i){t.updateTime()}))},u.onDungeonUpdate=function(){this.updateList=!0},u.onGoodsUpdate=function(t,e){this.updateList=!0},u.onDungeonEnter=function(){uiMgr.close("DungeonLevelView")},u.onAdInfoUpdate=function(){this.updateList=!0},u.onWorldBossInfoUpdate=function(){this.updateList=!0},u.onRoleOpenFunctionUpdate=function(){this.updateList=!0},u.onPrivilegeCardUpdate=function(){this.updateList=!0},u.reqRefreshWorldInfo=function(){IS(H).reqWorldBossInfo()},u.onDoubleChapterEntraceInfoBack=function(){this.updateList=!0},u.updateRed=function(){this.scrollDungeonList.items.forEach((function(t,e,i){t.updateRemind()}))},u.updateMessage=function(t){void 0===t&&(t=null);var e=null;t&&t.channel==G.Channel.World?(e=IS(L).GetChatInfo(G.Channel.World,0),this.refreshHisShow(e),this.channel=G.Channel.World):t&&t.channel==G.Channel.Guild?(e=IS(L).GetChatInfo(G.Channel.Guild,0),this.refreshHisShow(e),this.channel=G.Channel.Guild):null==e&&(e=IS(L).GetChatInfo(G.Channel.World,0),this.refreshHisShow(e),this.channel=G.Channel.World)},u.refreshHisShow=function(t){if(t&&t.length>0){var e=t[t.length-1];if(this.txtName.string=e.name+"ï¼š",e.type==G.ChatContentType.Conetnt||e.type==G.ChatContentType.Share||e.type==G.ChatContentType.Pic||e.type==G.ChatContentType.Voice){var i=e.content;e.type==G.ChatContentType.Pic?this.content.string=GetLanguage(200179):e.type==G.ChatContentType.Voice?this.content.string=GetLanguage(999000624):this.content.string=i,c(this.face)&&(this.face.node.active=!1)}else if(e.type==G.ChatContentType.Face){c(this.face)&&(this.face.node.active=!0),this.content.string="";var n=IS(L).GetFaceIconByContent(e.content),o=n[0],s=n[1],a=this.faceOriScale.y*s.scale;this.face.node.scale=new l(a,a,a),this.loadIcon(this.face,"icon_chat",o)}c(this.txtName)&&(this.txtName.node.active=!0)}else this.txtName.string="",this.content.string=""},n}(W));var Y=t("DunngeonItem",function(t){function n(){for(var e,i=arguments.length,n=new Array(i),o=0;o<i;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).btnGoto=void 0,e.btnGoto1=void 0,e.btnGoto2=void 0,e.txtDesc=void 0,e.txtNum=void 0,e.btnAd=void 0,e.txtAdDesc=void 0,e.txtAdCount=void 0,e.nodeAdIcon=void 0,e.adId=void 0,e.imgBG=void 0,e.imgIconBG=void 0,e.imgIcon=void 0,e.imgKey=void 0,e.btnRule=void 0,e.btnRule1=void 0,e.nodeMask=void 0,e.txtLockDesc=void 0,e.txtGoto=void 0,e.nodeKey=void 0,e.nodeTeam=void 0,e.txtTeamNum=void 0,e.node1=void 0,e.node2=void 0,e.node3=void 0,e.node4=void 0,e.txtTime=void 0,e.nodeRemind=void 0,e.nodeWait=void 0,e.nodeTime=void 0,e}e(n,t);var o=n.prototype;return o.onInit=function(){var t=this;this.adaptiveSize=!0,this.node1=m.findChild(this.node,"node1"),this.node2=m.findChild(this.node,"node2"),this.node3=m.findChild(this.node,"node3"),this.node4=m.findChild(this.node,"node4"),this.nodeTime=m.findChild(this.node4,"time"),this.txtTime=m.findChildComponent(this.node4,"time/txtTime",s),this.nodeRemind=m.findChild(this.node4,"btnGoto/point"),this.btnGoto=m.findChild(this.node1,"listContent/btnGoto"),this.btnGoto1=m.findChild(this.node3,"btnGoto"),this.btnGoto2=m.findChild(this.node4,"btnGoto"),this.nodeWait=m.findChild(this.node4,"btnWait"),this.txtGoto=m.findChildComponent(this.node1,"listContent/btnGoto/Label",s),this.nodeKey=m.findChild(this.node1,"numBg"),this.imgKey=m.findChildComponent(this.node1,"numBg/imgKey",r),this.txtNum=m.findChildComponent(this.node1,"numBg/txtNum",s),this.txtDesc=m.findChildComponent(this.node1,"txtDesc",s),this.imgBG=m.findChildComponent(this.node1,"imgBg",r),this.imgIconBG=m.findChildComponent(this.node1,"imgIconBG",r),this.imgIcon=m.findChildComponent(this.node1,"imgIconBG/imgIcon",r),this.btnRule=m.findChild(this.node1,"btnRule"),this.btnRule1=m.findChild(this.node3,"btnRule"),this.btnAd=m.findChild(this.node1,"listContent/btnAd"),this.txtAdDesc=m.findChildComponent(this.node1,"listContent/btnAd/txtDesc",s),this.txtAdCount=m.findChildComponent(this.node1,"listContent/btnAd/txtCount",s),this.nodeAdIcon=m.findChild(this.node1,"listContent/btnAd/imgAd"),this.nodeTeam=m.findChild(this.node1,"nodeTeam"),this.txtTeamNum=m.findChildComponent(this.node1,"nodeTeam/txtNum",s),this.nodeMask=m.findChild(this.node1,"imgMask"),this.txtLockDesc=m.findChildComponent(this.node1,"Node/txtLockDesc",s),this.nodeAdIcon.active=1==D.ads_icon_is_show,this.txtAdCount.node.position=1==D.ads_icon_is_show?new l(19.7,-7.7,0):new l(0,-7.7,0),this.view.addComponentCallbackListener(this.btnGoto,a.EventType.CLICK,(function(){t.onClickGoto()})),this.view.addComponentCallbackListener(this.btnGoto1,a.EventType.CLICK,(function(){t.onClickGoto()})),this.view.addComponentCallbackListener(this.btnGoto2,a.EventType.CLICK,(function(){t.onClickGoto()})),this.view.addComponentCallbackListener(this.btnAd,a.EventType.CLICK,(function(){IS(E).tryWatchAd(t.adId)})),this.view.addComponentCallbackListener(this.btnRule,a.EventType.CLICK,(function(){t.onShowTips()})),this.view.addComponentCallbackListener(this.btnRule1,a.EventType.CLICK,(function(){t.onShowTips()}))},o.onRender=function(t,e){if(this.data=t,99==t.type)return this.node1.active=!1,this.node2.active=!0,this.node3.active=!1,this.node4.active=!1,void(this.node.getComponent(d).height=200);if(t.type==k.CHAPTER_TYPE_WORLDBOSS)return this.node1.active=!1,this.node2.active=!1,this.node3.active=!0,this.node4.active=!1,this.node.getComponent(d).height=316,void this.refreshWorldBossView();t.type==k.CHAPTER_TYPE_DOUBLE_LADDER?(this.node1.active=!1,this.node2.active=!1,this.node3.active=!1,this.node4.active=!0,this.view.dealMirrorLayout(m.findChildComponent(this.node,"node4/time",u)),this.updateRemind(),this.node.getComponent(d).height=200):(this.node1.active=!0,this.node2.active=!1,this.node3.active=!1,this.node4.active=!1,this.node.getComponent(d).height=200),this.checkShowMask();var n=configChapter_type.getDataByKey(t.type);this.adId=n.ad,this.txtDesc.string=n.name,V[t.type]&&(this.view.loadIcon(this.imgBG,V[t.type].BG[0],V[t.type].BG[1],null,T.UI_ATLAS,!0),this.view.loadIcon(this.imgIconBG,V[t.type].iconBG[0],V[t.type].iconBG[1],null,T.UI_ATLAS,!0),this.view.loadIcon(this.imgIcon,V[t.type].icon[0],V[t.type].icon[1]),this.view.loadIcon(this.imgKey,V[t.type].key[0],V[t.type].key[1],null,T.UI_ATLAS,!0),this.imgKey.node.setScale(1,1,1));var o=IS(M).getLimit(t.type),s=0,a=!1;if(this.nodeKey.active=!0,this.imgKey.node.active=!0,this.nodeTeam.active=!1,this.txtGoto.string=GetLanguage(200147),t.type==k.CHAPTER_TYPE_LEGACY_TEAM)this.refreshLegacyTeamView();else if(this.data.type==k.CHAPTER_TYPE_DARK_TRIAL||this.data.type==k.CHAPTER_TYPE_DARK_TRIAL_2||this.data.type==k.CHAPTER_TYPE_DARK_TRIAL_3){this.btnAd.active=!1,this.imgKey.node.active=!1;var h=0,r=IS(b).getPrivilegeCardInfo(5);r&&h++,IS(b).getPrivilegeCardInfo(2)&&h++;var c=0;if(r)for(var l,C=i(t.ext);!(l=C()).done;){var f=l.value,p=f.k,g=f.v;11==p&&(c=g)}c=h-c,this.txtNum.string=_.formatStrWithMirrorDeal(GetLanguage(201967),c),this.btnGoto.active=!0}else if(t.type==k.CHAPTER_TYPE_DOUBLE_LADDER){var v=IS(M).checkDounleChapterOpen();this.nodeTime.active=v,this.btnGoto2.active=v,this.nodeWait.active=!v}else if(o){var y=configGoods.getDataByKey(o[2][0]);s=IS(R).getGoodsCountByGoodsGtid(y.id),this.txtNum.string=s+"/"+(o[1]+IS(b).getPrivilegeCardValue(x.SCRIPT,t.type)),a=null!=this.adId&&s<=0,this.btnGoto.active=!a,this.btnAd.active=a,a&&this.refreshADInfo()}},o.onClickGoto=function(){if(this.data.type==k.CHAPTER_TYPE_LEGACY_TEAM){var t=IS(R).getGoodsCountByGoodsGtid(1009);IS(R).getGoodsCountByGoodsGtid(1010);0==t?P.showFlyTip(GetLanguage(200069)):uiMgr.openView("MakeTeamView")}else if(this.data.type==k.CHAPTER_TYPE_WORLDBOSS)uiMgr.openView("WorldBossEnterView");else if(this.data.type==k.CHAPTER_TYPE_DARK_TRIAL||this.data.type==k.CHAPTER_TYPE_DARK_TRIAL_2||this.data.type==k.CHAPTER_TYPE_DARK_TRIAL_3){var e,i=((e={})[k.CHAPTER_TYPE_DARK_TRIAL]=1,e[k.CHAPTER_TYPE_DARK_TRIAL_2]=2,e[k.CHAPTER_TYPE_DARK_TRIAL_3]=3,e);uiMgr.openView("WingDungeonView",i[this.data.type])}else this.data.type==k.CHAPTER_TYPE_DOUBLE_LADDER?uiMgr.openView("DoubleChapterMainView"):uiMgr.openView("DungeonLevelView",this.data)},o.refreshADInfo=function(){var t=configAds.getDataByKey(this.adId);t&&(this.txtAdDesc.string=_.formatStrWithMirrorDeal(t.desc,_.GetNumString(IS(E).getAdRewardValue(this.adId))),this.txtAdCount.string=C.formatStr("(%s/%s)",t.times-IS(E).getAdWatchCount(this.adId),t.times))},o.checkShowMask=function(){var t=configChapter_type.getDataByKey(this.data.type).open_id;this.nodeMask.active=!IS(K).CheckFuncOpen(t),this.txtLockDesc.node.active=!IS(K).CheckFuncOpen(t);var e=configNewFuncOpen.getDataByKey(t);this.txtLockDesc.string=e.openCondition},o.refreshWorldBossView=function(){var t=m.findChild(this.node3,"imgMask"),e=m.findChildComponent(this.node3,"Node/txtLockDesc",s),i=configChapter_type.getDataByKey(this.data.type);m.findChildComponent(this.node3,"txtDesc",s).string=i.name;var n=i.open_id;t.active=!IS(K).CheckFuncOpen(n),e.node.active=!IS(K).CheckFuncOpen(n);var o=configNewFuncOpen.getDataByKey(n);e.string=o.openCondition;var a=IS(M).worldBossInfo;if(a){var d=m.findChildComponent(this.node3,"txtTime",s),h=m.findChildComponent(this.node3,"txtTime/txtTimedesc",s);f.uiMirror&&h.node.setScale(1,1,1);var r=y.formatDate(y.ServerDate(1e3*(a.start_time+1)),"hh:mm"),c=y.formatDate(y.ServerDate(1e3*(a.end_time+1)),"hh:mm");d.string=r+" - "+c+y.GetServerTimeZoneStr(),a.is_open?(h.string=GetLanguage(200148),m.findChild(this.node3,"numBg").active=!0):(h.string=GetLanguage(200149),m.findChild(this.node3,"numBg").active=!1);var l=m.findChildComponent(this.node3,"numBg/txtNum",s),u=D.world_boss_challenge_limit;l.string=a.times+"/"+u;var C=m.findChild(this.node3,"nodeBest/img"),p=m.findChildComponent(this.node3,"nodeBest/txtname",s),g=IS(M).worldBossInfo.figure;if(g&&0!=g.job_figure)p.string=IS(M).worldBossInfo.role_name,C.active=!1,this.loadRoleModel(g);else p.string=GetLanguage(200038),m.findChild(this.node3,"nodeBest/model").removeAllChildren(),C.active=!0}},o.loadRoleModel=function(t){for(var e=t.hair_figure>0&&t.hair_figure||6,i=t.equip_list.length>0&&IS(B).GetKvListByK(t.equip_list,0)||0,n=t.equip_list.length>1&&IS(B).GetKvListByK(t.equip_list,1)||0,o=t.equip_list.length>2&&IS(B).GetKvListByK(t.equip_list,2)||0,s=t.equip_list.length>2&&IS(B).GetKvListByK(t.equip_list,4)||0,a=t.mount_figure||0,d=t.skin_list||[],h=0,r=0;r<d.length;r++)2==d[r].k&&(h=d[r].v);var c=t.gender||1,l=t.artifact_figure||0,u=m.findChild(this.node3,"nodeBest/model");u.removeAllChildren(),this.view.addUnitModel({job:t.job_figure,parent:u,dressId:h,gender:c,color:e,weapon:i,ornaments:n,face:o,mount:a,shenqi:l,wing:s})},o.refreshLegacyTeamView=function(){var t=D.legacy_team_chapter_recover,e=IS(R).getGoodsCountByGoodsGtid(t[0]),i=(IS(R).getGoodsCountByGoodsGtid(t[2]),!1),n=!1;configAds.getDataByKey(this.adId).times,IS(E).getAdWatchCount(this.adId);0!=e?(this.txtNum.string=e+"/"+(t[1]+IS(b).getPrivilegeCardValue(x.SCRIPT,this.data.type)),n=!0):(i=!0,this.txtNum.string="0/"+(t[1]+IS(b).getPrivilegeCardValue(x.SCRIPT,this.data.type))),this.btnGoto.active=n,this.btnAd.active=i,this.txtGoto.string=GetLanguage(200150),i&&this.refreshADInfo()},o.onShowTips=function(){var t=configChapter_type.getDataByKey(this.data.type);P.showBoxTip({tip:""+t.desc,ensure:GetLanguage(200129),btnCnt:1,horizontalAlign:f.uiMirror?p.RIGHT:p.CENTER,title:GetLanguage(200143)})},o.updateTime=function(){if(this.data.type==k.CHAPTER_TYPE_DOUBLE_LADDER){var t=IS(M).doubleChapterEntraceInfo?IS(M).doubleChapterEntraceInfo.end_time:0;t||(t=0);var e=Math.max(0,t-y.serverTime);this.txtTime.string=y.formatTimeStringForSecond(e)}},o.updateRemind=function(){this.data.type==k.CHAPTER_TYPE_DOUBLE_LADDER&&(this.nodeRemind.active=IS(M).getDoubleChapterRewardRedNum()>0)},n}(v));n._RF.pop()}}}));

