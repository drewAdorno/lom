System.register("chunks:///_virtual/CrossWarMapScene.ts",["./rollupPluginModLoBabelHelpers.js","cc","./BattleData.ts","./NodeUtil.ts","./MapMgr.ts","./ChapterDataCache.ts","./MessageView.ts","./RoleDataCache.ts","./CrossWarDatacache.ts","./CrossWarDefine.ts","./CrossWarSceneControl.ts","./CrossWarSceneDataCache.ts","./SceneBoss.ts","./SceneCamera.ts","./SceneMiniMap.ts","./SceneMonster2.ts","./SceneRole2.ts","./SceneSelect.ts"],(function(e){"use strict";var t,i,o,s,n,a,r,c,l,h,d,u,p,f,v,S,w,m,M,C,g,y,b,I,T,U,j,x,L,_;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy,o=e.Vec2,s=e.find,n=e.Vec3,a=e.Prefab,r=e.UITransform,c=e.Camera,l=e.Node,h=e.screen,d=e.sys,u=e.game},function(e){p=e.ChapterType},function(e){f=e.default},function(e){v=e.MapMgr},function(e){S=e.ChapterDataCache},function(e){w=e.default},function(e){m=e.RoleDataCache},function(e){M=e.CrossWarDataCache},function(e){C=e.SceneObjType,g=e.SceneObjState,y=e.RoleUpdateFlag},function(e){b=e.default},function(e){I=e.CrossWarSceneDataCache},function(e){T=e.SceneBoss},function(e){U=e.SceneCamera},function(e){j=e.SceneMiniMap},function(e){x=e.SceneMonster},function(e){L=e.SceneRole},function(e){_=e.SceneSelect}],execute:function(){i._RF.push({},"fdd4e7+Od9FoIcEuLkefpZs","CrossWarMapScene",void 0);var D=new o;e("CrossWarMapScene",function(){function e(e){this.node=void 0,this.units=[],this.bossList=[],this.unitMap={},this.owner=void 0,this.view=void 0,this.mapCamera=new U,this.miniMap=new j,this.nodeUnit=void 0,this.nodeUnitHub=void 0,this.nodeUnitSelect=void 0,this.nodeUnitState=void 0,this.nodeMap=void 0,this.ut=void 0,this.onLoadViewSuccess=void 0,this.startTouchPos=void 0,this.sendPointTime=0,this.checkAutoTime=0,this.selectTarget=void 0,this.selectUnit=void 0,this.updateBossList=!1,this.view=e}var i=e.prototype;return i.load=function(){var e=this;this.node||(null!=this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/crosswar/CrosswarMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),this.onLoadViewSuccess=function(t){if(e.onLoadViewSuccess=null,!t.error&&null!=t.item&&null!=t.item.asset){var i=t.item.asset,o=nodeInstantiate.instantiate(i);e.node=o,o.setParent(s("UIRoot").parent),o.position=new n(-3e4,0),o.setSiblingIndex(1),e.onInit()}},resourceMgr.loadRes("ui/module/crosswar/CrosswarMapScene",a,this.onLoadViewSuccess))},i.onInit=function(){var e=this;this.nodeUnit=f.findChild(this.node,"unit"),this.ut=this.nodeUnit.getComponent(r),this.nodeUnitHub=f.findChild(this.node,"unitHub"),this.nodeMap=f.findChild(this.node,"map"),this.nodeUnitSelect=f.findChild(this.node,"unitSelect"),this.nodeUnitState=f.findChild(this.node,"unitState"),this.mapCamera.nodeCamera=f.findChild(this.node,"SceneCamera"),this.mapCamera.camera=this.mapCamera.nodeCamera.getComponent(c),this.miniMap.nodeMap=this.view.miniMap,this.view.addComponentCallbackListener(this.nodeMap,l.EventType.TOUCH_END,(function(t){if(e.owner){var i=t.getLocation();if(!(i.x<0||i.x>h.windowSize.width)){var o=new n(i.x,i.y,0),s=e.mapCamera.camera.screenToWorld(o);s.add3f(3e4,0,0),e.checkClick(s)}}})),this.open(),d.uiMirror&&this.node.setScale(-1,1,1)},i.registerEvent=function(){},i.open=function(){if(this.node)return this.registerEvent(),this.node.active||(this.node.active=!0),void this.onAfterOpen();this.load()},i.close=function(){this.node&&this.node.active&&(this.node.active=!1),null!=this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/crosswar/CrosswarMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),IS(v).exitMap(),this.onBeforeClose()},i.destroy=function(){this.close(),this.node&&(this.node.destroy(),resourceMgr.releaseResRef("ui/module/crosswar/CrosswarMapScene"),this.node=null)},i.onAfterOpen=function(){},i.onBeforeClose=function(){if(IS(I).battleAction=null,IS(M).clearActions(),uiMgr.close("CrossWarWantedView"),null!=this.owner){this.cancelSelect();for(var e,i=t(this.units);!(e=i()).done;){e.value.destroy()}this.mapCamera.follow=null,this.units.length=0,this.bossList.length=0,this.unitMap={},this.owner=null}},i.onDestroy=function(){},i.moveOwner=function(e){this.owner&&(this.cancelSelect(),this.owner.moveToDir(e))},i.checkBossList=function(e){for(var t=0;t<this.bossList.length;t++)this.bossList[t].info.obj_id==e&&(this.bossList.splice(t,1),t--)},i.synMoveToServer=function(){if(this.owner&&u.totalTime-this.sendPointTime>=300){var e=this.owner.velocity;if(null==e||e.lengthSqr()<=1)return;D.set(e.x,e.y),D.normalize().multiplyScalar(.4*this.owner.info.speed),D.add2f(this.owner.position.x,this.owner.position.y);for(var i,s=t(this.bossList);!(i=s()).done;){var n=i.value;if(o.distance(D,n.position)<n.radius)return o.subtract(D,this.owner.position,n.position),D.normalize().multiplyScalar(n.radius),D.add2f(n.position.x,n.position.y),this.owner.moveToTarget(D),this.sendPointTime=u.totalTime,void IS(b).reqMove(2,D)}D.set(e),D.normalize().multiplyScalar(.4*this.owner.info.speed),D.add2f(this.owner.position.x,this.owner.position.y);var a=IS(v).curMap.box;D.x>a.xMax-60&&(D.x=a.xMax-60),D.x<a.xMin+60&&(D.x=a.xMax+60),D.y>a.yMax-60&&(D.y=a.yMax-60),D.y<a.yMin+60&&(D.y=a.yMin+60),this.owner.moveToTarget(D),this.sendPointTime=u.totalTime,IS(b).reqMove(2,D)}},i.checkClick=function(e){if(this.owner){for(var i,s=t(this.units);!(i=s()).done;){var n=i.value;if(n!=this.owner&&(n.info.obj_type==C.Holy||n.rect.contains(e))){if(n instanceof L)if(n.info.role.serv_id==this.owner.info.role.serv_id)continue;if(n.info.state==g.Dead)return void w.showFlyTip(GetLanguage(200235));if(n.info.state==g.Battle)return void w.showFlyTip(GetLanguage(200236));if(n.info.obj_type!=C.Holy)return null==this.selectTarget&&(this.selectTarget=new _(this)),this.selectUnit=n,this.selectTarget.position=n.position,void this.selectTarget.refresh();if(o.distance(e,n.position)<=n.radius)return IS(m).GetServerId()==IS(M).serv_id?void w.showFlyTip(GetLanguage(201385)):(this.cancelSelect(),void IS(b).reqMove(3,null,n.info.obj_id,n.info.obj_type))}}this.cancelSelect(),this.moveToTarget(new o(e.x,e.y))}},i.moveToTarget=function(e){this.owner&&(o.distance(this.owner.position,e)<1||IS(b).reqMove(1,e))},i.moveToBattle=function(e){var t;this.owner&&this.owner.info.state!=g.Battle&&(e=null!=(t=e)?t:this.selectUnit)&&(this.owner.stopMove(),IS(b).reqMove(3,null,e.info.obj_id,e.info.obj_type))},i.cancelSelect=function(){var e;this.selectUnit&&(this.selectUnit=null,null==(e=this.selectTarget)||e.destroy(),this.selectTarget=null)},i.onUpdate=function(e){if(this.node){var t=IS(I);if(1==t.loadScene){var i=IS(M).scene_base,o=configScene.getDataByKey(i);IS(v).exitMap(),IS(v).enterMap(o.map_path),IS(v).curMap.parent=this.nodeMap;var s=IS(v).curMap.box;this.mapCamera.setMapSize(s.width,s.height),t.loadScene=2,this.view.load.active=!1}if(IS(v).update(),0!=t.roleUpdateFlag&&(t.roleUpdateFlag&y.Add&&this.addSceneObj(),t.roleUpdateFlag&y.Del&&this.delSceneObj(),t.roleUpdateFlag&y.Move&&this.moveSceneObj(),t.roleUpdateFlag&y.Update&&this.updateSceneObj()),t.roleUpdateFlag=0,this.owner){for(var n=0;n<this.units.length;n++){var a=this.units[n];if(a.del){if(a.destroy(),this.units.splice(n,1),a.info.obj_type==C.Holy&&(this.checkBossList(a.info.obj_id),IS(v).curMap.showBossId.delete(a.info.pos.x+"_"+a.info.pos.y),this.updateBossList=!0,IS(v).curMap.updateViewCenter(this.mapCamera.oriPos.x,this.mapCamera.oriPos.y,!0)),n--,this.selectUnit&&a.id==this.selectUnit.id&&this.cancelSelect(),a.id==this.owner.id)return this.owner=null,void(this.mapCamera.follow=null)}else a.update(e)}if(this.owner){var r;if(t.autoBattle&&this.owner.info.state==g.Normal&&u.totalTime-this.checkAutoTime>500){this.checkAutoTime=u.totalTime;var c=this.selectUnit&&this.selectUnit.info;if(null==c){var l=IS(M).job,h=configCross_war_job.getDataByKey(l).auto_attack;c=t.getAutoBattleObj(this.owner.position,h)}if(null!=c&&c.state==g.Normal){var d="obj:"+c.obj_id,f=this.unitMap[d];f&&(null==this.selectTarget&&(this.selectTarget=new _(this)),this.selectUnit=f,this.selectTarget.position=f.position,this.selectTarget.refresh(),this.moveToBattle())}}this.mapCamera.onUpdate(e),null==(r=IS(v).curMap)||r.updateViewCenter(this.mapCamera.oriPos.x,this.mapCamera.oriPos.y),this.owner.info.pos.x=this.owner.position.x,this.owner.info.pos.y=this.owner.position.y,this.miniMap.setCenter(this.mapCamera.oriPos.x,this.mapCamera.oriPos.y),this.miniMap.setPointPos(this.owner.info)}null!=this.selectUnit&&(this.selectTarget.position=this.selectUnit.position);var w=IS(S),m=w.currentLoadType==p.Main||w.chapterType==p.Main;if(this.node&&this.node.active!=m&&(this.node.active=m),IS(I).battleAction&&(IS(I).battleAction(),IS(I).battleAction=null,uiMgr.close("CrossWarMapOverView"),uiMgr.close("CrossWarEnterMapView"),uiMgr.close("CrossWarWantedView")),m){var b=IS(M);b.roleDeadAction&&(b.roleDeadAction(),b.roleDeadAction=null),b.rewardActions.length>0&&b.rewardActions.shift()()}}}},i._addSceneObj=function(e){var t=this;if(e){var i=null;switch(e.obj_type){case C.Player:i=new L(this,e);break;case C.Monster:i=new x(this,e);break;case C.Holy:i=new T(this,e),IS(v).curMap.showBossId.add(e.pos.x+"_"+e.pos.y),this.checkBossList(e.obj_id),this.bossList.push(i),this.updateBossList=!0}this.units.push(i),this.unitMap[i.id]=i,e.obj_id==IS(m).GetRoleId()&&(this.owner=i,this.mapCamera.follow=i,this.owner.info.state==g.Dead?IS(M).roleDeadAction=function(){uiMgr.openView("CrossWarDeadView",t.owner.info.role.revive_time,t.owner.info.role.revive_count)}:(uiMgr.close("CrossWarDeadView"),IS(M).roleDeadAction=null))}},i.loadAllSceneObj=function(){for(var e=0;e<this.units.length;e++){var t=this.units[e];1==t.type&&(t.destroy(),this.units.splice(e,1),e--,delete this.unitMap[t.id])}this.owner=null;var i=IS(I).roleMap;for(var o in i){var s=i[o];this._addSceneObj(s)}this.miniMap.refreshPoint()},i.addSceneObj=function(){for(var e,i=IS(I),o=i.roleMap,s=i.roleActions[y.Add],n=t(s);!(e=n()).done;){var a=e.value,r="obj:"+a;if(this.unitMap[r]){var c=this.unitMap[r];this.units.splice(this.units.indexOf(c),1),this.selectUnit&&this.selectUnit.id==c.id&&this.cancelSelect(),c.destroy(),delete this.unitMap[r]}var l=o[a];l&&this._addSceneObj(l)}s.clear(),this.miniMap.refreshPoint()},i.delSceneObj=function(){for(var e,i=IS(I).roleActions[y.Del],o=t(i);!(e=o()).done;){var s="obj:"+e.value;this.unitMap[s]&&(this.unitMap[s].del=!0,delete this.unitMap[s])}i.clear(),this.miniMap.refreshPoint()},i.moveSceneObj=function(){for(var e,i=IS(I),o=i.roleMap,s=i.roleActions[y.Move],n=t(s);!(e=n()).done;){var a=e.value,r="obj:"+a,c=this.unitMap[r];if(c&&!c.del){var l=o[a].moveInfo;if(null!=l){if(c.agent.maxSpeed=o[a].speed,this.owner&&this.owner.id==r&&2==l.type)continue;c.stopMove(),c.agent.activePath.push(l.pos),c.moveType=1,c.agent.isMove=!0}else c.stopMove(),c.agent.activePath.push(o[a].pos),c.moveType=1,c.agent.isMove=!0}}s.clear()},i.updateSceneObj=function(){for(var e,i=this,o=IS(I),s=o.roleMap,n=o.roleActions[y.Update],a=function(){var t=e.value,o="obj:"+t,n=i.unitMap[o];if(!n||n.del)return"continue";var a=s[t];a&&(n.updateState(),a.obj_type==C.Holy&&(i.updateBossList=!0)),i.owner==n&&(a.state==g.Dead?IS(M).roleDeadAction=function(){uiMgr.openView("CrossWarDeadView",a.role.revive_time,a.role.revive_count)}:(uiMgr.close("CrossWarDeadView"),IS(M).roleDeadAction=null))},r=t(n);!(e=r()).done;)a()},e}());i._RF.pop()}}}));

