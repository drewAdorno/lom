System.register("chunks:///_virtual/MapTileMgr.ts",["./rollupPluginModLoBabelHelpers.js","cc","./MapData.ts","./MapTile.ts"],(function(t){"use strict";var i,e,s,a,l,r,h;return{setters:[function(t){i=t.createForOfIteratorHelperLoose},function(t){e=t.cclegacy,s=t.Rect,a=t.Vec2},function(t){l=t.MapData,r=t._tileWidth},function(t){h=t.MapTile}],execute:function(){e._RF.push({},"7e76dwJb65AYqW8ASZQJJMp","MapTileMgr",void 0);var n=new s,o=new a;function c(t,i){return n.xMin=Math.floor((t.x-i.x/2)/r-.5),n.xMax=Math.floor((t.x+i.x/2)/r+.5),n.yMin=Math.floor((t.y-i.y/2)/r-.5),n.yMax=Math.floor((t.y+i.y/2)/r+.5),n}var u=t("TileObj",function(){function t(){this.go=void 0,this.mapObjectData=void 0,this.url=void 0,this.type=void 0,this.tiles=void 0}var i=t.prototype;return i.removeTile=function(t){return null==this.tiles||(this.tiles.delete(t),0==this.tiles.size&&null!=this.go&&(this.go.free(),this.go=null),0==this.tiles.size)},i.addTile=function(t){null==this.tiles&&(this.tiles=new Set),this.tiles.add(t)},t}());t("MapTileMgr",function(){function t(t){this.map=void 0,this._loadList=[],this._removeTileList=[],this._curTileDic={},this._cacheList=[],this._gameObjectDic={},this._curTileCenter=new a(-2e4,-2e4),this._viewSize=new a,this._tileObjs=[],this._updateTileObj=!1,this.map=t}var e=t.prototype;return e.updateTileCenter=function(t,i,e){if(void 0===e&&(e=!1),e||!(a.distance(this._curTileCenter,t)<=1)){e&&this.refresh();var s=c(t,i);this._curTileCenter.set(t),this._viewSize.set(i),this.doReadData(this.map.data.tileMap,s)}},e.cacheTileObj=function(t){t.pushObjToPool(),this._cacheList.push(t)},e.refresh=function(){var t=this._removeTileList,i=this._loadList,e=this._curTileDic;for(var s in i.length=0,t.length=0,e){var a=e[s];this.cacheTileObj(a)}this._curTileDic={}},e.getTileObj=function(t,i){void 0===i&&(i=!0);var e=this._gameObjectDic[t];if(!e){if(!i)return e;e=new u,this._gameObjectDic[t]=e,this._tileObjs.push(e),this._updateTileObj=!0}return e},e.removeObj=function(t,i){if(this._gameObjectDic[i]){var e=this._gameObjectDic[i];if(e.removeTile(t)){delete this._gameObjectDic[i];var s=this._tileObjs.indexOf(e);this._tileObjs.splice(s,1),this._updateTileObj=!0}}},e.doReadData=function(t,e){var s=e.xMin,h=e.xMax,n=e.yMin,c=e.yMax,u=this._removeTileList,d=this._loadList,p=this._curTileDic;for(var f in u.length=0,p){var _=p[f];(_.tileX<s||_.tileX>h||_.tileY<n||_.tileY>c)&&(this.cacheTileObj(_),u.push(l.getTileId(_.tileX,_.tileY)))}for(var v,T=i(u);!(v=T()).done;){delete p[v.value]}d.length=0;for(var b=r/2,O=s;O<=h;O++)for(var j=n;j<=c;j++){var g=l.getTileId(O,j);if(t[g]){var M=t[g];o.set(O*r+b,j*r+b);var D={x:O,y:j,tileId:g,tileData:M,tileDist:a.distance(this._curTileCenter,o)};d.push(D)}}d.sort((function(t,i){return t.tileDist-i.tileDist}))},e.update=function(){ftime.beginFTime(ftime.MapTileLoad);var t=this._loadList,i=this._curTileDic,e=this._cacheList,s=t.length;if(0!=s){for(var a=0;a<s&&!ftime.checkPass(ftime.MapTileLoad);++a){var l=t[a],r=i[l.tileId];r||((r=e.length>0?e.pop():new h(this.map)).tileId=l.tileId,r.tileX=l.x,r.tileY=l.y,r.tileData=l.tileData,i[l.tileId]=r),r.loadObject(),t.splice(a,1),--a,--s}this._updateTileObj&&(this._updateTileObj=!1,this._updateDepth())}},e._updateDepth=function(){this._tileObjs.sort((function(t,i){return t.mapObjectData.depth-i.mapObjectData.depth}));for(var t=0;t<this._tileObjs.length;++t){this._tileObjs[t].go.depth=t}},t}());e._RF.pop()}}}));

