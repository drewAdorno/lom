System.register("chunks:///_virtual/SocketClient.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TimeUtil.ts","./ByteArray.ts","./IOHandler.ts"],(function(e){"use strict";var t,n,s,o,c;return{setters:[function(e){t=e.createClass},function(e){n=e.cclegacy},function(e){s=e.default},function(e){o=e.ByteArray},function(e){c=e.IOHandler}],execute:function(){var i,a;e({SocketCode:void 0,SocketState:void 0}),n._RF.push({},"2da649HcqNEnbFI0MTrPQMv","SocketClient",void 0),function(e){e[e.Disconnected=0]="Disconnected",e[e.Connecting=1]="Connecting",e[e.Connected=2]="Connected"}(i||(i=e("SocketState",{}))),function(e){e[e.Connect=0]="Connect",e[e.Disconnect=1]="Disconnect",e[e.Exception=2]="Exception",e[e.ExceptionOnConnect=3]="ExceptionOnConnect",e[e.SendError=4]="SendError",e[e.ExceptionOnReceive=5]="ExceptionOnReceive",e[e.TimeoutDisconnect=6]="TimeoutDisconnect",e[e.DisconnectByServer=7]="DisconnectByServer",e[e.ServerNotResponse=8]="ServerNotResponse"}(a||(a=e("SocketCode",{})));e("SocketClient",function(){function e(){this._socket=void 0,this._state=void 0,this._address=void 0,this._reconnectFlag=void 0,this._onNetStateFunc=void 0,this._onNetMsgFunc=void 0,this._sendMsgQueue=void 0,this._receiveMsgQueue=void 0,this._codeQueue=void 0,this._lastTime=0,this._msgQueueIgnore=void 0,this._ioHandler=void 0,this._state=i.Disconnected,this._sendMsgQueue=[],this._receiveMsgQueue=[],this._codeQueue=[],this._msgQueueIgnore=new Set}var n=e.prototype;return n._onConnect=function(){this._codeQueue.length=0,this._state=i.Connected,this._sendActiveMessage(),this._lastTime=s.getTimestamp(),this._ioHandler=new c(this),this._onStatusChanged(a.Connect)},n._connectServer=function(){var e=this;if(this._state==i.Disconnected){var t=this;this._state=i.Connecting;var n=this._address.host;this._socket=new WebSocket(n),this._socket.binaryType="arraybuffer",this._socket.onopen=function(e){t._onConnect()},this._socket.onmessage=function(t){if(e._lastTime=s.getTimestamp(),null!=e._ioHandler&&t.data instanceof ArrayBuffer)try{e._ioHandler.onDataRead(t.data)}catch(e){printLogException(e,"协议解析报错!!")}},this._socket.onclose=function(e){printLogErr("onclose: wasClean = "+e.wasClean+", code="+e.code+", reason="+e.reason),t._state!==i.Connecting&&t._state!==i.Disconnected&&(1e3==e.code||1005==e.code?t._onStatusChanged(a.Disconnect):1001==e.code||1010==e.code||1011==e.code||1012==e.code||1013==e.code?t._onStatusChanged(a.DisconnectByServer):1006==e.code?t._onStatusChanged(a.TimeoutDisconnect):e.code>1e3&&t._onStatusChanged(a.ExceptionOnReceive))},this._socket.onerror=function(e){t._onError(e)}}else printLogErr("Calling connect when the socket is not disconnected")},n.connect=function(e){this._address=e,this._reconnectFlag=!1,this._connectServer()},n.reconnect=function(e){this._address=e,this._reconnectFlag=!0,this._connectServer()},n._onError=function(e){printLogErr("Connection error:",e),this._state==i.Connecting?this._onStatusChanged(a.ExceptionOnConnect):this._onStatusChanged(a.Exception)},n._onStatusChanged=function(e){e!=a.Connect&&(this.disconnect(),this._state=i.Disconnected),this._codeQueue.push(e)},n.disconnect=function(){if(this._state==i.Disconnected)return!1;this._sendMsgQueue.length=0,this._receiveMsgQueue.length=0,printLogErr("手动关闭连接。。。。   "+this._socket.readyState+"    "+WebSocket.CLOSED),this._socket.readyState!=WebSocket.CLOSED&&this._socket.close(),this._state=i.Disconnected,this._codeQueue.length=0},n.addMsgQueueIgnore=function(e){this._msgQueueIgnore.add(e)},n.sendMessage=function(e,t){var n=this._ioHandler.genPacket(e,t);this._sendMsgQueue.push(n)},n._sendMessage=function(e){this._socket.readyState==WebSocket.OPEN&&this._socket.send(e.buffer)},n._sendActiveMessage=function(){if(this._state==i.Connected){var e=new o;this._reconnectFlag?e.writeByte(1):e.writeByte(0),this._sendMessage(e)}},n.reciveMsg=function(e,t){if(this._msgQueueIgnore.has(e)){var n=this._onNetMsgFunc;null!=n&&(null!=n.target?n.callback.call(n.target,e,t):n.callback(e,t))}else this._receiveMsgQueue.push([e,t])},n.update=function(e){if(null!=this._socket){var t=this._onNetStateFunc;if(null!=t){for(var n=this._codeQueue,o=0;o<n.length;o++){var c=n[o];null!=t.target?t.callback.call(t.target,c):t.callback(c)}n.length=0}if(this._state==i.Connected||this._socket.readyState==WebSocket.OPEN)if(s.getTimestamp()-this._lastTime>12e4){this.disconnect();var r=this._onNetStateFunc;null!=r&&(null!=r.target?r.callback.call(r.target,a.ServerNotResponse):r.callback(a.ServerNotResponse))}else{var u=this._receiveMsgQueue,h=this._onNetMsgFunc;if(null!=h){ftime.beginFTime(ftime.SocketClientMsg);for(var d=0;d<u.length;d++){if(ftime.checkPass(ftime.SocketClientMsg))break;var l=u.shift();d--;try{null!=h.target?h.callback.call(h.target,l[0],l[1]):h.callback(l[0],l[1])}catch(e){printLogException(e,"protoId:"+l[0]+" runtime error!")}}}var _=this._sendMsgQueue;if(_.length>0){for(var g=0;g<_.length;g++){var f=_[g];this._sendMessage(f)}_.length=0}}}},n.setOnNetState=function(e,t){this._onNetStateFunc={callback:e,target:t}},n.setOnNetMsg=function(e,t){this._onNetMsgFunc={callback:e,target:t}},t(e,[{key:"state",get:function(){return this._state}}]),e}());n._RF.pop()}}}));

