System.register("chunks:///_virtual/ResourceMgr.ts",["./rollupPluginModLoBabelHelpers.js","cc","./AssetPool.ts","./ResCachePool.ts","./ResItem.ts"],(function(e){"use strict";var t,n,s,o,a,i,l,r,u,d,c,f,h,g;return{setters:[function(e){t=e.createForOfIteratorHelperLoose,n=e.createClass},function(e){s=e.cclegacy,o=e.director,a=e.Director,i=e.assetManager,l=e.isValid,r=e.sys,u=e.resources,d=e.BufferAsset,c=e.JsonAsset},function(e){f=e.assetPools},function(e){h=e.ResCachePool},function(e){g=e.ResItem}],execute:function(){s._RF.push({},"2e6a7vqAr9AfL/K6eXzByil","ResourceMgr",void 0);var v,_=function(){function e(){this.error=void 0,this.item=void 0}return e.get=function(){return new e},e.free=function(e){},e}();!function(e){e[e.Wait=0]="Wait",e[e.Loading=1]="Loading",e[e.SuccessToLoad=2]="SuccessToLoad",e[e.FailedToLoad=3]="FailedToLoad",e[e.Unloaded=4]="Unloaded",e[e.Cancel=5]="Cancel"}(v||(v={}));var p=function(){function e(){this.state=void 0,this.bundle=void 0,this.loadTime=0,this.url=void 0,this.type=void 0,this.cbList=[],this.result=void 0,this.isRemote=!1}return e.prototype.callback=function(){for(var e,n=t(this.cbList);!(e=n()).done;){(0,e.value)(this.result)}},e.get=function(){var t=new e;return t.state=v.Wait,t},e.free=function(e){},e}();e("default",function(){function e(){this._loading=void 0,this._cachePool=void 0,this._resultQueue=new Array,_G("resourceMgr",this),this._cachePool=new h,this._loading=new Map,o.on(a.EVENT_AFTER_DRAW,this.onEndDrawUpdate,this)}var s=e.prototype;return s.clear=function(){o.off(a.EVENT_AFTER_DRAW,this.onEndDrawUpdate,this),this._loading.clear(),this._cachePool.clearAll(),this._resultQueue.length=0,i.releaseAll()},s.addResult=function(e){this._resultQueue.push(e)},s.addAssetPool=function(e){f.push(e)},s.resultTaskUpdate=function(){var e=this._resultQueue;for(ftime.beginFTime(ftime.ResManager);e.length>0;){if(ftime.checkPass(ftime.ResManager))break;var t=e.shift(),n=t.url;try{t.callback(),p.free(t)}catch(e){printLogException(e,n+": run error!")}}},s._loadCb=function(e,t,n,s){var o,a=this;(this._loading.delete(t),n||!l(s))&&(console.error("加载 "+t+" 失败"),printLogException(n),null==(o=e.bundle)||o.release(e.url,e.type),s=null,e.state=v.FailedToLoad,this.SetBundleUseBgp(e.bundle));var i=null;s&&(s.addRef(),i=new g,e.cbList.forEach((function(e){i.addRef()})),i.asset=s,i.url=t,i.requestTime=r.now(),e.state=v.SuccessToLoad,this._cachePool.add(i)),e.cbList.forEach((function(s){var o=p.get();o.result=_.get(),o.result.error=n,o.state=e.state,o.type=e.type,o.cbList.push(s),o.result.item=i,o.url=t,a.addResult(o)}))},s.update=function(){for(var e,n=this,s=this._loading,o=[],a=function(){var t=e.value,s=t[1],a=t[0];return s.state==v.Loading&&r.now()-s.loadTime>1e4?(s.state=v.Cancel,o.push(s),"continue"):s.state!=v.Wait?"continue":(s.state=v.Loading,s.loadTime=r.now(),void(s.isRemote?i.loadRemote(s.url,{ext:".png"},(function(e,t){s.state==v.Loading&&n._loadCb(s,a,e,t)})):s.bundle.load(s.url,s.type,(function(e,t){s.state==v.Loading&&n._loadCb(s,a,e,t)}))))},l=t(s);!(e=l()).done;)a();if(o.length>0){for(var u,d=t(o);!(u=d()).done;){var c=u.value;this.releaseResRef(c.url);for(var f,h=this._getLoadParam(c.bundle,c.url,c.type),g=t(c.cbList);!(f=g()).done;){var _=f.value;h.cbList.push(_)}this._loading.set(h.url,h)}o.length=0}this.resultTaskUpdate(),this._cachePool.update()},s.onEndDrawUpdate=function(){f.forEach((function(e){e.onUpdate()}))},s._getLoadParam=function(e,t,n){var s=p.get();return s.state=v.Wait,s.type=n,s.bundle=e,null==e&&(s.isRemote=!0),s.url=t,s},s._loadRes=function(e,t,n,s){if(t){var o=t;t=t;var a=this._cachePool.get(o);if(null!=a){a.addRef();var i=p.get();return i.state=v.SuccessToLoad,i.bundle=e,i.url=t,i.cbList.push(s),i.result=_.get(),i.result.item=a,void this.addResult(i)}var l=this._loading.get(o);null==l?((l=this._getLoadParam(e,t,n)).cbList.push(s),this._loading.set(o,l)):l.cbList.push(s)}},s.SetResBundleUseBgp=function(){var e=i.getBundle("bundle-res");this.SetBundleUseBgp(e)},s.SetBundleUseBgp=function(e){0==(null==e?void 0:e.useBGP)&&e.base.startsWith("https")&&"none"!=GlobalDefine.REMOTE_PATH&&"none"!=GlobalDefine.REMOTE_BAK_PATH&&(e.useBGP=!0,GlobalDefine.USE_BACKCDN=!0,e.base=null==e?void 0:e.base.replace(GlobalDefine.REMOTE_PATH,GlobalDefine.REMOTE_BAK_PATH),console.error("包地址切换为 "+e.base))},s.loadRes=function(e,t,n){var s=i.getBundle("bundle-res");this._loadRes(s,e,t,n)},s.loadFirstLoadRes=function(e,t,n){var s=i.getBundle("bundle-firstload-res");this._loadRes(s,e,t,n)},s.getBasePath=function(){var e=i.getBundle("bundle-res");return e.base.substring(0,e.base.length-11)},s.getBaseConfig=function(){i.getBundle("bundle-res")},s.loadBuiltRes=function(e,t,n){this._loadRes(u,e,t,n)},s.releaseResRef=function(e){var t=this._loading.get(e);null!=t&&(this._loading.delete(e),t.state=v.Cancel);var n=this._cachePool.get(e);if(null!=n)null==n||n.decRef();else for(var s=this._resultQueue,o=0;o<s.length;o++)s[o].url==e&&(s.splice(o,1),o--)},s.cancelLoadRes=function(e,t){if(null!=t){for(var n=this._resultQueue,s=0;s<n.length;s++){var o=n[s];o.url==e&&o.cbList[0]==t&&(n.splice(s,1),s--)}var a=this._loading.get(e);if(a){for(var i=a.cbList,l=0;l<i.length;l++){i[l]==t&&(i.splice(l,1),l--)}0==a.cbList.length&&(a.state=v.Cancel,this._loading.delete(e))}}},s.loadConfig=function(e,t){var n=i.getBundle("bundle-config");this._loadRes(n,"datas/"+e,d,t)},s.loadConfigJson=function(e,t){var n=i.getBundle("bundle-config-json");this._loadRes(n,"datas/"+e,c,t)},s.loadRemote=function(e,t,n){if(!e)return printLogErr("url is null!"),void(n&&n(null));this._loadRes(null,e,t,n)},n(e,[{key:"cachePool",get:function(){return this._cachePool}}]),e}());s._RF.pop()}}}));

