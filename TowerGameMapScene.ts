System.register("chunks:///_virtual/TowerGameMapScene.ts",["./rollupPluginModLoBabelHelpers.js","cc","./V2.ts","./NodeUtil.ts","./UIEffectAsset.ts","./PolyNav2D.ts","./MessageView.ts","./GameCenterControl.ts","./GameCenterModel.ts","./TowerGameDataCache.ts","./TowerGameDefine.ts","./SceneCamera7.ts","./SceneUnit.ts"],(function(e){"use strict";var t,i,n,s,o,a,r,u,c,f,h,d,l,m,p,v,w,g,y,S,_,C,I,k,M,N;return{setters:[function(e){t=e.regeneratorRuntime,i=e.createForOfIteratorHelperLoose},function(e){n=e.cclegacy,s=e.Prefab,o=e.UITransform,a=e.Vec3,r=e.find,u=e.Camera,c=e.Vec2},function(e){f=e.V2},function(e){h=e.default},function(e){d=e.UIEffectAsset},function(e){l=e.PolyNav2D},function(e){m=e.default},function(e){p=e.default},function(e){v=e.default},function(e){w=e.default},function(e){g=e.RoleBirthPoint,y=e.defaultPoint,S=e.HitRange,_=e.bornTime,C=e.BirthPoint,I=e.AttackRange},function(e){k=e.SceneCamera},function(e){M=e.SceneRole,N=e.SceneMonster}],execute:function(){var R;n._RF.push({},"e06579Wqe9BV7Ovvb8pemNc","TowerGameMapScene",void 0);e("TowerGameMapScene",function(){function e(e){this.units=[],this.node=void 0,this.view=void 0,this.mapCamera=new k,this.owner=void 0,this.nodeUnit=void 0,this.polyNav=void 0,this.ut=void 0,this.onLoadViewSuccess=void 0,this.frameNum=0,this.curRound=0,this.maxNum=0,this.curNum=0,this._uiEffects=void 0,this._effectId=0,R=r("SceneRoot"),this.view=e,this.mapCamera.nodeCamera=h.findChild(R,"SceneCamera"),this.mapCamera.camera=this.mapCamera.nodeCamera.getComponent(u)}var n=e.prototype;return n.load=function(){var e=this;this.node||(null!==this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/towerGame/TowerGameMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),this.onLoadViewSuccess=function(t){if(e.onLoadViewSuccess=null,!t.error&&null!==t.item&&null!==t.item.asset){var i=t.item.asset,n=nodeInstantiate.instantiate(i);e.node=n,n.setParent(R),e.onInit()}},resourceMgr.loadRes("ui/module/towerGame/TowerGameMapScene",s,this.onLoadViewSuccess))},n.onInit=function(){this.nodeUnit=h.findChild(this.node,"unit"),this.ut=this.nodeUnit.getComponent(o),this.polyNav=h.findChildComponent(this.node,"polyNav2D",l),this.open()},n.registerEvent=function(){},n.open=function(){if(R.active||(R.active=!0),this.node)return this.registerEvent(),void this.onAfterOpen();this.load()},n.close=function(){R.active&&(R.active=!1),null!==this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/towerGame/TowerGameMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),this.onBeforeClose()},n.destroy=function(){this.close(),this.node&&(this.node.destroy(),resourceMgr.releaseResRef("ui/module/towerGame/TowerGameMapScene"),this.node=null)},n.onAfterOpen=function(){var e=IS(w);e.role={role_id:1,powerLev:1,speedLev:1,pos:g,attackPower:configTowerdefence.getDataByKeys("id",1,"lev",1).num,attackSpeed:configTowerdefence.getDataByKeys("id",2,"lev",1).num,skillPoint:y},e.gameState=1,this.owner=null;var t=e.role,i=new M(this,t);this.owner=i,this.mapCamera.setTarget(i,new a(0,-100,0)),this.units[i.id]=i,this.curRound=1,this.loadMonsterCfg(this.curRound)},n.onBeforeClose=function(){if(null!==this.owner){for(var e in this.units){if(this.units.hasOwnProperty(e))this.units[e].destroy()}this.units.length=0,this.owner=null,this._uiEffects&&(this._uiEffects.forEach((function(e){e.free()})),this._uiEffects.length=0)}},n.onDestroy=function(){},n.onUpdate=function(e){if(0!=IS(w).gameState){for(var t in this._updateDepth(),this.units)if(this.units.hasOwnProperty(t)){var i=this.units[t];if(i.del){i.destroy(),delete this.units[i.id];continue}i.update(e)}4===this.frameNum?(this.checkHitArea(),this.attackMonster(),this.frameNum=0):this.frameNum++}},n.attackMonster=function(){var e=this;if(0!=IS(w).gameState&&this.owner&&!this.owner.isAttackCD){var t=function(t){var i=e.units[t];if(2==i.type&&(f.distance(i.position,e.owner.position)<I&&e.owner.tryAttack()))var n=new c,s=new c(e.owner.position.x,e.owner.position.y),o=i.position,a=f.distance(s,o)/(I/.5),r=e.addUIEffect("prefab/effect/MX_tx_shulingchanggong",e.nodeUnit,-1,(function(t){var u=f.subtract(new f,o,s).signAngle(c.UNIT_X)/Math.PI*180;t.node.angle=-u,e.view.addTween(0,1,a,(function(e,i){var a=f.subtract(new f,o,s);n.set(s).add2f(a.x*i,a.y*i),t.node.setPosition(n.x,n.y)})).call((function(){i.isDestroy||i.hit(IS(w).role.attackPower)&&(IS(w).addSkillPoint(i.point),i.destroy(),delete e.units[i.id],e.curNum--,IS(w).monsterNum=e.curNum,0==e.curNum&&e.loadMonsterCfg(++e.curRound)),e.removeUIEffect(r)})).start()}))};for(var i in this.units)t(i)}},n.checkHitArea=function(){var e=this;if(this.owner)for(var t in this.units){var i=this.units[t];if(2==i.type)if(f.distance(i.position,this.owner.position)<S){for(var n in IS(w).gameState=0,this.units)if(this.units.hasOwnProperty(n)){var s=this.units[n];if(1==s.type)continue;s.destroy(),delete this.units[s.id]}m.showBoxTip({tip:GetLanguage(200982),notMaskClick:!0,func:function(t){"type_yes"==t?e.onAfterOpen():"type_cancel"==t&&e.view.close()}})}}},n.loadAllUnit=t().mark((function e(){var i,n,s,o,a,r,u;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t().keys(this.units);case 1:if((e.t1=e.t0()).done){e.next=11;break}if(i=e.t1.value,!this.units.hasOwnProperty(i)){e.next=9;break}if(1!=(n=this.units[i]).type){e.next=7;break}return e.abrupt("continue",1);case 7:n.destroy(),delete this.units[n.id];case 9:e.next=1;break;case 11:s=IS(w),o=s.monsters,e.t2=t().keys(o);case 14:if((e.t3=e.t2()).done){e.next=23;break}return a=e.t3.value,r=o[a],u=new N(this,r,r.monster_type),this.units[u.id]=u,e.next=21,coroutine.wait(_);case 21:e.next=14;break;case 23:case"end":return e.stop()}}),e,this)})),n._updateDepth=function(){var e=[];for(var t in this.units)this.units.hasOwnProperty(t)&&2==this.units[t].type&&e.push(this.units[t]);e.sort((function(e,t){var i=1,n=0,s=e.position.y-t.position.y;return(i-=100*s)-(n+=100*s)}));for(var i=0;i<e.length;++i){e[i].depth=i}},n.loadMonsterCfg=function(e){var t=this,n=IS(w),s=configTowerlevel.getDataByKey(e);if(n.monsters={},!s)return IS(w).gameState=0,void m.showBoxTip({tip:GetLanguage(200983),notMaskClick:!0,btnCnt:1,func:function(e){if("type_yes"==e){t.view.close();var i=IS(v).getRewardInfo(5);i&&2!=i.status&&IS(p).repTakeReward(5)}},ensure:GetLanguage(200129)});n.curRound=this.curRound;for(var o,a=1,r=0,u=i(s.num);!(o=u()).done;)for(var c=o.value,f=0;f<c[1];f++){var h=configTowermonster.getDataByKey(c[0]),d={monster_id:a,monster_type:c[0],pos:C[r],hp:h.hp,point:h.point};n.monsters[d.monster_id]=d,a++,r=(r+1)%4}this.maxNum=a-1,this.curNum=a-1,n.monsterNum=this.curNum,coroutine.start(this.loadAllUnit())},n.addUIEffect=function(e,t,i,n){var s,o=d.alloc(e,t,i,n);return this._uiEffects=null!=(s=this._uiEffects)?s:[],this._uiEffects.push(o),this._effectId++,o.id=this._effectId,this._effectId},n.removeUIEffect=function(e){if(null!=this._uiEffects)for(var t=0;t<this._uiEffects.length;t++){var i=this._uiEffects[t];if(i.id==e){i.free(),this._uiEffects.splice(t,1);break}}},e}());n._RF.pop()}}}));

