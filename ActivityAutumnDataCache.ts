System.register("chunks:///_virtual/ActivityAutumnDataCache.ts",["./rollupPluginModLoBabelHelpers.js","cc","./RedPointMgr.ts","./StorageUtil.ts","./TimeUtil.ts","./BaseView.ts","./BagDefine.ts","./BagModel.ts","./BattlePassControl.ts","./ChapterDefine.ts","./MessageView.ts","./LoginDefine.ts","./RoleDataCache.ts","./ActivityControl.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./ActivityAutumnDefine.ts"],(function(t){"use strict";var e,i,n,s,a,r,u,d,o,c,h,f,l,v,m,g,p,A,_,I;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy,n=t.js},function(t){s=t.RedPointMgr},function(t){a=t.default},function(t){r=t.default},function(t){u=t.ViewEvent},function(t){d=t.BagEventDefine},function(t){o=t.BagModel},function(t){c=t.default},function(t){h=t.ChapterEventDefine},function(t){f=t.default},function(t){l=t.LoginEventDefine},function(t){v=t.RoleDataCache},function(t){m=t.default},function(t){g=t.default},function(t){p=t.ActivityType,A=t.ActivityState,_=t.ActivityEventDefine},function(t){I=t.ActivityAutumnEventDefine}],execute:function(){i._RF.push({},"fd4d9JAKXZKUoBjcs++hfD9","ActivityAutumnDataCache",void 0);var y="openShotGuideRecord";t("default",function(){var t=i.prototype;function i(){this.viewList=void 0,this.cardList={},this.cardChatInfo={},this.rewardChatStatus=void 0,this.isReqCardChatInfo=!1,this.send_times=0,this.ask_times=0,this.recv_list=[],this.send_list=[],this.newCardMsgRed={},this.preOpenMsgTime={},this.curOpen=0,this.otherViewNum=0,this.isDungeon=void 0,this.riddlesList={},this.findInfo={total_reward:0,list:{}},this.pointGet=0,normalEvent.on(l.RECONNECT_NET_LINK,this.reconnet,this),normalEvent.on(_.OnActivityListUpdate,this.checkPop,this),normalEvent.on(_.OnActivityInfoUpdate,this.checkPop,this),normalEvent.on(_.OnActivityListUpdate,this.activityChange,this),normalEvent.on(_.OnActivityInfoUpdate,this.activityChange,this),normalEvent.on(u.ViewOpen,this.onViewOpen,this),normalEvent.on(u.ViewClose,this.onViewClose,this),normalEvent.on(h.BATTLE_STATE,this.onBattleState,this),normalEvent.on(_.OnActivityInfoTaskUpdate,this.checkTaskRed,this),normalEvent.on(d.GOODS_INFO_UPDATE,this.onBagUpdate,this),normalEvent.on(_.OnAutumnShotInfoBack,this.OnAutumnShotInfoBack,this),normalEvent.on(_.OnAutumnShotPointFetch,this.OnAutumnShotPointFetch,this)}return t.clear=function(){},t.reconnet=function(){this.isReqCardChatInfo=!1},t.checkTaskRed=function(){IS(s).changeValue("ActivityAutumnCardRed",this.GetCardRed())},t.checkPop=function(){var t=IS(g).GetActivityInfo(p.Autumn);if(t&&t.state==A.Open){var e,i=new Date(1e3*r.serverOpenTime),s=n.formatStr("#%s#%s#%s",i.getFullYear(),i.getMonth()+1,i.getDate()),u="ActivityAutumnPopView"+IS(v).GetRoleId();if((null!=(e=a.get(u))?e:"")==s)return;uiMgr.ViewIsAddPop("ActivityAutumnPopView")||(uiMgr.addPopView("ActivityAutumnPopView"),a.set(u,s))}},t.activityChange=function(t){if(void 0===t&&(t=null),!t||t.type==p.Autumn){var e=IS(g).GetActivityInfo(p.Autumn);e&&e.state==A.Open?this.sendProto():e&&e.state!=A.Null||(this.newCardMsgRed={})}},t.sendProto=function(){IS(m).send_24_58()},t.onViewOpen=function(t){if("ActivityAutumnFindIcon"!=t){var i=IS(g).GetActivityInfo(p.AutumnFind);if(i&&i.state==A.Open){if(!this.viewList){this.viewList={};for(var n,s=configMoonfestival_search.getDatas(),a=e(s);!(n=a()).done;){var r=n.value;r.type==i.type&&r.group_id==i.roundCfg.group_id&&(this.viewList[r.system_view]=r.id)}}var u=this.viewList[t];if(u&&u==this.getCurFind())this.curOpen=u,this.isDungeon||uiMgr.openView("ActivityAutumnFindIcon",u),this.otherViewNum=0;else if(0!=this.curOpen){var d=uiMgr.getOpenView("ActivityAutumnFindIcon");d&&d.close(),this.otherViewNum++}}}},t.onViewClose=function(t){if("ActivityAutumnFindIcon"!=t){var i=IS(g).GetActivityInfo(p.AutumnFind);if(i&&i.state==A.Open){if(!this.viewList){this.viewList={};for(var n,s=configMoonfestival_search.getDatas(),a=e(s);!(n=a()).done;){var r=n.value;r.type==i.type&&r.group_id==i.roundCfg.group_id&&(this.viewList[r.system_view]=r.id)}}var u=this.viewList[t];if(u&&u==this.getCurFind()){var d=uiMgr.getOpenView("ActivityAutumnFindIcon");d&&d.close(),this.curOpen=0,this.otherViewNum=0}else 0!=this.curOpen&&(this.otherViewNum--,0!=this.otherViewNum||this.isDungeon||uiMgr.openView("ActivityAutumnFindIcon",this.curOpen))}}},t.onBattleState=function(t,e){var i=IS(g).GetActivityInfo(p.AutumnFind);if(i&&i.state==A.Open)if(e){this.isDungeon=!0;var n=uiMgr.getOpenView("ActivityAutumnFindIcon");n&&n.close()}else this.isDungeon=!1,0!=this.curOpen&&0==this.otherViewNum&&uiMgr.openView("ActivityAutumnFindIcon",this.curOpen)},t.onBagUpdate=function(t,e){1042==e&&(IS(g).UpdateMainRedByActType(p.AutumnPass),IS(s).changeValue("autumn_pass",IS(i).getPassRedNum())),1043!=e&&1051!=e||(IS(g).UpdateMainRedByActType(p.AutumnGame),IS(s).changeValue("autumn_game",IS(i).getGameRed()))},t.OnAutumnShotInfoBack=function(){IS(g).UpdateMainRedByActType(p.AutumnGame),IS(s).changeValue("autumn_game",IS(i).getGameRed())},t.OnAutumnShotPointFetch=function(){IS(g).UpdateMainRedByActType(p.AutumnGame),IS(s).changeValue("autumn_game",IS(i).getGameRed())},t.updateRiddlesList=function(t){this.riddlesList={};for(var i,n=e(t.guess_info);!(i=n()).done;){var s=i.value;this.riddlesList[s.id]=s}normalEvent.emit(_.OnAutumnRiddlesUpdate),IS(g).UpdateMainRedByActType(p.AutumnRiddles)},t.updateRiddles=function(t){this.riddlesList[t.guess_info.id]=t.guess_info,normalEvent.emit(_.OnAutumnRiddlesUpdate),IS(g).UpdateMainRedByActType(p.AutumnRiddles)},t.updateFindList=function(t){this.findInfo.total_reward=t.total_reward_type,this.findInfo.list={};for(var i,n=e(t.pig_info);!(i=n()).done;){var s=i.value;this.findInfo.list[s.id]=s.state}normalEvent.emit(_.OnAutumnFindUpdate),IS(g).UpdateMainRedByActType(p.AutumnFind)},t.updateFind=function(t){if(0==t.pig_id)this.findInfo.total_reward=1;else if(this.findInfo.list[t.pig_id]=2,t.pig_id==this.curOpen){this.curOpen=0;var e=uiMgr.getOpenView("ActivityAutumnFindIcon");e&&e.close()}normalEvent.emit(_.OnAutumnFindUpdate),IS(g).UpdateMainRedByActType(p.AutumnFind)},t.getRiddlesList=function(){return this.riddlesList},t.getFindInfo=function(){return this.findInfo},t.getCurFind=function(){var t=[];for(var e in this.findInfo.list)if(this.findInfo.list.hasOwnProperty(e)){var i=this.findInfo.list[e];t.push({id:e,state:i})}t.sort((function(t,e){var i=configMoonfestival_search.getDataByKey(t.id),n=configMoonfestival_search.getDataByKey(e.id);return i.rank_num-n.rank_num}));for(var n=0,s=t;n<s.length;n++){var a=s[n];if(1==a.state)return a.id}return 0},t.UpdateCardInfo=function(t){this.send_times=t.send_times,this.ask_times=t.ask_times,this.recv_list=[],this.send_list=[],t.recv_list&&t.recv_list.length>0&&(this.recv_list=t.recv_list,this.recv_list.sort((function(t,e){return t.start_time<e.start_time?-1:1}))),t.send_list&&t.send_list.length>0&&(this.send_list=t.send_list,this.send_list.sort((function(t,e){return t.start_time<e.start_time?-1:1}))),this.UpdateNewMsgRed(),normalEvent.emit(I.UpdateActCardInfo)},t.UpdateCardTimes=function(t,e){1==e&&(this.send_times>0&&t.send_times<this.send_times&&f.showFlyTip(GetLanguage(200752)),this.send_times=t.send_times),2==e&&(this.ask_times>0&&t.ask_times<this.ask_times&&f.showFlyTip(GetLanguage(200775)),this.ask_times=t.ask_times),normalEvent.emit(I.UpdateActCardInfo)},t.UpdateCardMsg=function(t){if(0==t.type){var e=this.recv_list.findIndex((function(e){return e.id==t.card_msg.id}));e>=0?this.recv_list[e]=t.card_msg:this.recv_list.push(t.card_msg)}else{var i=this.send_list.findIndex((function(e){return e.id==t.card_msg.id}));i>=0?this.send_list[i]=t.card_msg:this.send_list.push(t.card_msg)}this.UpdateNewMsgRed(),normalEvent.emit(I.UpdateActCardInfo)},t.UpdateCardSearch=function(t){t.role_list&&t.role_list.length>0?normalEvent.emit(I.UpdateActCardSearchRoleInfo,t.role_list):f.showFlyTip(GetLanguage(200025))},t.GetCardMsgList=function(t){return 0==t?this.recv_list:this.send_list},t.UpdateNewMsgRed=function(){var t,e,i,n=uiMgr.getOpenView("ActivityAutumnCardMsgView"),r=IS(v).GetRoleId();if(this.newCardMsgRed[1]=0,!(i=this.preOpenMsgTime[1])){var u,d="ActivityAutumnCardMsgCheck_1_"+r;i=null!=(u=a.get(d))?u:0,this.preOpenMsgTime[1]=i}for(var o=0;o<this.send_list.length;o++){var c=this.send_list[o];if((!n||1!=n.curIndex)&&c.start_time>i){this.newCardMsgRed[1]=1;break}}if(this.newCardMsgRed[0]=0,!(i=this.preOpenMsgTime[0])){var h,f="ActivityAutumnCardMsgCheck_0_"+r;i=null!=(h=a.get(f))?h:0,this.preOpenMsgTime[0]=i}for(var l=0;l<this.recv_list.length;l++){var m=this.recv_list[l];if((!n||0!=n.curIndex)&&(m.start_time>i||0==m.state)){this.newCardMsgRed[0]=1;break}}IS(s).changeValue("ActivityAutumnCardMsgCheck_0",null!=(t=this.newCardMsgRed[0])?t:0),IS(s).changeValue("ActivityAutumnCardMsgCheck_1",null!=(e=this.newCardMsgRed[1])?e:0),IS(s).changeValue("ActivityAutumnCardMsgCheck",this.GetNewCardMsgRed()),IS(s).changeValue("ActivityAutumnCardRed",this.GetCardRed()),IS(g).UpdateMainRedByActType(p.AutumnCard)},t.GetNewCardMsgRed=function(){return 1==this.newCardMsgRed[0]||1==this.newCardMsgRed[1]?1:0},t.CheckNewMsgRed=function(t){var e="ActivityAutumnCardMsgCheck_"+t+"_"+IS(v).GetRoleId();a.set(e,r.serverTime),this.preOpenMsgTime[t]=r.serverTime,this.newCardMsgRed[t]&&this.newCardMsgRed[t]>0&&this.UpdateNewMsgRed()},t.UpdateCardRewardChatState=function(t,e){if(1==e){this.cardChatInfo={};for(var i=0;i<t.status_list.length;i++){var n=t.status_list[i];this.cardChatInfo[n.k]=n.v}}else this.cardChatInfo[t.chat_status.k]=t.chat_status.v;normalEvent.emit(I.UpdateCardChatInfo)},t.GetCardRewardChatState=function(t){return this.cardChatInfo[t]},t.GetCardRed=function(){var t=IS(g).GetTaskRedNum(p.AutumnCard);return t+=this.GetNewCardMsgRed()},t.isAllFind=function(){var t=IS(g).GetActivityInfo(p.AutumnFind);if(!t)return!1;for(var i,n=configMoonfestival_search.getDatas(),s=e(n);!(i=s()).done;){var a,r=i.value;if(r.type==t.type&&r.group_id==t.roundCfg.group_id)if(2!=(null!=(a=this.findInfo.list[r.id])?a:0))return!1}return!0},t.getPassRedNum=function(){var t,e=IS(g).GetActivityInfo(p.AutumnPass);if(!e||e.state!=A.Open)return 0;var i=e.roundCfg.group_id;return t=(t=t+c.checkRewardRP(i)>=0?1:0)+c.checkAddRewardRP(i)>0?1:0,t+=c.checkSpecialRewardRP(i),IS(o).getGoodsCountByGoodsGtid(1042)>0&&t++,t},t.GetGiftRed=function(){var t=IS(g).GetActivityInfo(p.AutumnGift);if(t){var e,i=String(t.id)+"#"+String(t.round),n="ActivityAutumnGiftRed"+IS(v).GetRoleId();return(null!=(e=a.get(n))?e:"")==i?0:1}return 0},t.getRiddlesRedNum=function(){var t=IS(g).GetActivityInfo(p.AutumnRiddles);if(!t||t.state!=A.Open)return 0;for(var e in this.riddlesList){if(this.riddlesList.hasOwnProperty(e))if(1==this.riddlesList[e].state)return 1}return 0},t.getFindRedNum=function(){var t=IS(g).GetActivityInfo(p.AutumnFind);if(!t||t.state!=A.Open)return 0;var e=this.findInfo.list;for(var i in e){if(e.hasOwnProperty(i))if(1==e[i])return 1}return 0==this.findInfo.total_reward&&this.isAllFind()?1:0},t.getGameRed=function(){return this.getGameVitalityFetchRed()+this.getGameCanShotRed()},t.getGameVitalityFetchRed=function(){var t=IS(g).GetActivityInfo(p.AutumnGame);return t&&t.state==A.Open&&1==this.pointGet?1:0},t.getGameCanShotRed=function(){var t=IS(g).GetActivityInfo(p.AutumnGame);return t&&t.state==A.Open&&IS(o).getGoodsCountByGoodsGtid(1043)+IS(o).getGoodsCountByGoodsGtid(1051)>0?1:0},t.checkHasOpenGuide=function(){var t=a.get(y);return null!=t&&""!=t},t.setOpenGuide=function(){a.set(y,1)},i}());i._RF.pop()}}}));

