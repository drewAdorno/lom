System.register("chunks:///_virtual/ActivityReverseDataCache.ts",["./rollupPluginModLoBabelHelpers.js","cc","./RedPointMgr.ts","./StorageUtil.ts","./TimeUtil.ts","./ObjectUtil.ts","./AdDefine.ts","./RoleDataCache.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./ActivityReverseControl.ts"],(function(e){"use strict";var t,i,r,n,s,a,o,d,u,v,f,l,c,R,h;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy,r=e.js},function(e){n=e.RedPointMgr},function(e){s=e.default},function(e){a=e.default},function(e){o=e.default},function(e){d=e.ADS_TYPE,u=e.AdEventDefine},function(e){v=e.RoleDataCache},function(e){f=e.default},function(e){l=e.ActivityType,c=e.ActivityState,R=e.ActivityEventDefine},function(e){h=e.default}],execute:function(){i._RF.push({},"8bb46ZFWOtOxKtippCheLHS","ActivityReverseDataCache",void 0);e("default",function(){var e=i.prototype;function i(){this.info={chapter_list:[],monster_list:[],equip_list:[],day_rewards:[],star_list:[0],reward_time:-1},this.timerGroup=void 0,this.timeRewardRed=0,this.shopRed=0,this.dungeonRed=0,normalEvent.on(R.OnActivityListUpdate,this.activityChange,this),normalEvent.on(R.OnActivityInfoUpdate,this.activityChange,this),normalEvent.on(u.AD_INFO_UPDATE,this.checkShopRed,this)}return e.clear=function(){},e.activityChange=function(e){if(void 0===e&&(e=null),!e||e.type==l.Reverse){var t=IS(f).GetActivityInfo(l.Reverse);t&&t.state==c.Open?(this.checkShopRed(),this.checkDungeonRed(),IS(h).send_24_110()):t&&t.state!=c.Null||(this.shopRed=0,this.dungeonRed=0)}},e.updateInfo=function(e){this.info.chapter_list=[];for(var i,r=t(null!=(n=e.chapter_list)?n:[]);!(i=r()).done;){var n,s=i.value;this.info.chapter_list[s.k]=s.v}this.info.monster_list=[];for(var a,o=t(null!=(d=e.monster_list)?d:[]);!(a=o()).done;){var d,u=a.value;this.info.monster_list[u.k]=u.v}this.info.equip_list=[];for(var v,f=t(null!=(l=e.equip_list)?l:[]);!(v=f()).done;){var l,c=v.value;this.info.equip_list[c.k]=c.v}this.info.day_rewards=[];for(var h,p=t(null!=(y=e.day_rewards)?y:[]);!(h=p()).done;){var y,_=h.value;this.info.day_rewards[_.k]=_.v}this.info.star_list=[];for(var g,m=t(null!=(S=e.star_list)?S:[]);!(g=m()).done;){var S,I=g.value;this.info.star_list[I.k]=I.v}this.info.reward_time=e.reward_time,this.refreshSupplyRed(),this.checkRewardRed(),normalEvent.emit(R.OnActivityReverseUpdate)},e.updateChapter=function(e){var t,i=null!=(t=this.info.chapter_list[e.update_info.k])?t:0;this.info.chapter_list[e.update_info.k]=Math.max(e.update_info.v,i),this.info.star_list[e.update_star.k]=e.update_star.v,this.checkRewardRed(),normalEvent.emit(R.OnActivityReverseUpdate)},e.updateMonster=function(e){this.info.monster_list[e.update_info.k]=e.update_info.v,normalEvent.emit(R.OnActivityReverseUpdate)},e.updateEquip=function(e){this.info.equip_list=[];for(var i,r=t(null!=(n=e.equip_list)?n:[]);!(i=r()).done;){var n,s=i.value;this.info.equip_list[s.k]=s.v}normalEvent.emit(R.OnActivityReverseUpdate)},e.updateReward=function(e){this.info.day_rewards[e.update_info.k]=e.update_info.v,this.checkRewardRed(),normalEvent.emit(R.OnActivityReverseUpdate)},e.updateTimeReward=function(e){this.info.reward_time=e.reward_time,this.refreshSupplyRed(),normalEvent.emit(R.OnActivityReverseUpdate)},e.refreshSupplyRed=function(){var e=this;this.timerGroup&&(normalTimer.stop(this.timerGroup),this.timerGroup=null),this.timeRewardRed=0;var t=IS(f).GetActivityInfo(l.Reverse);t&&t.state==c.Open&&(-1!=this.info.reward_time&&this.info.reward_time-a.serverTime>0?this.timerGroup=normalTimer.start(this.info.reward_time-a.serverTime,1,(function(){e.info.reward_time-a.serverTime<=0&&(normalTimer.stop(e.timerGroup),e.timerGroup=null,e.refreshSupplyRed())})):this.timeRewardRed=1),IS(n).changeValue("ActReverseSupply",this.getSupplyRed()),IS(f).UpdateMainRedByActType(l.Reverse)},e.getInfo=function(){return this.info},e.getMonsterList=function(){var e=this,t=this.getOpenDay(),i=configReversion_war_chess.getDatas(),r=o.copyArray(i);return r.sort((function(i,r){var n=2;1==e.info.monster_list[i.id]?n=1:i.unlock_day-t>0&&(n=3);var s=2;return 1==e.info.monster_list[r.id]?s=1:r.unlock_day-t>0&&(s=3),n!=s?n-s:3==n&&i.unlock_day!=r.unlock_day?i.unlock_day-r.unlock_day:i.quality!=r.quality?r.quality-i.quality:i.id-r.id})),r},e.getOpenDay=function(){var e=IS(f).GetActivityInfo(l.Reverse);if(!e)return 0;var t=a.ServerDate(1e3*e.state_time[c.Open].start_time),i=r.formatStr("%s/%s/%s %s:%s:%s",t.getFullYear(),t.getMonth()+1,t.getDate(),0,0,0),n=a.getServerDateByLocalStr(i).getTime()/1e3,s=a.serverTime-n;return Math.floor(s/86400+1)},e.monsterEquipPos=function(e){for(var t in this.info.equip_list){if(this.info.equip_list.hasOwnProperty(t))if(this.info.equip_list[t]==e)return t}return null},e.getEmptyPos=function(){for(var e=1;e<=10;e++)if(!this.info.equip_list[e])return e;return null},e.getRewardSche=function(e){for(var i,r=configReversion_war_reward.getDatas(),n=[],s=t(r);!(i=s()).done;){var a=i.value;a.day==e&&n.push(a)}n.sort((function(e,t){return e.star_num-t.star_num}));for(var o=0,d=0;d<n.length;d++){var u,v=n[d];(null!=(u=this.info.day_rewards[v.id])?u:0)&&(o=v.star_num)}return o=o==n[n.length-1].star_num?o:o+1},e.getRedNum=function(){var e=IS(f).GetActivityInfo(l.Reverse);if(!e||e.state!=c.Open)return 0;var t=0;return t+=this.getSupplyRed(),t+=this.getShopRed(),t+=this.getDungeonRed(),t+=this.getMonsterRed(),t+=this.getRewardRed()},e.getShopRed=function(){return this.shopRed},e.getSupplyRed=function(){return this.timeRewardRed},e.getDungeonRed=function(){return this.dungeonRed},e.checkRewardRed=function(){var e=this,i=IS(f).GetActivityInfo(l.Reverse);if(i&&i.state==c.Open){for(var r,a=IS(v).GetRoleId(),o=i.round+"ActivityReverseRewardRedList"+a,d=i.round+"ActivityReverseRewardRedInfo"+a,u=s.get(o,!0),R=s.get(d,!0),h="object"==typeof u?u:[],p="object"==typeof R?R:[],y=configReversion_war_reward.getDatas(),_=[],g=[],m=t(y);!(r=m()).done;){var S=r.value;g[S.day]||(_.push(S.day),g[S.day]=!0)}for(var I=function(){var t,i,r=A[w],n=Number(r),s=null!=(t=p[n])?t:0,a=e.getRewardSche(n),o=null!=(i=e.info.star_list[n])?i:0;if(s){var d=configReversion_war_reward.getDataByKey(s);if(a!=d.star_num){var u,v=y.find((function(e){return e.day==n&&e.star_num==a})),f=null!=(u=e.info.day_rewards[v.id])?u:0,l=o>=v.star_num;p[n]=v.id,h[n]=!(!l||f)||null}else{var c,R=null!=(c=e.info.day_rewards[d.id])?c:0,_=o>=d.star_num,g=h[n];null==g?_&&!R&&(h[n]=!0):0==g||R&&(h[n]=null)}}else{var m,S=y.find((function(e){return e.day==n&&e.star_num==a})),I=null!=(m=e.info.day_rewards[S.id])?m:0,D=o>=S.star_num;p[n]=S.id,h[n]=!(!D||I)||null}},w=0,A=_;w<A.length;w++)I();s.set(o,h),s.set(d,p),IS(n).changeValue("ActReverseRewrad",this.getRewardRed()),IS(f).UpdateMainRedByActType(l.Reverse)}},e.getRewardRed=function(e){var t=IS(f).GetActivityInfo(l.Reverse);if(!t||t.state!=c.Open)return 0;var i=IS(v).GetRoleId(),r=t.round+"ActivityReverseRewardRedList"+i,n=s.get(r,!0),a="object"==typeof n?n:[];if(e)return a[e]?1:0;for(var o in a){if(a.hasOwnProperty(o))if(a[o])return 1}return 0},e.setRewardRed=function(e){var t,i=IS(f).GetActivityInfo(l.Reverse);if(i&&i.state==c.Open){var r,a=IS(v).GetRoleId(),o=i.round+"ActivityReverseRewardRedList"+a,d=i.round+"ActivityReverseRewardRedInfo"+a,u=s.get(o,!0),R="object"==typeof u?u:[],h=s.get(d,!0),p="object"==typeof h?h:[],y=null!=(t=p[e])?t:0,_=R[e];if(y&&_)0!=configReversion_war_reward.getDataByKey(y).get_way.length&&(R[e]=!1,r=!0);r&&(s.set(o,R),s.set(d,p),IS(n).changeValue("ActReverseRewrad",this.getRewardRed()),IS(f).UpdateMainRedByActType(l.Reverse))}},e.getMonsterRed=function(){var e=IS(f).GetActivityInfo(l.Reverse);if(!e||e.state!=c.Open)return 0;var t=IS(v).GetRoleId(),i=e.round+"ActivityReverseMonsterRed"+t,r=s.get(i,!0),n="object"==typeof r?r:[];for(var a in this.info.monster_list)if(this.info.monster_list.hasOwnProperty(a)){var o=Number(a),d=configReversion_war_chess.getDataByKey(o),u=this.info.monster_list[a];if(0==d.spend.length&&1==u&&!n[d.unlock_day])return 1}return 0},e.setMonsterRed=function(){var e=IS(f).GetActivityInfo(l.Reverse);if(e&&e.state==c.Open){var t=IS(v).GetRoleId(),i=e.round+"ActivityReverseMonsterRed"+t,r=[];for(var a in this.info.monster_list)if(this.info.monster_list.hasOwnProperty(a)){var o=Number(a),d=configReversion_war_chess.getDataByKey(o),u=this.info.monster_list[a];0==d.spend.length&&1==u&&(r[d.unlock_day]=!0)}s.set(i,r),IS(n).changeValue("ActReverseMonster",this.getMonsterRed()),IS(f).UpdateMainRedByActType(l.Reverse)}},e.checkDungeonRed=function(){var e=IS(f).GetActivityInfo(l.Reverse);if(e&&e.state==c.Open){var t,i=new Date(1e3*a.serverTime),o=r.formatStr("#%s#%s#%s",i.getFullYear(),i.getMonth()+1,i.getDate()),d="ActivityReverseDungeonRed"+IS(v).GetRoleId(),u=null!=(t=s.get(d))?t:"";this.dungeonRed=u==o?0:1,IS(n).changeValue("ActReverseDungeon",this.dungeonRed+ +IS(f).GetTaskRedNum(l.Reverse)),IS(f).UpdateMainRedByActType(l.Reverse)}},e.setDungeonRed=function(){if(1==this.dungeonRed){this.dungeonRed=0;var e=new Date(1e3*a.serverTime),t=r.formatStr("#%s#%s#%s",e.getFullYear(),e.getMonth()+1,e.getDate()),i="ActivityReverseDungeonRed"+IS(v).GetRoleId();s.set(i,t),IS(n).changeValue("ActReverseDungeon",this.dungeonRed+IS(f).GetTaskRedNum(l.Reverse)),IS(f).UpdateMainRedByActType(l.Reverse)}},e.checkShopRed=function(e){var t;if(void 0===e&&(e=null),!e||e==d.AD_REVERSION_WAR_reward){this.shopRed=0;var i=new Date(1e3*a.serverTime),o=r.formatStr("#%s#%s#%s",i.getFullYear(),i.getMonth()+1,i.getDate()),u="ActivityReverseGiftRed"+IS(v).GetRoleId(),R=null!=(t=s.get(u))?t:"",h=IS(f).GetActivityInfo(l.Reverse);R!=o&&h&&h.state==c.Open&&(this.shopRed=1),IS(n).changeValue("ActReverseGift",this.shopRed),IS(f).UpdateMainRedByActType(l.Reverse)}},e.setShopRed=function(){if(1==this.shopRed){this.shopRed=0;var e=new Date(1e3*a.serverTime),t=r.formatStr("#%s#%s#%s",e.getFullYear(),e.getMonth()+1,e.getDate()),i="ActivityReverseGiftRed"+IS(v).GetRoleId();s.set(i,t),IS(n).changeValue("ActReverseGift",this.shopRed),IS(f).UpdateMainRedByActType(l.Reverse)}},i}());i._RF.pop()}}}));

