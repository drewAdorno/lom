System.register("chunks:///_virtual/ActivityMiningGameView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./V2.ts","./AudioMgr.ts","./NodeUtil.ts","./StringUtil.ts","./index57.ts","./ItemIcon.ts","./SpineSkeleton.ts","./BattlePassDataCache.ts","./MessageView.ts","./ActivityControl.ts","./ActivityDefine.ts","./ActivityMiningDataCache.ts","./BaseView.ts"],(function(t){"use strict";var i,e,n,o,s,h,a,r,l,d,f,c,m,u,p,g,v,C,I,x,b,y,A,S,w,M,B;return{setters:[function(t){i=t.inheritsLoose},function(t){e=t.cclegacy,n=t.Button,o=t.Widget,s=t.Sprite,h=t.Label,a=t.UITransform,r=t.Vec3,l=t.js,d=t.RigidBody2D,f=t.BoxCollider2D,c=t.ProgressBar,m=t.Vec2,u=t.Contact2DType,p=t.Node},function(t){g=t.V2},function(t){v=t.audioMgr},function(t){C=t.default},function(t){I=t.default},null,function(t){x=t.IconAseetType},function(t){b=t.SpineSkeleton},function(t){y=t.BattlePassDataCache},function(t){A=t.default},function(t){S=t.default},function(t){w=t.ActivityEventDefine},function(t){M=t.default},function(t){B=t.BaseView}],execute:function(){e._RF.push({},"a284bziG8tLRIXhm+JNHlHX","ActivityMiningGameView",void 0);var k=130,L=30,_=21;t("default",function(t){function e(){var i;return(i=t.call(this)||this).levelId=void 0,i.chapterData=void 0,i.levelRound=void 0,i.loadRound=void 0,i.lastLoadRound=void 0,i.finishGroup=void 0,i.giftGetList={},i.shovel_list=void 0,i.axeMaxRow=void 0,i.mainGroupId=0,i.levelData=null,i.pickAxeRowList={},i.pickAxeItem={},i.oreItem={},i.endItem={},i.endBossItem={},i.boss=null,i.hasBoss=!1,i.bossName=void 0,i.coinCount=0,i.giftCount=0,i.roundGiftCount=0,i.roundCoinCount=0,i.lowBuyLevel=0,i.buyPrice=0,i.endBoxList=[],i.endCount=[],i.endFinish=99,i.time=0,i.lowY=0,i.movInter=void 0,i.isMining=void 0,i.isTouching=!1,i.isReplay=!1,i.needReStart=!1,i.bossNeedFresh=!0,i.btnMining=void 0,i.btnMiningWidget=void 0,i.btnBuyAxe=void 0,i.btnBuyAxeWidget=void 0,i.buyImg=void 0,i.buyCost=void 0,i.mapbgGo=void 0,i.mapSizeBg=void 0,i.mapbglist={},i.txtCoin=void 0,i.txtGift=void 0,i.txtTitile=void 0,i.txtChapter=void 0,i.needFinish=void 0,i.txtMention=void 0,i.getFinish=void 0,i.getFinishBox=void 0,i.getFinishCoin=void 0,i.getDone=void 0,i.getDoneBox=void 0,i.getDoneCoin=void 0,i.getInherit=void 0,i.getInheritBox=void 0,i.getInheritCoin=void 0,i.getFail=void 0,i.getFailBox=void 0,i.getFailCoin=void 0,i.txtFailMention=void 0,i.finish=void 0,i.btnGoNext=void 0,i.fail=void 0,i.btnContinue=void 0,i.isInherit=void 0,i.btnInherit=void 0,i.btnOut=void 0,i.isDone=void 0,i.bossEffectID=0,i.bossSpine=void 0,i.BossIDSel=void 0,i.recycle=void 0,i.recycleWidget=void 0,i.recycleGo=void 0,i.noMining=void 0,i.bgUp=void 0,i.btnGuild=void 0,i.firstMention=void 0,i.name="ActivityMiningGameView",i.url="ui/module/mining/ActivityMiningGameView",i}i(e,t);var B=e.prototype;return B.onInit=function(){var t=this,i=this.findChild("bottom/btnClose");this.addComponentCallbackListener(i,n.EventType.CLICK,(function(){if(t.isMining||t.isTouching)t.isMining&&A.showFlyTip(GetLanguage(300684));else{var i=I.formatStrWithMirrorDeal(GetLanguage(300685));A.showBoxTip({tip:i,title:GetLanguage(200048),func:function(i){"type_yes"==i&&t.close()}})}}));var e=this.findChild("isDone/btnDone");this.addComponentCallbackListener(e,n.EventType.CLICK,(function(){t.isMining||t.isTouching||(t.isDone.active=!1,t.close())}));var r=this.findChild("map/bg/sizebg/recycle");this.addComponentCallbackListener(r,n.EventType.CLICK,(function(){A.showFlyTip(GetLanguage(300683))})),this.btnMining=this.findChild("map/bg/sizebg/miningBtn"),this.btnMiningWidget=this.findChildComponent("map/bg/sizebg/miningBtn",o),this.addComponentCallbackListener(this.btnMining,n.EventType.CLICK,(function(){if(!t.isMining&&!t.isTouching){clearInterval(t.movInter);for(var i=!1,e=0;e<4;e++)for(var n=0;n<5;n++)e<t.axeMaxRow&&null!=t.pickAxeItem[e][n]&&0!=t.pickAxeItem[e][n].level&&(i=!0);i?t.StartMining():A.showFlyTip(GetLanguage(201655))}})),this.buyImg=this.findChildComponent("map/bg/sizebg/buyAxeBtn/buyImg",s),this.buyCost=this.findChildComponent("map/bg/sizebg/buyAxeBtn/cost",h),this.btnBuyAxe=this.findChild("map/bg/sizebg/buyAxeBtn"),this.btnBuyAxeWidget=this.findChildComponent("map/bg/sizebg/buyAxeBtn",o),this.addComponentCallbackListener(this.btnBuyAxe,n.EventType.CLICK,(function(){t.isMining||(t.buyPrice<=t.coinCount?t.BuyAxe():A.showFlyTip(GetLanguage(201650)))})),this.mapbgGo=this.findChild("map/bg"),this.mapSizeBg=this.findChildComponent("map/bg/sizebg",a),this.txtCoin=this.findChildComponent("top/coinGet",h),this.txtGift=this.findChildComponent("top/giftGet",h),this.txtChapter=this.findChildComponent("top/title/txtChapter",h),this.txtTitile=this.findChildComponent("top/title/txtTitle",h),this.needFinish=this.findChildComponent("top/needFinish",h),this.txtMention=this.findChildComponent("top/box/txtMention",h);var l=this.findChild("top/box");this.addComponentCallbackListener(l,n.EventType.CLICK,(function(){A.showFlyTip(I.formatStrWithMirrorDeal(GetLanguage(300667),t.endFinish))})),this.firstMention=this.findChild("top/firstMention"),this.getFinish=this.findChildComponent("finish/getFinish",h),this.getFinishBox=this.findChildComponent("finish/getFinishBox",h),this.getFinishCoin=this.findChildComponent("finish/getFinishCoin",h),this.getDone=this.findChildComponent("isDone/getDone",h),this.getInherit=this.findChildComponent("isInherit/getInherit",h),this.getFail=this.findChildComponent("fail/getFail",h),this.getFailBox=this.findChildComponent("fail/getFailBox",h),this.getFailCoin=this.findChildComponent("fail/getFailCoin",h),this.txtFailMention=this.findChildComponent("fail/txtFailMention",h);for(var d=0;d<4;d++)this.pickAxeRowList[d]=this.findChild("map/0/"+d),this.mapbglist[d]=this.findChild("map/bg/"+d);this.finish=this.findChild("finish"),this.btnGoNext=this.findChild("finish/btnGoNext"),this.addComponentCallbackListener(this.btnGoNext,n.EventType.CLICK,(function(){t.chapterData=IS(M).getChapterData()[t.levelId],t.levelRound=t.chapterData.round,t.loadRound=t.levelRound+1,t.UpdateMiningData(),t.btnMining.active=!0,t.btnBuyAxe.active=!0,t.recycleGo.active=!0,t.isMining=!1,t.noMining.active=!0,t.isTouching=!1,t.finish.active=!1,t.fail.active=!1})),this.fail=this.findChild("fail"),this.btnContinue=this.findChild("fail/btnContinue"),this.addComponentCallbackListener(this.btnContinue,n.EventType.CLICK,(function(){t.finish.active=!1,t.fail.active=!1,t.needReStart=!0,IS(S).send_24_127(t.levelId,t.loadRound,0,t.coinCount,t.giftCount,t.shovel_list)})),this.isInherit=this.findChild("isInherit"),this.getInheritBox=this.findChildComponent("isInherit/getInheritBox",h),this.getInheritCoin=this.findChildComponent("isInherit/getInheritCoin",h),this.btnInherit=this.findChild("isInherit/btnInherit"),this.addComponentCallbackListener(this.btnInherit,n.EventType.CLICK,(function(){IS(S).send_24_128(t.levelId),t.isInherit.active=!1,t.close()})),this.btnOut=this.findChild("isInherit/btnOut"),this.addComponentCallbackListener(this.btnOut,n.EventType.CLICK,(function(){t.isMining||t.isTouching||(t.isInherit.active=!1,t.close())})),this.isDone=this.findChild("isDone"),this.getDone=this.findChildComponent("isDone/getDone",h),this.getDoneBox=this.findChildComponent("isDone/getDoneBox",h),this.getDoneCoin=this.findChildComponent("isDone/getDoneCoin",h),this.recycle=this.findChildComponent("map/bg/sizebg/recycle",a),this.recycleWidget=this.findChildComponent("map/bg/sizebg/recycle",o),this.recycleGo=this.findChild("map/bg/sizebg/recycle"),this.noMining=this.findChild("map/noMining"),this.bgUp=this.findChildComponent("bgUp",a),this.btnGuild=this.findChild("bottom/btnGuild"),this.addComponentCallbackListener(this.btnGuild,n.EventType.CLICK,(function(){uiMgr.openView("ActivityMiningGuideView")})),this.InitPickAxe(),this.InitOre(),this.InitEnd()},B.onTouchStart=function(t,i){var e=t.getUILocation(),n=new r(e.x,e.y,0),o=i.node.getComponent(a).convertToNodeSpaceAR(n);this.isTouching=!0,i.node.position=new r(i.node.position.x+o.x,i.node.position.y+o.y,0)},B.onTouchMove=function(t,i){if(this.isTouching){var e=t.getUILocation(),n=new r(e.x,e.y,0),o=i.node.getComponent(a).convertToNodeSpaceAR(n);i.node.position=new r(i.node.position.x+o.x,i.node.position.y+o.y,0)}},B.onTouchEnd=function(t,i){if(this.isTouching){this.isTouching=!1;var e=t.getUILocation(),n=new r(e.x,e.y,0),o=k*(i.id-2);i.node.position=new r(o,0,0);var s=this.recycle.convertToNodeSpaceAR(n);if(Math.abs(s.x)<50&&Math.abs(s.y)<50){var h=configMining_item.getDataByKey(i.level);if(i.isGift)A.showFlyTip(GetLanguage(201654));else{if(v.playSound("msqql_hecheng"),this.RemoveShovelList(i.row,i.id),this.RefreshAxeFormation(i.row,i.id),this.coinCount=this.coinCount+h.price,this.txtCoin.string=l.formatStr("x %s",this.coinCount),this.giftCount>0)for(var d=0;d<4;d++)for(var f=0;f<5&&!(this.giftCount<=0);f++)if(d<this.axeMaxRow&&null!=this.pickAxeItem[d][f]&&0==this.pickAxeItem[d][f].level&&this.giftCount>0){var c=configMining_item.getDataByKey(_);this.AddAxe(d,f,c),this.AddShovelList(_,d,f),this.giftCount=this.giftCount-1}this.txtGift.string=l.formatStr("x %s",this.giftCount)}}else{var m=i.node.getComponent(a).convertToNodeSpaceAR(n),u=-1,p=-1;if(p=Math.abs(m.x)<65?i.id:m.x>0?i.id+Math.ceil(Math.abs(m.x)/k-.5):i.id-Math.ceil(Math.abs(m.x)/k-.5),u=Math.abs(m.y)<65?i.row:m.y<0?i.row+Math.ceil(Math.abs(m.y)/k-.5):i.row-Math.ceil(Math.abs(m.y)/k-.5),p==i.id&&u==i.row);else if(u<this.axeMaxRow&&null!=this.pickAxeItem[u]&&null!=this.pickAxeItem[u][p])if(this.pickAxeItem[u][p].level==i.level)if(i.level+1<=20){this.RefreshAxeFormation(u,p);var C=configMining_item.getDataByKey(i.level+1);if(this.AddAxe(u,p,C),this.pickAxeItem[u][p].eff&&(this.removeUIEffect(this.pickAxeItem[u][p].eff),this.pickAxeItem[u][p].eff=null),this.pickAxeItem[u][p].eff=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_hecheng"),this.pickAxeItem[u][p].node,-1,new g(0,0),1),this.RemoveShovelList(u,p),this.RemoveShovelList(i.row,i.id),this.AddShovelList(i.level+1,u,p),this.RefreshAxeFormation(i.row,i.id),v.playSound("msqql_hecheng"),this.giftCount>0)for(var I=0;I<4;I++)for(var x=0;x<5&&!(this.giftCount<=0);x++)if(I<this.axeMaxRow&&null!=this.pickAxeItem[I][x]&&0==this.pickAxeItem[I][x].level&&this.giftCount>0){var b=configMining_item.getDataByKey(_);this.AddAxe(I,x,b),this.AddShovelList(_,I,x),this.giftCount=this.giftCount-1}this.txtGift.string=l.formatStr("x %s",this.giftCount)}else{var y=this.pickAxeItem[u][p].level,S=i.level,w=i.row,M=i.id;this.RemoveShovelList(i.row,i.id),this.RemoveShovelList(u,p),this.RefreshAxeFormation(i.row,i.id),this.RefreshAxeFormation(u,p);var B=configMining_item.getDataByKey(y);this.AddAxe(w,M,B),this.AddShovelList(y,w,M);var L=configMining_item.getDataByKey(S);this.AddAxe(u,p,L),this.AddShovelList(S,u,p)}else if(0==this.pickAxeItem[u][p].level){var R=configMining_item.getDataByKey(i.level);this.AddAxe(u,p,R),this.AddShovelList(i.level,u,p),this.RemoveShovelList(i.row,i.id),this.RefreshAxeFormation(i.row,i.id)}else{var G=this.pickAxeItem[u][p].level,D=i.level,T=i.row,E=i.id;this.RemoveShovelList(i.row,i.id),this.RemoveShovelList(u,p),this.RefreshAxeFormation(i.row,i.id),this.RefreshAxeFormation(u,p);var F=configMining_item.getDataByKey(G);this.AddAxe(T,E,F),this.AddShovelList(G,T,E);var U=configMining_item.getDataByKey(D);this.AddAxe(u,p,U),this.AddShovelList(D,u,p)}}}},B.InitPickAxe=function(){for(var t=this,i=function(i){t.pickAxeItem[i]={};for(var e=function(e){var o=t.findChild(l.formatStr("map/%s/%s/%s",0,i,e)),r=t.findChildComponent(l.formatStr("map/%s/%s/%s/lv",0,i,e),h);t.pickAxeItem[i][e]={row:i,id:e,node:o,sprite:o.getComponent(s),ut:o.getComponent(a),rig:o.getComponent(d),collider:o.getComponent(f),hp:0,atk:0,isAxe:!0,level:0,isGift:!1,btn:o.getComponent(n),eff:null,tween:null,txtLv:r},t.addComponentCallbackListener(t.pickAxeItem[i][e].node,n.EventType.CLICK,(function(){if(!t.isMining&&!t.isTouching&&t.pickAxeItem[i][e].isGift){var n=t.levelData[t.levelId-1].gift,o=n[Math.floor(Math.random()*n.length)];t.RemoveShovelList(i,e),t.AddShovelList(o,i,e);var s=configMining_item.getDataByKey(o);t.RefreshAxeFormation(i,e),t.AddAxe(i,e,s)}})),t.addComponentCallbackListener(t.pickAxeItem[i][e].node,p.EventType.TOUCH_START,(function(n){t.isMining||t.onTouchStart(n,t.pickAxeItem[i][e])})),t.addComponentCallbackListener(t.pickAxeItem[i][e].node,p.EventType.TOUCH_MOVE,(function(n){t.isMining||t.onTouchMove(n,t.pickAxeItem[i][e])})),t.addComponentCallbackListener(t.pickAxeItem[i][e].node,p.EventType.TOUCH_END,(function(n){t.isMining||t.onTouchEnd(n,t.pickAxeItem[i][e])})),t.addComponentCallbackListener(t.pickAxeItem[i][e].node,p.EventType.TOUCH_CANCEL,(function(n){t.isMining||t.onTouchEnd(n,t.pickAxeItem[i][e])}))},o=0;o<5;o++)e(o)},e=0;e<4;e++)i(e)},B.InitOre=function(){for(var t=0;t<20;t++){this.oreItem[t]={};for(var i=0;i<5;i++){var e=this.findChild(l.formatStr("map/%s/%s/%s",1,t,i));this.oreItem[t][i]={row:t,id:i,node:e,sprite:e.getComponent(s),ut:e.getComponent(a),rig:e.getComponent(d),collider:e.getComponent(f),hp:0,maxHp:0,atk:0,isAxe:!1,level:0,oreType:0,effect:0,isGiftGet:!1,coin:0,eff:null,effList:[],coinGet:this.findChild(l.formatStr("map/%s/%s/%s/coinGet",1,t,i)),coinGetCount:this.findChildComponent(l.formatStr("map/%s/%s/%s/coinGet/count",1,t,i),h)}}}},B.InitEnd=function(){for(var t=0;t<5;t++){var i=this.findChild(l.formatStr("map/%s/%s/%s",2,0,t));this.endItem[t]={id:t,node:i,ut:i.getComponent(a),sprite:i.getComponent(s),rig:i.getComponent(d),collider:i.getComponent(f),eff:null,effID:null,boxSpine:null}}for(var e=0;e<5;e++){var n=this.findChild(l.formatStr("map/%s/%s/%s",2,1,e));this.endBossItem[e]={id:e,node:n,ut:n.getComponent(a),sprite:n.getComponent(s),rig:n.getComponent(d),collider:n.getComponent(f),eff:null,effID:null,boxSpine:null}}var o=this.findChild("map/2/1/5");this.boss={node:o,nodePbBossHp:C.findChild(o,"pbBossHp"),pbBossHp:C.findChildComponent(o,"pbBossHp",c),sprite:C.findChild(o,"tx"),rig:o.getComponent(d),collider:o.getComponent(f),hp:50,maxHp:50,atk:1,coin:100}},B.refreshBossShow=function(t){this.removeUIEffect(this.bossEffectID);var i="prefab/model/"+t;this.bossEffectID=this.addUIEffect(i,this.boss.sprite,-1,null,this.levelData[this.levelId-1].boss_size/100);var e=i.split("/")[i.split("/").length-1];this.bossSpine=C.findChildComponent(this.boss.sprite,e+"/model",b)},B.removeBossShow=function(){this.removeUIEffect(this.bossEffectID),this.bossEffectID=null,this.bossSpine=null},B.refreshEndShow=function(){this.removeEndShow();for(var t=0;t<5;t++)this.endItem[t].effID=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_baoxiang"),this.endItem[t].node,-1,new g(0,0),1),this.endItem[t].boxSpine=C.findChildComponent(this.endItem[t].node,"MX_tx_baoxiang",b);for(var i=0;i<5;i++)this.endBossItem[i].effID=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_baoxiang"),this.endBossItem[i].node,-1,new g(0,0),1),this.endBossItem[i].boxSpine=C.findChildComponent(this.endBossItem[i].node,"MX_tx_baoxiang",b)},B.removeEndShow=function(){for(var t=0;t<5;t++)this.removeUIEffect(this.endItem[t].effID),this.endItem[t].effID=null,this.endItem[t].boxSpine=null;for(var i=0;i<5;i++)this.removeUIEffect(this.endBossItem[i].effID),this.endBossItem[i].effID=null,this.endBossItem[i].boxSpine=null},B.onAttack=function(){this.bossSpine&&(this.bossSpine.setAnimation(0,"hit",!1),this.bossSpine.addAnimation(0,"idle",!0))},B.onAfterOpen=function(){var t;this.RefreshAllAxeFormation(),this.RefreshOreList(),this.levelId=this.openArgs[0],this.firstMention.active=1==this.levelId,this.finishGroup=IS(y).getPassInfo(14).lev,this.mainGroupId=IS(M).mainGroupId,this.levelData=null!=(t=configMining_level.getDataByList("group",this.mainGroupId))?t:[],this.axeMaxRow=configMining_level.getDataByKey(this.levelId).mining_row,this.lowBuyLevel=configMining_level.getDataByKey(this.levelId).buy;var i=configMining_item.getDataByKey(this.lowBuyLevel);this.loadIcon(this.buyImg,"icon_mining",i.image,null,x.ICON_SPRITE),this.buyPrice=i.price,this.buyCost.string=l.formatStr("%s",i.price),this.chapterData=IS(M).getChapterData()[this.levelId],this.levelRound=this.chapterData.round,5*this.levelId<this.finishGroup-1?(IS(S).send_24_129(this.levelId),this.isReplay=!0):(this.isReplay=!1,0==this.levelRound?this.loadRound=this.levelRound+this.levelData[this.levelId-1].round[0]:this.levelRound==this.levelData[this.levelId-1].round[4]?(IS(S).send_24_129(this.levelId),this.isReplay=!0):this.loadRound=this.levelRound+1,this.UpdateMiningData(),this.btnMining.active=!0,this.btnBuyAxe.active=!0,this.recycleGo.active=!0,this.isMining=!1,this.noMining.active=!0,this.isTouching=!1),this.RefreshAllPos()},B.LoadAfterRefresh=function(){this.chapterData=IS(M).getChapterData()[this.levelId],this.levelRound=this.chapterData.round,0==this.levelRound?this.loadRound=this.levelRound+this.levelData[this.levelId-1].round[0]:this.loadRound=this.levelRound+1,this.UpdateMiningData(),this.btnMining.active=!0,this.btnBuyAxe.active=!0,this.recycleGo.active=!0,this.isMining=!1,this.noMining.active=!0,this.isTouching=!1},B.RefreshAllAxeFormation=function(){for(var t=0;t<4;t++)for(var i=0;i<5;i++)this.RefreshAxeFormation(t,i);this.mapbgGo.position=new r(0,511,0)},B.RefreshAllPos=function(){for(var t=0;t<4;t++)for(var i=0;i<5;i++){var e=k*(i-2);this.pickAxeItem[t][i].rig.linearVelocity=new m(0,0),this.pickAxeItem[t][i].rig.angularVelocity=0,this.pickAxeItem[t][i].node.position=new r(e,0,0),null!=this.pickAxeItem[t][i].tween&&(this.pickAxeItem[t][i].tween.stop(),this.pickAxeItem[t][i].rig.linearVelocity=new m(0,0),this.pickAxeItem[t][i].rig.enabled=!1)}},B.RefreshAxeFormation=function(t,i){var e=this.pickAxeItem[t][i];if(null!=e){e.eff&&(this.removeUIEffect(e.eff),e.eff=null),e.rig.linearVelocity=new m(0,0),e.rig.angularVelocity=0;var n=k*(i-2);e.node.position=new r(n,0,0),e.node.setRotationFromEuler(0,0,0),e.sprite.enabled=!1,e.collider.enabled=!0,e.isAxe=!0,e.isGift=!1,e.node.active=!1,e.level=0,e.txtLv.string=e.level,e.txtLv.node.active=!1,e.hp=0,e.atk=0,null!=e.tween&&(e.tween.stop(),e.rig.linearVelocity=new m(0,0),e.tween=null),e.rig.enabled=!1}},B.RefreshOreList=function(){for(var t=0;t<20;t++)for(var i=0;i<5;i++){var e=k*(i-2),n=this.oreItem[t][i];if(n.eff&&(this.removeUIEffect(n.eff),n.eff=null),0!=n.effList.length){for(var o=0;o<n.effList.length;o++)n.effList[o]&&this.removeUIEffect(n.effList[o]);n.effList=[]}n.node.position=new r(e,0,0),n.node.setRotationFromEuler(0,0,0),n.node.active=!1,n.sprite.enabled=!0,n.rig.linearVelocity=new m(0,0),n.rig.angularVelocity=0,n.isAxe=!1,n.level=0,n.hp=0,n.maxHp=0,n.atk=0,n.coin=0,n.oreType=0,n.effect=0,n.coinGet.active=!1,n.coinGetCount.string=0}for(var s=0;s<5;s++){var h=k*(s-2);this.endItem[s].node.position=new r(h,0,0),this.endBossItem[s].node.position=new r(h,0,0),this.endItem[s].node.active=!0,this.endBossItem[s].node.active=!0,this.endItem[s].eff&&(this.removeUIEffect(this.endItem[s].eff),this.endItem[s].eff=null),this.endBossItem[s].eff&&(this.removeUIEffect(this.endBossItem[s].eff),this.endBossItem[s].eff=null)}this.boss.node.position=new r(0,300,0),this.boss.node.active=!0,this.giftGetList={}},B.UpdateMiningData=function(){var t=this;this.endCount=[],this.coinCount=this.chapterData.gold,this.giftCount=this.chapterData.gift;var i=this.loadRound%5;0==i&&(i=5),this.txtChapter.string=I.formatStrWithMirrorDeal(GetLanguage(201653),this.levelId,i),this.txtCoin.string=l.formatStr("x %s",this.coinCount);for(var e=0;e<4;e++)this.pickAxeRowList[e].active=e<this.axeMaxRow,this.mapbglist[e].active=e<this.axeMaxRow;for(var n in this.mapSizeBg.height=130*this.axeMaxRow+160,this.btnMiningWidget.bottom=12,this.btnBuyAxeWidget.bottom=12,this.recycleWidget.bottom=12,this.RefreshAllAxeFormation(),this.RefreshOreList(),this.shovel_list=this.chapterData.shovel_list,this.shovel_list)if(this.shovel_list.hasOwnProperty(n)){var o=this.shovel_list[n],s=o.row;if(s<this.axeMaxRow){var h=o.column,a=configMining_item.getDataByKey(o.level);this.AddAxe(s,h,a),this.pickAxeItem[s][h].node.active=!0}}if(this.giftCount>0)for(var d=0;d<4;d++)for(var f=0;f<5&&!(this.giftCount<=0);f++)if(d<this.axeMaxRow&&null!=this.pickAxeItem[d][f]&&0==this.pickAxeItem[d][f].level&&this.giftCount>0){var c=configMining_item.getDataByKey(_);this.AddAxe(d,f,c),this.pickAxeItem[d][f].node.active=!0,this.AddShovelList(_,d,f),this.giftCount=this.giftCount-1}this.txtGift.string=l.formatStr("x %s",this.giftCount);var m=configMining_config.getDataByList("group",this.loadRound);this.hasBoss=!1;var u=0;for(var p in m)if(m.hasOwnProperty(p)){for(var g=m[p],v=0;v<5;v++){var C=g.row[0][v],b=configMining_soil.getDataByKey(C);if(this.lastLoadRound==this.loadRound&&this.oreItem[u][v].isGiftGet);else{if(null!=b.boss&&1==b.boss){this.hasBoss=!0,this.bossName=b.spine,this.boss.maxHp=b.hp,this.boss.hp=this.boss.maxHp,this.boss.atk=b.attack,this.boss.pbBossHp.progress=Math.min(1,this.boss.hp/this.boss.maxHp);break}this.oreItem[u][v].node.active=!0,this.oreItem[u][v].hp=b.hp,this.oreItem[u][v].maxHp=b.hp,this.oreItem[u][v].atk=b.attack,this.oreItem[u][v].coin=b.price,this.oreItem[u][v].isGiftGet=!1,null!=b.effect[0]&&(this.oreItem[u][v].oreType=b.effect[0][0],this.oreItem[u][v].effect=b.effect[0][1]),this.loadIcon(this.oreItem[u][v].sprite,"icon_mining",b.image,null,x.ICON_SPRITE)}}u++}this.lastLoadRound=this.loadRound;for(var y=0;y<5;y++){var A=new r(this.endItem[y].node.position.x,this.endItem[y].node.position.y+120*(20-u+1),this.endItem[y].node.position.z);this.endItem[y].node.position=A,A=new r(this.endBossItem[y].node.position.x,this.endBossItem[y].node.position.y+120*(20-u+1),this.endBossItem[y].node.position.z),this.endBossItem[y].node.position=A}this.endFinish=configMining_level.getDataByKey(this.levelId).condition[(this.loadRound-1)%5],0==this.endFinish&&(this.endFinish=1),this.needFinish.string=l.formatStr("x%s",this.endFinish),this.getFinish.string=l.formatStr("x%s",this.endFinish),this.getDone.string=l.formatStr("x%s",this.endFinish),this.getInherit.string=l.formatStr("x%s",this.endFinish),this.txtMention.string=I.formatStrWithMirrorDeal(GetLanguage(300667),this.endFinish),this.txtFailMention.string=I.formatStrWithMirrorDeal(GetLanguage(300667),this.endFinish);var S=new r(0,this.boss.node.position.y+120*(20-u+1),0);this.boss.node.position=S,this.boss.node.active=this.hasBoss,this.hasBoss&&this.refreshBossShow(this.bossName);for(var w=0;w<5;w++)this.endItem[w].node.active=0==this.hasBoss,this.endBossItem[w].node.active=1==this.hasBoss;this.refreshEndShow(),this.addTimer(.2,1,(function(){t.RefreshAllPos()}))},B.AddAxe=function(t,i,e){var n=this.pickAxeItem[t][i];null!=n&&(n.hp=e.hp,n.atk=e.attack,n.node.active=!0,n.level=e.level,1!=e.gift?(n.txtLv.string=e.level,n.txtLv.node.active=!0):n.txtLv.node.active=!1,n.sprite.enabled=!0,this.loadIcon(n.sprite,"icon_mining",e.image,null,x.ICON_SPRITE),n.isGift=1==e.gift)},B.BuyAxe=function(){for(var t=0;t<4;t++)for(var i=0;i<5;i++)if(t<this.axeMaxRow&&null!=this.pickAxeItem[t][i]&&0==this.pickAxeItem[t][i].level){this.coinCount=this.coinCount-this.buyPrice,this.txtCoin.string=l.formatStr("x %s",this.coinCount);var e=configMining_item.getDataByKey(this.lowBuyLevel);return this.AddAxe(t,i,e),this.AddShovelList(this.lowBuyLevel,t,i),void v.playSound("msqql_chushi")}A.showFlyTip(GetLanguage(201649))},B.AddShovelList=function(t,i,e){var n={};n.level=t,n.row=i,n.column=e,this.shovel_list.push(n)},B.RemoveShovelList=function(t,i){for(var e in this.shovel_list)if(this.shovel_list.hasOwnProperty(e)){var n=this.shovel_list[e];if(t==n.row&&i==n.column){this.shovel_list.splice(e,1);break}}},B.StartMining=function(){var t=this;if(0==this.isMining){this.endCount=[],this.btnMining.active=!1,this.btnBuyAxe.active=!1,this.recycleGo.active=!1,this.firstMention.active=!1,this.roundCoinCount=0,this.roundGiftCount=0;for(var i=0;i<4;i++)for(var e=0;e<5;e++)if(this.pickAxeItem[i][e].txtLv.node.active=!1,null!=this.pickAxeItem[i][e]&&this.pickAxeItem[i][e].node.active&&0==this.pickAxeItem[i][e].isGift){this.pickAxeItem[i][e].collider.on(u.BEGIN_CONTACT,this.onBeginContact,this),this.pickAxeItem[i][e].rig.enabled=!0;var n=new m(0,-30);this.pickAxeItem[i][e].rig.linearVelocity=n}this.movInter=setInterval((function(){var i=t.getFastPickAxeItem();if(null!=i){var e=-1*i.node.position.y;if(e>t.lowY){for(var n=0;n<4;n++)for(var o=0;o<5;o++)if(null!=t.pickAxeItem[n][o]&&t.pickAxeItem[n][o].node.active){var s=new r(t.pickAxeItem[n][o].node.position.x,t.pickAxeItem[n][o].node.position.y+e/2,t.pickAxeItem[n][o].node.position.z);t.pickAxeItem[n][o].node.position=s}for(var h=0;h<20;h++)for(var a=0;a<5;a++){var l=new r(t.oreItem[h][a].node.position.x,t.oreItem[h][a].node.position.y+e/2,t.oreItem[h][a].node.position.z);t.oreItem[h][a].node.position=l}for(var d=0;d<5;d++){var f=new r(t.endItem[d].node.position.x,t.endItem[d].node.position.y+e/2,t.endItem[d].node.position.z);t.endItem[d].node.position=f,f=new r(t.endBossItem[d].node.position.x,t.endBossItem[d].node.position.y+e/2,t.endBossItem[d].node.position.z),t.endBossItem[d].node.position=f}var c=new r(t.boss.node.position.x,t.boss.node.position.y+e/2,t.boss.node.position.z);t.boss.node.position=c;var m=new r(t.mapbgGo.position.x,t.mapbgGo.position.y+e/2,t.mapbgGo.position.z);if(t.mapbgGo.position=m,t.hasBoss)t.endBossItem[0].ut.convertToWorldSpaceAR(new r(0,0,0)).y>=220&&clearInterval(t.movInter);else t.endItem[0].ut.convertToWorldSpaceAR(new r(0,0,0)).y>=220&&clearInterval(t.movInter)}else t.lowY=-1*i.node.position.y}})),this.time=0,this.isMining=!0,this.noMining.active=!1}},B.EndMining=function(){var t=this;clearInterval(this.movInter);var i=0;for(var e in this.endCount)this.endCount.hasOwnProperty(e)&&(i+=1);this.addTimer(.5,1,(function(){if(i>=t.endFinish){for(var e=0;e<t.endBoxList.length;e++){var n=t.endBoxList[e];null==t.endItem[n].boxSpine&&(t.endItem[n].boxSpine=C.findChildComponent(t.endItem[n].node,"MX_tx_baoxiang",b)),null==t.endBossItem[n].boxSpine&&(t.endBossItem[n].boxSpine=C.findChildComponent(t.endBossItem[n].node,"MX_tx_baoxiang",b)),t.endItem[n].boxSpine.setAnimation(0,"skill2",!1),t.endItem[n].boxSpine.addAnimation(0,"idle1",!0),t.endBossItem[n].boxSpine.setAnimation(0,"skill2",!1),t.endBossItem[n].boxSpine.addAnimation(0,"idle1",!0)}t.endBoxList=[],t.loadRound<t.levelData[t.levelId-1].round[4]?(t.needReStart=!1,IS(S).send_24_127(t.levelId,t.loadRound,1,t.coinCount,t.giftCount+i,t.shovel_list),t.endCount=[],t.finish.active=!0,t.getFinishCoin.string=l.formatStr("x%s",t.roundCoinCount),t.getFinishBox.string=l.formatStr("x%s",t.roundGiftCount)):t.loadRound==t.levelData[t.levelId-1].round[4]&&(t.needReStart=!1,IS(S).send_24_127(t.levelId,t.loadRound,1,t.coinCount,t.giftCount+i,t.shovel_list),t.endCount=[],t.isReplay&&t.loadRound<t.levelData[t.levelData.length-1].round[4]?(t.isInherit.active=!0,t.getInheritCoin.string=l.formatStr("x%s",t.roundCoinCount),t.getInheritBox.string=l.formatStr("x%s",t.roundGiftCount)):(t.isDone.active=!0,t.getDoneCoin.string=l.formatStr("x%s",t.roundCoinCount),t.getDoneBox.string=l.formatStr("x%s",t.roundGiftCount)))}else{for(var o=0;o<t.endBoxList.length;o++){var s=t.endBoxList[o];t.endItem[s].boxSpine.addAnimation(0,"idle",!0),t.endBossItem[s].boxSpine.addAnimation(0,"idle",!0)}t.endBoxList=[],t.fail.active=!0,t.getFailCoin.string=l.formatStr("x%s",t.roundCoinCount),t.getFailBox.string=l.formatStr("x%s",t.roundGiftCount),t.getFail.string=l.formatStr("x%s",i),t.endCount=[]}t.roundGiftCount=0,t.roundCoinCount=0}))},B.onBeginContact=function(t,i){if(this.isMining){var e=Number(t.node.parent.parent.name),n=Number(i.node.parent.parent.name),o=Number(t.node.parent.name),s=Number(t.node.name),h=Number(i.node.parent.name),a=Number(i.node.name),d=this.getOreItem(h,a),f=this.getPickAxeItem(o,s,e);if(1==n&&null!=d)if(d.level<=10?v.playSound("msqql_luoxia"):d.level<=20&&v.playSound("msqql_guodong"),f.rig.linearVelocity=new m(0,0),null!=d.atk&&0!=d.atk)if(d.hp=d.hp-f.atk,f.hp=f.hp-d.atk,d.hp>0){if(d.hp<=.75*d.maxHp?(d.eff&&(this.removeUIEffect(d.eff),d.eff=null),d.eff=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_liewen01"),d.node,-1,new g(0,0),1)):d.hp<=.25*d.maxHp&&(d.eff&&(this.removeUIEffect(d.eff),d.eff=null),d.eff=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_liewen02"),d.node,-1,new g(0,0),1)),f.hp>0)f.rig.angularVelocity=13,null!=f.tween&&(f.tween.stop(),f.rig.linearVelocity=new m(0,0),f.tween=null),f.tween=normalTween.to(L,0,.5,(function(t,i){f.rig.linearVelocity=new m(0,i)})).start(),f.rig.scheduleOnce((function(){null!=f.tween&&(f.tween.stop(),f.rig.linearVelocity=new m(0,0),f.tween=null),f.tween=normalTween.to(0,-30,.5,(function(t,i){f.rig.linearVelocity=new m(0,i)})).start()}),.5);else if(f.hp<=0){var c=k*(s-2);f.node.position=new r(c,0,0),f.node.setRotationFromEuler(0,0,0),f.rig.angularVelocity=0,f.sprite.enabled=!1,setTimeout((function(){f.node.active=!1}),0)}}else if(3==d.oreType||(d.sprite.enabled=!1,d.eff&&(this.removeUIEffect(d.eff),d.eff=null),d.coinGetCount.string=l.formatStr("+%s",d.coin),d.coinGet.active=!0,this.addTimer(.5,1,(function(){d.coinGet.active=!1,d.node.active=!1}))),this.coinCount=this.coinCount+d.coin,this.roundCoinCount=this.roundCoinCount+d.coin,this.txtCoin.string=l.formatStr("x %s",this.coinCount),f.hp<=0){var u=k*(s-2);f.node.position=new r(u,0,0),f.node.setRotationFromEuler(0,0,0),f.rig.angularVelocity=0,f.sprite.enabled=!1,setTimeout((function(){f.node.active=!1}),0)}else f.rig.linearVelocity=new m(0,-30);else if(1==d.oreType){0==d.effList.length&&(v.playSound("skill_dadihuichun"),d.effList[0]=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_zhadan"),d.node,-1,new g(0,0),1),d.effList[1]=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_baozha01"),d.node,-1,new g(0,0),1),d.effList[2]=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_baozha02"),d.node,-1,new g(0,0),1),d.effList[3]=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_baozha03"),d.node,-1,new g(0,0),1),d.effList[4]=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_baozha04"),d.node,-1,new g(0,0),1),d.effList[5]=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_baozha05"),d.node,-1,new g(0,0),1)),d.sprite.enabled=!1,this.coinCount=this.coinCount+d.coin,this.roundCoinCount=this.roundCoinCount+d.coin,this.txtCoin.string=l.formatStr("x %s",this.coinCount),this.addTimer(.5,1,(function(){d.node.active=!1}));for(var p=0;p<5;p++)0==this.oreItem[h][p].isAxe&&1==this.oreItem[h][p].sprite.enabled&&(this.oreItem[h][p].node.active=!1,this.oreItem[h][p].hp=0,this.coinCount=this.coinCount+this.oreItem[h][p].coin,this.roundCoinCount=this.roundCoinCount+this.oreItem[h][p].coin,this.txtCoin.string=l.formatStr("x %s",this.coinCount),null!=this.oreItem[h][p].atk&&0!=this.oreItem[h][p].atk||(2==this.oreItem[h][p].oreType?(this.oreItem[h][p].isGiftGet=!0,null!=this.giftGetList[h]&&null!=this.giftGetList[h][p]||(null==this.giftGetList[h]&&(this.giftGetList[h]={}),this.giftGetList[h][p]=1,this.giftCount=this.giftCount+1,this.roundGiftCount=this.roundGiftCount+1,this.txtGift.string=l.formatStr("x %s",this.giftCount))):this.oreItem[h][p].oreType));f.rig.linearVelocity=new m(0,-30)}else 2==d.oreType&&(d.node.active=!1,d.isGiftGet=!0,this.coinCount=this.coinCount+d.coin,this.roundCoinCount=this.roundCoinCount+d.coin,this.txtCoin.string=l.formatStr("x %s",this.coinCount),null!=this.giftGetList[h]&&null!=this.giftGetList[h][a]||(null==this.giftGetList[h]&&(this.giftGetList[h]={}),this.giftGetList[h][a]=1,this.giftCount=this.giftCount+1,this.roundGiftCount=this.roundGiftCount+1,this.txtGift.string=l.formatStr("x %s",this.giftCount)),this.txtGift.string=l.formatStr("x %s",this.giftCount),f.rig.linearVelocity=new m(0,-30));else if(2==n){v.playSound("msqql_luoxia");var I=Number(i.node.name);if(f.rig.linearVelocity=new m(0,0),5==I)if(this.onAttack(),this.boss.hp=this.boss.hp-f.atk,f.hp=f.hp-this.boss.atk,this.boss.pbBossHp.progress=Math.min(1,this.boss.hp/this.boss.maxHp),this.boss.hp>0){if(f.hp>0)null!=f.tween&&(f.tween.stop(),f.rig.linearVelocity=new m(0,0),f.tween=null),f.rig.angularVelocity=13,f.tween=normalTween.to(L,0,.5,(function(t,i){f.rig.linearVelocity=new m(0,i)})).start(),f.rig.scheduleOnce((function(){null!=f.tween&&(f.tween.stop(),f.rig.linearVelocity=new m(0,0),f.tween=null),f.tween=normalTween.to(0,-30,.5,(function(t,i){f.rig.linearVelocity=new m(0,i)})).start()}),.5);else if(f.hp<=0){var x=k*(s-2);f.node.position=new r(x,0,0),f.node.setRotationFromEuler(0,0,0),f.rig.angularVelocity=0,f.sprite.enabled=!1,f.rig.linearVelocity=new m(0,0),setTimeout((function(){f.node.active=!1}),0)}}else if(this.coinCount=this.coinCount+this.boss.coin,this.roundCoinCount=this.roundCoinCount+this.boss.coin,this.txtCoin.string=l.formatStr("x %s",this.coinCount),this.boss.node.active=!1,this.removeBossShow(),f.hp<=0){var y=k*(s-2);f.node.position=new r(y,0,0),f.node.setRotationFromEuler(0,0,0),f.rig.angularVelocity=0,f.sprite.enabled=!1,setTimeout((function(){f.node.active=!1}),0)}else f.rig.linearVelocity=new m(0,-30);else{Number(i.node.parent.name);null==this.endCount[I]&&(this.endCount[I]=0),this.endCount[I]=this.endCount[I]+1,this.endItem[I].eff&&(this.removeUIEffect(this.endItem[I].eff),this.endItem[I].eff=null),this.endBossItem[I].eff&&(this.removeUIEffect(this.endBossItem[I].eff),this.endBossItem[I].eff=null),v.playSound("msqql_zhongdian"),null==this.endItem[I].boxSpine&&(this.endItem[I].boxSpine=C.findChildComponent(this.endItem[I].node,"MX_tx_baoxiang",b)),null==this.endBossItem[I].boxSpine&&(this.endBossItem[I].boxSpine=C.findChildComponent(this.endBossItem[I].node,"MX_tx_baoxiang",b)),this.endItem[I].boxSpine.setAnimation(0,"skill1",!0),this.endBossItem[I].boxSpine.setAnimation(0,"skill1",!0),this.endBoxList.push(I),this.endItem[I].eff=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_kaibaoxiang"),this.endItem[I].node,-1,new g(0,0),1),this.endBossItem[I].eff=this.addUIEffect(l.formatStr("prefab/ui-effect/%s","MX_tx_qiaoqiaole_kaibaoxiang"),this.endBossItem[I].node,-1,new g(0,0),1);var A=k*(s-2);f.node.position=new r(A,0,0),f.node.setRotationFromEuler(0,0,0),f.rig.angularVelocity=0,f.sprite.enabled=!1,setTimeout((function(){f.node.active=!1}),0)}}}},B.getOreItem=function(t,i){if(null!=this.oreItem[t][i]&&0==this.oreItem[t][i].isAxe)return this.oreItem[t][i]},B.getPickAxeItem=function(t,i,e){if(0==e){if(null!=this.pickAxeItem[t][i]&&1==this.pickAxeItem[t][i].isAxe)return this.pickAxeItem[t][i]}else if(1==e&&null!=this.oreItem[t][i]&&1==this.oreItem[t][i].isAxe)return this.oreItem[t][i]},B.getFastPickAxeItem=function(){for(var t=0,i=null,e=0;e<4;e++)for(var n=0;n<5;n++)if(null!=this.pickAxeItem[e][n]&&this.pickAxeItem[e][n].node.active){var o=-1*this.pickAxeItem[e][n].node.position.y;o>t&&(t=o,i=this.pickAxeItem[e][n])}for(var s=0;s<6;s++)for(var h=0;h<5;h++)if(this.oreItem[s][h].isAxe&&this.oreItem[s][h].node.active){var a=-1*this.oreItem[s][h].node.position.y;a>t&&(t=a,i=this.oreItem[s][h])}if(null!=i)return i},B.registerUpdateHandler=function(){this.addEvent(w.OnMiningSettleUpdate,this.LoadAfterRefresh,this),this.addEvent(w.OnMiningRoundUpdate,this.ReStartRound,this)},B.onUpdate=function(t){if(this.isMining){if(this.time=this.time+t,this.CheckEnd(),this.time<1)return;this.time=0}},B.ReStartRound=function(){this.needReStart&&(this.chapterData=IS(M).getChapterData()[this.levelId],this.UpdateMiningData(),this.btnMining.active=!0,this.btnBuyAxe.active=!0,this.recycleGo.active=!0,this.isMining=!1,this.noMining.active=!0,this.isTouching=!1,this.needReStart=!1)},B.CheckEnd=function(){for(var t=!0,i=0;i<4;i++)for(var e=0;e<5;e++)null!=this.pickAxeItem[i][e]&&this.pickAxeItem[i][e].node.active&&1==this.pickAxeItem[i][e].sprite.enabled&&0==this.pickAxeItem[i][e].isGift&&(t=!1);for(var n=0;n<20;n++)for(var o=0;o<5;o++)null!=this.oreItem[n][o]&&1==this.oreItem[n][o].isAxe&&this.oreItem[n][o].node.active&&1==this.oreItem[n][o].sprite.enabled&&(t=!1);t&&(this.isMining=!1,this.noMining.active=!0,this.EndMining())},B.onBeforeClose=function(){clearInterval(this.movInter),this.RefreshAllAxeFormation(),this.RefreshOreList(),this.RefreshAllPos(),this.removeEndShow(),this.removeBossShow(),IS(S).send_24_126()},B.onDestroy=function(){},e}(B));e._RF.pop()}}}));

