System.register("chunks:///_virtual/ActivityLoopyShotView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./NodeUtil.ts","./StringUtil.ts","./TimeUtil.ts","./index57.ts","./SpineSkeleton.ts","./MathUtil.ts","./MessageView.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./ActivityLoopyControl.ts","./ActivityLoopyDataCache.ts","./ActivityLoopyDefine.ts","./BaseView.ts"],(function(t){"use strict";var i,e,n,o,h,s,r,a,d,u,c,g,l,f,p,m,v,S,C,I,y,T,w,U,E,L,R,M,A,x,_,O,V;return{setters:[function(t){i=t.inheritsLoose},function(t){e=t.cclegacy,n=t.Button,o=t.Label,h=t.HorizontalTextAlignment,s=t.RichText,r=t.Widget,a=t.UITransform,d=t.Vec3,u=t.js,c=t.Vec2,g=t.PhysicsSystem2D,l=t.RigidBody2D,f=t.BoxCollider2D,p=t.Contact2DType,m=t.sys,v=t.PHYSICS_2D_PTM_RATIO,S=t.CircleCollider2D},function(t){C=t.default},function(t){I=t.default},function(t){y=t.default},null,function(t){T=t.SpineSkeleton},function(t){w=t.default},function(t){U=t.default},function(t){E=t.default},function(t){L=t.ActivityEventDefine,R=t.ActivityType,M=t.ActivityState},function(t){A=t.default},function(t){x=t.default},function(t){_=t.ActivityLoopyEvent,O=t.starToResult},function(t){V=t.BaseView}],execute:function(){e._RF.push({},"ec579guAKJN+YNOXj93f1eM","ActivityLoopyShotView",void 0);t("default",function(t){function e(){var i;return(i=t.call(this)||this).txtChapter=void 0,i.txtResNum=void 0,i.useStep=0,i.curChapter=0,i.curChapterStateCfg=void 0,i.isMoving=!1,i.isMovingOn=!1,i.nodeUnitParent=void 0,i.nodeUnitItem=void 0,i.unitItems=void 0,i.unitIdToInfo={},i.usingShotCfg=void 0,i.touchList=[],i.curShottingItem=void 0,i.curShottingRig=void 0,i.nodeShottingParent=void 0,i.utShottingParent=void 0,i.time=0,i.txtTime=void 0,i.endTime=0,i.nodeEdge1=void 0,i.nodeEdge2=void 0,i.nodeEdge3=void 0,i.isWatingEnd=!1,i.circleTween=void 0,i.widgetMap=void 0,i.nodeWindTip=void 0,i.txtWind=void 0,i.txtDistance=void 0,i.nodeShot=void 0,i.nodeShottingPoint=void 0,i.name="ActivityLoopyShotView",i.url="ui/module/activityLoopy/ActivityLoopyShotView",i}i(e,t);var V=e.prototype;return V.onInit=function(){var t=this,i=this.findChild("bottom/btnClose");this.addComponentCallbackListener(i,n.EventType.CLICK,(function(){t.isMoving?U.showFlyTip(GetLanguage(200758)):U.showBoxTip({tip:GetLanguage(201211),func:function(i){"type_yes"==i&&t.close()}})})),this.nodeEdge1=this.findChild("map/edge1"),this.nodeEdge2=this.findChild("map/edge2"),this.nodeEdge3=this.findChild("map/edge3"),this.nodeEdge1.active=!1,this.nodeEdge2.active=!1,this.nodeEdge3.active=!1,this.nodeWindTip=this.findChild("top/title/wind/imgWind"),this.txtWind=this.findChildComponent("top/title/wind/txtWind",o),this.txtDistance=this.findChildComponent("top/title/txtDistance",o),this.txtTime=this.findChildComponent("top/txtTime",o);var e=this.findChild("bottom/btnGuild");this.addComponentCallbackListener(e,n.EventType.CLICK,(function(){uiMgr.openView("ActivityLoopyShotGuideView")}));var d=this.findChild("top/title/btnTip");this.addComponentCallbackListener(d,n.EventType.CLICK,(function(){U.showBoxTip({tip:GetLanguage(204004),btnCnt:1,horizontalAlign:h.LEFT})})),this.txtChapter=this.findChildComponent("top/title/txtChapter",o),this.txtResNum=this.findChildComponent("resRoot/resItem/txtNum",s),this.nodeUnitParent=this.findChild("map/UnitParent"),this.nodeUnitItem=this.findChild("map/UnitParent/Unit"),this.nodeUnitItem.active=!1;var u=this.findChild("map");this.widgetMap=u.getComponent(r),this.widgetMap.scheduleOnce((function(){t.nodeEdge1.active=!0,t.nodeEdge2.active=!0,t.nodeEdge3.active=!0}),0),this.nodeShottingParent=this.findChild("map/shotting"),this.utShottingParent=this.nodeShottingParent.getComponent(a),this.nodeShot=this.findChild("map/ready");var c=this.findChild("map/btnShot");this.addComponentCallbackListener(c,n.EventType.CLICK,(function(){t.onSlingShotClick()})),this.nodeShottingPoint=this.findChild("map/ready/shottingPoint")},V.registerUpdateHandler=function(){this.addEvent(L.OnActivityInfoUpdate,this.updateInfo,this),this.addEvent(_.OnLoopyChapterResult,this.OnLoopyChapterResult,this)},V.onAfterOpen=function(){var t=IS(E).GetActivityInfo(R.LoopyArchery);if(null!=t&&t.state==M.Open){var i=t.state_time[M.Open];this.endTime=i.end_time,this.curChapter=this.openArgs[0],this.curChapterStateCfg=configArchery_chapter.getDataByKey(this.curChapter),this.updateResShow(),this.updateTime(),this.updateChapter(),this.updateWind(),IS(x).checkHasOpenGuide()||(uiMgr.openView("ActivityLoopyShotGuideView"),IS(x).setOpenGuide()),this.trySetShotTween(!0)}else this.close()},V.trySetShotTween=function(t){var i=this;this.nodeShot.active=t,null!=this.circleTween&&(this.circleTween.stop(),this.circleTween=null),this.nodeShot.eulerAngles=new d(0,0,0),t&&(this.circleTween=this.addTween(0,4,2,(function(t,e){i.nodeShot.eulerAngles=new d(0,0,e<=1?-e*i.curChapterStateCfg.launch_angle:e<=3?(e-2)*i.curChapterStateCfg.launch_angle:(4-e)*i.curChapterStateCfg.launch_angle)})).loop(-1).start())},V.updateChapter=function(){this.txtChapter.string=I.formatStrWithMirrorDeal(GetLanguage(200797),this.curChapter);var t=u.formatStr("%sm",this.curChapterStateCfg.distance);this.txtDistance.string=I.formatStrWithMirrorDeal(GetLanguage(203963),t),this.updateChapterUnit()},V.updateWind=function(){var t;t=0==this.curChapterStateCfg.wind_direction?w.getRandomInt(0,2):1==this.curChapterStateCfg.wind_direction?0:1,this.nodeWindTip.eulerAngles=new d(0,0,t<=0?180:0);var i=w.getRandomInt(this.curChapterStateCfg.wind_power[0],this.curChapterStateCfg.wind_power[1]+1),e=Math.floor(i/1e3)/10;this.txtWind.string=u.formatStr("%sm/s",e);var n=e*v*6,o=new c(t<=0?-n:n,0);g.instance.gravity=o},V.updateChapterUnit=function(){var t=this;this.unitItems||(this.unitItems=[]);for(var i=this.curChapterStateCfg.template,e=0,n=function(n){var o=i[n],h=o[0];null==t.getUnitInfoById(h)&&(t.unitIdToInfo[h]={id:h,unit_id:0,hp:1,max_hp:1,ext:[]});var s=t.unitItems[e]||t.newUnitItem();s.id=h,s.node.active=!0,s.node.name=String(h),s.effect&&(t.removeUIEffect(s.effect),s.effect=null),s.effect=t.addUIEffect(u.formatStr("prefab/ui-effect/%s",o[4]),s.nodeEffect,-1,null,t.curChapterStateCfg.scale/1e4,(function(i){var e=i.node;s.spine=e.getComponent(T);var n=o[2];s.spine.needAnimation=0!=n?"run":"idle",i.node.getComponent(S).on(p.END_CONTACT,t.onEndContactTarget,t);var h=e.getComponent(l);s.rig=h,h.linearVelocity=new c(0,0);var r=o[3];i.dir=0==r?-1:1;var a=new c(0==r?-n:n,0);h.scheduleOnce((function(){h.applyForceToCenter(a,!0)}))})),s.node.position=new d(o[1][0],o[1][1],0),t.updateSingleUnit(s),t.unitItems[e]=s,e+=1},o=0;o<i.length;o++)n(o);for(var h=e;h<this.unitItems.length;h++)this.hideUnitItem(this.unitItems[h])},V.newUnitItem=function(){var t=nodeInstantiate.instantiate(this.nodeUnitItem);return t.parent=this.nodeUnitParent,{node:t,nodeTx:C.findChild(t,"tx"),nodeEffect:C.findChild(t,"effect")}},V.getUnitInfoById=function(t){return this.unitIdToInfo[t]},V.updateSingleUnitById=function(t){var i=this.getUnitItemById(t);null!=i&&this.updateSingleUnit(i)},V.getUnitItemById=function(t){if(null!=this.unitItems)for(var i=0;i<this.unitItems.length;i++){var e=this.unitItems[i];if(e.id&&e.id==t)return e}},V.updateSingleUnit=function(t){var i=this.getUnitInfoById(t.id);(i?i.hp:1)<=0?this.hideUnitItem(t):t.node.acitve=!0},V.trySetShottingItem=function(t,i,e){var n=this;this.curShottingItem&&(this.removeUIEffect(this.curShottingItem),this.curShottingRig=null,this.curShottingItem=null);var o=this.utShottingParent.convertToNodeSpaceAR(i);this.isMoving=!0,this.useStep=this.useStep+1,this.updateResShow(),this.curShottingItem=this.addUIEffect("prefab/ui-effect/MX_loopy_zidan",this.nodeShottingParent,-1,new c(o.x,o.y),this.curChapterStateCfg.scale/1e4,(function(i){n.curShottingRig=i.node.getComponent(l),i.node.getComponent(f).on(p.BEGIN_CONTACT,n.onBeginContact,n);i.node.getComponent(T);var o=new c(t.x*n.curChapterStateCfg.launch_power/10,t.y*n.curChapterStateCfg.launch_power/10);n.curShottingRig.scheduleOnce((function(){n.curShottingRig.linearVelocity=new c(0,0),n.curShottingRig.angularVelocity=10,i.node.active=!0,i.node.eulerAngles=new d(0,0,e),n.curShottingRig.scheduleOnce((function(){n.curShottingRig.applyForceToCenter(o,!0)}))})),n.addTimer(.5,1,(function(){n.isMovingOn=!0}))}))},V.onBeginContact=function(t,i){var e=this,n=i.node.name;if("edge1"==n||"edge2"==n||"edge3"==n)return this.curShottingRig.angularVelocity=0,this.curShottingRig.linearVelocity=new c(0,0),void this.curShottingRig.scheduleOnce((function(){e.onMoveEnd()}));var o=Number(i.node.parent.parent.name);if(null!=o){var h=this.getUnitItemById(o);h&&(h.rig.linearVelocity=new c(0,0),this.curShottingRig.angularVelocity=0,this.curShottingRig.linearVelocity=new c(0,0),h.spine.setAnimation(0,"skill1",!1),h.spine.addAnimation(0,"idle",!0),this.touchList.push({k:o,v:1}),this.isWatingEnd=!0,this.curShottingRig.scheduleOnce((function(){e.curShottingRig.node.active=!1})),this.addTimer(.7,1,(function(){e.onMoveEnd()})))}},V.onEndContactTarget=function(t,i){var e=i.node.name;if("edge1"==e||"edge2"==e){var n=Number(t.node.parent.parent.name),o=this.getUnitItemById(n),h=this.getUIEffect(o.effect);h.dir=-h.dir}},V.onBeforeClose=function(){if(g.instance.gravity=new c(0,-10),this.isWatingEnd=!1,this.isMoving=!1,this.isMovingOn=!1,this.unitIdToInfo={},this.usingShotCfg=null,this.touchList=[],this.curShottingRig=null,this.curShottingItem=null,this.time=0,this.endTime=0,this.useStep=0,this.trySetShotTween(!1),this.unitItems)for(var t=0;t<this.unitItems.length;t++)this.hideUnitItem(this.unitItems[t])},V.hideUnitItem=function(t){t.spine=null,this.removeUIEffect(t.effect),t.rig.linearVelocity=new c(0,0),t.id=null,t.node.active=!1},V.onDestroy=function(){if(this.unitItems)for(var t=0;t<this.unitItems.length;t++)this.unitItems[t].node.destroy();this.unitItems=null},V.updateTime=function(){var t=I.formatStrWithMirrorDeal(GetLanguage(200043),y.formatTimeStringForSecond(Math.max(0,this.endTime-y.serverTime)));m.uiMirror&&(t=y.formatTimeStringForSecond(Math.max(0,this.endTime-y.serverTime))),this.txtTime.string=t},V.onUpdate=function(t){this.time=this.time+t,!this.isWatingEnd&&this.isMoving&&this.curShottingRig&&0==this.curShottingRig.node.active&&(this.curShottingRig.node.active=!0),this.time<1||(this.time=0,0!=this.endTime&&this.updateTime())},V.onMoveEnd=function(){if(this.isMoving){for(var t=[],i={},e=0;e<this.touchList.length;e++){var n=this.touchList[e];i[n.k]||(i[n.k]=0),i[n.k]=i[n.k]+n.v}for(var o in i)t.push({k:Number(o),v:i[o]});this.isMoving=!1,this.isMovingOn=!1,this.isWatingEnd=!1,this.trySetShotTween(!0),this.removeUIEffect(this.curShottingItem),this.curShottingRig=null,this.curShottingItem=null,this.touchList=[],this.updateWind();for(var h=0;h<t.length;h++){var s=t[h].k;t[h].v;this.unitIdToInfo[s].hp=0,this.updateSingleUnitById(s)}var r=!0;for(var a in this.unitIdToInfo){if(this.unitIdToInfo[a].hp>0){r=!1;break}}for(var d=this.curChapterStateCfg.star_step,u=0,c=0;c<d.length;c++)if(this.useStep<=d[c]){u=3-c;break}r?IS(A).send_24_122(this.curChapter,O[u]):this.useStep>=this.curChapterStateCfg.limit&&IS(A).send_24_122(this.curChapter,0)}},V.updateResShow=function(){var t=this.curChapterStateCfg.limit-this.useStep;this.txtResNum.string=u.formatStr("<b><outline color=#000000 width=1><color=#ffd659>%s</color><color=#ffffff>/%s</color></outline></b>",t,this.curChapterStateCfg.limit)},V.updateInfo=function(t){t.type==R.LoopyArchery&&t.state!=M.Open&&this.close()},V.OnLoopyChapterResult=function(t,i){i==this.curChapter&&(IS(A).send_24_120(),uiMgr.openView("ActivityLoopyGameResultView",{result:t}))},V.onSlingShotClick=function(){if(!(this.isMoving||this.useStep>=this.curChapterStateCfg.limit)){var t=this.nodeShot.eulerAngles.z+90,i=new c(Math.cos(t*(Math.PI/180)),Math.sin(t*(Math.PI/180)));this.trySetShottingItem(i,this.nodeShottingPoint.worldPosition,t),this.trySetShotTween(!1),this.isMoving=!0}},e}(V));e._RF.pop()}}}));

