System.register("chunks:///_virtual/MysteryMineView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./AudioMgr.ts","./index3.ts","./NodeUtil.ts","./StringUtil.ts","./TimeUtil.ts","./index57.ts","./BaseView.ts","./ConfigGlobal.ts","./MathUtil.ts","./AdDefine.ts","./AdModel.ts","./BagDefine.ts","./BagModel.ts","./MessageView.ts","./GainBuffDataCache.ts","./GainBuffDefine.ts","./MainViewModel.ts","./PrivilegeDataCache.ts","./PrivilegeDefine.ts","./RoleDefine.ts","./MysteryControl.ts","./MysteryDataCache.ts","./MysteryDefine.ts","./MysteryModel.ts","./EaseMethod.ts","./UIDefine.ts"],(function(t){"use strict";var e,o,i,n,s,r,a,d,c,h,l,u,f,m,I,v,y,p,g,T,C,B,S,w,k,M,b,R,_,P,E,L,A,x,G,N,O,D,F,U,K,V,j;return{setters:[function(t){e=t.inheritsLoose,o=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy,n=t.Button,s=t.Label,r=t.Node,a=t.UITransform,d=t.Vec3,c=t.Vec2,h=t.js,l=t.sys,u=t.Sprite,f=t.ProgressBar},function(t){m=t.audioMgr},null,function(t){I=t.default},function(t){v=t.default},function(t){y=t.default},null,function(t){p=t.BaseView},function(t){g=t.ConfigGlobal},function(t){T=t.default},function(t){C=t.ADS_TYPE,B=t.AdEventDefine},function(t){S=t.AdModel},function(t){w=t.BagEventDefine},function(t){k=t.BagModel},function(t){M=t.default},function(t){b=t.GainBuffDataCache},function(t){R=t.GainBuffEventDefine,_=t.GainBuffType,P=t.GainBuff},function(t){E=t.MainViewModel},function(t){L=t.PrivilegeDataCache},function(t){A=t.PrivilegeCardEffect},function(t){x=t.RoleEventDefine,G=t.PlayerAttr},function(t){N=t.default},function(t){O=t.MysteryDataCache},function(t){D=t.MysteryEventDefine,F=t.mine_row_count,U=t.mine_colomn_count},function(t){K=t.MysteryModel},function(t){V=t.EasingMethod},function(t){j=t.PanelTabType}],execute:function(){i._RF.push({},"c0173i4E6BF5b5z9HeFC5oQ","MysteryMineView",void 0);var H=g.word_stay_time/1e3,W=[{key:"Axe",goodsGtid:g.mine_pickaxe,adCfgId:C.AD_MINE_PICKAXE,lang:200696},{key:"Drill",goodsGtid:g.mine_drill,adCfgId:C.AD_MINE_DRILL,lang:200697},{key:"Boom",goodsGtid:g.mine_bomb,adCfgId:C.AD_MINE_BOMB,lang:200698}],X={Axe:"prefab/ui-effect/MX_tx_jiayuan_gaozi",Drill:"prefab/ui-effect/MX_tx_jiayuan_zuantou",Boom:"prefab/ui-effect/MX_tx_jiayuan_zhadan"},Y={Axe:"home_wakuang",Drill:"home_zuantou",Boom:"home_zhadan"},q=1,z=2,J=3,Q=4,Z=5,$=6,tt=7,et=[1,2],ot=g.mine_auto_open,it=(t("default",function(t){function i(){var e;return(e=t.call(this)||this).bottomOprateItems=void 0,e.curSelectKey=void 0,e.isMoving=void 0,e.isContentMoving=void 0,e.txtResNum=void 0,e.txtAxeNum=void 0,e.txtRecoverTime=void 0,e.txtBaseLine=void 0,e.nextRecoverTime=void 0,e.time=void 0,e.nodeBaseLine=void 0,e.nodeContet=void 0,e.utContent=void 0,e.nodeBlockRoot=void 0,e.nodeEmptyItem=void 0,e.nodeWoodItem=void 0,e.nodeStoneItem=void 0,e.nodeSpaceRoot=void 0,e.nodeSpaceItem=void 0,e.nodeGroupRoot=void 0,e.nodeGroupItem=void 0,e.nodeMaskRoot=void 0,e.nodeMaskItem=void 0,e.nodeSpecialBuff=void 0,e.nodeBuff=void 0,e.updatebufftime=void 0,e.typeToPool=void 0,e.curBaseLine=void 0,e.beginPosY=void 0,e.blockToItemInfo=void 0,e.isAutoMove=void 0,e.moveTween=void 0,e.curMoveCount=void 0,e.curPlayTypeStr=void 0,e.curPlayPos=void 0,e.dirllTween=void 0,e.effectTimer=void 0,e.moveTimer=void 0,e.needIgnoreNextUse=!1,e.nodeResParent=void 0,e.nodeResItem=void 0,e.resItems=void 0,e.nodeContentResRoot=void 0,e.nodeContentResItem=void 0,e.nodeEffectRoot=void 0,e.blockIdToFloopItems=void 0,e.nodeFlyRoot=void 0,e.utFlyRoot=void 0,e.nodeFlyItem=void 0,e.nodeMineItem=void 0,e.nodeAxeItem=void 0,e.blockIdToFlyResList=void 0,e.lastUpdateTime=0,e.blockIdToReward=void 0,e.name="MysteryMineView",e.url="ui/module/mystery/MysteryMineView",e.fullScreen=!0,e}e(i,t);var f=i.prototype;return f.onInit=function(){var t=this;this.curSelectKey="",this.nextRecoverTime=0,this.time=0,this.blockToItemInfo={},this.isAutoMove=!1,this.isContentMoving=!1,this.blockIdToReward={};var e=this.findChild("btnGuide");this.addComponentCallbackListener(e,n.EventType.CLICK,(function(){uiMgr.openView("MysteryTipsView")}));var o=this.findChild("btnClose");this.addComponentCallbackListener(o,n.EventType.CLICK,(function(){t.onCloseClick()}));var i=this.findChild("btnAuto");this.addComponentCallbackListener(i,n.EventType.CLICK,(function(){IS(O).baseLine<ot&&IS(L).getPrivilegeCardValue(A.AUTO_MINE)<=0?M.showFlyTip(v.formatStrWithMirrorDeal(GetLanguage(201469),ot)):uiMgr.openView("MysteryAutoView")})),this.nodeResParent=this.findChild("resRoot2"),this.nodeResItem=this.findChild("resRoot2/resItem"),this.nodeResItem.active=!1,this.initResShow(),this.nodeMineItem=this.findChild("resRoot/resItem1"),this.txtResNum=this.findChildComponent("resRoot/resItem1/txtNum",s),this.addComponentCallbackListener(this.nodeMineItem,n.EventType.CLICK,(function(){IS(k).OpenItemTips(1007,t.txtResNum.node)})),this.nodeAxeItem=this.findChild("resRoot/resItem2"),this.txtAxeNum=this.findChildComponent("resRoot/resItem2/txtNum",s),this.addComponentCallbackListener(this.nodeAxeItem,n.EventType.CLICK,(function(){IS(k).OpenItemTips(4001,t.txtAxeNum.node)})),this.txtRecoverTime=this.findChildComponent("resRoot/resItem2/txtTime",s),this.txtBaseLine=this.findChildComponent("line/txtDepth",s),this.nodeBaseLine=this.findChild("line"),this.nodeContet=this.findChild("scrollMineList/view/content"),this.addComponentCallbackListener(this.nodeContet,r.EventType.TOUCH_START,(function(){t.onContentTouchStart()})),this.addComponentCallbackListener(this.nodeContet,r.EventType.MOUSE_DOWN,(function(){t.onContentTouchStart()})),this.addComponentCallbackListener(this.nodeContet,r.EventType.TOUCH_MOVE,(function(e){t.onContentTouchMove(e)})),this.addComponentCallbackListener(this.nodeContet,r.EventType.MOUSE_MOVE,(function(e){t.onContentTouchMove(e)})),this.addComponentCallbackListener(this.nodeContet,r.EventType.TOUCH_END,(function(e){t.onContentTouchEnd(e)})),this.addComponentCallbackListener(this.nodeContet,r.EventType.TOUCH_CANCEL,(function(e){t.onContentTouchEnd(e)})),this.addComponentCallbackListener(this.nodeContet,r.EventType.MOUSE_UP,(function(e){t.onContentTouchEnd(e)})),this.utContent=this.nodeContet.getComponent(a),this.nodeBlockRoot=this.findChild("scrollMineList/view/content/BlockRoot"),this.nodeEmptyItem=this.findChild("scrollMineList/view/content/BlockRoot/emptyItem"),this.nodeEmptyItem.active=!1,this.nodeWoodItem=this.findChild("scrollMineList/view/content/BlockRoot/woodItem"),this.nodeWoodItem.active=!1,this.nodeStoneItem=this.findChild("scrollMineList/view/content/BlockRoot/stoneItem"),this.nodeStoneItem.active=!1,this.nodeSpaceRoot=this.findChild("scrollMineList/view/content/SpaceRoot"),this.nodeSpaceItem=this.findChild("scrollMineList/view/content/SpaceRoot/spaceItem"),this.nodeSpaceItem.active=!1,this.nodeGroupRoot=this.findChild("scrollMineList/view/content/GroupRoot"),this.nodeGroupItem=this.findChild("scrollMineList/view/content/GroupRoot/groupItem"),this.nodeGroupItem.active=!1,this.nodeMaskRoot=this.findChild("scrollMineList/view/content/MaskRoot"),this.nodeMaskItem=this.findChild("scrollMineList/view/content/MaskRoot/maskItem"),this.nodeMaskItem.active=!1,this.nodeContentResRoot=this.findChild("floopResRoot"),this.nodeContentResItem=this.findChild("floopResRoot/resItem"),this.nodeContentResItem.active=!1,this.nodeEffectRoot=this.findChild("effectRoot"),this.nodeFlyRoot=this.findChild("flyRoot"),this.utFlyRoot=this.nodeFlyRoot.getComponent(a),this.nodeFlyItem=this.findChild("flyRoot/flyItem"),this.nodeFlyItem.active=!1,this.nodeSpecialBuff=this.findChild("SpecialBuff"),this.bottomOprateItems={};for(var c=function(e){var o=W[e].key,i=W[e].goodsGtid,a=W[e].adCfgId,c=t.findChild(h.formatStr("bottomBtns/btn%s",o)),l=I.findChild(c,"normal"),u=I.findChild(c,"move");u.active=!1,t.addComponentCallbackListener(c,n.EventType.CLICK,(function(){t.onBottomBtnClick(o)})),t.addComponentCallbackListener(c,r.EventType.TOUCH_START,(function(){t.onTouchStart(o)})),t.addComponentCallbackListener(c,r.EventType.MOUSE_DOWN,(function(){t.onTouchStart(o)})),t.addComponentCallbackListener(c,r.EventType.TOUCH_MOVE,(function(e){t.onTouchMove(o,e)})),t.addComponentCallbackListener(c,r.EventType.MOUSE_MOVE,(function(e){t.onTouchMove(o,e)})),t.addComponentCallbackListener(c,r.EventType.TOUCH_END,(function(e){t.onTouchEnd(o,e)})),t.addComponentCallbackListener(c,r.EventType.TOUCH_CANCEL,(function(e){t.onTouchEnd(o,e)})),t.addComponentCallbackListener(c,r.EventType.MOUSE_UP,(function(e){t.onTouchEnd(o,e)}));var f=I.findChild(l,"imgError");f.active=!1;var m=I.findChild(u,"imgError");m.active=!1;var v=t.findChild(h.formatStr("scrollMineList/view/content/PreviewRoot/%sItem",o));v.active=!1;var y=t.findChild(h.formatStr("bottomBtns/btn%sAd",o));t.addComponentCallbackListener(y,n.EventType.CLICK,(function(){t.onAdClick(o)})),t.findChild(h.formatStr("bottomBtns/btn%sAd/imgAd",o)).active=1==g.ads_icon_is_show;var p=I.findChildComponent(y,"txtCount",s);p.node.position=1==g.ads_icon_is_show?new d(16,-13,0):new d(0,-13,0),t.bottomOprateItems[o]={node:c,nodeSelect:I.findChild(c,"imgSelect"),nodeNormal:l,nodeMove:u,goodsGtid:i,txtNum:I.findChildComponent(l,"txtNum",s),txtMoveNum:I.findChildComponent(u,"txtNum",s),nodeError:m,nodeNormalError:f,oriNormalPos:u.getPosition(),nodePreView:v,nodePreRight:I.findChild(v,"right"),nodePreError:I.findChild(v,"error"),nodeAd:y,txtAdDesc:I.findChildComponent(y,"txtDesc",s),txtAdCount:p,key:o,adCfgId:a,lang:GetLanguage(W[e].lang)}},l=0;l<W.length;l++)c(l);this.typeToPool={}},f.initResShow=function(){var t=this;this.resItems=new Array;for(var e=function(e){var o=nodeInstantiate.instantiate(t.nodeResItem);o.parent=t.nodeResParent,o.active=!0;var i=et[e];t.addComponentCallbackListener(o,n.EventType.CLICK,(function(){IS(E).TryJumpToMainViewPanel(j.Main_Shop,j.Shop_Gem,1==i?[1]:[0]),t.close()}));var r=configGoods.getDataByKey(i),a=I.findChildComponent(o,"imgIcon",u);t.loadIcon(a,"icon_item",r.icon),t.resItems.push({node:o,txtNum:I.findChildComponent(o,"txtNum",s),goodsGtid:i})},o=0;o<et.length;o++)e(o)},f.getResNodeByResId=function(t){for(var e in this.resItems)if(this.resItems[e].goodsGtid==t)return this.resItems[e].node},f.registerUpdateHandler=function(){this.addEvent(x.ROLE_RES_UPDATE,this.onRoleResUpdate,this),this.addEvent(w.GOODS_INFO_UPDATE,this.onGoodsInfoUpdate,this),this.addEvent(D.AXE_RECOVER_UPDATE,this.onAxeRecoverUpdate,this),this.addEvent(D.MINE_INFO_UPDATE,this.onMineInfoUpdate,this),this.addEvent(D.MINE_BLOCK_GET_REWARD,this.onMineBlockGetReward,this),this.addEvent(B.AD_INFO_UPDATE,this.onAdInfoUpdate,this),this.addEvent(R.GAINBUFF_INFO_UPDATE,this.onGainBuffUpdate,this),this.addEvent(D.MINE_INFO_BACK,this.onMineInfoBack,this),this.addEvent(D.MINE_AUTO_BACK,this.onMineAutoBack,this)},f.onAfterOpen=function(){this.isMoving=!1,this.isAutoMove=!1,this.curSelectKey="Axe",this.isContentMoving=!1,this.utContent.height=840,this.nodeContet.setPosition(new d(-360,0,0)),this.updateSelectShow(),this.updateResShow(),this.updateAxeShow(),this.updateAdShow(),this.updateBottomBtns(),this.curBaseLine=IS(K).getBaseLine(),this.beginPosY=this.curBaseLine>=F-1?this.curBaseLine-(F-2):1;var t=this.curBaseLine>=F-1?this.curBaseLine+1:F;this.showBlockList(this.beginPosY,t),this.updateBaseLine(),this.onGainBuffUpdate()},f.onGainBuffUpdate=function(){var t={},e=IS(b).gain_buff_info[_.MineBuff];if(e){this.nodeSpecialBuff.active=!0;for(var i,n=o(e);!(i=n()).done;){var s=i.value;t[s.k]=s.v}this.nodeBuff=new P(this.nodeSpecialBuff,this,_.MineBuff);var r=configSpecil_buff.getDataByKey(_.MineBuff);if(this.loadIcon(this.nodeBuff.icon,"icon_buff",r.state_icon),r.time>0){if(this.nodeBuff.nodeTime.active=!0,this.updatebufftime=t[2]-y.serverTime,this.updatebufftime<=0)return void(this.nodeSpecialBuff.active=!1);this.nodeBuff.txtTime.string=y.formatTimeForSecond(t[2]-y.serverTime)}else this.nodeBuff.nodeTime.active=!1;r.quantity>0?(t[1]<=0&&(this.nodeSpecialBuff.active=!1),this.nodeBuff.txtNum.node.active=!0,this.nodeBuff.txtNum.string=t[1]+"/"+r.quantity):this.nodeBuff.txtNum.node.active=!1}else this.nodeSpecialBuff.active=!1},f.onMineInfoBack=function(){},f.onMineAutoBack=function(t,e,o){var i=this;this.addUIEffect("prefab/ui-effect/MX_tx_jiayuan_zhadan2",this.nodeEffectRoot,1,new c(360,-390),1),this.addTimer(1,1,(function(){i.recycleAll(),uiMgr.openView("MysteryAutoResultView",t,e,o),i.onAfterOpen()}))},f.updateResShow=function(){for(var t=0;t<this.resItems.length;t++)this.resItems[t].txtNum.string=v.GetNumString(IS(k).getGoodsCountByGoodsGtid(this.resItems[t].goodsGtid));this.txtResNum.string=v.GetNumString(IS(k).getGoodsCountByGoodsGtid(g.mine_ore))},f.updateSingleResShow=function(t){for(var e,o=0;o<this.resItems.length;o++)(e=this.resItems[o].goodsGtid)==t&&(this.resItems[o].txtNum.string=v.GetNumString(IS(k).getGoodsCountByGoodsGtid(e)))},f.updateMineOreShow=function(){this.txtResNum.string=v.GetNumString(IS(k).getGoodsCountByGoodsGtid(g.mine_ore))},f.updateAxeShow=function(){var t=IS(K).getAxeNumInfo(),e=IS(k).getGoodsCountByGoodsGtid(4001),o=t.maxAxeNum;if(this.txtAxeNum.string=h.formatStr("%s/%s",e,o),e>=o)return this.txtRecoverTime.node.active=!1,void(this.nextRecoverTime=0);this.txtRecoverTime.node.active=!0,this.nextRecoverTime=t.nextRecoverTime,this.refreshTimeShow()},f.onUpdate=function(t){this.updatebufftime>0&&(this.updatebufftime=this.updatebufftime-t,this.updatebufftime<=0&&(this.updatebufftime=0,this.nodeSpecialBuff.active=!1),this.nodeBuff.txtTime.string=y.formatTimeForSecond(this.updatebufftime)),0!=this.nextRecoverTime&&(this.time=this.time+t,this.time<1||(this.time=0,this.refreshTimeShow()))},f.refreshTimeShow=function(){if(!(this.nextRecoverTime<=0)){var t=this.nextRecoverTime-y.serverTime;this.txtRecoverTime.string=y.formatTimeForSecond(t)}},f.updateAdShow=function(){for(var t in this.bottomOprateItems){var e=this.bottomOprateItems[t];this.updateSingleAdInfo(e.txtAdDesc,e.txtAdCount,e.adCfgId)}},f.updateSingleAdInfo=function(t,e,o){var i=configAds.getDataByKey(o),n=IS(S).getAdWatchCount(o);t.string=v.formatStrWithMirrorDeal(i.desc,IS(S).getAdRewardValue(o)),e.string=h.formatStr("(%s/%s)",i.times-n,i.times)},f.updateBottomBtns=function(){var t;for(var e in this.bottomOprateItems){var o=this.bottomOprateItems[e];t=IS(k).getGoodsCountByGoodsGtid(o.goodsGtid),o.txtNum.string=t,o.txtMoveNum.string=t,o.node.active=t>0,o.nodeAd.active=t<=0}},f.updateSelectShow=function(){for(var t in this.bottomOprateItems)this.bottomOprateItems[t].nodeSelect.active=t==this.curSelectKey},f.setOprateErrorTip=function(t){this.bottomOprateItems[this.curSelectKey].nodeError.active=t,this.bottomOprateItems[this.curSelectKey].nodePreError.active=t,this.bottomOprateItems[this.curSelectKey].nodePreRight.active=!t,this.bottomOprateItems[this.curSelectKey].nodeNormalError.active=t},f.showBlockList=function(t,e){for(var o,i,n,s,r,a=!1,d=t;d<=e;d++)for(var c=1;c<=U;c++){o=100*d+c;var h=IS(K).getBlockInfo(o),l=configMine_grid.getDataByKey(h.config_id);if(l.num<=0&&""==l.icon&&null==IS(K).getSpeBgbyBlockCfgId(h.config_id))this.tryAddMask(h);else if(l.num<=0)this.addBlockItem(h,q),this.tryAddMask(h);else if(!(l.num>0&&h.count<=0)){if(l.num<=1&&this.addBlockItem(h,z),l.num>=2&&this.addBlockItem(h,J),this.tryAddMask(h),r=!1,a=!1,c+1<=U){i=100*d+c+1;var u=IS(K).getBlockInfo(i);configMine_grid.getDataByKey(u.config_id).num==l.num&&u.count>0&&(this.addBlockItem(h,Q,{includeIds:[o,i]}),r=!0)}n=100*(d+1)+c;var f=IS(K).getBlockInfo(n);if(configMine_grid.getDataByKey(f.config_id).num==l.num&&f.count>0&&(this.addBlockItem(h,Z,{includeIds:[o,n]}),a=!0),r&&a){s=100*(d+1)+c+1;var m=IS(K).getBlockInfo(s);configMine_grid.getDataByKey(m.config_id).num==l.num&&m.count>0&&this.addBlockItem(h,$,{includeIds:[o,i,n,s]})}}}},f.tryAddMask=function(t){IS(K).checkBlockActive(t.id)||this.addBlockItem(t,tt)},f.addBlockItem=function(t,e,o){var i=t.id;null==this.blockToItemInfo[i]&&(this.blockToItemInfo[i]={}),this.recycleBlockItemByType(i,e,!0),this.blockToItemInfo[i][e]={item:this.tryGetItem(e),otherInfo:o},this.blockToItemInfo[i][e].item.show(t),this.setItemPos(e,this.blockToItemInfo[i][e].item,i,o)},f.setItemPos=function(t,e,o,i){var n;if(t==q||t==z||t==J||t==tt)n=this.getPosByBlockId(o);else{for(var s=0,r=0,a=i.includeIds.length,d=0;d<a;d++){var c=this.getPosByBlockId(i.includeIds[d]);s+=c.x,r+=c.y}n={x:s/a,y:r/a}}e.setPos(n.x,n.y)},f.getPosByBlockXY=function(t,e){return{x:60+120*(t-1),y:-60-120*(e-this.beginPosY)}},f.getPosByBlockId=function(t){var e=Math.floor(t/100),o=t-100*e;return this.getPosByBlockXY(o,e)},f.getBlockIdByPos=function(t,e){var o=Math.ceil(t/120);if(!(o<1||o>U)){var i=Math.ceil(-e/120);if(!(i<1||i>F))return 100*(this.beginPosY+i-1)+o}},f.updateBaseLine=function(t){var e=null!=t?t:this.curBaseLine;this.nodeBaseLine.active=e>=6,this.txtBaseLine.string=h.formatStr("%sm",e)},f.onBeforeClose=function(){if(this.needIgnoreNextUse=!1,this.clearMoveTween(),this.clearDrillTween(),this.recycleAll(),this.curMoveCount=0,this.nextRecoverTime=0,this.time=0,this.blockIdToFloopItems){for(var t in this.blockIdToFloopItems)this.blockIdToFloopItems[t].tween.stop(),this.blockIdToFloopItems[t].node.destroy(),delete this.blockIdToFloopItems[t];this.blockIdToFloopItems={}}if(this.blockIdToFlyResList){for(var e in this.blockIdToFlyResList)this.clearFlyRes(Number(e));this.blockIdToFlyResList={}}this.blockIdToReward={}},f.onDestroy=function(){for(var t in this.recycleAll(),this.typeToPool){for(var e=0;e<this.typeToPool[t].length;e++)this.typeToPool[t][e].destroy();delete this.typeToPool[t]}this.typeToPool=null},f.recycleBlockItemByType=function(t,e,o){var i=this.blockToItemInfo[t];if(null!=i){for(var n in i)if(Number(n)==e){this.recycleItem(e,i[e].item,o);break}delete this.blockToItemInfo[t][e]}},f.recycleBlockItemByTypeList=function(t,e,o){var i=this.blockToItemInfo[t];if(null!=i&&!(null==e||e.length<=0)){for(var n={},s=0;s<e.length;s++)n[e[s]]=!0;for(var r in i)n[Number(r)]&&this.recycleItem(Number(r),i[r].item,o);for(var a=0;a<e.length;a++)delete this.blockToItemInfo[t][e[a]]}},f.recycleByBlockId=function(t,e){var o=this.blockToItemInfo[t];if(null!=o){for(var i in o)null!=o[i]&&this.recycleItem(Number(i),o[i].item,e);delete this.blockToItemInfo[t]}},f.recycleAll=function(){for(var t in this.blockToItemInfo)for(var e in this.blockToItemInfo[t])this.recycleItem(Number(e),this.blockToItemInfo[t][e].item,!0);this.blockToItemInfo={}},f.recycleItem=function(t,e,o){e.hide(o),this.typeToPool[t].push(e)},f.tryShowBaseChange=function(){var t=this,e=IS(K).getBaseLine();if(e!=this.curBaseLine)if(e<=F-1)this.curBaseLine=e;else{var o=this.curBaseLine+2,i=e+1;this.showBlockList(o,i),this.isAutoMove=!0,this.utContent.height=840+120*(e-this.curBaseLine),this.clearMoveTween();var n=e-Math.max(F-1,this.curBaseLine);this.moveTween=this.addTween(this.nodeContet.position.y,120*n,.5*n,(function(e,o){t.nodeContet.position=new d(-360,o,0)})).delay(.1).call((function(){t.updateToNormal()})).start(),this.curMoveCount=0,this.moveTimer&&(this.removeTimer(this.moveTimer),this.moveTimer=null),this.moveTimer=this.addTimer(.5,n,(function(){t.curMoveCount=t.curMoveCount+1,t.updateBaseLine(Math.max(F-1,t.curBaseLine)+t.curMoveCount)}))}},f.updateToNormal=function(){this.isAutoMove=!1;this.curBaseLine;this.curBaseLine=IS(K).getBaseLine();var t,e=this.beginPosY;this.beginPosY=this.curBaseLine-(F-2);for(var o=e;o<this.beginPosY;o++)for(var i=1;i<=U;i++)t=100*o+i,this.recycleByBlockId(t,!0);for(var n in this.utContent.height=840,this.nodeContet.setPosition(new d(-360,0,0)),this.blockToItemInfo){var s=this.blockToItemInfo[n];for(var r in s){var a=s[r];null!=a&&this.setItemPos(Number(r),a.item,Number(n),a.otherInfo)}}},f.clearMoveTween=function(){null!=this.moveTween&&(this.moveTween.stop(),this.moveTween=null)},f.onRoleResUpdate=function(t){t==G.ROLE_ATTR_DIAMOND&&l.now()-this.lastUpdateTime<2||this.updateSingleResShow(t)},f.onGoodsInfoUpdate=function(t,e){4001==e&&this.updateAxeShow(),e==g.mine_ore&&l.now()-this.lastUpdateTime>=2&&this.updateMineOreShow(),this.updateBottomBtns()},f.onAxeRecoverUpdate=function(){this.updateAxeShow()},f.onMineInfoUpdate=function(t){var e=this;this.lastUpdateTime=l.now();var o=t.reward;if(null!=o)for(var i=0;i<o.length;i++){var n=o[i];this.blockIdToReward[n.id]=n.reward}var s=function(){e.needIgnoreNextUse=!1,e.curPlayTypeStr=null,e.curPlayPos=null;for(var o,i=t.actives||[],n=0;n<i.length;n++){o=i[n];var s=e.blockToItemInfo[o];if(null!=s)null!=s[tt]&&e.recycleBlockItemByType(o,tt)}for(var r=t.blocks||[],a=0;a<r.length;a++){var d=r[a];o=d.id,e.tryDeleteSpaceOrGroupItem(d);var c=e.blockToItemInfo[o];null!=c&&(null==c[q]?null==c[z]?null==c[J]||(d.count<=0?e.recycleBlockItemByType(o,J):c[J].item.show(d)):d.count<=0&&e.recycleBlockItemByType(o,z):c[q].item.show(d))}e.tryShowBaseChange()};if(this.curSelectKey="Axe",this.updateSelectShow(),null!=this.curPlayTypeStr)if(m.playSound(Y[this.curPlayTypeStr]),"Axe"!=this.curPlayTypeStr&&(this.needIgnoreNextUse=!0),"Drill"!=this.curPlayTypeStr)"Axe"==this.curPlayTypeStr?this.addUIEffect(X[this.curPlayTypeStr],this.nodeEffectRoot,.5,new c(this.curPlayPos.x+60,this.curPlayPos.y+60)):this.addUIEffect(X[this.curPlayTypeStr],this.nodeEffectRoot,.5,new c(this.curPlayPos.x,this.curPlayPos.y)),this.addTimer(.3,1,(function(){s()}));else{var r,a=this.addUIEffect(X[this.curPlayTypeStr],this.nodeEffectRoot,1,new c(this.curPlayPos.x,0)),d={};this.addTween(0,1,1,(function(t,o){var i=-840*o,n=Math.floor(i/120);d[n]||(r=e.getBlockIdByPos(e.curPlayPos.x,i),e.recycleBlockItemByTypeList(r,[J,z,tt]),e.tryDeleteSpaceOrGroupItem({id:r,count:0}),-7==n&&(e.recycleBlockItemByTypeList(r-1,[J,z,tt]),e.tryDeleteSpaceOrGroupItem({id:r-1,count:0}),e.recycleBlockItemByTypeList(r+1,[J,z,tt]),e.tryDeleteSpaceOrGroupItem({id:r+1,count:0})),d[n]=!0),e.setUIEffect(a,new c(e.curPlayPos.x,i))})).call((function(){s()})).start()}else s()},f.clearDrillTween=function(){null!=this.dirllTween&&(this.dirllTween.stop(),this.dirllTween=null)},f.tryDeleteSpaceOrGroupItem=function(t){for(var e in this.blockToItemInfo){var o=this.blockToItemInfo[e];if(null!=o[$])for(var i=o[$].otherInfo.includeIds,n=0;n<i.length;n++)if(i[n]==t.id){t.count<=0&&this.recycleBlockItemByType(Number(e),$);break}if(null!=o[Q])for(var s=o[Q].otherInfo.includeIds,r=0;r<s.length;r++)if(s[r]==t.id){t.count<=0&&this.recycleBlockItemByType(Number(e),Q);break}if(null!=o[Z])for(var a=o[Z].otherInfo.includeIds,d=0;d<a.length;d++)if(a[d]==t.id){t.count<=0&&this.recycleBlockItemByType(Number(e),Z);break}}},f.onMineBlockGetReward=function(t,e){this.lastUpdateTime=l.now(),e&&(this.blockIdToReward[e.id]=e.reward);var o=t.id,i=this.blockToItemInfo[o];if(null!=i){var n=i[q];if(null!=n){configMine_grid.getDataByKey(t.config_id);this.playFloopRes(o,n.item.node.position),this.playFlyRes(o,n.item.node.worldPosition),n.item.show(t)}}},f.onAdInfoUpdate=function(t){for(var e in this.bottomOprateItems){var o=this.bottomOprateItems[e];if(o.adCfgId==t){this.updateSingleAdInfo(o.txtAdDesc,o.txtAdCount,o.adCfgId);break}}},f.onCloseClick=function(){this.close()},f.onBottomBtnClick=function(t){var e=this.bottomOprateItems[t].goodsGtid;IS(k).getGoodsCountByGoodsGtid(e)<=0?M.showFlyTip(v.formatStrWithMirrorDeal(GetLanguage(200453),this.bottomOprateItems[t].lang)):(this.curSelectKey=t,this.updateSelectShow())},f.onTouchStart=function(t){var e=this.bottomOprateItems[t],o=e.goodsGtid;IS(k).getGoodsCountByGoodsGtid(o)<=0||(this.curSelectKey=t,this.isMoving=!0,e.nodeMove.active=!0,e.nodeNormal.active=!1,this.updateSelectShow())},f.onTouchMove=function(t,e){if(this.isMoving&&null!=e&&this.curSelectKey==t){var o=this.bottomOprateItems[this.curSelectKey],i=e.getUILocation(),n=new d(i.x,i.y,0);o.nodeMove.position=o.node.getComponent(a).convertToNodeSpaceAR(n);var s=this.utContent.convertToNodeSpaceAR(n),r=this.getBlockIdByPos(s.x,s.y);if(null==r)return o.nodePreView.active=!1,void this.setOprateErrorTip(!0);o.nodePreView.active=!0;var c=this.getPosByBlockId(r);if("Drill"==this.curSelectKey?o.nodePreView.setPosition(new d(c.x,-420,0)):o.nodePreView.setPosition(new d(c.x,c.y,0)),IS(k).getGoodsCountByGoodsGtid(o.goodsGtid)<=0)this.setOprateErrorTip(!0);else if(IS(K).checkBlockActive(r)){var h=IS(K).getBlockInfo(r);"Axe"==this.curSelectKey?this.setOprateErrorTip(h.count<=0):this.setOprateErrorTip(h.count>0)}else this.setOprateErrorTip(!0)}},f.onTouchEnd=function(t,e){if(this.isMoving&&this.curSelectKey==t){var o=e.getUILocation(),i=new d(o.x,o.y,0),n=this.bottomOprateItems[this.curSelectKey];n.nodeMove.position=n.oriNormalPos,n.nodeMove.active=!1,n.nodePreView.active=!1,n.nodeNormal.active=!0,this.isMoving=!1,this.setOprateErrorTip(!1);var s=this.utContent.convertToNodeSpaceAR(i),r=this.getBlockIdByPos(s.x,s.y);if(null!=r)if(this.needIgnoreNextUse)M.showFlyTip(GetLanguage(200457));else if(this.isAutoMove)M.showFlyTip(GetLanguage(200458));else if(IS(K).checkBlockActive(r)){var a=IS(K).getBlockInfo(r);if(!(a.count<=0&&1==a.is_reward))if(IS(k).getGoodsCountByGoodsGtid(n.goodsGtid)<=0)M.showFlyTip(v.formatStrWithMirrorDeal(GetLanguage(200453),n.lang));else if("Axe"==this.curSelectKey){if(a.count<=0)return void M.showFlyTip(GetLanguage(200460));this.curPlayTypeStr=this.curSelectKey,this.curPlayPos=this.getPosByBlockId(r),IS(N).reqMineUseGoods(n.goodsGtid,r)}else{if(a.count>0)return void M.showFlyTip(v.formatStrWithMirrorDeal(GetLanguage(200461),n.lang));this.curPlayTypeStr=this.curSelectKey,this.curPlayPos=this.getPosByBlockId(r),IS(N).reqMineUseGoods(n.goodsGtid,r)}}else M.showFlyTip(GetLanguage(200459))}},f.onAdClick=function(t){IS(S).tryWatchAd(this.bottomOprateItems[t].adCfgId)},f.onContentTouchStart=function(){this.isContentMoving=!0},f.onContentTouchMove=function(t){if(this.isContentMoving){var e=t.getUILocation(),o=new d(e.x,e.y,0),i=this.utContent.convertToNodeSpaceAR(o),n=this.bottomOprateItems[this.curSelectKey],s=this.getBlockIdByPos(i.x,i.y);if(null==s)n.nodePreView.active=!1,this.setOprateErrorTip(!1);else{n.nodePreView.active=!0;var r=this.getPosByBlockId(s);if("Drill"==this.curSelectKey?n.nodePreView.setPosition(new d(r.x,-420,0)):n.nodePreView.setPosition(new d(r.x,r.y,0)),IS(k).getGoodsCountByGoodsGtid(n.goodsGtid)<=0)return void this.setOprateErrorTip(!0);if(!IS(K).checkBlockActive(s))return void this.setOprateErrorTip(!0);var a=IS(K).getBlockInfo(s);"Axe"==this.curSelectKey?this.setOprateErrorTip(a.count<=0):this.setOprateErrorTip(a.count>0)}}},f.onContentTouchEnd=function(t){if(this.isContentMoving){var e=this.bottomOprateItems[this.curSelectKey];if(this.setOprateErrorTip(!1),e.nodePreView.active=!1,this.isContentMoving=!1,this.needIgnoreNextUse)M.showFlyTip(GetLanguage(200457));else if(this.isAutoMove)M.showFlyTip(GetLanguage(200458));else{var o=t.getUILocation(),i=new d(o.x,o.y,0),n=this.utContent.convertToNodeSpaceAR(i),s=this.getBlockIdByPos(n.x,n.y);if(null!=s){var r=IS(K).getBlockInfo(s);if(IS(K).checkBlockActive(s)){if(!(r.count<=0&&1==r.is_reward))if(IS(k).getGoodsCountByGoodsGtid(e.goodsGtid)<=0)M.showFlyTip(v.formatStrWithMirrorDeal(GetLanguage(200453),e.lang));else if("Axe"==this.curSelectKey){if(r.count<=0)return void M.showFlyTip(GetLanguage(200460));this.curPlayTypeStr=this.curSelectKey,this.curPlayPos=this.getPosByBlockId(s),IS(N).reqMineUseGoods(e.goodsGtid,s)}else{if(r.count>0)return void M.showFlyTip(v.formatStrWithMirrorDeal(GetLanguage(200461),e.lang));this.curPlayTypeStr=this.curSelectKey,this.curPlayPos=this.getPosByBlockId(s),IS(N).reqMineUseGoods(e.goodsGtid,s)}}else M.showFlyTip(GetLanguage(200459))}}}},f.playHideEffect=function(t,e){var o="prefab/ui-effect/MX_tx_jiayuan_shikuai"==t?.5:1;this.addUIEffect(t,this.nodeEffectRoot,1,new c(e.x,e.y),o)},f.playFloopRes=function(t,e){var o=this,i=this.blockIdToReward[t];if(!(null==i||i.length<=0)){var n=nodeInstantiate.instantiate(this.nodeContentResItem);n.parent=this.nodeContentResRoot;var r=I.findChildComponent(n,"imgIcon",u),a=I.findChildComponent(n,"txtNum",s),c=i[0].gtid,l=i[0].num,f=configGoods.getDataByKey(c);this.loadIcon(r,"icon_item",f.icon),a.string=h.formatStr("x%s",l);var m=e.x,v=e.y;n.position=new d(m,v,0),n.active=!0,null==this.blockIdToFloopItems&&(this.blockIdToFloopItems={}),this.blockIdToFloopItems[t]={node:n,tween:this.addTween(0,1,H,(function(t,e){n.position=new d(m,v+60*e,0)})).call((function(){o.blockIdToFloopItems[t]&&(o.blockIdToFloopItems[t].node.destroy(),delete o.blockIdToFloopItems[t])})).start()}}},f.playFlyRes=function(t,e){var o=this,i=this.blockIdToReward[t];if(!(null==i||i.length<=0)){var n=i[0].gtid,s=i[0].num;if(n==G.ROLE_ATTR_DIAMOND||n==g.mine_ore){var r=s>1?5:1,a=this.getTargetByResId(n),d=this.utFlyRoot.convertToNodeSpaceAR(e),c=this.utFlyRoot.convertToNodeSpaceAR(a);this.addFlyItem(t,n,d,c,1),r-1>0&&this.addTimer(.2,r-1,(function(){o.addFlyItem(t,n,d,c)})),this.addTimer(1+.2*(r-1),1,(function(){n==G.ROLE_ATTR_DIAMOND?o.updateSingleResShow(G.ROLE_ATTR_DIAMOND):o.updateMineOreShow(),o.clearFlyRes(t)}))}}},f.addFlyItem=function(t,e,o,i,n){var s=nodeInstantiate.instantiate(this.nodeFlyItem);s.parent=this.nodeFlyRoot;var r=s.getComponent(u),a=configGoods.getDataByKey(e);this.loadIcon(r,"icon_item",a.icon),s.active=!0,s.setPosition(o),null==this.blockIdToFlyResList&&(this.blockIdToFlyResList={}),null==this.blockIdToFlyResList[t]&&(this.blockIdToFlyResList[t]=new Array);var c={node:s,tween:this.addTween(0,1,1,(function(t,e){var n=new d(0,0,0);d.lerp(n,o,i,e),s.setPosition(n)})).call((function(){n&&1==n&&m.playSound("common_jinbitiao"),s.active=!1})).easing(V.BACK_IN).start()};this.blockIdToFlyResList[t].push(c)},f.clearFlyRes=function(t){if(null!=this.blockIdToFlyResList&&null!=this.blockIdToFlyResList[t]){for(var e=0;e<this.blockIdToFlyResList[t].length;e++)this.blockIdToFlyResList[t][e].node.destroy(),this.blockIdToFlyResList[t][e].tween.stop();delete this.blockIdToFlyResList[t]}},f.getTargetByResId=function(t){var e;switch(t){case 1:case 2:e=this.getResNodeByResId(t).worldPosition;break;case 1007:e=this.nodeMineItem.worldPosition;break;case 4001:e=this.nodeAxeItem.worldPosition;break;case 4002:e=this.bottomOprateItems.Drill.node.worldPosition;break;case 4003:e=this.bottomOprateItems.Boom.node.worldPosition}return e},f.tryGetItem=function(t){return this.typeToPool[t]||(this.typeToPool[t]=[]),this.typeToPool[t].length<=0?this.getNewItem(t):this.typeToPool[t].pop()},f.getNewItem=function(t){var e,o;return t==q?((o=nodeInstantiate.instantiate(this.nodeEmptyItem)).parent=this.nodeBlockRoot,e=new nt):t==z?((o=nodeInstantiate.instantiate(this.nodeWoodItem)).parent=this.nodeBlockRoot,e=new st):t==J?((o=nodeInstantiate.instantiate(this.nodeStoneItem)).parent=this.nodeBlockRoot,e=new rt):t==Q?((o=nodeInstantiate.instantiate(this.nodeSpaceItem)).parent=this.nodeSpaceRoot,e=new at):t==Z?((o=nodeInstantiate.instantiate(this.nodeSpaceItem)).setRotationFromEuler(0,0,90),o.parent=this.nodeSpaceRoot,e=new at):t==$?((o=nodeInstantiate.instantiate(this.nodeGroupItem)).parent=this.nodeGroupRoot,e=new dt):t==tt&&((o=nodeInstantiate.instantiate(this.nodeMaskItem)).parent=this.nodeMaskRoot,e=new ct),e.init(o,this),e},i}(p)),function(){function t(){this.view=void 0,this.node=void 0,this.imgBg=void 0,this.imgIcon=void 0,this.data=void 0}var e=t.prototype;return e.init=function(t,e){this.node=t,this.view=e,this.imgBg=I.findChildComponent(this.node,"imgBg",u),this.imgIcon=I.findChildComponent(this.node,"imgIcon",u)},e.hide=function(){this.node.active=!1},e.setPos=function(t,e){this.node.setPosition(new d(t,e,0))},e.destroy=function(){this.view=null,this.node.destroy()},t}()),nt=function(t){function o(){for(var e,o=arguments.length,i=new Array(o),n=0;n<o;n++)i[n]=arguments[n];return(e=t.call.apply(t,[this].concat(i))||this).blockId=void 0,e}e(o,t);var i=o.prototype;return i.init=function(e,o){var i=this;t.prototype.init.call(this,e,o),this.view.addComponentCallbackListener(this.imgIcon.node,n.EventType.CLICK,(function(){IS(N).reqHomeGetReward(i.blockId)}))},i.show=function(t){this.blockId=t.id,this.node.active=!0;var e=IS(K).getSpeBgbyBlockCfgId(t.config_id);if(this.view.loadIcon(this.imgBg,"icon_mystery",e),this.imgIcon.node.active=1==t.is_reward,1==t.is_reward){var o=configMine_grid.getDataByKey(t.config_id);this.view.loadIcon(this.imgIcon,"icon_mystery",o.icon)}},o}(it),st=function(t){function o(){return t.apply(this,arguments)||this}e(o,t);var i=o.prototype;return i.show=function(t){this.data=t,this.node.active=!0;var e=T.getRandomInt(1,4);this.view.loadIcon(this.imgBg,"icon_mystery",h.formatStr("jy_ICON_tu0%s",e));var o=configMine_grid.getDataByKey(t.config_id);this.imgIcon.node.active=""!=o.icon,""!=o.icon&&this.view.loadIcon(this.imgIcon,"icon_mystery",o.icon)},i.hide=function(e){if(!e){this.view.playHideEffect("prefab/ui-effect/MX_tx_jiayuan_tukuai",this.node.position);configMine_grid.getDataByKey(this.data.config_id);this.view.playFloopRes(this.data.id,this.node.position),this.view.playFlyRes(this.data.id,this.node.worldPosition)}t.prototype.hide.call(this)},o}(it),rt=function(t){function o(){for(var e,o=arguments.length,i=new Array(o),n=0;n<o;n++)i[n]=arguments[n];return(e=t.call.apply(t,[this].concat(i))||this).pbHp=void 0,e}e(o,t);var i=o.prototype;return i.init=function(e,o){t.prototype.init.call(this,e,o),this.pbHp=I.findChildComponent(this.node,"pbHp",f)},i.show=function(t){this.data=t,this.node.active=!0;var e=T.getRandomInt(1,4);this.view.loadIcon(this.imgBg,"icon_mystery",h.formatStr("jy_ICON_shi0%s",e));var o=configMine_grid.getDataByKey(t.config_id);this.imgIcon.node.active=t.count<o.num,this.pbHp.node.active=t.count<o.num,t.count<o.num&&(this.view.loadIcon(this.imgIcon,"icon_mystery",h.formatStr("jy_ICON_liewen0%s",e)),this.pbHp.progress=Math.min(1,t.count/o.num))},i.hide=function(e){if(!e){this.view.playHideEffect("prefab/ui-effect/MX_tx_jiayuan_shikuai",this.node.position);configMine_grid.getDataByKey(this.data.config_id);this.view.playFloopRes(this.data.id,this.node.position),this.view.playFlyRes(this.data.id,this.node.worldPosition)}t.prototype.hide.call(this)},o}(it),at=function(t){function o(){return t.apply(this,arguments)||this}e(o,t);var i=o.prototype;return i.init=function(e,o){t.prototype.init.call(this,e,o)},i.show=function(t){this.node.active=!0;var e=configMine_grid.getDataByKey(t.config_id);this.view.loadIcon(this.imgBg,"icon_mystery",e.num<=1?"jy_ICON_tulianjie":"jy_ICON_shilianjie"),this.view.loadIcon(this.imgIcon,"icon_mystery",e.num<=1?"jy_ICON_tulianjie02":"jy_ICON_shilianjie02")},o}(it),dt=function(t){function o(){return t.apply(this,arguments)||this}e(o,t);var i=o.prototype;return i.init=function(t,e){this.node=t,this.view=e,this.imgIcon=this.node.getComponent(u)},i.show=function(t){this.node.active=!0;var e=configMine_grid.getDataByKey(t.config_id);this.view.loadIcon(this.imgIcon,"icon_mystery",e.num<=1?"jy_ICON_tulianjie04":"jy_ICON_shilianjie04")},o}(it),ct=function(t){function o(){return t.apply(this,arguments)||this}e(o,t);var i=o.prototype;return i.init=function(t,e){this.node=t,this.view=e},i.show=function(t){this.node.active=!0},o}(it);i._RF.pop()}}}));

