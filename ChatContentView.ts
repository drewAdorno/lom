System.register("chunks:///_virtual/ChatContentView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TranslateMgr.ts","./StringUtil.ts","./TimeUtil.ts","./index57.ts","./ObjectUtil.ts","./ActivityControl.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./ActivityAutumnDefine.ts","./CommonDefine.ts","./GameSetting.ts","./GuildControl.ts","./GuildDataCache.ts","./GuildDefine.ts","./RoleDataCache.ts","./ChatControl.ts","./ChatDataCache.ts","./ChatDefine.ts","./ChatMessageItem.ts","./BaseSubView.ts"],(function(t){"use strict";var e,i,s,n,a,h,o,l,r,d,c,u,C,p,g,f,v,m,I,w,S,T,L,V,y,A,_,G,D,R,B,H,E,P,M;return{setters:[function(t){e=t.inheritsLoose},function(t){i=t.cclegacy,s=t.Label,n=t.Button,a=t.UITransform,h=t.Sprite,o=t.Widget,l=t.ScrollView,r=t.instantiate,d=t.js,c=t.Vec2,u=t.Vec3},function(t){C=t.TranslateMgr},function(t){p=t.default},function(t){g=t.default},null,function(t){f=t.default},function(t){v=t.default},function(t){m=t.default},function(t){I=t.ActivityEventDefine,w=t.ActivityType,S=t.ActivityState},function(t){T=t.ActivityAutumnEventDefine},function(t){L=t.CommonEventDefine},function(t){V=t.default,y=t.GameSettingKey},function(t){A=t.default},function(t){_=t.default},function(t){G=t.GuildEventDefine},function(t){D=t.RoleDataCache},function(t){R=t.default},function(t){B=t.ChatDataCache},function(t){H=t.ChatEventDefine,E=t.ChatDefine},function(t){P=t.ChatMessageItem},function(t){M=t.BaseSubView}],execute:function(){i._RF.push({},"ed9cd5ZiTRITbKFFs2mCGqP","ChatContentView",void 0);t("ChatContentView",function(t){function i(){var e;return(e=t.call(this)||this).privateTitle=void 0,e.guildHelp=void 0,e.guildHelpRed=void 0,e.noReadBtn=void 0,e.scrollView=void 0,e.goToChatBtn=void 0,e.scrollWidge=void 0,e.scrollTrans=void 0,e.noReadText=void 0,e.scrollViewGo=void 0,e.tempMessageItem=void 0,e.arrowBtn=void 0,e.shareItemPool=void 0,e.emptyNode=void 0,e.contentPos=void 0,e.contentTrans=void 0,e.updateByNext=void 0,e.contentSizeY=void 0,e.isScrollToEnd=void 0,e.oriTop=void 0,e.channel=void 0,e.needScrollToEnd=void 0,e.targetId=void 0,e.noReadNum=0,e.preHeight=void 0,e.update=void 0,e.shareItemPoolList={},e.chatList=void 0,e.guildQuestionView=void 0,e.guildQuesDiceSubView=void 0,e.auto_play_list=[],e.heightCalcTxtDict={},e.cacheShareNum=0,e.is_Block=void 0,e.isWaitHis=void 0,e.name="ChatContentView",e}e(i,t);var M=i.prototype;return M.onInit=function(){var t=this;this.InitTempItem(),this.privateTitle=this.findChildComponent("privateTitle",s),this.goToChatBtn=this.findChild("privateTitle/goToChatBtn"),this.shareItemPool=this.findChild("ShareItemPool"),this.addComponentCallbackListener(this.goToChatBtn,n.EventType.CLICK,(function(){t.parentView.showPrivateChatType()})),this.noReadText=this.findChildComponent("noReadBtn/Label",s),this.noReadBtn=this.findChild("noReadBtn"),this.addComponentCallbackListener(this.noReadBtn,n.EventType.CLICK,(function(){t.noReadBtn.active=!1,t.noReadNum=0,t.scrollView.scrollView.stopAutoScroll(),t.scrollView.scrollTo(t.chatList.length,-1)})),this.noReadBtn.active=!1,this.contentTrans=this.findChildComponent("ScrollView/view/content",a),this.emptyNode=this.findChild("empty"),this.loadIcon(this.findChildComponent("empty/icon",h),"common","pyq_img_mogutuxiang"),this.scrollTrans=this.findChildComponent("ScrollView",a),this.scrollWidge=this.findChildComponent("ScrollView",o),this.oriTop=this.scrollWidge.top,this.scrollViewGo=this.findChildComponent("ScrollView",l),this.addComponentCallbackListener(this.scrollViewGo.node,l.EventType.SCROLL_BEGAN,(function(){t.updateByNext=!1})),this.scrollView=this.addUIList(this.scrollViewGo,P),this.scrollView.inBottomFunc=function(){t.noReadNum>0&&(t.noReadBtn.active=!1,t.noReadNum=0)},this.goToChatBtn=this.findChild("privateTitle/goToChatBtn"),this.addComponentCallbackListener(this.goToChatBtn,n.EventType.CLICK,(function(){t.parentView.showPrivateChatType()})),this.arrowBtn=this.findChild("ScrollView/arrowBtn"),this.addComponentCallbackListener(this.arrowBtn,n.EventType.CLICK,(function(){var e={preHeight:t.scrollTrans.height,contentSizeY:t.contentTrans.height,contentPos:t.scrollView.content.getPosition()};t.parentView.updateConetntHeight(),t.guildQuestionView.isActive&&t.guildQuestionView.updateRank(),t.UpdateSizeScrollToPos(null,e)})),this.guildQuestionView=this.addSubView("GuildQuestionSubView",this.findChild("ScrollView/questionView")),this.guildQuesDiceSubView=this.addSubView("GuildQuesDiceSubView",this.findChild("guildQuesDice")),this.guildHelp=this.findChild("ScrollView/guildHelp"),this.guildHelpRed=this.findChild("ScrollView/guildHelp/red"),this.addComponentCallbackListener(this.guildHelp,n.EventType.CLICK,(function(){uiMgr.openView("GuildHelpView")})),this.addComponentCallbackListener(this.guildHelpRed,n.EventType.CLICK,(function(){IS(A).send_29_30(0)}))},M.InitTempItem=function(){this.tempMessageItem=new P;var t=this.findChild("ScrollView/view/content/item"),e=r(t);e.setParent(this.node),e.active=!1,this.tempMessageItem.isTempItem=!0,this.tempMessageItem.init(null,e,this)},M.registerUpdateHandler=function(){this.addEvent(H.RemoveChatFiriend,this.RemoveChatFriend,this),this.addEvent(H.InsertNewMsg,this.insertNewMsg,this),this.addEvent(H.UpdateChatMsg,this.UpdateMsg,this),this.addEvent(H.UpdateChatFriendInfo,this.showName,this),this.addEvent(G.GUIDE_UPDATE_QUESTION,this.showQuestion,this),this.addEvent(G.GUILD_HELP_UPDATE,this.updateAll,this),this.addEvent(H.UpdateRedBagList,this.updateAll,this),this.addEvent(G.GUILD_DICE_START_UPDATE,this.showDice,this),this.addEvent(T.UpdateCardChatInfo,this.updateAll,this),this.addEvent(I.OnHalloweenGroupChatInfo,this.updateAll,this),this.addEvent(L.UpdateTranslateResult,this.updateTranslate,this),this.addEvent(G.GUILD_HELP_UPDATE,this.updateGuildHelp,this),this.addEvent(I.OnRobCaseGroupChatInfo,this.updateAll,this),this.addEvent(I.OnActivityCollectInfo,this.updateAll,this)},M.updateTranslate=function(t){if(this.chatList&&this.chatList.length>0)for(var e=0;e<this.chatList.length;e++){var i=this.chatList[e];if("Chat"==t.key1&&t.extraInfo&&t.extraInfo.role_id==i.role_id&&t.extraInfo.time==i.time){delete i.height;var s=this.CalcHeightByIndex(i);this.scrollView.setCustomItemSize(e,s),this.scrollView.updateAll();break}}},M.showQuestion=function(){if(this.channel==E.Channel.Guild){var t=IS(_).GetGuildQuestion();t&&t.question>0&&g.serverTime<t.countdown?this.guildQuestionView.setActive(!0):this.guildQuestionView.setActive(!1)}else this.guildQuestionView.setActive(!1)},M.showDice=function(){if(this.channel==E.Channel.Guild){var t=IS(_).GetGuildDiceTime();t&&t>g.serverTime?this.guildQuesDiceSubView.setActive(!0):this.guildQuesDiceSubView.setActive(!1)}else this.guildQuesDiceSubView.setActive(!1)},M.onAfterOpen=function(){IS(A).send_29_28(1),IS(A).send_29_32(),this.scrollWidge.updateAlignment()},M.setViewType=function(t,e,i){var s=this;t!=this.channel&&IS(C).ClearTranslateByKey1("Chat"),this.channel=t,this.targetId=e,this.isWaitHis=!1,this.targetId&&this.targetId>0&&IS(R).reqChatHistoryRead(this.targetId),this.channel==E.Channel.Private?(IS(B).SetChatTarget(this.targetId),this.isWaitHis=IS(B).GetHasPrivateChatHis(this.targetId),IS(B).ReqPrivateChatHisByOnce(this.targetId),this.scrollWidge.top=68,this.privateTitle.node.active=!0,this.showName(),e&&e!=E.VIPGmUid&&IS(R).reqFriendInfoList([e])):(IS(B).SetChatTarget(t),this.scrollWidge.top=this.oriTop,this.privateTitle.node.active=!1),this.chatList=f.copyArray(IS(B).GetChatInfo(this.channel,this.targetId));var n=0;if(this.scrollView.setCustomItemsSize(this.chatList,(function(t){return IS(B).GetMentionNoRead(s.chatList[t])&&(n=t),s.CalcAddOne(s.chatList[t],t),s.CalcTime(s.chatList[t],t),s.CalcHeightByIndex(s.chatList[t])}),!0),this.scrollView.clearData(),this.scrollView.datas=this.chatList,this.emptyNode.active=this.chatList.length<=0,this.isCloseExtend?i&&(this.UpdateByNextFrame(1,!0),this.isCloseExtend=!1):this.scrollView.scrollTo(this.chatList.length,.1),this.showQuestion(),this.showDice(),this.guildHelp.active=this.channel==E.Channel.Guild,this.channel==E.Channel.Guild&&(IS(A).send_29_22(),IS(A).send_29_33(),IS(A).send_29_28(1)),this.channel==E.Channel.World||this.channel==E.Channel.Private){var a=IS(m).GetActivityInfo(w.Autumn);if(a&&a.state==S.Open&&IS(v).send_24_63(),this.channel==E.Channel.World){var h=IS(m).GetActivityInfo(w.Halloween);h&&h.state==S.Open&&IS(v).send_24_76();var o=IS(m).GetActivityInfo(w.RobCase);o&&o.state==S.Open&&IS(v).send_24_76(w.RobCaseBuy)}}n>0?this.scrollView.scrollTo(n,-1):this.scrollView.scrollTo(this.chatList.length,-1),this.isWaitHis||IS(B).SetNewMsgTime(t,e)},M.CalcAddOne=function(t,e){if(e>=1){var i=this.chatList[e-1];(t.type==E.ChatContentType.Conetnt&&i.type==E.ChatContentType.Conetnt||t.type==E.ChatContentType.Face&&i.type==E.ChatContentType.Face)&&(i.content==t.content?(delete i.addOne,t.addOne=!0):t.addOne&&delete t.addOne)}else t.addOne&&delete t.addOne},M.CalcTime=function(t,e){var i=new Date(1e3*g.serverTime);i.setHours(0,0,0);var s=i.getTime()/1e3,n=g.serverTime,a=g.serverTime-t.time>300;e>0&&(n=this.chatList[e-1].time,a=t.time-n>300);var h=t.timeStr;if(a){var o=new Date(1e3*t.time),l=g.ServerDate(1e3*t.time);if(t.time-s>0)t.timeStr=d.formatStr("%s:%s",l.getHours().toString().padStart(2,"0"),l.getMinutes().toString().padStart(2,"0"))+g.GetServerTimeZoneStr();else if(o.getFullYear()==i.getFullYear()){var r=new Date(1e3*n);!(e>0&&r.getMonth()==o.getMonth()&&r.getDate()==o.getDate())&&(t.timeStr=d.formatStr("%s/%s",l.getMonth()+1,l.getDate())+g.GetServerTimeZoneStr())}else t.timeStr=d.formatStr("%s/%s/%s",l.getFullYear(),l.getMonth()+1,l.getDate())+g.GetServerTimeZoneStr()}h!=t.timeStr&&(t.height=null)},M.CalcHeightByIndex=function(t){if(t){if(t.height)return t.height;var e=this.tempMessageItem.CalcHeight(t);return t.height=e,e}},M.UpdateSizeScrollToPos=function(t,e){if(t)this.scrollView.scrollTo(this.chatList.length,-1);else if(e&&null!=e.contentPos&&(e.preHeight!=this.scrollTrans.height||this.contentTrans.height!=e.contentSizeY)){var i=e.preHeight-this.scrollTrans.height,s=this.contentTrans.height-e.contentSizeY,n=e.contentPos,a=Math.max(n.y+i+s,0),h=this.scrollView.scrollView.getMaxScrollOffset();a>h.y&&(a=h.y),this.scrollView.scrollView.stopAutoScroll(),this.scrollView.scrollView.scrollToOffset(new c(0,a)),this.scrollView.updateAll()}},M.updateAll=function(){this.scrollView.updateAll()},M.toBottom=function(){this.chatList.length>0&&this.scrollView.scrollTo(this.chatList.length,-1)},M.UpdateMsg=function(t,e){var i=this;t&&t!=this.channel||t==E.Channel.Private&&e!=this.targetId||(this.chatList=f.copyArray(IS(B).GetChatInfo(this.channel,this.targetId)),this.scrollView.setCustomItemsSize(this.chatList,(function(s){return i.isWaitHis&&t==E.Channel.Private&&e==i.targetId&&IS(B).GetMentionNoRead(i.chatList[s]),i.CalcAddOne(i.chatList[s],s),i.CalcTime(i.chatList[s],s),i.CalcHeightByIndex(i.chatList[s])}),!0),this.scrollView.datas=this.chatList,this.emptyNode.active=this.chatList.length<=0,this.scrollView.scrollTo(this.chatList.length,-1),this.updateAutoList(),this.isWaitHis&&(this.isWaitHis=!1,IS(B).SetNewMsgTime(t,e)))},M.UpdateAll=function(){this.scrollView.updateAll()},M.updateAutoList=function(){if(this.chatList){this.auto_play_list=[];var t=IS(V).Get(y.AUTO_VOICE_TIME);if(t&&t>0)for(var e=this.chatList.length-1;e>0;e--){null!=(n=this.chatList[e])&&n.time>t&&n.type==E.ChatContentType.Voice&&n.role_id!=IS(D).GetRoleId()&&this.auto_play_list.push({info:n,list_index:e})}else for(var i=0,s=this.chatList.length-1;s>0;s--){var n;if(i++,null!=(n=this.chatList[s])&&n.type==E.ChatContentType.Voice&&n.role_id!=IS(D).GetRoleId()){this.auto_play_list.push({info:n,list_index:s});break}if(i>=5){IS(B).SetAutoTimer();break}}}},M.ScrollToChatItem=function(t){this.scrollView.scrollTo(t,.3)},M.GetAutoPlayList=function(){return this.auto_play_list},M.updateGuildHelp=function(){this.guildHelpRed.active=1==IS(_).GetGuildHelpRed()},M.showName=function(){var t=IS(B).GetChatFriendInfoListById(this.targetId);if(this.targetId==E.VIPGmUid){var e=IS(B).GetKfList();e&&e[0]?this.privateTitle.string=e[0].name:this.privateTitle.string=GetLanguage(200168)}else t&&(this.privateTitle.string=t.name)},M.insertNewMsg=function(t){var e=this;if(!(this.channel!=t.channel||t.friend_id&&t.friend_id!=this.targetId)){var i=this.scrollView.getIsShowBottomItem(this.chatList.length-1),s=this.contentTrans.height,n=this.contentTrans.node.position.y,a=IS(B).GetChatInfo(this.channel,this.targetId);if(this.chatList.length>=E.ChatShowLimitNum){var h=this.scrollView.getDisplayRange();if(h){var o=this.chatList.length-E.ChatLimitNum;o>h.top&&(o=h.top-1),o>0&&(this.chatList.splice(0,o),this.scrollView.setCustomItemsSize(this.chatList,(function(t){return e.CalcAddOne(e.chatList[t],t),e.CalcHeightByIndex(e.chatList[t])}),!0))}}this.scrollView.datas=this.chatList,this.emptyNode.active=this.chatList.length<=0;var l=this.contentTrans.height-s;this.chatList.push(a[a.length-1]),t.is_my||i||(this.noReadNum+=1,this.noReadBtn.active=!0,this.noReadText.string=p.formatStrWithMirrorDeal(GetLanguage(200169),this.noReadNum));var r=this.chatList.length-1;if(this.chatList[r]){this.CalcTime(this.chatList[r],r),this.CalcAddOne(this.chatList[r],r);var d=this.CalcHeightByIndex(this.chatList[r]);this.scrollView.setCustomItemSize(r,d),this.scrollView.datas=this.chatList,this.emptyNode.active=this.chatList.length<=0,i?this.scrollView.scrollTo(this.chatList.length,-1):l<0&&(this.scrollView.scrollView.scrollToOffset(new c(this.contentTrans.node.position.x,n+l)),this.scrollView.updateAll()),this.updateAutoList()}}},M.RemoveChatFriend=function(t){this.channel==E.Channel.Private&&this.targetId==t&&this.parentView.showPrivateChatType()},M.onBeforeClose=function(){this.auto_play_list=[],this.targetId&&this.targetId>0&&IS(R).reqChatHistoryRead(this.targetId),IS(B).SetChatTarget(0),this.heightCalcTxtDict={},IS(C).ClearTranslateByKey1("Chat")},M.setBlockLinkJump=function(t){this.is_Block=!!t},M.updateArrowRoate=function(t){this.arrowBtn.setRotationFromEuler(new u(0,0,1==t?0:180))},M.onUpdate=function(t){this.update},M.InsertShareItemPool=function(t,e){this.shareItemPoolList[t]||(e.setParent(this.shareItemPool),this.shareItemPoolList[t]=e)},M.GetShareItemPool=function(t){var e=this.shareItemPoolList[t];return delete this.shareItemPoolList[t],e},M.GetPreShareCalcItem=function(t){return this.findChild("preShareCalcHeightItem/"+t)},M.onDestroy=function(){this.shareItemPoolList={}},i}(M));i._RF.pop()}}}));

