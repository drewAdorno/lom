System.register("chunks:///_virtual/CrossWarSelectMapScene.ts",["./rollupPluginModLoBabelHelpers.js","cc","./BattleData.ts","./NodeUtil.ts","./UIEffectAsset.ts","./MapMgr.ts","./ChapterDataCache.ts","./MessageView.ts","./RoleDataCache.ts","./CrossWarControl.ts","./CrossWarDatacache.ts","./CrossWarDefine.ts","./CrossWarSceneDataCache.ts","./SceneCamera.ts","./SceneBoss2.ts","./SceneMonster.ts","./SceneRole.ts","./SceneRoleOwner.ts"],(function(e){"use strict";var t,n,i,s,o,a,r,c,d,h,l,u,p,f,S,v,C,m,w,M,g,y,b,T,L,U,I,R;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){n=e.cclegacy,i=e.Rect,s=e.find,o=e.Vec3,a=e.Prefab,r=e.UITransform,c=e.Camera,d=e.Node,h=e.screen,l=e.Vec2},function(e){u=e.ChapterType},function(e){p=e.default},function(e){f=e.UIEffectAsset},function(e){S=e.MapMgr},function(e){v=e.ChapterDataCache},function(e){C=e.default},function(e){m=e.RoleDataCache},function(e){w=e.default},function(e){M=e.CrossWarDataCache},function(e){g=e.SceneObjType,y=e.RoleUpdateFlag},function(e){b=e.CrossWarSceneDataCache},function(e){T=e.SceneCamera},function(e){L=e.SceneBoss},function(e){U=e.SceneMonster},function(e){I=e.SceneRole},function(e){R=e.SceneRoleOwner}],execute:function(){n._RF.push({},"eac6eTlsCNLYLccKH09h+Bq","CrossWarSelectMapScene",void 0);var O=new i;e("CrossWarSelectMapScene",function(){function e(e){this.node=void 0,this.units=[],this.unitMap={},this.view=void 0,this.mapCamera=new T,this.miniMap=void 0,this.nodeUnit=void 0,this.nodeUnitHub=void 0,this.nodeUnitSelect=void 0,this.nodeUnitState=void 0,this.nodeMap=void 0,this.ut=void 0,this.onLoadViewSuccess=void 0,this.startTouchPos=void 0,this.owner=void 0,this.view=e,O.width=3112.5,O.height=1237.5,O.center=l.ZERO}var n=e.prototype;return n.load=function(){var e=this;this.node||(null!=this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/crosswar/CrosswarMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),this.onLoadViewSuccess=function(t){if(e.onLoadViewSuccess=null,!t.error&&null!=t.item&&null!=t.item.asset){var n=t.item.asset,i=nodeInstantiate.instantiate(n);i.name="CrossWarSelectMapScene",e.node=i,i.setParent(s("UIRoot").parent),i.position=new o(-3e4,0),i.setSiblingIndex(1),e.onInit()}},resourceMgr.loadRes("ui/module/crosswar/CrosswarMapScene",a,this.onLoadViewSuccess))},n.onInit=function(){var e=this;this.nodeUnit=p.findChild(this.node,"unit"),this.ut=this.nodeUnit.getComponent(r),this.nodeUnitHub=p.findChild(this.node,"unitHub"),this.nodeMap=p.findChild(this.node,"map"),this.nodeUnitSelect=p.findChild(this.node,"unitSelect"),this.nodeUnitState=p.findChild(this.node,"unitState"),this.mapCamera.nodeCamera=p.findChild(this.node,"SceneCamera"),this.mapCamera.camera=this.mapCamera.nodeCamera.getComponent(c),this.mapCamera.setMapSize(25e3,1e4,9.75);var t=this.view;t.addComponentCallbackListener(this.nodeMap,d.EventType.TOUCH_START,(function(t){var n=t.getLocation();if(n.x<0||n.x>h.windowSize.width)e.startTouchPos=null;else{var i=new o(n.x,n.y,0),s=e.mapCamera.camera.screenToWorld(i);s.add3f(3e4,0,0),e.startTouchPos=s}})),t.addComponentCallbackListener(this.nodeMap,d.EventType.TOUCH_END,(function(t){if(e.startTouchPos){var n=t.getLocation();if(!(n.x<0||n.x>h.windowSize.width)){var i=new o(n.x,n.y,0),s=e.mapCamera.camera.screenToWorld(i);if(s.add3f(3e4,0,0),l.distance(e.startTouchPos,s)<20)e.checkClick(s);else{s.y=0,s.z=0;var a=e.startTouchPos.x-s.x;s.x=1.5*a+e.mapCamera.oriPos.x,e.mapCamera.toTargetPos(s,2),IS(w).reqCrossWarSceneTransferSlide(s)}}}})),this.open()},n.registerEvent=function(){},n.open=function(){if(this.node)return this.registerEvent(),this.node.active||(this.node.active=!0),void this.onAfterOpen();this.load()},n.close=function(){this.node&&this.node.active&&(this.node.active=!1),null!=this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/crosswar/CrosswarMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),IS(S).exitMap(),this.onBeforeClose()},n.destroy=function(){this.close(),this.node&&(this.node.destroy(),resourceMgr.releaseResRef("ui/module/crosswar/CrosswarMapScene"),this.node=null)},n.onAfterOpen=function(){var e=IS(M).scene_base,t=configScene.getDataByKey(e);this.mapCamera.toTargetPos(o.ZERO,0),this.view.load.active=!1,t&&(this.miniMap=f.alloc(t.mini_map_path,this.nodeMap,-1),this.miniMap.scale=2)},n.onBeforeClose=function(){var e;null==(e=this.miniMap)||e.free(),this.miniMap=null,this.cancelSelect();for(var n,i=t(this.units);!(n=i()).done;){n.value.destroy()}this.mapCamera.follow=null,this.units.length=0,this.unitMap={}},n.onDestroy=function(){},n.checkClick=function(e){for(var n,i=IS(m).GetRoleId(),s=t(this.units);!(n=s()).done;){var o=n.value;if(o.info.obj_id!=i){if(o.info.obj_type!=g.Holy)break;if(l.distance(e,o.position)<=188)return void C.showFlyTip(GetLanguage(201386))}}if(O.contains(e)){if(null==this.owner){var a={obj_id:IS(m).GetRoleId(),obj_type:1,pos:{x:e.x,y:e.y},hp:1,state:0,speed:0};this.owner=new R(this,a)}this.owner.position=e}else C.showFlyTip(GetLanguage(201386))},n.cancelSelect=function(){null!=this.owner&&(this.owner.destroy(),this.owner=null)},n.onUpdate=function(e){if(this.node){IS(S).update();var t=IS(b);0!=t.roleUpdateFlag&&(t.roleUpdateFlag&y.Add&&this.addSceneObj(),t.roleUpdateFlag&y.Del&&this.delSceneObj()),t.roleUpdateFlag=0;for(var n=0;n<this.units.length;n++){var i=this.units[n];i.del?(i.destroy(),this.units.splice(n,1),n--):i.update(e)}this.mapCamera.onUpdate(e);var s=IS(v),o=s.currentLoadType==u.Main||s.chapterType==u.Main;this.node&&this.node.active!=o&&(this.node.active=o)}},n._addSceneObj=function(e){if(e){var t=null;switch(e.obj_type){case g.Player:t=new I(this,e);break;case g.Monster:t=new U(this,e);break;case g.Holy:t=new L(this,e)}this.units.push(t),this.unitMap[t.id]=t}},n.addSceneObj=function(){for(var e,n=IS(b),i=n.roleMap,s=n.roleActions[y.Add],o=t(s);!(e=o()).done;){var a=e.value,r="obj:"+a;if(this.unitMap[r]){var c=this.unitMap[r];this.units.splice(this.units.indexOf(c),1),c.destroy(),delete this.unitMap[r]}var d=i[a];this._addSceneObj(d)}s.clear()},n.delSceneObj=function(){for(var e,n=IS(b).roleActions[y.Del],i=t(n);!(e=i()).done;){var s="obj:"+e.value;this.unitMap[s]&&(this.unitMap[s].del=!0,delete this.unitMap[s])}n.clear()},e}());n._RF.pop()}}}));

