System.register("chunks:///_virtual/RunningGameMapScene.ts",["./rollupPluginModLoBabelHelpers.js","cc","./V2.ts","./NodeUtil.ts","./MessageView.ts","./GameCenterControl.ts","./GameCenterModel.ts","./RunningGameDataCache.ts","./RunningGameDefine.ts","./SceneCamera5.ts","./SceneUnit7.ts"],(function(e){"use strict";var t,i,o,s,n,h,r,l,a,u,c,d,v,f,g,L,m,p,C,R,w,S,M,_,y,I,Q;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy,o=e.Prefab,s=e.UITransform,n=e.Vec2,h=e.Vec3,r=e.find,l=e.Camera},function(e){a=e.V2},function(e){u=e.default},function(e){c=e.default},function(e){d=e.default},function(e){v=e.default},function(e){f=e.default},function(e){g=e.TrackSize,L=e.RoleLevel,m=e.HairFigureLevel,p=e.JobFigureLevel,C=e.levelRoleNum,R=e.DetectRange,w=e.RoleLevelNum,S=e.TrackEdge,M=e.levelLength,_=e.ChooseLevelInfo,y=e.ScrollSpeed},function(e){I=e.SceneCamera},function(e){Q=e.SceneRole}],execute:function(){var N;i._RF.push({},"c4e0bJMVH9ImbFo9JWlqWyC","RunningGameMapScene",void 0);e("RunningGameMapScene",function(){function e(e){this.units=[],this.node=void 0,this.unitMap={},this.view=void 0,this.roleQuene=[],this.roleQueneLevel=[],this.trackAry=[],this.mapCamera=new I,this.owner=void 0,this.nodeUnit=void 0,this.nodePlayer=void 0,this.polyNav=void 0,this.ut=void 0,this.onLoadViewSuccess=void 0,this.startTouchPos=void 0,this.frameNum=0,this.queneNum=0,this.trackNum=void 0,this.totalRoleLevel=0,this.quenePos=[],this.isCreatingRole=!1,this.completeGame=void 0,this.bottomTrackTrackEdgeY=void 0,this.totalRoleId=0,this.curRoleNum=0,this.curLevelNum=1,this.curDistance=300,this.lastLevel=0,this.lastChooseLevel=-1,this.curLevel=0,this.chooseLevelId=0,this.chooseLevelNum=0,this.nodeStart=void 0,this.ChooseLevelList=[],N=r("SceneRoot"),this.view=e,this.mapCamera.nodeCamera=u.findChild(N,"SceneCamera"),this.mapCamera.camera=this.mapCamera.nodeCamera.getComponent(l)}var i=e.prototype;return i.load=function(){var e=this;this.node||(null!==this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/runningGame/RunningGameMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),this.onLoadViewSuccess=function(t){if(e.onLoadViewSuccess=null,!t.error&&null!==t.item&&null!==t.item.asset){var i=t.item.asset,o=nodeInstantiate.instantiate(i);e.node=o,o.setParent(N),e.onInit()}},resourceMgr.loadRes("ui/module/runningGame/RunningGameMapScene",o,this.onLoadViewSuccess))},i.onInit=function(){this.nodeUnit=u.findChild(this.node,"unit"),this.nodePlayer=u.findChild(this.node,"player"),this.nodeStart=u.findChild(this.node,"start");for(var e=0;e<3;e++){var t=e,i=u.findChild(this.node,"chooseLevel/chooseLevel_"+e.toString());this.ChooseLevelList.push(new k(t,i))}this.ut=this.nodeUnit.getComponent(s);for(var o=1;;){var n=u.findChild(this.node,"track/track_"+o.toString());if(!n)break;this.trackAry[o]=n,o++}this.trackNum=this.trackAry.length,this.bottomTrackTrackEdgeY=-1e3-g.y/2,this.curDistance=0,IS(f).roleMap[1]={role_id:1,role_level:L.Level1,inQuene:1,figure:{equip_list:[{k:1,v:40100202}],skin_list:[],hair_figure:m[L.Level1],job_figure:p[L.Level1],mount_figure:0,artifact_figure:0,gender:0,current_title:0},pos:{x:-200,y:-300},break:1},this.InitRole(),this.open()},i.registerEvent=function(){this.view},i.open=function(){if(N.active||(N.active=!0),this.node)return this.registerEvent(),void this.onAfterOpen();this.load()},i.close=function(){N.active&&(N.active=!1),null!==this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/runningGame/RunningGameMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),this.onBeforeClose()},i.destroy=function(){this.close(),this.node&&(this.node.destroy(),resourceMgr.releaseResRef("ui/module/runningGame/RunningGameMapScene"),this.node=null)},i.onAfterOpen=function(){this.completeGame=!1,this.mapCamera.follow=null},i.onBeforeClose=function(){if(null!==this.owner){for(var e,i=t(this.units);!(e=i()).done;){e.value.destroy()}this.mapCamera.follow=null,this.units.length=0,this.unitMap={},this.owner=null}},i.onDestroy=function(){},i.onUpdate=function(e){var t=this;this.trackAry&&this.Circulate(e),this.destroyRole(),this._updateDepth();for(var i=0;i<this.units.length;i++){var o=this.units[i];o.del?(o.destroy(),this.units.splice(i,1),i--):o.update(e)}for(var s in this.owner&&(this.owner.update(e),this.mapCamera.onUpdate()),this.lastLevel!=this.curLevel&&this.curLevel>0&&this.changeLevel(),!1===this.completeGame&&(4==this.frameNum?(this.curRoleNum<C[this.curLevel]&&this.isCreatingRole&&this.CreateRandomRole(),this.DetectChooseLevel(),this.DetectRole(),this.totalRoleLevel<1&&c.showBoxTip({tip:"闯关失败！",btnCnt:1,func:function(e){t.destroy(),uiMgr.getOpenView("RunningGameMapSceneView").destroy(),uiMgr.openView("RunningGameMapSceneView")},ensure:GetLanguage(200129)}),this.frameNum=0):this.frameNum++),this.roleQuene)this.roleQuene[s].info.inQuene>0&&(this.quenePos[this.roleQuene[s].info.inQuene]=new n(this.roleQuene[s].agent.pos.x,this.roleQuene[s].agent.pos.y));for(var h in this.roleQuene)if(this.roleQuene[h].info.role_id!==this.owner.info.role_id&&this.roleQuene[h].info.inQuene>1){var r=this.roleQuene[h].agent.pos,l=new n(this.quenePos[parseInt(h)].x,this.quenePos[parseInt(h)].y-120),u=a.distance(r,l);if(u>0){var d=new a;d.set(0,0),a.subtract(d,l,r),a.subtract(l,l,new n(d.x/u,d.y/u)),this.roleQuene[h].moveToTarget(l)}}},i.DetectChooseLevel=function(){for(var e=-1,t=0,i=0;i<this.ChooseLevelList.length;i++)if(i!=this.lastChooseLevel){this.lastChooseLevel=i;var o=this.ChooseLevelList[i].node.worldPosition.y,s=this.owner.agent.pos.y;if(Math.abs(o-s)<10){this.owner.agent.pos.x<0?(e=0,this.ChooseLevelList[i].nodeLeft.active=!1,t=this.ChooseLevelList[i].leftChoice.choiceNum):(e=1,this.ChooseLevelList[i].nodeRight.active=!1,t=this.ChooseLevelList[i].rightChoice.choiceNum);break}}-1!=e&&(this.totalRoleLevel+=t,this.SortRoleQuene())},i.DetectRole=function(){if(this.owner){var e=IS(f).roleMap;for(var t in e)if(1!=parseInt(t)){var i=new a(0,0);for(var o in this.units)if(this.units[o].uid==e[t].role_id){i=this.units[o].position;break}if(a.distance(i,this.owner.position)<R&&0==e[t].inQuene&&e[t].role_level<=this.owner.info.role_level&&0==e[t].inQuene)for(var s=0;s<this.units.length;s++)if(this.units[s].uid==e[t].role_id){var n=this.units[s];n.destroy(),this.units.splice(s,1),this.totalRoleLevel+=w[e[t].role_level],delete this.unitMap[n.id],delete e[t],this.SortRoleQuene();break}}}},i.CreateRandomRole=function(){this.totalRoleId++,this.curRoleNum++;var e=IS(f).roleMap,t=Math.ceil(25*Math.random()),i=1,o={role_id:0,role_level:i=t<9?1:t<16?2:t<21?3:t<24?4:5,inQuene:0,figure:{equip_list:[{k:1,v:40100202}],hair_figure:m[i],job_figure:p[i],mount_figure:0,artifact_figure:0,gender:0,current_title:0},pos:{x:0,y:S.Top},break:1};e[this.totalRoleId]=o,e[this.totalRoleId].role_id=this.totalRoleId,e[this.totalRoleId].pos.x=Math.ceil(Math.random()*S.Left)+Math.ceil(Math.random()*S.Right),e[this.totalRoleId].pos.y+=Math.ceil(200*Math.random());var s=new Q(this,e[this.totalRoleId]);this.units.push(s),this.unitMap[s.id]=s},i.destroyRole=function(){var e=IS(f).roleMap;if(this.units)for(var t=0;t<this.units.length;t++)if(this.units[t].position.y<S.Bottom)for(var i in e){if(!this.units[t])return;if(e[i].role_id==this.units[t].uid){var o=this.units[t];o.destroy(),this.units.splice(t,1),delete this.unitMap[o.id],delete e[i]}}},i.InitRole=function(){for(var e=0;e<this.units.length;e++){var t=this.units[e];t.destroy(),this.units.splice(e,1),delete this.unitMap[t.id]}this.owner=null;var i=IS(f).roleMap[1],o=new Q(this,i);this.owner=o,this.queneNum++,this.owner.info.inQuene=this.queneNum,this.roleQuene.push(o),this.totalRoleLevel+=this.owner.info.role_level,this.totalRoleId++,this.curRoleNum++},i.SortRoleQuene=function(){this.CalculateRoleLevel();for(var e=IS(f).roleMap,t=0;t<this.roleQuene.length;t++)for(var i in this.roleQuene[t].destroy(),e)parseInt(i)==this.roleQuene[t].info.role_id&&1!=this.roleQuene[t].info.role_id&&delete e[i];this.roleQuene.splice(0,this.roleQuene.length),this.owner.info.role_level=this.roleQueneLevel[0],this.owner.info.figure.job_figure=p[this.owner.info.role_level],this.owner.info.figure.hair_figure=m[this.owner.info.role_level],this.owner.info.pos=this.owner.agent.pos,this.owner.info.inQuene=1;var o=new Q(this,this.owner.info);this.owner=o,this.roleQuene.splice(0,0,o),this.queneNum=1,this.roleQuene[0].info.inQuene=1;for(var s=1;s<this.roleQueneLevel.length;s++)this.queneNum++,this.totalRoleId++,this.CreateQueneRole(this.roleQueneLevel[s],s+1)},i.CreateQueneRole=function(e,t){var i={role_id:0,role_level:e,inQuene:t,figure:{equip_list:[{k:1,v:40100202}],hair_figure:m[e],job_figure:p[e],mount_figure:0,artifact_figure:0,gender:0,current_title:0},pos:{x:0,y:S.Top},break:1},o=IS(f).roleMap;o[this.totalRoleId]=i,o[this.totalRoleId].role_id=this.totalRoleId,o[this.totalRoleId].inQuene=this.queneNum,o[this.totalRoleId].pos.x=this.owner.agent.pos.x,o[this.totalRoleId].pos.y=this.owner.agent.pos.y-100*t;var s=new Q(this,o[this.totalRoleId]);this.units.push(s),this.unitMap[s.id]=s,this.roleQuene.push(s)},i.CalculateRoleLevel=function(){var e=this.totalRoleLevel,t=32;this.roleQueneLevel.splice(0,this.roleQueneLevel.length);for(var i=6;i>0;i--){for(;e>=t&&(e-=t,this.roleQueneLevel.push(i),0!=e););t/=2}},i.Circulate=function(e){var t=this,i=y*e;this.curDistance+=i,this.curLevel=Math.floor(this.curDistance/M),18==this.curLevel&&(this.completeGame=!0,c.showBoxTip({tip:"您已通关！",btnCnt:1,func:function(e){t.destroy(),uiMgr.getOpenView("RunningGameMapSceneView").destroy();var i=IS(v).getRewardInfo(3);i&&2!=i.status&&IS(d).repTakeReward(3)},ensure:GetLanguage(200129)}));for(var o=1;o<this.trackNum;o++){this.trackAry[o].getSiblingIndex();this.trackAry[o].translate(new h(0,-i,0)),this.trackAry[o].getPosition().y<this.bottomTrackTrackEdgeY&&this.trackAry[o].setSiblingIndex(this.trackNum-1)}if(this.ChooseLevelList[0])for(var s=0;s<3;s++)this.ChooseLevelList[s].isMoving&&this.ChooseLevelList[s].node.translate(new h(0,-i,0)),this.ChooseLevelList[s].node.position.y<-1800&&(this.ChooseLevelList[s].node.setPosition(0,0),this.ChooseLevelList[s].isMoving=!1);if(this.nodeUnit)for(var r=0;r<this.units.length;r++){var l=IS(f).roleMap;for(var a in l)this.units[r].uid==l[a].role_id&&0==l[a].inQuene&&(this.units[r].position=new n(this.units[r].position.x,this.units[r].position.y-i))}this.nodeStart&&(this.nodeStart.translate(new h(0,-i,0)),this.nodeStart.position.y<this.bottomTrackTrackEdgeY&&(this.nodeStart.active=!1))},i.changeLevel=function(){if(C[this.curLevel]>0)this.isCreatingRole=!0,this.curRoleNum=0;else if(this.chooseLevelNum<6){this.isCreatingRole=!1,5==this.chooseLevelNum&&(this.nodeStart.active=!0,this.nodeStart.position=new h(0,1e3,0));var e=_[this.chooseLevelNum],t=this.chooseLevelId%3;this.ChooseLevelList[t].isMoving=!0,this.ChooseLevelList[t].nodeLeft.active=!0,this.ChooseLevelList[t].nodeRight.active=!0,this.ChooseLevelList[t].leftChoice.choiceNum=e.left,this.ChooseLevelList[t].rightChoice.choiceNum=e.right;var i=e.left;e.left<0?(this.ChooseLevelList[t].leftChoice.nodeSign[0].active=!1,this.ChooseLevelList[t].leftChoice.nodeSign[1].active=!0,i=Math.abs(e.left)):(this.ChooseLevelList[t].leftChoice.nodeSign[0].active=!0,this.ChooseLevelList[t].leftChoice.nodeSign[1].active=!1);for(var o=1;o<=9;o++)this.ChooseLevelList[t].leftChoice.nodeNum[o].active=o==i;var s=e.right;e.right<0?(this.ChooseLevelList[t].rightChoice.nodeSign[0].active=!1,this.ChooseLevelList[t].rightChoice.nodeSign[1].active=!0,s=Math.abs(e.right)):(this.ChooseLevelList[t].rightChoice.nodeSign[0].active=!0,this.ChooseLevelList[t].rightChoice.nodeSign[1].active=!1);for(var n=1;n<=9;n++)this.ChooseLevelList[t].rightChoice.nodeNum[n].active=n==s;this.chooseLevelId++,this.chooseLevelNum++,this.chooseLevelId=this.chooseLevelId%3}this.lastLevel=this.curLevel},i.moveOwner=function(e){this.owner&&(this.owner.moveToDir(e),IS(f).roleMap[this.owner.info.role_id].pos=this.owner.agent.pos)},i._updateDepth=function(){this.units.sort((function(e,t){var i=1,o=0,s=e.position.y-t.position.y;return(i-=100*s)-(o+=100*s)}));for(var e=0;e<this.units.length;++e){this.units[e].depth=e}},e}());var k=function(e,t){this.id=void 0,this.node=void 0,this.nodeLeft=void 0,this.nodeRight=void 0,this.leftChoice=void 0,this.rightChoice=void 0,this.isMoving=void 0,this.id=e,this.node=t,this.nodeLeft=u.findChild(this.node,"leftChoice"),this.nodeRight=u.findChild(this.node,"rightChoice"),this.leftChoice=new b(this.nodeLeft),this.rightChoice=new b(this.nodeRight),this.isMoving=!1},b=function(e){this.nodeSign=[],this.nodeNum=[],this.choiceNum=void 0,this.nodeSign[0]=u.findChild(e,"num/imgSign/plus"),this.nodeSign[1]=u.findChild(e,"num/imgSign/minus");for(var t=1;t<10;t++)this.nodeNum[t]=u.findChild(e,"num/imgNum/"+t.toString())};i._RF.pop()}}}));

