System.register("chunks:///_virtual/ChapterMainCC.ts",["./rollupPluginModLoBabelHelpers.js","cc","./BattleData.ts","./index94.ts","./EnumDefine.ts","./EventDefine.ts","./V2.ts","./CameraMgr.ts","./UIDefine.ts","./ConfigGlobal.ts","./ArtifactDefine.ts","./BattleDefine.ts","./ChapterControl.ts","./ChapterDataCache.ts","./ChapterDefine.ts","./GameSetting.ts","./GuideModel.ts","./MessageView.ts","./EquipDefine.ts","./FateDefine.ts","./FlyPetDefine.ts","./HorseDefine.ts","./MainViewModel.ts","./PetDefine.ts","./RoleControl.ts","./RoleDataCache.ts","./RoleDefine.ts","./SkillDefine.ts","./WingDefine.ts","./ChapterNormal.ts"],(function(t){"use strict";var e,a,n,i,o,r,l,s,d,u,p,h,f,c,E,S,M,m,U,C,g,_,b,v,P,R,I,T,y,A,D,k,F,L,w,G,N,x,B,O,q,K,H;return{setters:[function(t){e=t.inheritsLoose,a=t.regeneratorRuntime,n=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy,o=t.sys,r=t.game,l=t.Vec3},function(t){s=t.ChapterType},null,function(t){d=t.RunMode,u=t.RunState,p=t.BattleFlag,h=t.UnityType,f=t.SpBuffState,c=t.BuffGroupType,E=t.TargetFilter},function(t){S=t.EventDefine},function(t){M=t.V2},function(t){m=t.cameraMgr},function(t){U=t.ViewType},function(t){C=t.ConfigGlobal},function(t){g=t.ArtifactEvent},function(t){_=t.BattleEventDefine},function(t){b=t.default},function(t){v=t.ChapterDataCache},function(t){P=t.ChapterEventDefine},function(t){R=t.default,I=t.GameSettingKey},function(t){T=t.GuideModel},function(t){y=t.default},function(t){A=t.EquipEventDefine},function(t){D=t.FateEventDefine},function(t){k=t.FlyPetEventDefine},function(t){F=t.HorseEvent},function(t){L=t.MainViewModel},function(t){w=t.PetEventDefine},function(t){G=t.default},function(t){N=t.RoleDataCache},function(t){x=t.RoleEventDefine,B=t.PlayerAttr,O=t.ClientData},function(t){q=t.SKILLEventDefine},function(t){K=t.WingEvent},function(t){H=t.ChapterNormal}],execute:function(){var V;i._RF.push({},"561bbltX4RM9KGZnKn5BD7l","ChapterMainCC",void 0),function(t){t[t.Not=0]="Not",t[t.SkillListUpdate=1]="SkillListUpdate",t[t.RoleColorUpdate=2]="RoleColorUpdate",t[t.EquipUpdate=4]="EquipUpdate",t[t.RoleAttribUpdate=8]="RoleAttribUpdate",t[t.PetUpdate=16]="PetUpdate",t[t.PassiveSkillListUpdate=32]="PassiveSkillListUpdate",t[t.ResetEnterUpdate=64]="ResetEnterUpdate",t[t.PetAttribUpdate=128]="PetAttribUpdate",t[t.MountUpdate=256]="MountUpdate",t[t.SkillAttriUpdate=512]="SkillAttriUpdate",t[t.FlyPetUpdate=1024]="FlyPetUpdate"}(V||(V={}));t("ChapterMainCC",function(t){function i(){for(var e,a=arguments.length,n=new Array(a),i=0;i<a;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))||this).updateFlag=V.Not,e._jobId=0,e._dressId=0,e._gender=0,e._startCheckSimpTime=0,e}e(i,t);var H=i.prototype;return H.init=function(){normalEvent.on(q.ACTIVE_SKILL_LIST_UPDATE,this.onSkillListUpdate,this),normalEvent.on(x.ROLE_ATTR_LIST_UPDATE,this.onRoleAttribUpdate,this),normalEvent.on(A.EQUIP_SKIN_UPDATE,this.onEquipUpdate,this),normalEvent.on(w.PET_LIST_UPDATE,this.onPetUpdate,this),normalEvent.on(w.PET_ATTR_UPDATE,this.onPetAttribUpdate,this),normalEvent.on(x.ROLE_SKIN_CHANGE,this.onRoleSkinUpdate,this),normalEvent.on(x.ROLE_INFO_UPDATE,this.onResetEnterUpdate,this),normalEvent.on(x.ROLE_SKIN_LIST,this.onResetEnterUpdate,this),normalEvent.on(F.TYPE_HORSE_CHANGE,this.onRoleMountUpdate,this),normalEvent.on(q.SKILL_ATTR_UPDATE,this.onSkillAttrUpdate,this),normalEvent.on(g.TYPE_ARTIFACT_CHANGE,this.onEquipUpdate,this),normalEvent.on(D.OnFateInfoUpdate,this.onEquipUpdate,this),normalEvent.on(P.BATTLE_SEED,this.onBattleSeed,this),normalEvent.on(K.TYPE_WING_CHANGE,this.onRoleSkinUpdate,this),normalEvent.on(k.FlyPetUseChange,this.onFlyPetUpdate,this),battleEvent.on(S.UnitDead,this.onUnitDead,this),battleMain.runMode==d.Main&&(this.battleMain.playerAuto=IS(R).Get(I.AUTO_SKILL))},H.destroy=function(){normalEvent.off(q.ACTIVE_SKILL_LIST_UPDATE,this.onSkillListUpdate,this),normalEvent.off(x.ROLE_ATTR_LIST_UPDATE,this.onRoleAttribUpdate,this),normalEvent.off(A.EQUIP_SKIN_UPDATE,this.onEquipUpdate,this),normalEvent.off(w.PET_LIST_UPDATE,this.onPetUpdate,this),normalEvent.off(w.PET_ATTR_UPDATE,this.onPetAttribUpdate,this),normalEvent.off(x.ROLE_SKIN_CHANGE,this.onRoleSkinUpdate,this),normalEvent.off(x.ROLE_INFO_UPDATE,this.onResetEnterUpdate,this),normalEvent.off(x.ROLE_SKIN_LIST,this.onResetEnterUpdate,this),normalEvent.off(F.TYPE_HORSE_CHANGE,this.onRoleMountUpdate,this),normalEvent.off(q.SKILL_ATTR_UPDATE,this.onSkillAttrUpdate,this),normalEvent.off(g.TYPE_ARTIFACT_CHANGE,this.onEquipUpdate,this),normalEvent.off(D.OnFateInfoUpdate,this.onEquipUpdate,this),normalEvent.off(P.BATTLE_SEED,this.onBattleSeed,this),normalEvent.off(K.TYPE_WING_CHANGE,this.onRoleSkinUpdate,this),normalEvent.off(k.FlyPetUseChange,this.onFlyPetUpdate,this)},H.getConfig=function(t){return chapterDataCache.getChapterConfig(t)},H.addUnit=function(t,e){var a=Math.floor((this.config.id-1)/500)+1,n=getConfig("configMainUnit",a).getDataByKey(t);return battleMain.unitMgr.addUnitMain(n,e)},H.endBoss1_1=a().mark((function t(e,n,i){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,coroutine.wait(3);case 2:battleMain.runState=u.Running,coroutine.start(this.endPart(e,!1,n,i),"battle");case 4:case"end":return t.stop()}}),t,this)})),H.endPart=a().mark((function t(e,n,i,o){var r;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===n&&(n=!1),void(t.next=3);case 3:return(r=this.battleMain).mainCtr.positionSelected(r.mapCamera.offsetX+700),r.hub.showNextPartEffect(),t.next=8,coroutine.wait(.1);case 8:if(!r.mainCtr.isIdle()){t.next=12;break}return r.mainCtr.positionSelected(r.mapCamera.offsetX+700),t.next=12,coroutine.wait(.1);case 12:if(r.mainCtr.isIdle()){t.next=17;break}return t.next=15,coroutine.wait(.1);case 15:t.next=12;break;case 17:if(!n){t.next=25;break}return normalEvent.emit(_.BATTLE_MASK_CLOSE,0),t.next=21,coroutine.wait(.1);case 21:if(!IS(L).checkGuideShow()){t.next=25;break}return uiMgr.openView("ChapterMapView",e.id),t.next=25,coroutine.wait(3);case 25:r.runningToPart=!1,this.endResult(i,e,o);case 27:case"end":return t.stop()}}),t,this)})),H.loadData=function(e){t.prototype.loadData.call(this,e-200),null==this.battleMain.mainCtr.player?printLogErr("玩家数据为空异常！！！！"):(this._jobId=IS(N).GetTypeUsedSkin(0),this._dressId=IS(N).GetTypeUsedSkin(2),this._gender=IS(N).GetRoleAttr(B.ROLE_ATTR_GENDER)),this.battleMain.mainCtr.positionSelected(e)},H.start=function(){t.prototype.start.call(this);var e=this.battleMain;(IS(v).openSimpModel?e.battleFlag=e.battleFlag|p.SIMP_MODEL:e.battleFlag=e.battleFlag&~p.SIMP_MODEL,1==e.data.chapterMode)&&(IS(L).checkGuideShow()&&1==IS(N).getClientDataByNum(O.Battle,"endless_num")&&IS(T).openGuide(1011))},H.onUpdate=function(e){if(t.prototype.onUpdate.call(this,e),!this.over&&IS(v).simpModel&&!IS(v).openSimpModel){if(IS(v).closeSimpNum>=C.auto_simp_mode_disable_count)return;if(o.now()-IS(v).autoStartSimpTime<1e3*C.auto_simp_mode_cd)return;mainGame.fps<=C.fps_check_limit?(0==this._startCheckSimpTime&&(this._startCheckSimpTime=r.totalTime),r.totalTime-this._startCheckSimpTime>C.fps_check_time&&(IS(v).openSimpModel=!0,battleMain.battleFlag=battleMain.battleFlag|p.SIMP_MODEL,this._startCheckSimpTime=0,IS(v).autoStartSimpTime=o.now(),y.showFlyTip(GetLanguage(899000103)),normalEvent.emit(P.CHAPTER_SIMP_MODE))):this._startCheckSimpTime=0}},H.toResult=function(t,e){void 0===e&&(e=!1);var a=this.battleMain,n=this.config;0==t&&1==n.part_type&&a.checkCheat()&&(t=1,y.showBoxTip({tip:GetLanguage(200998),btnCnt:1,func:function(t){},ensure:GetLanguage(200129)}));var i=chapterDataCache.getChapterConfig(n.next_part),o=0==t&&null!=i;if(o&&1==i.part_type){if(1!=a.data.chapterMode)return IS(b).reqChapterResult(i.id,t),a.enterChapter(i.bossModel),void a.toResult(n.id,s.Main,t,e);if(1==a.data.chapterMode)return i=chapterDataCache.getChapterConfigInfo(n.id).getDataByList("index",n.index)[0],a.data.chapterId=i.id,IS(b).reqChapterResult(i.id,t),a.enterChapter(),void a.toResult(n.id,s.Main,t,e)}return o&&i.section==n.section?(a.data.chapterId=i.id,IS(b).reqChapterResult(i.id,t),void a.startNextPart(i)):0==t&&1==n.part_type?(a.runningToPart=!0,a.hub.showVictory(),void(5==n.id&&IS(L).checkGuideShow()?(a.runState=u.Pause,uiMgr.openView("LampGetView"),coroutine.start(this.endBoss1_1(n,t,e),"battle")):coroutine.start(this.endPart(n,i.chapter!=n.chapter,t,e),"battle"))):void coroutine.start(this._endResult(t,n,e),"battle")},H._endResult=a().mark((function t(e,n,i){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(1!=e||0!=n.part_type){t.next=6;break}return normalEvent.emit(_.BATTLE_MASK_CLOSE,0,1),t.next=4,coroutine.wait(.8);case 4:t.next=8;break;case 6:return t.next=8,coroutine.wait(1);case 8:this.endResult(e,n,i);case 9:case"end":return t.stop()}}),t,this)})),H.endResult=function(t,e,a){if(battleMain.enterChapter(),1==t){if(1==e.part_type){var n=IS(N).getClientDataByNum(O.Battle,"endless_num");++n<=2&&IS(G).send_3_29(O.Battle,1,"endless_num",String(n))}var i=chapterDataCache.getChapterConfigInfo(e.id).getDataByList("index",e.index);IS(b).reqChapterResult(i[0].id,t)}else battleMain.curRecord&&battleMain.curRecord.manual?IS(b).reqChapterResult(e.id,t,1,battleMain.curRecord.collects):IS(b).reqChapterResult(e.id,t);battleMain.toResult(e.id,s.Main,t,a)},H.onEndDrawUpdate=function(){if(this.updateFlag!=V.Not){var t=this.battleMain,e=t.data;if(this.updateFlag&V.ResetEnterUpdate)return IS(b).reqEnterChapter(0),t.enterChapter(),void(this.updateFlag=V.Not);this.updateFlag&V.SkillListUpdate&&(IS(v).setPlayerSkill(e,t.mainCtr.player.data,!0),t.hub.updateSkill()),this.updateFlag&V.EquipUpdate&&IS(v).setPlayerEquip(t.mainCtr.player.data),this.updateFlag&V.MountUpdate&&t.mainCtr&&t.mainCtr.player&&t.mainCtr.player.modelObj&&(IS(v).setPlayerMount(t.mainCtr.player.data),t.mainCtr.player.modelObj.mount=t.mainCtr.player.data.mount),this.updateFlag&V.RoleAttribUpdate&&IS(v).setPlayerAttrib(t.mainCtr.player.data),this.updateFlag&V.PetUpdate?this.setPlayerPets(!0):this.updateFlag&V.PetAttribUpdate&&IS(v).setPetAttrib(e.playerList[1],t.mainCtr.units),this.updateFlag&V.SkillAttriUpdate&&IS(v).setPlayerSkillAttr(t.mainCtr.player.data),this.updateFlag&V.FlyPetUpdate&&this.setFlyPet(!0),this.updateFlag=V.Not}},H.setPlayerPets=function(t){var e;void 0===t&&(t=!1);var a=this.battleMain,i=a.data,o=i.playerList[1].units,r=null==(e=a.mainCtr)?void 0:e.player;if(t){for(var l=0;l<o.length;l++){var s,d=o[l];if(d.config.type==h.Partner)null==(s=a.unitMgr.getUnit(d.unitId))||s.dead(),o.splice(l,1),l--}null==r||r.skillctr.unloadPetPassiveSkill()}if(IS(v).setPlayerPets(i.playerList[1]),t){for(var u,p=n(o);!(u=p()).done;){var S=u.value;if(S.config.type==h.Partner){var M=a.unitMgr.addPlayer(S);r&&(M.direction=r.direction),a.mainCtr.units.push(M)}}if(a.mainCtr.positionSelected(a.mapCamera.offsetX,!0,5),r&&r.data.getBuffState(f.PetAddBuff))for(var m,U=r.buffCtr.getBuffByType(c.ADDBUFF_TOPET),C=n(U);!(m=C()).done;){m.value.checkTarget(E.CastPartner)}}},H.setFlyPet=function(t){var e;void 0===t&&(t=!1);var a=this.battleMain,i=a.data,o=i.playerList[1].units,r=null==(e=a.mainCtr)?void 0:e.player;if(t){for(var l=0;l<o.length;l++){var s,d=o[l];if(d.config.type==h.FlyPet)null==(s=a.unitMgr.getUnit(d.unitId))||s.dead(),o.splice(l,1),l--}null==r||r.skillctr.unloadFlyPetPassiveSkill(),r.flyPet=null}if(IS(v).setPlayerFlyPet(i.playerList[1]),t){for(var u,p=n(o);!(u=p()).done;){var f=u.value;if(f.config.type==h.FlyPet){var c=a.unitMgr.addPlayer(f);r&&(c.direction=r.direction),a.mainCtr.units.push(c),r.flyPet=c}}a.mainCtr.positionSelected(a.mapCamera.offsetX,!0,3)}},H.onSkillListUpdate=function(){this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main&&(2!=this.battleMain.data.battleCheckout?this.updateFlag|=V.SkillListUpdate:this.updateFlag|=V.ResetEnterUpdate)},H.onRoleAttribUpdate=function(){this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main&&2!=this.battleMain.data.battleCheckout&&(this.updateFlag|=V.RoleAttribUpdate)},H.onEquipUpdate=function(){this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main&&2!=this.battleMain.data.battleCheckout&&(this.updateFlag|=V.EquipUpdate)},H.onPetUpdate=function(){this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main&&(2!=this.battleMain.data.battleCheckout?this.updateFlag|=V.PetUpdate:this.updateFlag|=V.ResetEnterUpdate)},H.onPetAttribUpdate=function(){this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main&&2!=this.battleMain.data.battleCheckout&&(this.updateFlag|=V.PetAttribUpdate)},H.onRoleSkinUpdate=function(){this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main&&(2!=this.battleMain.data.battleCheckout?this.updateFlag|=V.EquipUpdate:this.updateFlag|=V.ResetEnterUpdate)},H.onResetEnterUpdate=function(){if(this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main){var t=IS(N).GetTypeUsedSkin(0),e=IS(N).GetTypeUsedSkin(2),a=IS(N).GetRoleAttr(B.ROLE_ATTR_GENDER);(this._jobId!=t||this._dressId!=e||0!=this._gender&&this._gender!=a)&&(this.updateFlag|=V.ResetEnterUpdate)}},H.onRoleMountUpdate=function(){this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main&&(2!=this.battleMain.data.battleCheckout?this.updateFlag|=V.MountUpdate:this.updateFlag|=V.ResetEnterUpdate)},H.onSkillAttrUpdate=function(){this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main&&2!=this.battleMain.data.battleCheckout&&(this.updateFlag|=V.SkillAttriUpdate)},H.onBattleSeed=function(){this.battleMain.runState==u.Running&&(battleMain.timeScale=IS(v).speed_scale)},H.onUnitDead=function(t){if(!this.over&&1==t.teamId){var e=new l,a=uiMgr.pNodes[U.NormalView];m.battleCamera.convertToUINode(new l(t.position.x,t.position.y+640),a,e),IS(b).reqChaptrKillReward(this.config.id,t.config.id,new M(Math.floor(e.x),Math.floor(e.y)))}},H.onFlyPetUpdate=function(){this.battleMain.runState==u.Running&&this.battleMain.runMode==d.Main&&2!=this.battleMain.data.battleCheckout&&(this.updateFlag|=V.FlyPetUpdate)},i}(H));i._RF.pop()}}}));

