System.register("chunks:///_virtual/BaseView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./V2.ts","./UIEffectAsset.ts","./UIShipModel.ts","./UIUnitModelObj.ts","./index23.ts","./AudioMgr.ts","./index3.ts","./UIList.ts","./RedPoint.ts","./RedPointMgr.ts","./NodeUtil.ts","./StringUtil.ts","./ItemIcon.ts","./UIDefine.ts","./Timer.ts","./Tween.ts"],(function(i){"use strict";var t,e,n,s,o,r,l,a,h,c,u,d,f,_,p,v,m,w,g,M,C,D,I,V,E,b,S;return{setters:[function(i){t=i.createForOfIteratorHelperLoose,e=i.createClass},function(i){n=i.cclegacy,s=i.isValid,o=i.sys,r=i.UITransform,l=i.Label,a=i.Prefab,h=i.Animation,c=i.Button},function(i){u=i.V2},function(i){d=i.UIEffectAsset},function(i){f=i.UIShipModel},function(i){_=i.UIUnitModelObj},null,function(i){p=i.audioMgr},null,function(i){v=i.UIList},function(i){m=i.RedPointType},function(i){w=i.RedPointMgr},function(i){g=i.default},function(i){M=i.default},function(i){C=i.IconAseetType,D=i.ItemIcon},function(i){I=i.UIViewState,V=i.ViewType,E=i.ViewEventType},function(i){b=i.TimerGroup},function(i){S=i.TweenGroup}],execute:function(){var L;i("ViewEvent",void 0),n._RF.push({},"8cfaav/ia1Jg56hUYYl15Z8","BaseView",void 0),function(i){i.ViewOpen="ViewOpen",i.ViewClose="ViewClose"}(L||(L=i("ViewEvent",{})));i("BaseView",function(){function i(){this.state=I.None,this.viewType=V.NormalView,this.sortIdx=0,this.parentView=void 0,this.node=void 0,this.ut=void 0,this.depth=0,this.name=void 0,this.url=void 0,this.openArgs=void 0,this.closeTime=0,this.banDefeat=!1,this.poolTime=3e4,this.closeDestroy=!1,this._timerGroup=void 0,this._tweenGroup=void 0,this._compDelegateDic=void 0,this._compClickDic=void 0,this._subViewDict=void 0,this._eventActions=void 0,this._subCompSet=new Set,this._redPointDic=void 0,this._iconDic=void 0,this._uilists=void 0,this._uiEffects=void 0,this._unitModelId=0,this._effectId=0,this._unitModels=void 0,this._shipModelId=0,this._shipModels=void 0,this._viewAnimation=void 0,this._instantiateId=0,this._visible=!0,this.tweenCloseTime=0,this.tweenOpenTime=.01,this.fullScreen=!1,this.onLoadViewSuccess=void 0}var n=i.prototype;return n.onUpdate=function(i){},n.open=function(){if(this.state!=I.Destroy){if(this.openArgs=arguments.length<=0?void 0:arguments[0],this.state!=I.Loading)return this.state==I.None?(uiMgr.OpenViewSortIdx(this),void this._resLoad()):this.state==I.Close?(uiMgr.OpenViewSortIdx(this),this.state=I.Opening,void uiMgr.addOpenTask(this)):void(this.state==I.Open&&(uiMgr.OpenViewSortIdx(this),this._openView()));printLogWarn(this.name+" 正在加载中，请稍后")}else printLogWarn(this.name+" 已被销毁")},n.close=function(){if(this.state!=I.Closeing){if(this.state==I.Loading)return printLogWarn(this.name+"放弃加载!!!!,原因是:没加载完成之前,有人调用了CloseView()"),this._removeAllComponentCallbackListeners(),this._removeAllRedPoint(),this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes(this.url,this.onLoadViewSuccess),this.onLoadViewSuccess=null),0==this._instantiateId&&(nodeInstantiate.remove(this._instantiateId),this._instantiateId=0),uiMgr.CloseViewSortIdx(this),null!=this.parentView?void(this.state=I.None):void this._setViewState(I.Destroy);if(this.state!=I.CloseTween&&this.state!=I.Close&&this.state!=I.Destroy)return this.state==I.Opening?(uiMgr.CloseViewSortIdx(this),uiMgr.removeOpenTask(this),this.fullScreen&&uiMgr.openFullScreenNum.delete(this.name),void(this.state=I.Close)):void uiMgr.addCloseTask(this);s(this.node)&&(this.node.active=!1)}},n._closeView=function(i){if(void 0===i&&(i=!1),0==i&&(i=this.closeDestroy),this.state!=I.Close&&this._beforeClose(),i){for(var t in s(this.node)&&this.url&&resourceMgr.releaseResRef(this.url),this._removeAllComponentCallbackListeners(),this._unloadIcons(),this._removeAllRedPoint(),this._unUILists(),this.onDestroy(),this._subViewDict){this._subViewDict[t].destroy()}s(this.node)&&(this.node.destroy(),this.node=null),this._setViewState(I.Destroy)}else{var e=this.node;this.closeTime=o.now(),s(e)&&(e.active=!1),this._setViewState(I.Close)}},n.dealMirrorLayout=function(i){if(o.uiMirror){i.horizontalDirection=1==i.horizontalDirection?0:1;var t=i.node;t.setScale(-1,1,1),t.getComponent(r).anchorX=1-t.getComponent(r).anchorX,this.refreshTxtMirrorByLayout(i)}},n.refreshTxtMirrorByLayout=function(i){for(var t=i.node.getComponentsInChildren(l),e=0;e<t.length;e++)t[e].node.setScale(1,1,1)},n.adjustMirrorNode=function(i,t,e,n){if(void 0===t&&(t=0),void 0===e&&(e=!0),o.uiMirror){if(e&&i.setScale(-Math.abs(i.scale.x),i.scale.y),n)i.getComponent(r).anchorX=n;t&&0!=t&&i.setPosition(i.position.x+t,i.position.y)}},n.destroy=function(){this.state!=I.Destroy&&this._closeView(!0)},n._resLoad=function(){var i=this;this.onLoadViewSuccess=function(t){if(i.onLoadViewSuccess=null,t.error||null==t.item)i._setViewState(I.LoadFail);else{if(s(i.node))return printLogWarn("base view node not null",i.node),void i._setViewState(I.LoadFail);var e=t.item.asset;i._instantiateId=nodeInstantiate.instantiateAsync(e,(function(t,e){i._instantiateId=0,e.setPosition(0,0,0),e.name=i.name,i.node=e,i.ut=e.getComponent(r),i._setViewState(I.Init)}))}},resourceMgr.loadRes(this.url,a,this.onLoadViewSuccess),this._setViewState(I.Loading)},n._setViewState=function(i){if(!this.state||this.state!=i){var t=this.state!=I.Close&&"GuideView"!=this.name;switch(this.state=i,uiMgr.onViewStateChange(this,i),i){case I.Init:var e=uiMgr.pNodes[this.viewType];this.node.setParent(e,!1),this._openViewInit();break;case I.LoadFail:printLogErr("界面加载失败 ["+this.name+"] : "+this.url),uiMgr.onViewStateChange(this,I.Destroy);break;case I.Open:normalEvent.emit(L.ViewOpen,this.name);break;case I.Close:case I.Destroy:t&&normalEvent.emit(L.ViewClose,this.name)}}},n._openViewInit=function(){this._viewAnimation=this.node.getComponent(h),this.onInit(),this._openView()},n._updateDeth=function(){var i=this.node;this.parentView?i.setSiblingIndex(i.parent.children.length-1):this.node.setSiblingIndex(this.sortIdx)},n._openView=function(){var i=this.node;if(s(i)){i.active=this._visible,this._updateDeth(),this.tweenOpenTime>0&&this._viewAnimation&&this.playAnim();try{this._afterOpen()}catch(i){printLogException(i,"openview err "+this.name)}this._setViewState(I.Open)}},n._update=function(i){if(null!=this._timerGroup&&this._timerGroup.update(i),null!=this._tweenGroup&&this._tweenGroup.update(i),null!=this._uilists)for(var e,n=t(this._uilists);!(e=n()).done;){e.value.update()}for(var s in this.onUpdate(i),this._subViewDict){var o=this._subViewDict[s];o.isActive&&o._update(i)}},n._afterOpen=function(){this.fullScreen&&uiMgr.openFullScreenNum.add(this.name),this.registerUpdateHandler(),this.onAfterOpen()},n._beforeClose=function(){for(var i in this.fullScreen&&uiMgr.openFullScreenNum.delete(this.name),coroutine.stopGroup("ui-"+this.name),null!=this._timerGroup&&this._timerGroup.clear(),this._removeAllEvent(),this._closeIcons(),this._closeUILists(),this._closeUIEffect(),this._closeUnitModel(),this._closeTween(),this._subViewDict){var t=this._subViewDict[i];t.isActive&&(t.isActive=null,t._beforeClose())}this.onBeforeClose()},n.playAnim=function(i,t){void 0===t&&(t=!1),s(this._viewAnimation)&&(this._viewAnimation.play(i),t&&this._viewAnimation.update(0))},n.checkFullSrceen=function(){if(this.fullScreen)return!0;for(var i in this._subViewDict){var t=this._subViewDict[i];if(t.isActive&&t.fullScreen)return!0}},n.findChild=function(i){return g.findChild(this.node,i)},n.findChildComponent=function(i,t){return g.findChildComponent(this.node,i,t)},n._addComponentCallbackListener=function(i,t,e){var n,s=this,o=null!=(n=this.parentView)?n:this;if(o==this){var r;this._compDelegateDic=null!=(r=this._compDelegateDic)?r:new Map;var l=this._compDelegateDic.get(i);if(null==l)l={},this._compDelegateDic.set(i,l);else{var a=l[t];null!=a&&i.off(t,a)}var h,u=function(n){try{e(n)}catch(i){printLogException(i,"[CompoentEvent] err: "+s.name+" - eventType: "+t)}t==c.EventType.CLICK&&(p.playSound("common_tap"),uiMgr.lastClickObj=i,normalEvent.emit(E.EventClick,i))};if(t==c.EventType.CLICK)this._compClickDic=null!=(h=this._compClickDic)?h:new Map,this._compClickDic.set(i,u);i.on(t,u),l[t]=u}else o._addComponentCallbackListener(i,t,e)},n.addComponentCallbackListener=function(i,t,e){this.parentView&&this._subCompSet.add(i),this._addComponentCallbackListener(i,t,e)},n._removeAllComponentCallbackListeners1=function(i){var t,e=this,n=null!=(t=this.parentView)?t:this;if(n==this){if(null==this._compDelegateDic)return;if(null!=i)return void i.forEach((function(i){e._compDelegateDic.delete(i),e._compClickDic.delete(i)}));this._compDelegateDic.clear(),this._compClickDic.clear()}else n._removeAllComponentCallbackListeners1(i)},n._removeAllComponentCallbackListeners=function(){var i;s(this.node)&&(this.parentView?(this._removeAllComponentCallbackListeners1(this._subCompSet),null==(i=this._subCompSet)||i.clear()):this._removeAllComponentCallbackListeners1())},n.getComponentClickCallBack=function(i){var t,e=null!=(t=this.parentView)?t:this;if(e==this){if(null==this._compClickDic)return;return this._compClickDic.get(i)}return e.getComponentClickCallBack(i)},n.addRedPoint=function(i,t,e,n,s){var o;if(void 0===n&&(n=m.Dot),void 0===s&&(s=1),this._redPointDic=null!=(o=this._redPointDic)?o:{},!this._redPointDic[i]){var r=IS(w).addRedPoint(i,t,e,n,s);this._redPointDic[i]=r}},n._removeAllRedPoint=function(){if(this._redPointDic)for(var i in this._redPointDic)IS(w).removeRedPoint(i,this._redPointDic[i])},n.loadIcon=function(i,t,e,n,s,o){var r;void 0===s&&(s=C.UI_ATLAS),this._iconDic=null!=(r=this._iconDic)?r:new Map;var l=this._iconDic.get(i);null==l&&(l=new D,this._iconDic.set(i,l)),l.sprite=i,l.assetType=s,l.atlas=t,l.frame=e,l.callback=n,l.noMirror=o||!1,l.load()},n.loadRemoteIcon=function(i,t,e,n,s){var o;void 0===n&&(n=!1),i=i.replace("f1.img4399.com/syavatar~","f1img.qq933.com/syavatar/"),this._iconDic=null!=(o=this._iconDic)?o:new Map;var r=this._iconDic.get(t);if(null==r&&(r=new D,this._iconDic.set(t,r)),0==GlobalDefine.SERVER_LIST_TYPE||null==i||""==i)return r.sprite=t,r.assetType==C.REMOTE&&(r.assetType=C.UI_ATLAS,r.forceChange()),r.atlas="common",r.frame="grxx_ui_morentouxiang",r.noMirror=s||!1,void r.load();n&&(i=M.GetURLWithTime(i)),r.assetType=C.REMOTE,r.sprite=t,r.url=i,r.callback=e,r.load()},n._closeIcons=function(){null!=this._iconDic&&this._iconDic.forEach((function(i,t){i.close()}))},n._unloadIcons=function(){null!=this._iconDic&&(this._iconDic.forEach((function(i,t){i.unload()})),this._iconDic.clear())},n.addSubView=function(i,t){var e;if(this._subViewDict=null!=(e=this._subViewDict)?e:{},!this._subViewDict[i]){var n=uiMgr.createView(i);return this._subViewDict[i]=n,t&&(n.node=t,n.ut=t.getComponent(r),t.active=!1),n.parentView=this,t&&(n.onInit(),n.setActive(!1),n.state=I.Close),n}printLogErr("SubView has already register name : "+i)},n.removeSubView=function(i){null!=this._subViewDict&&delete this._subViewDict[i]},n.addEvent=function(i,e,n,s){var o,r=this;if(void 0===s&&(s=!1),this._eventActions=null!=(o=this._eventActions)?o:new Map,null==n&&(n=this),this._isRepeat(i,e))printLogWarn(this.name+"  already add!");else{var l={action:e,target:n,hideTrigger:s};if(this._eventActions.has(i)){this._eventActions.get(i).list.push(l)}else{var a=function(){for(var e=r._eventActions.get(i),n=arguments.length,s=new Array(n),o=0;o<n;o++)s[o]=arguments[o];for(var l,a=t(e.list);!(l=a()).done;){var h=l.value;if(r.visible||h.hideTrigger)try{var c;if(h.target)(c=h.action).call.apply(c,[h.target].concat(s));else h.action.apply(h,s)}catch(t){printLogException(t,"[NormalEvent] event-type: "+i+" view: "+r.name)}}},h={func:a,list:[]};h.list.push(l),this._eventActions.set(i,h),normalEvent.on(i,a)}}},n._isRepeat=function(i,t){var e=this._eventActions.get(i);if(null==e)return!1;for(var n=0;n<e.list.length;n++){if(t==e.list[n].action)return!0}return!1},n._removeAllEvent=function(){this._eventActions&&(this._eventActions.forEach((function(i,t){normalEvent.off(t,i.func)})),this._eventActions.clear())},n.addTimer=function(i,t,e,n){void 0===t&&(t=1);var s=this._timerGroup;return s||(s=new b("ui-"+this.name),this._timerGroup=s),s.start(i,t,e,n)},n.removeTimer=function(i){this._timerGroup&&this._timerGroup.stop(i)},n.startCoroutine=function(i){return coroutine.start(i,"ui-"+this.name)},n.stopCoroutine=function(i){null!=i&&coroutine.stop(i)},n.addUIList=function(i,t,e,n,s){var o;void 0===e&&(e=!0),void 0===n&&(n=2),void 0===s&&(s=2),this._uilists=null!=(o=this._uilists)?o:[];var r=new v;return r.touchEvent=e,r.init(i,this,t),r.frameRenderTime=n,r.frameMaxNum=s,this._uilists.push(r),r},n._closeUILists=function(){null!=this._uilists&&this._uilists.forEach((function(i){i.clearData()}))},n._unUILists=function(){null!=this._uilists&&(this._uilists.forEach((function(i){i.destroy()})),this._uilists.length=0)},n.addUIEffect=function(i,t,e,n,s,o){var r;void 0===n&&(n=u.ZERO),void 0===s&&(s=1);var l=d.alloc(i,t,e,o);return l.position=n,l.scale=s,l.depth=20,this._uiEffects=null!=(r=this._uiEffects)?r:[],this._uiEffects.push(l),this._effectId++,l.id=this._effectId,this._effectId},n.removeUIEffect=function(i){if(null!=this._uiEffects)for(var t=0;t<this._uiEffects.length;t++){var e=this._uiEffects[t];if(e.id==i){e.free(),this._uiEffects.splice(t,1);break}}},n.setUIEffect=function(i,t,e){if(void 0===t&&(t=u.ZERO),void 0===e&&(e=1),null!=this._uiEffects)for(var n=0;n<this._uiEffects.length;n++){var s=this._uiEffects[n];if(s.id==i)return s.position=t,void(s.scale=e)}},n.getUIEffect=function(i){if(null!=this._uiEffects)for(var t=0;t<this._uiEffects.length;t++){var e=this._uiEffects[t];if(e.id==i)return e}},n._closeUIEffect=function(){null!=this._uiEffects&&(this._uiEffects.forEach((function(i){i.free()})),this._uiEffects.length=0)},n.addUnitModel=function(i,t,e){var n,s;void 0===t&&(t=u.ZERO),void 0===e&&(e=1);var o=_.alloc(i.job,i.dressId,i.gender,i.parent);return i.wing=null!=(n=i.wing)?n:0,o.setSkin(i.color,i.weapon,i.ornaments,i.face,i.shenqi,i.fate,i.wing),o.mount=i.mount,o.position=t,o.scale=e,this._unitModels=null!=(s=this._unitModels)?s:[],this._unitModelId++,o.id=this._unitModelId,this._unitModels.push(o),this._unitModelId},n.removeUnitModel=function(i){if(null!=this._unitModels)for(var t=0;t<this._unitModels.length;t++){var e=this._unitModels[t];if(e.id==i){_.free(e),this._unitModels.splice(t,1);break}}},n.getUnitModel=function(i){if(null==this._unitModels)return null;for(var t=0;t<this._unitModels.length;t++){var e=this._unitModels[t];if(e.id==i)return e}return null},n._closeUnitModel=function(){null!=this._unitModels&&(this._unitModels.forEach((function(i){i.free()})),this._unitModels.length=0)},n.addShipModel=function(i,t,e){var n;void 0===t&&(t=u.ZERO),void 0===e&&(e=1);var s=f.alloc(i.shipId,i.parent);return s.setSkin(i.flag,i.ram,i.gunId),s.position=t,s.scale=e,this._shipModels=null!=(n=this._shipModels)?n:[],this._shipModelId++,s.id=this._shipModelId,this._shipModels.push(s),this._shipModelId},n.removeShipModel=function(i){if(null!=this._shipModels)for(var t=0;t<this._shipModels.length;t++){var e=this._shipModels[t];if(e.id==i){f.free(e),this._shipModels.splice(t,1);break}}},n.getShipModel=function(i){if(null==this._shipModels)return null;for(var t=0;t<this._shipModels.length;t++){var e=this._shipModels[t];if(e.id==i)return e}return null},n._closeShipModel=function(){null!=this._shipModels&&(this._shipModels.forEach((function(i){i.free()})),this._shipModels.length=0)},n.addTween=function(i,t,e,n){return void 0===i&&(i=0),void 0===t&&(t=1),void 0===e&&(e=1),null==this._tweenGroup&&(this._tweenGroup=new S("ui-"+this.name)),this._tweenGroup.to(i,t,e,n)},n._closeTween=function(){null!=this._tweenGroup&&this._tweenGroup.clear()},e(i,[{key:"visible",get:function(){return this._visible},set:function(i){this._visible!=i&&(this._visible=i,this.node&&(this.node.active=i))}}]),i}());n._RF.pop()}}}));

