System.register("chunks:///_virtual/ActivityHalloweenGamePlayView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./NodeUtil.ts","./StringUtil.ts","./index57.ts","./SpineSkeleton.ts","./MathUtil.ts","./ObjectUtil.ts","./MessageView.ts","./ActivityControl.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./BaseView.ts"],(function(t){"use strict";var e,i,n,o,s,a,r,h,d,c,u,l,f,g,m,v,I,p,x,C,y,w,R;return{setters:[function(t){e=t.inheritsLoose},function(t){i=t.cclegacy,n=t.Vec2,o=t.Label,s=t.Button,a=t.js,r=t.ProgressBar,h=t.UITransform,d=t.Vec3,c=t.Sprite,u=t.Node},function(t){l=t.default},function(t){f=t.default},null,function(t){g=t.SpineSkeleton},function(t){m=t.default},function(t){v=t.default},function(t){I=t.default},function(t){p=t.default},function(t){x=t.default},function(t){C=t.ActivityEventDefine,y=t.ActivityType,w=t.ActivityState},function(t){R=t.BaseView}],execute:function(){var b;i._RF.push({},"765126s99RNOL6CHi1mZvnl","ActivityHalloweenGamePlayView",void 0);var B=new n(-294,292),T=new n(116,116),M=((b={})[0]=553,b[1]=640,b[2]=640,b[3]=553,b);t("default",function(t){function i(){var e;return(e=t.call(this)||this).curChapter=void 0,e.curChapterCfg=void 0,e.txtRemainTimes=void 0,e.useCount=0,e.monsterItems=[],e.nodeUnitRoot=void 0,e.utUnitRoot=void 0,e.nodeUnitItem=void 0,e.unitItems=void 0,e.targetPosDic={},e.oriPos=void 0,e.curIndex=void 0,e.isMoving=!1,e.beadList=void 0,e.beatMonstarDic={},e.totalBeadIndex=void 0,e.isTouchStart=void 0,e.needRecover=!1,e.nodeBoomEffectRoot=void 0,e.nodeFlyEffectRoot=void 0,e.nodeModelRoot=void 0,e.txtTitle=void 0,e.name="ActivityHalloweenGamePlayView",e.url="ui/module/halloween/ActivityHalloweenGamePlayView",e.fullScreen=!0,e}e(i,t);var R=i.prototype;return R.onInit=function(){var t=this;this.txtTitle=this.findChildComponent("title/txtTitle",o),this.totalBeadIndex=configGgbond_bead.getDatas().length;var e=this.findChild("view/btnClose");this.addComponentCallbackListener(e,s.EventType.CLICK,(function(){t.isMoving?I.showFlyTip(GetLanguage(201210)):I.showBoxTip({tip:GetLanguage(201211),func:function(e){"type_yes"==e&&t.close()}})})),this.txtRemainTimes=this.findChildComponent("view/txtCount",o),this.monsterItems=[];for(var i=1;i<=4;i++){var n=this.findChild(a.formatStr("view/enemy%s",i));this.monsterItems.push({node:n,pbHp:l.findChildComponent(n,"pbNormalHp",r),nodeModel:l.findChild(n,"imgGGBond"),index:i,monsterId:0,monsterCfg:null})}this.nodeUnitRoot=this.findChild("view/map/unitRoot"),this.utUnitRoot=this.nodeUnitRoot.getComponent(h),this.nodeUnitItem=this.findChild("view/map/unitRoot/item"),this.nodeUnitItem.active=!1,this.nodeBoomEffectRoot=this.findChild("view/map/effectRoot/boomEffect"),this.nodeFlyEffectRoot=this.findChild("view/map/effectRoot/flyEffect"),this.nodeModelRoot=this.findChild("view/model/imgGGBond")},R.registerUpdateHandler=function(){this.addEvent(C.OnActivityInfoUpdate,this.updateInfo,this),this.addEvent(C.OnHolloweenChapterResult,this.OnHolloweenChapterResult,this)},R.onAfterOpen=function(){this.addUIEffect("prefab/ui-effect/MX_j_L4_zzx",this.nodeModelRoot,-1,new n(0,-90),.3),this.curChapter=this.openArgs[0],this.curChapterCfg=configGgbond_chapter.getDataByKey(this.curChapter);var t=IS(x).GetActivityInfo(y.HalloweenGame),e=IS(x).GetRoundCfg(y.HalloweenGame,t.round);this.txtTitle.string=e.name,this.initMonsterShow(),this.initUnitShow(),this.updateRemainTimes()},R.initMonsterShow=function(){for(var t=this,e=this.curChapterCfg.monster,i=function(i){var n=e[i],o=t.monsterItems[i];o.monsterId=n,o.monsterCfg=configGgbond_monster.getDataByKey(n),o.curHp=o.monsterCfg.monster_hp,o.pbHp.progress=1;var s=o.monsterCfg.scale/1e4;o.node.active=!0,t.addUIEffect(a.formatStr("prefab/ui-effect/%s",o.monsterCfg.spine),o.nodeModel,-1,null,s,(function(t){var e=t.node;o.spine=e.getComponent(g),o.spine.setAnimation(0,"idle",!0)}))},n=0;n<e.length;n++)i(n)},R.initUnitShow=function(){var t=this.curChapterCfg.initial_bead;null==this.unitItems&&(this.unitItems=[]),this.beadList=v.clone(t);for(var e=0;e<t.length;e++){var i=this.unitItems[e]||this.newUnitItem();i.setIndex(e+1);var n=this.getPosByIndex(e+1);i.node.position=new d(n.x,n.y,0),i.id=t[e],i.cfg=configGgbond_bead.getDataByKey(i.id),this.loadIcon(i.imgIcon,"halloween_game",i.cfg.icon),i.node.active=!0,this.unitItems[e]=i}for(var o=t.length;o<this.unitItems.length;o++)this.unitItems[o].hide()},R.newUnitItem=function(){var t=this,e=nodeInstantiate.instantiate(this.nodeUnitItem);e.parent=this.nodeUnitRoot;var i={node:e,imgIcon:l.findChildComponent(e,"imgIcon",c),index:null,hide:function(){i.node.active=!1,i.index=null},setIndex:function(t){i.index=t,i.node.name=String(t)}};return this.addComponentCallbackListener(e,u.EventType.TOUCH_START,(function(e){t.onTouchStart(e,i)})),this.addComponentCallbackListener(e,u.EventType.MOUSE_DOWN,(function(e){t.onTouchStart(e,i)})),this.addComponentCallbackListener(e,u.EventType.TOUCH_MOVE,(function(e){t.onTouchMove(e,i)})),this.addComponentCallbackListener(e,u.EventType.MOUSE_MOVE,(function(e){t.onTouchMove(e,i)})),this.addComponentCallbackListener(e,u.EventType.TOUCH_END,(function(e){t.onTouchEnd(e,i)})),this.addComponentCallbackListener(e,u.EventType.TOUCH_CANCEL,(function(e){t.onTouchEnd(e,i)})),this.addComponentCallbackListener(e,u.EventType.MOUSE_UP,(function(e){t.onTouchEnd(e,i)})),i},R.updateRemainTimes=function(){this.txtRemainTimes.string=f.formatStrWithMirrorDeal(GetLanguage(201209),this.curChapterCfg.limit-this.useCount)},R.updateMonsterHp=function(t,e){if(!this.beatMonstarDic[t]){var i=this.monsterItems[t],n=i.curHp,o=Math.max(0,i.curHp-e);i.curHp=o,i.pbHp.progress=Math.max(0,i.curHp),i.spine.setAnimation(0,"hit",!1),i.spine.addAnimation(0,"idle",!0),normalTween.to(n,o,.3,(function(t,e){i.pbHp.progress=Math.min(1,e/i.monsterCfg.monster_hp)})).call((function(){o<=0&&(i.node.active=!1)})).start(),o<=0&&(this.beatMonstarDic[t]=!0)}},R.checkChapterEnd=function(){this.isMoving=!1;for(var t=!0,e=0;e<this.monsterItems.length;e++)if(1!=this.beatMonstarDic[e]){t=!1;break}t?IS(p).send_24_73(1,this.curChapter,this.useCount):this.useCount>=this.curChapterCfg.limit&&IS(p).send_24_73(0,this.curChapter,this.useCount)},R.getPosByIndex=function(t){var e=this.getRowColByIndex(t);return this.getPosByRowCol(e.row,e.col)},R.getPosByRowCol=function(t,e){return{x:(e-1)*T.x+B.x,y:B.y-(t-1)*T.y}},R.getRowColByIndex=function(t){var e=Math.ceil(t/6);return{row:e,col:t-6*(e-1)}},R.getIndexByRowCol=function(t,e){return 6*(t-1)+e},R.getItemByIndex=function(t){for(var e=0;e<this.unitItems.length;e++)if(this.unitItems[e].index&&this.unitItems[e].index==t)return this.unitItems[e]},R.setChangeIndex=function(t,e){var i=this;this.isMoving=!0,this.needRecover=!1,this.isTouchStart=!1,this.useCount=this.useCount+1,this.updateRemainTimes();var n=this.getPosByIndex(t),o=this.getPosByIndex(e),s=this.beadList[t-1],a=this.beadList[e-1];this.beadList[e-1]=s,this.beadList[t-1]=a;var r=this.getItemByIndex(t),h=this.getItemByIndex(e);normalTween.to(0,1,.2,(function(t,e){r.node.position=new d(n.x+e*(o.x-n.x),n.y+e*(o.y-n.y),0),h.node.position=new d(o.x+e*(n.x-o.x),o.y+e*(n.y-o.y),0)})).call((function(){r.setIndex(e),h.setIndex(t),i.checkNeedClear()})).start()},R.getClearByList=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i];if(!(i+1>=t.length||i+2>=t.length)){var o=t[i+1],s=t[i+2];if(o==n&&s==n){var a=this.getRowColByIndex(i+1),r=this.getRowColByIndex(i+2),h=this.getRowColByIndex(i+3);a.row==r.row&&r.row==h.row&&e.push([i,i+1,i+2])}var d=i+6,c=i+12;if(!(i+6>=t.length||i+12>=t.length)){var u=t[d],l=t[c];u==n&&l==n&&e.push([i,i+6,i+12])}}}for(var f={},g=0;g<e.length;g++)for(var m=0;m<e[g].length;m++)f[e[g][m]]||(f[e[g][m]]=!0);return f},R.checkNeedClear=function(){var t=this.getClearByList(this.beadList);v.isEmpty(t)?this.checkChapterEnd():this.factClearItem(t)},R.factClearItem=function(t){var e=this,i={},o=function(t){var o=Number(t)+1,s=e.getRowColByIndex(o),a=e.getPosByIndex(o),r=e.getTargetMonsterIndex(s.col),h=M[r];i[s.col]||(i[s.col]=0),i[s.col]=i[s.col]+1,e.beadList[o-1]=-1;var c=e.getItemByIndex(o);e.addUIEffect("prefab/ui-effect/MX_tx_xiaoxiaole",e.nodeBoomEffectRoot,1,new n(a.x,a.y),1,(function(t){t.node.getComponent(g).needAnimation=c.cfg.effect})),c.hide();var u=e.addUIEffect("prefab/ui-effect/MX_tx_xiaoxiaole_zidan",e.nodeFlyEffectRoot,-1,new n(a.x,a.y),1,(function(t){var i=t.node;normalTween.to(0,1,.3,(function(t,e){i.position=new d(a.x,a.y+e*(h-a.y),0)})).call((function(){e.removeUIEffect(u),e.updateMonsterHp(r,1)})).start()}))};for(var s in t)o(s);var a=[];for(var r in i)for(var h=Number(r),c=1;c<=i[r];c++)a.push(this.getIndexByRowCol(6+c,h));a.sort((function(t,e){return t-e}));for(var u={},l=0;l<a.length;l++){var f=this.getEmptyItem(),m=a[l];f.setIndex(m);var v=this.getPosByIndex(m);f.node.position=new d(v.x,v.y,0),f.node.active=!0;var I={};u[m-1]&&u[m-2]&&u[m-1]==u[m-2]&&(I[u[m-1]]=!0),u[m-6]&&u[m-12]&&u[m-6]==u[m-12]&&(I[u[m-6]]=!0);var p=this.getRandomBeadId(I);f.id=p,u[m]=p,f.cfg=configGgbond_bead.getDataByKey(f.id),this.loadIcon(f.imgIcon,"halloween_game",f.cfg.icon)}for(var x={},C=0;C<this.beadList.length;C++)if(-1==this.beadList[C]){var y=void 0,w=this.getRowColByIndex(C+1);if(w.row<6)for(var R=w.row+1;R<=6;R++){var b=this.getIndexByRowCol(R,w.col);if(-1!=this.beadList[b-1]&&null==x[b]){y=b,x[b]=C+1,this.beadList[b-1]=-1;break}}if(!y)for(var B=1;B<=i[w.col];B++){var T=this.getIndexByRowCol(6+B,w.col);if(null!=u[T]&&null==x[T]){y=T,x[T]=C+1;break}}}var P=function(t){var i=e.getItemByIndex(Number(t)),n=i.id,o=x[t];i.setIndex(o);var s=e.getPosByIndex(Number(t)),a=e.getPosByIndex(o);normalTween.to(0,1,.3,(function(t,e){i.node.position=new d(s.x+e*(a.x-s.x),s.y+e*(a.y-s.y),0)})).call((function(){e.beadList[o-1]=n})).start()};for(var E in x)P(E);this.addTimer(.4,1,(function(){e.checkNeedClear()}))},R.getRandomBeadId=function(t){var e=m.getRandomInt(1,this.totalBeadIndex+1);if(t&&t[e])for(;t[e];)e=m.getRandomInt(1,this.totalBeadIndex+1);return e},R.getTargetMonsterIndex=function(t){return 1==t||2==t&&!this.beatMonstarDic[0]?0:3==t||2==t&&this.beatMonstarDic[0]?1:4==t||5==t&&this.beatMonstarDic[3]?2:6==t||5==t&&!this.beatMonstarDic[3]?3:void 0},R.getEmptyItem=function(){for(var t=0;t<this.unitItems.length;t++)if(null==this.unitItems[t].index)return this.unitItems[t]},R.onBeforeClose=function(){if(this.needRecover=!1,this.isMoving=!1,this.useCount=0,this.beatMonstarDic={},this.isTouchStart=!1,this.unitItems)for(var t=0;t<this.unitItems.length;t++)this.unitItems[t].hide()},R.onDestroy=function(){if(this.unitItems){for(var t=0;t<this.unitItems.length;t++)this.unitItems[t].node.destroy();this.unitItems=null}},R.updateInfo=function(t){t.type==y.HalloweenGame&&t.state!=w.Open&&this.close()},R.OnHolloweenChapterResult=function(t,e,i){if(e==this.curChapter)if(0!=t){for(var n=this.curChapterCfg.star_step,o=0,s=0;s<n.length;s++)if(i<=n[s]){o=3-s;break}uiMgr.openView("ActivityHalloweenGameResultView",{result:t,step:i,star:o})}else uiMgr.openView("ActivityHalloweenGameResultView",{result:t})},R.onTouchStart=function(t,e){if(!this.isMoving){this.isTouchStart=!0;var i=e.index;this.curIndex=i,this.targetPosDic={};var n=t.getUILocation(),o=new d(n.x,n.y,0);this.oriPos=this.utUnitRoot.convertToNodeSpaceAR(o);var s=this.getRowColByIndex(i);s.col-1>0&&(this.targetPosDic.left=this.getPosByRowCol(s.row,s.col-1).x),s.col+1<=6&&(this.targetPosDic.right=this.getPosByRowCol(s.row,s.col+1).x),s.row-1>0&&(this.targetPosDic.up=this.getPosByRowCol(s.row-1,s.col).y),s.row+1<=6&&(this.targetPosDic.down=this.getPosByRowCol(s.row+1,s.col).y),this.needRecover=!0}},R.onTouchMove=function(t,e){if(!this.isMoving&&this.isTouchStart&&e.index==this.curIndex){var i=t.getUILocation(),n=new d(i.x,i.y,0),o=this.utUnitRoot.convertToNodeSpaceAR(n),s=this.getPosByIndex(this.curIndex),a=Math.min(this.getPosByIndex(6).x,Math.max(B.x,s.x+o.x-this.oriPos.x)),r=Math.max(this.getPosByIndex(36).y,Math.min(B.y,s.y+o.y-this.oriPos.y));e.node.position=new d(a,r,0),this.targetPosDic.left&&a<=this.targetPosDic.left?this.setChangeIndex(this.curIndex,this.curIndex-1):this.targetPosDic.right&&a>=this.targetPosDic.right?this.setChangeIndex(this.curIndex,this.curIndex+1):this.targetPosDic.up&&r>=this.targetPosDic.up?this.setChangeIndex(this.curIndex,this.curIndex-6):this.targetPosDic.down&&r<=this.targetPosDic.down&&this.setChangeIndex(this.curIndex,this.curIndex+6)}},R.onTouchEnd=function(t,e){if(!this.isMoving&&this.isTouchStart&&this.needRecover&&e.index==this.curIndex){this.isTouchStart=!1;var i=this.getPosByIndex(this.curIndex);e.node.position=new d(i.x,i.y,0),this.needRecover=!1}},i}(R));i._RF.pop()}}}));

