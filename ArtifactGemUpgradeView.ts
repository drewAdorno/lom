System.register("chunks:///_virtual/ArtifactGemUpgradeView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIList.ts","./NodeUtil.ts","./StringUtil.ts","./index57.ts","./BagModel.ts","./MessageView.ts","./EquipDefine.ts","./ArtifactControl.ts","./ArtifactDataCache.ts","./ArtifactDefine.ts","./BaseView.ts"],(function(t){"use strict";var e,i,n,o,s,r,a,l,h,d,g,u,v,f,c,m,p,S,L,y,x,C,I,w;return{setters:[function(t){e=t.inheritsLoose,i=t.createForOfIteratorHelperLoose},function(t){n=t.cclegacy,o=t.Button,s=t.Sprite,r=t.ScrollView,a=t.Label,l=t.ProgressBar,h=t.UITransform,d=t.Vec3,g=t.js,u=t.Layout},function(t){v=t.ListItem},function(t){f=t.default},function(t){c=t.default},null,function(t){m=t.BagModel},function(t){p=t.default,S=t.TYPE_YES},function(t){L=t.EquipEventDefine},function(t){y=t.default},function(t){x=t.ArtifactDataCache},function(t){C=t.posToRotation,I=t.ArtifactEvent},function(t){w=t.BaseView}],execute:function(){n._RF.push({},"57c6fLyTJtLsaSA/DWpUaoW","ArtifactGemUpgradeView",void 0);var A=1141,N=(t("default",function(t){function n(){var e;return(e=t.call(this)||this).curLevel=void 0,e.nextLevel=void 0,e.pos=void 0,e.type=1,e.curFilteColor=1,e.tarStone=void 0,e.selList=[],e.stoneList=[],e.GemShowList=[],e.max=!1,e.Rightmax=!1,e.nodeNone=void 0,e.gemScroll=void 0,e.attrScroll=void 0,e.btnConfirm=void 0,e.btnAutoSel=void 0,e.btnAttr=void 0,e.imgFrameBase=void 0,e.imgFrame=void 0,e.imgIcon=void 0,e.nodeDown=void 0,e.nodeUp=void 0,e.txtAttr=void 0,e.pbLevel=void 0,e.txtLevel=void 0,e.txtNextLevel=void 0,e.txtCurLevel=void 0,e.upgradeTips1=void 0,e.upgradeTips2=void 0,e.upgradeTips3=void 0,e.upgradeTips4=void 0,e.block=void 0,e.pbPreUT=void 0,e.isUpgrading=!1,e.calInfo=void 0,e.upgradeTimer=0,e.name="ArtifactGemUpgradeView",e.url="ui/module/artifact/ArtifactGemUpgradeView",e.poolTime=3e3,e.fullScreen=!0,e}e(n,t);var u=n.prototype;return u.onInit=function(){var t=this,e=this.findChild("btnClose");this.addComponentCallbackListener(e,o.EventType.CLICK,(function(){t.close()})),this.nodeNone=this.findChild("root/nodeShow/nodeNone"),this.imgFrameBase=this.findChild("root/nodeShowStone/frame"),this.imgFrame=this.findChildComponent("root/nodeShowStone/frame/frame",s),this.imgIcon=this.findChildComponent("root/nodeShowStone/frame/icon",s);var n=this.findChildComponent("root/nodeShow/scrollGoodsList",r);this.gemScroll=this.addUIList(n,N);var d=this.findChildComponent("root/nodeShowStone/ScrollView",r);this.attrScroll=this.addUIList(d,_),this.btnConfirm=this.findChild("root/nodeShow/btnConfirm"),this.addComponentCallbackListener(this.btnConfirm,o.EventType.CLICK,(function(){for(var e,n=i(t.selList);!(e=n()).done;){var o=e.value,s=IS(x).getStoneInfoByID(o);if(s)if(configArtifact_gemlevel.getDataByKeys("level",s.lv,"quality",s.quality).weaken<1e4)return void p.showBoxTip({tip:GetLanguage(201806),title:GetLanguage(201384),func:function(e){e==S&&(IS(y).reqGemUpInfo(t.tarStone,t.selList,[{k:A,v:t.stoneList.length}]),t.selList=[],t.stoneList=[])}})}for(var r,a=i(t.selList);!(r=a()).done;){var l=r.value;if(IS(x).getStoneInfoByID(l).quality>=7)return void p.showBoxTip({tip:GetLanguage(201807),title:GetLanguage(201384),func:function(e){e==S&&(IS(y).reqGemUpInfo(t.tarStone,t.selList,[{k:A,v:t.stoneList.length}]),t.selList=[],t.stoneList=[])}})}IS(y).reqGemUpInfo(t.tarStone,t.selList,[{k:A,v:t.stoneList.length}]),t.selList=[],t.stoneList=[]})),this.btnAutoSel=this.findChild("root/nodeShow/btnAutoSel"),this.addComponentCallbackListener(this.btnAutoSel,o.EventType.CLICK,(function(){t.max?p.showFlyTip(GetLanguage(201589)):t.autoSelStone()})),this.nodeDown=this.findChild("root/nodeShow/btnAttr/imgDown"),this.nodeUp=this.findChild("root/nodeShow/btnAttr/imgUp"),this.txtAttr=this.findChildComponent("root/nodeShow/btnAttr/txtSelect",a),this.btnAttr=this.findChild("root/nodeShow/btnAttr"),this.addComponentCallbackListener(this.btnAttr,o.EventType.CLICK,(function(){var e={typeStr:"artifactquality",listIdx:t.curFilteColor,onUp:!0,targetNode:t.btnAttr,descStr:GetLanguage(200272),selectValue:IS(x).getGenQualityList()};uiMgr.openView("EquipConditionListView",e),t.nodeDown.active=!0,t.nodeUp.active=!1})),this.pbLevel=this.findChildComponent("root/nodeShowStone/bg/ProgressBar",l),this.txtLevel=this.findChildComponent("root/nodeShowStone/bg/ProgressBar/txtDesc",a),this.txtNextLevel=this.findChildComponent("root/nodeShowStone/bg/nextLV",a),this.txtCurLevel=this.findChildComponent("root/nodeShowStone/bg/curLV",a),this.upgradeTips1=this.findChild("root/nodeShowStone/nextLevelTips1"),this.upgradeTips2=this.findChild("root/nodeShowStone/nextLevelTips2"),this.upgradeTips3=this.findChild("root/nodeShowStone/nextLevelTips3"),this.upgradeTips4=this.findChild("root/nodeShowStone/nextLevelTips4"),this.pbPreUT=this.findChildComponent("root/nodeShowStone/bg/ProgressBar/Bar-001",h),this.block=this.findChild("block"),this.addComponentCallbackListener(this.block,o.EventType.CLICK,(function(){t.upgradeTimer&&0!=t.upgradeTimer&&t.removeTimer(t.upgradeTimer),t.refreshGemShow(),t.isUpgrading=!1,t.block.active=!1}))},u.onAfterOpen=function(){this.block.active=!1,this.tarStone=this.openArgs[0];var t=IS(x).getStoneInfoByID(this.tarStone);if(t){var e=configArtifact_gemquality.getDataByKey(t.quality).frame;this.loadIcon(this.imgFrame,"icon_gem",e);var i=configArtifact_gemsets.getDataByKey(t.suit);this.loadIcon(this.imgIcon,"icon_gem",i.icon),this.imgFrameBase.eulerAngles=new d(0,0,C[t.pos]),this.curFilteColor=IS(x).getGenQualityList()[0],this.refreshGemShow(),this.refreshFilteShow()}},u.registerUpdateHandler=function(){this.addEvent(I.TYPE_ARTIFACT_GEM_INFO_UPDATE_UP,this.showLevelUpgradeEffect,this),this.addEvent(I.TYPE_ARTIFACT_GEM_INFO_UPDATE_RED,this.updateGemScroll,this),this.addEvent(I.TYPE_ARTIFACT_GEM_REFRESH_SEL_UPGRADE,this.refreshStoneInfo,this),this.addEvent(L.AUTO_OPEN_CONDITION_CHANGE,this.onConditionChange,this)},u.onConditionChange=function(t){this.nodeDown.active=!1,this.nodeUp.active=!0,"artifactquality"==t.typeStr&&(this.curFilteColor=t.selectValue,this.refreshFilteShow())},u.refreshFilteShow=function(){var t=IS(x).getGemQualityNameAndColor(this.curFilteColor,!0);this.txtAttr.string=g.formatStr("%s%s",t.nameStr,GetLanguage(200272)),this.txtAttr.color=t.nameColor},u.updateGemScroll=function(){this.gemScroll.updateAll()},u.refreshGemShow=function(){var t=this;if(this.calInfo){var e=this.getPlayerLevelInfo(this.calInfo),i=e.nowInfo,n=e.oriInfo;i.level>n.level&&(uiMgr.openView("ArtifactGemResultView",this.calInfo.ori,this.calInfo.new),this.calInfo=null)}var o=[];if(0==(o=IS(x).gem_list).length)this.nodeNone.active=!0,this.selList=[],this.stoneList=[];else{o.sort((function(t,e){return t.quality>e.quality?1:t.quality<e.quality||t.lv>e.lv?-1:t.lv<e.lv?1:t.suit>e.suit?-1:1}));var s=[];for(var r in IS(x).pos_list)s.push(IS(x).pos_list[r]);o=(o=o.filter((function(e){return!s.includes(e.id)&&e.id!=t.tarStone}))).filter((function(t){return 1!=t.is_lock}));for(var a=IS(m).getGoodsCountByGoodsGtid(A),l=0;l<a;l++)o.unshift({id:A});this.gemScroll.datas=o,this.GemShowList=o,0==o.length?this.nodeNone.active=!0:this.nodeNone.active=!1}this.refreshStoneInfo()},u.autoSelStone=function(){for(var t,e=IS(x).getGenQualityList(),n=i(e);!(t=n()).done;){var o=t.value;this.curFilteColor>=o&&this.autoSelByQuality(o)}this.refreshStoneInfo(),this.gemScroll.updateAll()},u.autoSelByQuality=function(t){var e=[];for(var i in IS(x).pos_list)e.push(IS(x).pos_list[i]);for(var n=IS(m).getGoodsCountByGoodsGtid(A),o=0;o<n&&!this.max;o++)if(!this.stoneList.includes(o)){this.stoneList.push(o);var s=this.getGemPreviewInfo(),r=IS(x).getStoneInfoByID(this.tarStone),a=configArtifact_gemquality.getDataByKey(r.quality).max_level;if(s.lv>=a){this.max=!0;break}}for(var l=this.GemShowList.length-1;l>=0&&!this.max;l--){var h=this.GemShowList[l];if(h.quality==t&&!e.includes(h.id)&&!this.selList.includes(h.id)){this.selList.push(h.id);var d=this.getGemPreviewInfo(),g=IS(x).getStoneInfoByID(this.tarStone),u=configArtifact_gemquality.getDataByKey(g.quality).max_level;if(d.lv>=u){this.max=!0;break}}}},u.refreshStoneInfo=function(){this.gemScroll.updateAll();var t=IS(x).getStoneInfoByID(this.tarStone);this.max=!1;var e=configArtifact_gemquality.getDataByKey(t.quality).max_level;if(t.lv>=e)this.close();else{var n=this.getGemPreviewInfo(),o=configArtifact_gemlevel.getDataByKeys("level",n.lv,"quality",t.quality),s=n.exp+"/"+o.exp,r=n.exp/o.exp;n.lv>=e&&(this.max=!0,s="MAX",r=1),n.lv>t.lv&&(r=1),this.pbPreUT.width=354*r,n.lv==t.lv&&n.exp==t.exp&&(this.pbLevel.progress=r),this.txtLevel.string=s,this.txtCurLevel.string="Lv."+t.lv,this.txtNextLevel.string="Lv."+n.lv,this.curLevel=t.lv,this.nextLevel=n.lv;var a=[];a.push({info:t.base_attr[0],type:1});for(var l,h=i(t.rand_attr);!(l=h()).done;){var d=l.value;a.push({info:d,type:2})}this.attrScroll.datas=a,this.upgradeTips1.active=!1,this.upgradeTips2.active=!1,this.upgradeTips3.active=!1,this.upgradeTips4.active=!1,this.curLevel!=this.nextLevel&&(Math.floor(this.curLevel/4)==Math.floor(this.nextLevel/4)?this.upgradeTips4.active=!0:1==a.length?this.upgradeTips1.active=!0:a.length<=4?this.upgradeTips2.active=!0:a.length>=5&&(this.upgradeTips3.active=!0))}},u.getGemPreviewInfo=function(){for(var t,e=IS(x),n=e.getStoneInfoByID(this.tarStone),o=0,s=1;null==(r=s<(null==n?void 0:n.lv))||r;s++){var r;o+=configArtifact_gemlevel.getDataByKeys("level",s,"quality",n.quality).exp}o+=null!=(t=null==n?void 0:n.exp)?t:0;for(var a,l=0,h=i(this.stoneList);!(a=h()).done;){a.value;l+=configGoods.getDataByKey(A).effect[0]}for(var d,g=i(this.selList);!(d=g()).done;){var u=d.value,v=e.getStoneInfoByID(u);if(v){for(var f=1;null==(c=f<v.lv)||c;f++){var c,m=configArtifact_gemlevel.getDataByKeys("level",f,"quality",v.quality);l+=Math.floor(m.exp*m.weaken/1e4)}l+=Math.floor(v.exp*configArtifact_gemlevel.getDataByKeys("level",v.lv,"quality",v.quality).weaken/1e4),l+=configArtifact_gemquality.getDataByKey(v.quality).quality_exp}}for(var p=o+l,S=1,L=configArtifact_gemquality.getDataByKey(n.quality).max_level,y=1;y<L;y++){var C=configArtifact_gemlevel.getDataByKeys("level",y,"quality",n.quality).exp;if(!(p>=C))break;S+=1,p-=C}return{lv:S,exp:p}},u.getPlayerLevelInfo=function(t){var e=t.ori,i=configArtifact_gemlevel.getDataByKeys("level",e.lv,"quality",e.quality).exp,n=configArtifact_gemquality.getDataByKey(e.quality).max_level,o=t.new,s=configArtifact_gemlevel.getDataByKeys("level",o.lv,"quality",e.quality),r=o.exp/s.exp;return o.lv>=n&&(r=1),{oriInfo:{level:e.lv,rate:Math.min(1,e.exp/i),progressNum:e.exp,nextLevelNeedNum:i},nowInfo:{level:o.lv,rate:Math.min(1,r),progressNum:o.exp,nextLevelNeedNum:s.exp}}},u.showLevelUpgradeEffect=function(t){var e=this;if(!this.isUpgrading){this.calInfo=t;var i=this.getPlayerLevelInfo(t),n=i.nowInfo,o=i.oriInfo;if(n.level!=o.level||n.progressNum!=o.progressNum){this.isUpgrading=!0,this.block.active=!0;var s=n.level!=o.level,r=o.rate,a=n.rate;if(!s)return normalTween.to(r,a,1,(function(t,i){e.isUpgrading&&(e.pbLevel.progress=i)})).call((function(){e.isUpgrading&&(e.pbLevel.progress=a,e.isUpgrading=!1,e.block.active=!1,e.pbPreUT.width=0,e.refreshGemShow())})).start(),void normalTween.to(o.progressNum,n.progressNum,1,(function(t,i){e.isUpgrading&&(e.txtLevel.string=g.formatStr("%s/%s",c.GetNumString(Math.floor(i)),c.GetNumString(o.nextLevelNeedNum)))})).call((function(){e.isUpgrading&&(e.txtLevel.string=g.formatStr("%s/%s",c.GetNumString(n.progressNum),c.GetNumString(o.nextLevelNeedNum)))})).start();normalTween.to(r,1,1,(function(t,i){e.isUpgrading&&(e.pbLevel.progress=i)})).call((function(){e.isUpgrading&&(e.txtLevel.string=""+n.level,e.pbLevel.progress=1,e.pbPreUT.width=0)})).start(),normalTween.to(o.progressNum,o.nextLevelNeedNum,1,(function(t,i){e.isUpgrading&&(e.txtLevel.string=g.formatStr("%s/%s",c.GetNumString(Math.floor(i)),c.GetNumString(o.nextLevelNeedNum)))})).call((function(){e.isUpgrading&&(e.txtLevel.string=g.formatStr("%s/%s",c.GetNumString(o.nextLevelNeedNum),c.GetNumString(o.nextLevelNeedNum)))})).start(),this.upgradeTimer=this.addTimer(1,1,(function(){normalTween.to(0,a,1,(function(t,i){e.isUpgrading&&(e.pbLevel.progress=i)})).call((function(){e.isUpgrading&&(e.pbLevel.progress=a,e.isUpgrading=!1,e.block.active=!1,e.refreshGemShow())})).start(),normalTween.to(0,n.progressNum,1,(function(t,i){e.isUpgrading&&(e.txtLevel.string=g.formatStr("%s/%s",c.GetNumString(Math.floor(i)),c.GetNumString(n.nextLevelNeedNum)))})).call((function(){e.isUpgrading&&(e.txtLevel.string=g.formatStr("%s/%s",c.GetNumString(n.progressNum),c.GetNumString(n.nextLevelNeedNum)))})).start()}))}}},u.onBeforeClose=function(){this.tarStone=0,this.selList=[],this.stoneList=[],this.isUpgrading=!1,this.block.active=!1},u.onDestroy=function(){},n}(w)),function(t){function i(){for(var e,i=arguments.length,n=new Array(i),o=0;o<i;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).imgFrame=void 0,e.imgIcon=void 0,e.imgSel=void 0,e.imgUsing=void 0,e.new=void 0,e.txtNum=void 0,e}e(i,t);var n=i.prototype;return n.onInit=function(){var t=this;this.imgFrame=f.findChildComponent(this.node,"imgFrame",s),this.imgIcon=f.findChildComponent(this.node,"imgFrame/imgIcon",s),this.imgSel=f.findChild(this.node,"sel"),this.imgUsing=f.findChild(this.node,"using"),this.txtNum=f.findChildComponent(this.node,"num",a),this.new=f.findChild(this.node,"new"),this.view.loadIcon(this.new.getComponent(s),"fate","mg_ui_new");var e=f.findChildComponent(this.node,"sel",s);this.view.loadIcon(e,"common","common_ui_dagou"),this.view.addComponentCallbackListener(this.node,o.EventType.CLICK,(function(){t.data.is_red>0&&IS(y).reqRedRead(t.data.id);var e=t.view;e.tarStone==t.data.id&&1==e.type||(t.data.id==A?e.stoneList.includes(t.index)?e.stoneList=e.stoneList.filter((function(e){return e!=t.index})):e.max?p.showFlyTip(GetLanguage(201589)):e.stoneList.push(t.index):e.selList.includes(t.data.id)?e.selList=e.selList.filter((function(e){return e!=t.data.id})):e.max?p.showFlyTip(GetLanguage(201589)):e.selList.push(t.data.id),normalEvent.emit(I.TYPE_ARTIFACT_GEM_REFRESH_SEL_UPGRADE))}))},n.onRender=function(t,e){var i=this.view;if(t.id==A)return this.view.loadIcon(this.imgFrame,"icon_item",String(A)),this.view.loadIcon(this.imgIcon,"icon_item",""),this.imgFrame.node.eulerAngles=new d(0,0,0),this.txtNum.string="",this.imgUsing.active=!1,this.imgFrame.grayscale=!1,this.imgIcon.grayscale=!1,this.new.active=!1,void(this.imgSel.active=i.stoneList.includes(this.index));var n=configArtifact_gemquality.getDataByKey(t.quality).frame;this.view.loadIcon(this.imgFrame,"icon_gem",n);var o=configArtifact_gemsets.getDataByKey(t.suit);for(var s in this.view.loadIcon(this.imgIcon,"icon_gem",o.icon),this.imgFrame.node.eulerAngles=new d(0,0,C[t.pos]),this.txtNum.string=t.lv>0?"Lv."+t.lv:"",this.imgUsing.active=!1,IS(x).pos_list)if(IS(x).pos_list[s]==t.id){this.imgUsing.active=!0;break}this.imgFrame.grayscale=!1,this.imgIcon.grayscale=!1,this.imgSel.active=i.selList.includes(this.data.id),i.tarStone==this.data.id&&(this.imgFrame.grayscale=!0,this.imgIcon.grayscale=!0),this.new.active=this.data.is_red},i}(v)),_=function(t){function i(){for(var e,i=arguments.length,n=new Array(i),o=0;o<i;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).txtBaseName=void 0,e.txtBaseAttr=void 0,e.txtMainName=void 0,e.txtCurMainAttr=void 0,e.txtNextMainAttr=void 0,e.imgArrow=void 0,e.nodeMain=void 0,e}e(i,t);var n=i.prototype;return n.onInit=function(){this.txtBaseName=f.findChildComponent(this.node,"txtBaseName",a),this.txtBaseAttr=f.findChildComponent(this.node,"txtBaseAttr",a),this.txtMainName=f.findChildComponent(this.node,"nodeMain/txtMainName",a),this.txtCurMainAttr=f.findChildComponent(this.node,"nodeMain/Node/curAttr",a),this.txtNextMainAttr=f.findChildComponent(this.node,"nodeMain/Node/nextAttr",a),this.view.dealMirrorLayout(f.findChildComponent(this.node,"nodeMain/Node",u)),this.imgArrow=f.findChild(this.node,"nodeMain/Node/imgarrow"),this.nodeMain=f.findChild(this.node,"nodeMain")},n.onRender=function(t,e){this.nodeMain.active=1==t.type;var i=configAttribute.getDataByKey(t.info.k);this.txtBaseName.string=i.name,this.txtMainName.string=i.name;var n=this.view,o=t.info.v/n.curLevel*n.nextLevel;if(1!=t.type){var s=IS(x).getGemAttrColor(t.info.k,t.info.v);this.txtBaseName.color=s,this.txtBaseAttr.color=s}var r=i.show_type;2==r?(this.txtBaseAttr.string="+"+g.formatStr("%s%",c.GetNumString(t.info.v/100)),this.txtCurMainAttr.string="+"+g.formatStr("%s%",c.GetNumString(t.info.v/100)),this.txtNextMainAttr.string="+"+g.formatStr("%s%",c.GetNumString(o/100))):3==r?(this.txtBaseAttr.string="+"+c.GetNumString(Math.floor(t.info.v/100)/100),this.txtCurMainAttr.string="+"+c.GetNumString(Math.floor(t.info.v/100)/100),this.txtNextMainAttr.string="+"+c.GetNumString(Math.floor(o/100)/100)):(this.txtBaseAttr.string="+"+c.GetNumString(t.info.v),this.txtCurMainAttr.string="+"+c.GetNumString(t.info.v),this.txtNextMainAttr.string="+"+c.GetNumString(o)),n.nextLevel!=n.curLevel?(this.txtNextMainAttr.node.active=!0,this.imgArrow.active=!0):(this.txtNextMainAttr.node.active=!1,this.imgArrow.active=!1)},i}(v);n._RF.pop()}}}));

