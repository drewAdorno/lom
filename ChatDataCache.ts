System.register("chunks:///_virtual/ChatDataCache.ts",["./rollupPluginModLoBabelHelpers.js","cc","./RedPointMgr.ts","./StorageUtil.ts","./StringUtil.ts","./TimeUtil.ts","./ConfigGlobal.ts","./GameSetting.ts","./MessageView.ts","./LoginDefine.ts","./MarryDialogDataCache.ts","./PayDataCache.ts","./PayDefine.ts","./RoleControl.ts","./RoleDataCache.ts","./RoleDefine.ts","./WelfareDataCache.ts","./WelfareDefine.ts","./ChatControl.ts","./ChatDefine.ts"],(function(e){"use strict";var t,i,a,n,s,h,r,d,o,l,p,f,g,_,u,c,m,v,C,R,S,G,I,y,T,L,B,w,D;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy},function(e){a=e.RedPointMgr},function(e){n=e.default},function(e){s=e.default},function(e){h=e.default},function(e){r=e.ConfigGlobal},function(e){d=e.default,o=e.GameSettingKey},function(e){l=e.default},function(e){p=e.LoginEventDefine},function(e){f=e.default},function(e){g=e.default},function(e){_=e.PayEventDefine},function(e){u=e.default},function(e){c=e.RoleDataCache},function(e){m=e.ClientData,v=e.PlayerAttr,C=e.RoleEventDefine},function(e){R=e.WelfareDataCache},function(e){S=e.WelfareEvent},function(e){G=e.default},function(e){I=e.ChatDefine,y=e.ChatEventDefine,T=e.ChatExtElemDefine,L=e.RedBagState,B=e.ToggleToChannel,w=e.ChatTempViewType,D=e.ChatFaceSizeDefine}],execute:function(){var k;e("EPvpShareType",void 0),i._RF.push({},"27d9dHM/nZLGL4BEtinvfRC","ChatDataCache",void 0),function(e){e[e.default=0]="default",e[e.farmBattle=1]="farmBattle",e[e.roleSolo=2]="roleSolo",e[e.crossPvp=3]="crossPvp",e[e.parkingBattle=4]="parkingBattle",e[e.slaveBattle=5]="slaveBattle"}(k||(k=e("EPvpShareType",{})));e("ChatDataCache",function(){var e=i.prototype;function i(){this.chatMessageDict=[],this.privateChatDict=[],this.chatFriendInfoList=[],this.isReqprivateChatHis={},this.banRoleList={},this.privateChatRed=0,this.canRewardRedBagRed=0,this.chatTarget=0,this.is_need_update_list=!1,this.is_auto_play=!1,this.showAnswerTip=!0,this.redBagSendDict={},this.redBagGrabDict={},this.redBagShowSendDict={},this.redBagShowGrabDict={},this.newRedBag=void 0,this.newGrabRedBag=void 0,this.isClickedGrabRed=!1,this.kf_uid=void 0,this.kf_list=[],this.kf_red=0,this.kf_saveTime=0,this.isLoadGmHistory=!1,this.kf_his_ver="1.0.0",this.isGmChatOpen=!1,this.gmOpenInfo={is_open:0,end_time:0,show_money:4e3,open_money:5e3,isOriData:!0},this.vipBtnRed=0,this.vipBtnShowState=0,this.vipSendTime=0,this.sound_list=[],this.mentionRole={},this.openChannelList=[],this.chatTipShow=null,this.chatTipShowDict={},this.openTempViewType={},this.isOpenSeasonMap=!1,this.mentionRed={},this.mentionRedNum=0,this.readTime=void 0,this.chatMessageDict=[],this.privateChatDict=[],this.chatFriendInfoList=[],this.banRoleList={},normalEvent.on(C.ROLE_INFO_UPDATE,this.RemoveGuildChat,this),normalEvent.on(p.UPLOADSOUND_BACK,this.setSound,this),normalEvent.on(C.ROLE_CLIENT_DATA,this.LoadGmHistoryMsg,this),normalEvent.on(C.ROLE_CLIENT_DATA,this.UpdateKfSaveTime,this),normalEvent.on(C.ROLE_CLIENT_DATA,this.RefreshVipBtnRed,this),normalEvent.on(_.PAY_RECHARGE_INFO_UPDATE,this.RefreshVipBtnShowState,this),normalEvent.on(_.PAY_RECHARGE_INFO_UPDATE,this.RefreshVipBtnRed,this),normalEvent.on(p.RECONNECT_NET_LINK,this.ReSetReqHistory,this)}return e.clear=function(){this.chatMessageDict=[],this.privateChatDict=[],this.chatFriendInfoList=[],this.banRoleList={},this.privateChatRed=0,this.chatTarget=0,this.sound_list=[],this.is_need_update_list=!1},e.ReSetReqHistory=function(){this.isReqprivateChatHis={},IS(G).reqChatHistory(I.Channel.World),IS(G).reqChatHistory(I.Channel.Guild),IS(G).reqChatHistory(I.Channel.News);for(var e,i=t(this.openChannelList);!(e=i()).done;){var a=e.value;IS(G).reqChatHistory(a)}this.isLoadGmHistory=!1,IS(u).send_3_29_All(m.GmChat,3,[])},e.InsertNewMsg=function(e){this.GenChatData(e.chat_info,e.target_id,e.channel),e.channel!=I.Channel.Private?(null==this.chatMessageDict[e.channel]&&(this.chatMessageDict[e.channel]=new Array),this.RemoveLimitMsg(this.chatMessageDict[e.channel]),this.chatMessageDict[e.channel].push(e.chat_info)):(null==this.privateChatDict[e.target_id]&&(this.privateChatDict[e.target_id]=new Array),this.RemoveLimitMsg(this.privateChatDict[e.target_id]),this.privateChatDict[e.target_id].push(e.chat_info),this.InsertChatFriendInfoByChat(e.chat_info),this.UpdateMainChatTipShow(e.target_id)),this.UpdateMentionRed(e.channel,e.target_id,e.chat_info),normalEvent.emit(y.InsertNewMsg,e.chat_info)},e.RemoveLimitMsg=function(e){e.length>=I.ChatLimitNum&&e.splice(0,1)},e.UpdateChatHistoryMessage=function(e){if(I.Channel.Private==e.channel&&e.target_id&&e.target_id>0){if(null!=this.isReqprivateChatHis[e.target_id])return;this.isReqprivateChatHis[e.target_id]=!0,this.privateChatDict[e.target_id]=new Array}else I.Channel.Private!=e.channel&&(this.chatMessageDict[e.channel]=new Array);if(e.chat_history){for(var t in e.chat_history){var i=e.chat_history[t];this.GenChatData(i,e.target_id,e.channel),e.channel!=I.Channel.Private?this.chatMessageDict[e.channel].push(i):(this.privateChatDict[i.friend_id].push(i),this.InsertChatFriendInfoByChat(i))}e.channel!=I.Channel.Private?this.chatMessageDict[e.channel]&&this.chatMessageDict[e.channel].sort((function(e,t){return e.time<t.time?-1:1})):this.privateChatDict[e.target_id]&&(this.privateChatDict[e.target_id].sort((function(e,t){return e.time<t.time?-1:1})),this.UpdateMainChatTipShow(e.target_id)),this.UpdateMentionRed(e.channel,e.target_id),normalEvent.emit(y.UpdateChatMsg,e.channel,e.target_id)}},e.ReqPrivateChatHisByOnce=function(e){null==this.isReqprivateChatHis[e]&&e!=I.VIPGmUid&&IS(G).reqChatHistory(I.Channel.Private,e)},e.GetHasPrivateChatHis=function(e){return this.isReqprivateChatHis[e]},e.ReqPrivateChatFriend=function(){var e=new Array,t=[];for(var i in this.chatFriendInfoList){var a=this.chatFriendInfoList[i];null!=a&&null!=a.chat_info&&Number(i)!=I.VIPGmUid&&(e.push(a.role_id),t[a.role_id]=!0)}for(var n in this.privateChatDict){null!=this.privateChatDict[n]&&Number(n)!=I.VIPGmUid&&e.push(n)}IS(G).reqFriendInfoList(e)},e.UpdateChatFriendInfoList=function(e){if(e.friend_info_list){for(var t in e.friend_info_list){var i=e.friend_info_list[t];null!=i&&i.role_id!=I.VIPGmUid&&(this.GenChatData(i.chat_info,i.role_id,I.Channel.Private),this.chatFriendInfoList[i.role_id]=i)}this.UpdateChatRed(),this.UpdateMainChatTipShow(),normalEvent.emit(y.UpdateChatFriendInfo)}},e.InsertChatFriendInfoByChat=function(e){var t=this.chatFriendInfoList[e.friend_id];if(!t&&e.friend_id==I.VIPGmUid)return(t=this.GenChatFriendInfo(e)).chat_info=e,void(this.chatFriendInfoList[e.friend_id]=t);t&&(t.chat_info=e,e.friend_id!=I.VIPGmUid&&(e.is_my||e.friend_id==this.chatTarget?e.is_my||(this.chatFriendInfoList[e.friend_id]=this.GenChatFriendInfo(e),e.friend_id!=this.chatTarget&&(this.privateChatRed+=1,normalEvent.emit(y.UpdateChatRed),IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()))):(t.num+=1,this.privateChatRed+=1,normalEvent.emit(y.UpdateChatRed),IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()))))},e.SetChatTarget=function(e){this.chatTarget=e},e.GenChatFriendInfo=function(e){var t=e.name,i=1;if(e.friend_id==I.VIPGmUid){var a=this.GetKfList();a&&a[0]&&(t=a[0].name),i=0}return{role_id:e.friend_id,head:e.head,name:t,is_online:1,chat_info:e,num:i,history_read_time:0}},e.UpdateChatRed=function(){var e=this.privateChatRed;for(var t in this.privateChatRed=0,this.chatFriendInfoList){var i=this.chatFriendInfoList[t];null!=i&&i.chat_info&&i.role_id!=this.chatTarget&&i.role_id!=I.VIPGmUid&&(this.privateChatRed+=i.num)}e!=this.privateChatRed&&(normalEvent.emit(y.UpdateChatRed),IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()))},e.GetChatFriendInfoList=function(){return this.chatFriendInfoList},e.GetChatFriendInfoListById=function(e){return this.chatFriendInfoList[e]},e.GetChatInfo=function(e,t){return e!=I.Channel.Private?this.chatMessageDict[e]?this.chatMessageDict[e]:[]:this.privateChatDict[t]?this.privateChatDict[t]:[]},e.GetNewestPrivateInfo=function(){var e;for(var t in this.privateChatDict)if(this.privateChatDict.hasOwnProperty(t)){var i=this.privateChatDict[t],a=void 0;i&&i.length>0&&(a=a=i[i.length-1]),a&&(!e&&a&&(e=a),e.time<a.time&&(e=a))}return e},e.GenChatData=function(e,t,i){if(e){var a=IS(c).GetRoleAttr(v.ROLE_ATTR_ID);if(e.is_my=e.role_id==a,e.channel=i,null!=e.ext_list)for(var n=0;n<e.ext_list.length;n++){var h=e.ext_list[n],r=T[h.field];null!=r&&(e[r.name]=1==r.type?h.num:h.string)}e.lang_args&&(e.content=s.GetFullStringByP_lang_info(e.lang_args)),i==I.Channel.Private&&(e.friend_id=t==a?e.role_id:t)}},e.IsOpenInput=function(){var e=r.chat_level;return IS(c).GetLevel()>=e},e.ReadChat=function(e){if(e.target_id){var t=this.chatFriendInfoList[e.target_id];t&&t.num>0&&(this.privateChatRed-=t.num,this.privateChatRed=Math.max(0,this.privateChatRed),t.num=0,t.history_read_time=e.history_read_time,this.UpdateMainChatTipShow(e.target_id),normalEvent.emit(y.UpdateChatRed),IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()))}},e.UpdateBanRoleList=function(e){var t=!1,i=!1;if(this.banRoleList={},e.role_id){for(var n in e.role_id){var s=e.role_id[n].k,h=e.role_id[n].v;if(null==this.banRoleList[s]){this.banRoleList[s]=h,this.privateChatDict[s]&&(this.privateChatDict[s]=null,t=!0);var r=this.chatFriendInfoList[s];r&&(this.privateChatRed=Math.max(0,this.privateChatRed-r.num),this.chatFriendInfoList[s]=null,r.num>0&&(i=!0))}}for(var d in this.chatMessageDict){var o=this.chatMessageDict[d];if(o)for(var l=o.length-1;l>=0;l--)this.banRoleList[o[l].role_id]&&(o.splice(l,1),t=!0)}t&&normalEvent.emit(y.UpdateChatMsg),i&&(normalEvent.emit(y.UpdateChatRed),IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()))}},e.GetIsBanRole=function(e){return this.banRoleList[e]},e.RemoveFriendDataByBlack=function(e){var t=!1,i=!1;delete this.isReqprivateChatHis[e];var n=e;null!=this.privateChatDict[n]&&(this.privateChatDict[n]=null,t=!0);var s=this.chatFriendInfoList[n];null!=s&&(e!=I.VIPGmUid&&(this.privateChatRed=Math.max(0,this.privateChatRed-s.num)),this.chatFriendInfoList[n]=null,s.num>0&&(i=!0)),t&&(normalEvent.emit(y.UpdateChatMsg),normalEvent.emit(y.UpdateBlackMsg),normalEvent.emit(y.RemoveChatFiriend,e)),i&&(normalEvent.emit(y.UpdateChatRed),IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()))},e.GetPrivateRed=function(){return this.privateChatRed+this.kf_red+this.GetMentionRed(I.Channel.Private)},e.GetVipGmRed=function(){return this.kf_red},e.GetChatRed=function(){var e=this.GetPrivateRed();return e+=this.GetRedBagRed(),e+=this.mentionRedNum},e.GetRedBagRed=function(){return this.GetSendRedBagRed()+this.GetGrabRedBagRed()},e.GetSendRedBagRed=function(){return this.newRedBag?1:0},e.GetGrabRedBagRed=function(){return this.canRewardRedBagRed},e.UpdateRedBagRed=function(){if(this.canRewardRedBagRed=0,this.isClickedGrabRed)this.newGrabRedBag&&this.newGrabRedBag.state==L.UnClaimed&&(this.canRewardRedBagRed=1);else for(var e in this.redBagGrabDict){if(this.redBagGrabDict[e].state==L.UnClaimed){this.canRewardRedBagRed=1;break}}IS(a).changeValue("send_red_bag",this.GetSendRedBagRed()),IS(a).changeValue("chat_red",this.GetChatRed()),IS(a).changeValue("red_bag",this.GetRedBagRed()),IS(a).changeValue("grab_red_bag",this.GetGrabRedBagRed())},e.SendShareData=function(e,t,a,n,s){if(void 0===s&&(s=k.default),e==I.ChatLinkType.PvpShare){if(t.atk_role&&t.def_role){var r,d,o=IS(c).GetRoleAttr(v.ROLE_ATTR_ID),p=t.atk_role,g=t.def_role;t.def_role.id==IS(c).GetRoleAttr(v.ROLE_ATTR_ID)&&(p=t.def_role,g=t.atk_role);var _=new Array,u=t.win_id==o?1:2;_.push({pos:1,type:I.ChatLinkType.PvpShare,args_list:[t.vid,u,p.power,g.power,p.job,g.job,s,null!=(r=p.sex)?r:0,null!=(d=g.sex)?d:0],string_list:[p.name,g.name]});IS(G).reqChatMessage(I.Channel.World,I.ChatContentType.Share,"",0,_,null,{id:200158,arg_list:[]})}}else if(e==I.ChatLinkType.FarmHelp){var m=new Array;m.push({pos:1,type:I.ChatLinkType.FarmHelp,args_list:[t.farmRoleId,t.landId,t.thiefRoleId,t.cropId,t.endTime],string_list:[]});IS(G).reqChatMessage(a,I.ChatContentType.Share,"",n,m,null,{id:200159,arg_list:[]})}else if(e==I.ChatLinkType.MakeTeam){var C=new Array;C.push({pos:1,type:I.ChatLinkType.MakeTeam,args_list:[t.level,t.teamID],string_list:[]});IS(G).reqChatMessage(a,I.ChatContentType.Share,"",n,C,null,{id:200160,arg_list:[]})}else if(e==I.ChatLinkType.GuildBossNotice){var R=new Array;R.push({pos:1,type:I.ChatLinkType.GuildBossNotice,args_list:[],string_list:[]});IS(G).reqChatMessage(a,I.ChatContentType.Share,"",n,R,null,{id:200161,arg_list:[]})}else if(e==I.ChatLinkType.SkillTab){var S=new Array;S.push({pos:1,type:I.ChatLinkType.SkillTab,args_list:[],string_list:[t.tabName,t.skillListStr]});IS(G).reqChatMessage(a,I.ChatContentType.Share,"",n,S,null,{id:200162,arg_list:[]})}else if(e==I.ChatLinkType.PetTab){var y=new Array;y.push({pos:1,type:I.ChatLinkType.PetTab,args_list:[],string_list:[t.tabName,t.petListStr]});IS(G).reqChatMessage(a,I.ChatContentType.Share,"",n,y,null,{id:200163,arg_list:[]})}else if(e==I.ChatLinkType.CrossWarReport){var T=new Array;T.push({pos:1,type:I.ChatLinkType.CrossWarReport,args_list:[t.serv_rank,t.self_rank,t.self_kill,t.self_point,t.job,t.dressId,t.gender,t.weapon,t.ornaments,t.face,t.color,t.mount,t.shenqi,t.self_monster],string_list:[]});IS(G).reqChatMessage(a,I.ChatContentType.Share,"",n,T,null,{id:200714,arg_list:[]})}else if(e==I.ChatLinkType.ParkingCall){var L=new Array;L.push({pos:1,type:I.ChatLinkType.ParkingCall,args_list:[t.pos,t.type,t.master_id,t.role_id,t.ceng],string_list:[]});IS(G).reqChatMessage(a,I.ChatContentType.Share,"",n,L,null,{id:201324,arg_list:[]})}else if(e==I.ChatLinkType.ArtifactGemInfo){var B=new Array;B.push({pos:1,type:I.ChatLinkType.ArtifactGemInfo,args_list:[],string_list:[t.gemInfoStr]}),IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(201673),n,B)}else if(e==I.ChatLinkType.SlaveHelp){var w=new Array;w.push({pos:1,type:I.ChatLinkType.SlaveHelp,args_list:[t.targetId,t.slaveId,h.serverTime,t.endTime],string_list:[]});IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(201787),n,w,null,{id:201787,arg_list:[]})}else if(e==I.ChatLinkType.MoleScoreshare){var D=new Array;D.push({pos:1,type:I.ChatLinkType.MoleScoreshare,args_list:[t.score_num,t.level_num],string_list:[]}),IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(201752),n,D)}else if(e==I.ChatLinkType.DateApply){var M=new Array;M.push({pos:1,type:I.ChatLinkType.DateApply,args_list:[t.player_id],string_list:[t.content]});IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(204163),n,M,null,{id:204163,arg_list:[]})}else if(e==I.ChatLinkType.MarryApply){var P=new Array;P.push({pos:1,type:I.ChatLinkType.MarryApply,args_list:[t.player_id],string_list:[t.content]});IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(204164),n,P,null,{id:204164,arg_list:[]})}else if(e==I.ChatLinkType.WeddingInvite){var U=new Array;console.log(t),U.push({pos:1,type:I.ChatLinkType.WeddingInvite,args_list:[t.type,t.selfName,t.loverName],string_list:[t.time]});IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(204166),n,U,null,{id:204166,arg_list:[]})}else if(e==I.ChatLinkType.DivoreApply){var V=new Array;V.push({pos:1,type:I.ChatLinkType.DivoreApply,args_list:[],string_list:[]});var E=IS(f).GetLoverGender(),A=IS(c).GetGender();if(E&&E==A){IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(204168),n,V,null,{id:204168,arg_list:[]})}else{IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(204167),n,V,null,{id:204167,arg_list:[]})}}else if(e==I.ChatLinkType.SeasonMapShare){var b=new Array;b.push({pos:1,type:I.ChatLinkType.SeasonMapShare,args_list:[t.action,t.base_id,t.grid_id,t.spy_end_time],string_list:[]}),IS(G).reqChatMessage(a,I.ChatContentType.Share,t.msg,n,b)}else if(e==I.ChatLinkType.DoubleChapterInvateShare){var O=new Array;O.push({pos:1,type:I.ChatLinkType.DoubleChapterInvateShare,args_list:[],string_list:[]}),IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(204928),n,O)}else if(e==I.ChatLinkType.FlyPetRoleUse){var N=new Array;N.push({pos:1,type:I.ChatLinkType.FlyPetRoleUse,args_list:[t.pet_share_type,t.pet_id],string_list:[]});IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(205184),n,N,null,{id:205184,arg_list:[]})}else if(e==I.ChatLinkType.FlyPetPetUse){var F=new Array;F.push({pos:1,type:I.ChatLinkType.FlyPetPetUse,args_list:[t.pet_share_type,t.pet_id,t.pet_cfg_id],string_list:[]});IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(205183),n,F,null,{id:205183,arg_list:[]})}else if(e==I.ChatLinkType.FlyPetPetShow){var H=new Array;H.push({pos:1,type:I.ChatLinkType.FlyPetPetShow,args_list:[t.pet_id,t.pet_cfg_id,t.level,t.age,t.is_bian],string_list:[t.pet_name,t.role_name]});IS(G).reqChatMessage(a,I.ChatContentType.Share,GetLanguage(205185),n,H,null,{id:205185,arg_list:[]})}IS(i).IsOpenInput()&&l.showFlyTip(GetLanguage(200164))},e.ChannelIsShow=function(e){return e==I.Channel.Guild?[IS(c).HasGuild(),GetLanguage(200165)]:[!0,""]},e.RemoveGuildChat=function(e){1==e[v.ROLE_ATTR_GUILD_ID]&&(IS(c).HasGuild()?(IS(G).reqChatHistory(I.Channel.Guild),IS(G).send_red_all_list_c2s()):(this.chatMessageDict[I.Channel.Guild]=[],this.ClearMentionRed(I.Channel.Guild),normalEvent.emit(y.UpdateChatMsg)))},e.SetAutoTimer=function(e,t){void 0===t&&(t=!1),null==e&&(e=h.getLocalTime()),IS(d).set(o.AUTO_VOICE_TIME,e),this.is_need_update_list=t},e.SetAutoPlay=function(e){this.is_auto_play=e},e.IsInAutoPlay=function(){return this.is_auto_play},e.SetNeedUpdateVoice=function(e){this.is_need_update_list=e},e.IsInNeedUpdateVoice=function(){return this.is_need_update_list},e.setSound=function(e){this.sound_list.push({voicePath:e.voicePath,vcode:e.vcode,text:""})},e.setSoundTxt=function(e,t){for(var i=0;i<this.sound_list.length;i++)e==this.sound_list[i].vcode&&(this.sound_list[i].text=t);normalEvent.emit(p.UPLOADSOUNDText_BACK)},e.GetSound=function(){var e=0;return this.sound_list.length>0&&(e=this.sound_list.length-1),this.sound_list[e]},e.resetSound=function(){this.sound_list=[]},e.SetShowAnswerTip=function(e){this.showAnswerTip=e},e.GetShowAnswerTip=function(){return this.showAnswerTip},e.UpdateRedBagInfo=function(e){if(this.redBagSendDict={},this.redBagGrabDict={},e.send_list)for(var t=0;t<e.send_list.length;t++){var i=e.send_list[t];this.redBagSendDict[i.id]=i}if(e.grab_list)for(var a=0;a<e.grab_list.length;a++){var n=e.grab_list[a];this.redBagGrabDict[n.id]=n}this.UpdateRedBagRed(),normalEvent.emit(y.UpdateRedBagList)},e.UpdateRedBagBySend=function(e){0==e.code&&(this.redBagSendDict[e.id]&&delete this.redBagSendDict[e.id],this.newRedBag&&this.newRedBag.id==e.id&&(this.newRedBag=null),this.redBagGrabDict[e.red.id]=e.red,normalEvent.emit(y.UpdateRedBagList),normalEvent.emit(y.ShowRedBagInChat,e),uiMgr.close("RedBagListView"))},e.UpdateRedBagByGrab=function(e){this.newGrabRedBag&&e.red_envelope.id==this.newGrabRedBag.id&&(this.newGrabRedBag=null),2!=e.code?(this.redBagGrabDict[e.red_envelope.id]=e.red_envelope,uiMgr.openView("RedBagShowView",e.red_envelope),normalEvent.emit(y.UpdateRedBagList),this.UpdateRedBagRed()):this.redBagGrabDict[e.red_envelope.id]&&(delete this.redBagGrabDict[e.red_envelope.id],normalEvent.emit(y.UpdateRedBagList),this.UpdateRedBagRed())},e.GetRedBagDictByType=function(e){return 0==e?this.redBagShowGrabDict:this.redBagShowSendDict},e.GetRedBagById=function(e){return this.redBagGrabDict[e]?this.redBagGrabDict[e]:this.redBagSendDict[e]},e.UpdateShowRedBagInfo=function(e){if(this.redBagShowSendDict={},this.redBagShowGrabDict={},e.send_list)for(var t=0;t<e.send_list.length;t++){var i=e.send_list[t];this.redBagShowSendDict[i.id]=i,this.redBagSendDict[i.id]=i}if(e.grab_list)for(var a=0;a<e.grab_list.length;a++){var n=e.grab_list[a];this.redBagShowGrabDict[n.id]=n,this.redBagGrabDict[n.id]=n}normalEvent.emit(y.UpdateRedBagList),this.UpdateRedBagRed()},e.UpdateRedBagPop=function(e){1==e.type?this.newRedBag=e.red:this.newGrabRedBag=e.red,this.redBagGrabDict[e.red.id]||(this.redBagGrabDict[e.red.id]=e.red,normalEvent.emit(y.UpdateRedBagList)),this.UpdateRedBagRed()},e.SetNewSendRedBagEmpty=function(){this.newRedBag&&(this.newRedBag=null,this.UpdateRedBagRed())},e.SetNewGrabRedBagEmpty=function(){!this.newGrabRedBag&&this.isClickedGrabRed||(this.newGrabRedBag=null,this.isClickedGrabRed=!0,this.UpdateRedBagRed())},e.InsertLocalMsgByGm=function(e,t){var i=IS(c).GetRoleAttr(v.ROLE_ATTR_ID),a=IS(c).GetRoleAttr(v.ROLE_ATTR_HEAD_URL),n=IS(c).GetRoleAttr(v.ROLE_ATTR_GENDER),s={role_id:i,head:{id:0,frame_id:0,url:a},name:IS(c).GetRoleAttr(v.ROLE_ATTR_NAME),gender:n,type:t,content:e,server_id:0,time:h.serverTime,is_block:0,links:[],ext_list:[],chatToGm:1};this.InsertNewMsg({chat_info:s,target_id:I.VIPGmUid,channel:I.Channel.Private}),this.SaveGmMySelfMsg()},e.ReceiveGmMsg=function(e,t){if(void 0===t&&(t=null),3!=this.gmOpenInfo.is_open){this.kf_uid=e.kf_uid;var i=IS(c).GetRoleAttr(v.ROLE_ATTR_HEAD_URL),a=e.content;a.length>I.VipChatMsgLenLimit&&(e.content=a.slice(0,I.VipChatMsgLenLimit));var n={role_id:I.VIPGmUid,kf_uid:e.kf_uid,head:{id:0,frame_id:0,url:i},name:e.kf_name,gender:0,type:2==e.msg_type?I.ChatContentType.Pic:e.msg_type,content:e.content,server_id:0,time:e.time,is_block:0,links:[],ext_list:[],chatToGm:1};this.isGmChatOpen||(this.isGmChatOpen=h.serverTime-n.time<I.GmShowTime,this.RefreshVipBtnShowState()),this.InsertNewMsg({chat_info:n,target_id:I.VIPGmUid,channel:I.Channel.Private}),t&&(this.RefreshGmChatRed(n),this.SaveGmMySelfMsg(),this.LoadGmHistoryMsg())}},e.GetGmBtnOpen=function(){return!1},e.GetGmIsOpen=function(){return 2==this.vipBtnShowState},e.GetKfUid=function(){if(this.kf_uid||this.kf_list&&(this.kf_uid=this.kf_list[0].uid),!this.kf_uid){var e=this.GetChatInfo(I.Channel.Private,I.VIPGmUid);if(e&&e.length>0)for(var t=e.length-1;t>=0;t--)if(e[t].kf_uid){this.kf_uid=e[t].kf_uid;break}}return this.kf_uid},e.SaveGmMySelfMsg=function(){},e.RefreshGmChatRed=function(e){void 0===e&&(e=null);var t=this.kf_red,i=this.kf_saveTime;if(e)this.GetGmIsOpen()&&this.chatTarget!=I.VIPGmUid&&e.time>i&&(this.kf_red+=1);else{var n=this.GetChatInfo(I.Channel.Private,I.VIPGmUid);if(this.kf_red=0,this.GetGmIsOpen()&&this.chatTarget!=I.VIPGmUid&&n&&n.length>0)for(var s=n.length-1;s>=0;s--){var h=n[s];if(!h.is_my)if(h.time>i)this.kf_red+=1;else if(h.time<i)break}}t!=this.kf_red&&(normalEvent.emit(y.UpdateChatRed),IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()),IS(a).changeValue("vip_btnRed",this.GetVipBtnRed()))},e.ReadGmMsg=function(e){if(e==I.VIPGmUid){var t=this.kf_red;this.kf_red=0,this.kf_saveTime=h.serverTime;var i=this.GetChatInfo(I.Channel.Private,I.VIPGmUid);if(i&&i.length>0){var n=i[i.length-1];this.kf_saveTime=n.time}return IS(u).send_3_29(m.GmChatTime,0,"time",this.kf_saveTime.toString()),t!=this.kf_red&&(normalEvent.emit(y.UpdateChatRed),IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()),IS(a).changeValue("vip_btnRed",this.GetVipBtnRed())),!0}return!1},e.UpdateKfSaveTime=function(e){e&&!e[m.GmChatTime]||0==this.kf_saveTime&&(this.kf_saveTime=IS(c).getClientDataByNum(m.GmChatTime,"time"),this.RefreshGmChatRed())},e.LoadGmHistoryMsg=function(e){if(void 0===e&&(e=null),(!e||e[m.GmChat])&&!this.isLoadGmHistory&&!this.gmOpenInfo.isOriData&&this.gmOpenInfo.is_open<3){this.kf_his_ver;var t=IS(c).getClientData(m.GmChat,"ver");if(t&&t==this.kf_his_ver){var i=IS(c).getClientData(m.GmChat,"chat_info"),a=[];if(i){var n=JSON.parse(i);if(n){var s=[],r=this.GetChatInfo(I.Channel.Private,I.VIPGmUid);if(r)for(var d=0;d<r.length;d++)s[r[d].time]=!0;a=r;for(var o=0;o<n.length;o++){var l=n[o];if(!s[l.time]){delete l.height;var p=l.content;p.length>I.VipChatMsgLenLimit&&(l.content=p.slice(0,I.VipChatMsgLenLimit)),a.push(l),this.isGmChatOpen||(this.isGmChatOpen=h.serverTime-l.time<I.GmShowTime)}}}}this.RefreshVipBtnShowState(),this.GetGmIsOpen()&&(a.length>0&&(this.UpdateChatHistoryMessage({channel:I.Channel.Private,target_id:I.VIPGmUid,chat_history:a}),this.RefreshGmChatRed()),this.isLoadGmHistory=!0)}}},e.UpdateGmList=function(e){this.kf_list=e.list,normalEvent.emit(y.UpdateGmList)},e.UpdateGmInfo=function(e){this.kf_list||(this.kf_list=new Array),this.kf_list[0]=e.data,normalEvent.emit(y.UpdateGmList)},e.kfOffline=function(e){this.kf_list&&this.kf_list[0].uid==e.kf_uid&&(this.kf_list[0].online_state=0,normalEvent.emit(y.UpdateGmList))},e.GetKfList=function(){return this.kf_list},e.UpdateVipGmOfflineMsg=function(e){if(e.msg_list&&e.msg_list.length>0){var t=[],i=this.GetChatInfo(I.Channel.Private,I.VIPGmUid);if(i)for(var a=0;a<i.length;a++)t[i[a].time]=!0;for(var n=0;n<e.msg_list.length;n++)t[e.msg_list[n].time]||this.ReceiveGmMsg(e.msg_list[n]);this.RefreshGmChatRed(),this.LoadGmHistoryMsg(),this.SaveGmMySelfMsg()}},e.UpdateVipInfo=function(e){this.gmOpenInfo=e,0==IS(d).Get(o.VIP_GET)&&1==this.gmOpenInfo.is_open&&(IS(R).VIPRedPoint=1,normalEvent.emit(S.WELFARE_VIP_UPDATE,1)),IS(d).set(o.VIP_GET,this.gmOpenInfo.is_open),this.RefreshVipBtnShowState(),this.LoadGmHistoryMsg(),this.RefreshVipBtnRed(),normalEvent.emit(y.UpdateGmOpenInfo)},e.GetGmOpenInfo=function(){return this.gmOpenInfo},e.RefreshVipBtnShowState=function(){var e=this.vipBtnShowState;this.vipBtnShowState=0,3==this.gmOpenInfo.is_open&&(this.isGmChatOpen=!1,this.isLoadGmHistory=!1,this.RemoveFriendDataByBlack(I.VIPGmUid),this.RefreshGmChatRed()),this.gmOpenInfo.isOriData||(this.isGmChatOpen||1==this.gmOpenInfo.is_open||2==this.gmOpenInfo.is_open)&&(this.vipBtnShowState=2),e!=this.vipBtnShowState&&normalEvent.emit(y.UpdateVipBtnShowStateChange)},e.GetVipBtnShowState=function(){return this.vipBtnShowState},e.RefreshVipBtnRed=function(e){if(void 0===e&&(e=null),!e||e[m.VipBtnRed]){if(this.vipBtnRed=0,IS(g).GetRechargeInfo().total_money>=this.gmOpenInfo.open_money){var t=IS(c).getClientDataByNum(m.VipBtnRed,"vipShowRed");t&&0!=t||(this.vipBtnRed=1)}IS(a).changeValue("vip_btnRed",this.GetVipBtnRed())}},e.GetVipBtnRed=function(){return this.vipBtnRed+this.kf_red},e.ClickVipRed=function(){this.vipBtnRed=0;var e=[],t=!1;IS(c).getClientDataByNum(m.VipBtnRed,"vipPreRed")>0?e.push({k:"vipPreRed",s:"1"}):1==this.vipBtnShowState&&(e.push({k:"vipPreRed",s:"1"}),t=!0),IS(c).getClientDataByNum(m.VipBtnRed,"vipShowRed")>0?e.push({k:"vipShowRed",s:"1"}):2==this.vipBtnShowState&&(e.push({k:"vipShowRed",s:"1"}),t=!0),t&&IS(u).send_3_29_All(m.VipBtnRed,0,e)},e.initChannelList=function(e){this.openChannelList=e;for(var i,a=t(e);!(i=a()).done;){var n=i.value;this.ClearMentionRed(n),IS(G).reqChatHistory(n)}normalEvent.emit(y.ChannelListUpdate)},e.updateChannelList=function(e,t){if(0==e)IS(i).openChannelList.push(t),this.ClearMentionRed(t),IS(G).reqChatHistory(t),normalEvent.emit(y.ChannelListUpdate);else{var a=IS(i).openChannelList.indexOf(t);-1!==a&&(IS(i).openChannelList.splice(a,1)[0],normalEvent.emit(y.ChannelListUpdate))}},e.getChannelList=function(){if(this.isOpenSeasonMap)return[I.ViewType.SeasonMap,I.ViewType.SeasonMapBattle,I.ViewType.SeasonMapFOUR];for(var e,i=[I.ViewType.World,I.ViewType.Private,I.ViewType.Guild,I.ViewType.News,I.ViewType.Activity],a={},n=t(this.openChannelList);!(e=n()).done;){a[e.value]=!0}for(var s in B){a[B[s]]&&!i.includes(Number(s))&&i.push(Number(s))}for(var h=0;h<w.length;h++)this.openTempViewType[w[h]]&&i.push(w[h]);return i.sort(),i},e.SetOpenTempViewTypeState=function(e,t){t?this.openTempViewType[e]=!0:delete this.openTempViewType[e]},e.GetFaceIconByContent=function(e){var t=e.split("_");if(t[1]){var i=D[t[1]];if(i.openTime){var a=new Date(i.openTime).getTime()/1e3;h.serverTime<a&&(e="")}return[e,i]}return[e+"_1",D[1]]},e.UpdateMainChatTipShow=function(e){},e.GetIsShowMainTip=function(){},e.SetMentionRole=function(e){this.mentionRole[e.role_id]=e},e.ClearMentionRole=function(){this.mentionRole={}},e.GetHasMentionRole=function(){for(var e in this.mentionRole)return!0;return!1},e.GetMentionRole=function(){return this.mentionRole},e.SetNewMsgTime=function(e,t){var i=!1,s=this.GetChatInfo(e,t);if(s&&s.length>0){var h=s[s.length-1];e==I.Channel.Private?(i=this.GetChatReadTime(t)!=h.time,this.readTime[t]=h.time):(i=this.GetChatReadTime(e)!=h.time,this.readTime[e]=h.time)}var r=!1;for(var d in e==I.Channel.Private?(r=!!this.mentionRed[t],delete this.mentionRed[t]):(r=!!this.mentionRed[e],delete this.mentionRed[e]),this.mentionRedNum=0,this.mentionRed)this.mentionRedNum++;if(r&&(IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()),normalEvent.emit(y.UpdateChatRed)),i){var o="ChatReadTime_"+IS(c).GetRoleId();n.set(o,this.readTime)}},e.ClearMentionRed=function(e){if(this.mentionRed[e]){for(var t in delete this.mentionRed[e],this.mentionRedNum=0,this.mentionRed)this.mentionRedNum++;IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()),normalEvent.emit(y.UpdateChatRed)}},e.GetChatReadTime=function(e){var t;if(!this.readTime){var i="ChatReadTime_"+IS(c).GetRoleId();this.readTime=n.get(i)}return this.readTime||(this.readTime={}),null!=(t=this.readTime[e])?t:0},e.GetMentionNoRead=function(e){if(!e.is_my&&e.links[0]&&e.links[0].type==I.ChatLinkType.MentionRole){var t=0;if(t=e.channel==I.Channel.Private?this.GetChatReadTime(e.role_id):this.GetChatReadTime(e.channel),e.time<=t)return!1;for(var i=IS(c).GetRoleId(),a=0;a<e.links[0].args_list.length;a++)if(e.links[0].args_list[a]==i)return!0}return!1},e.UpdateMentionRed=function(e,t,i){var n=!1;if(e!=this.chatTarget&&(e!=I.Channel.Private||this.chatTarget!=t)){if(i)this.GetMentionNoRead(i)&&(e==I.Channel.Private?(n=!this.mentionRed[t],this.mentionRed[t]=1,this.mentionRedNum+=1):(n=!this.mentionRed[e],this.mentionRed[e]=1,this.mentionRedNum+=1));else for(var s=this.GetChatInfo(e,t),h=0;h<s.length;h++)if(this.GetMentionNoRead(s[h])){e==I.Channel.Private?(n=!this.mentionRed[t],this.mentionRed[t]=1,this.mentionRedNum+=1):(n=!this.mentionRed[e],this.mentionRed[e]=1,this.mentionRedNum+=1);break}n&&(IS(a).changeValue("private_red",this.GetPrivateRed()),IS(a).changeValue("chat_red",this.GetChatRed()),normalEvent.emit(y.UpdateChatRed))}},e.GetMentionRed=function(e,t){if(e!=I.Channel.Private)return this.mentionRed[e];if(t)return this.mentionRed[t];for(var i in this.mentionRed)if(parseInt(i)>1e3)return 1;return 0},i}());i._RF.pop()}}}));

