System.register("chunks:///_virtual/UnitMgr.ts",["./rollupPluginModLoBabelHelpers.js","cc","./FixMath.ts","./ObjectUtil.ts","./MetaAttrib.ts","./Skill.ts","./Unit.ts","./UnitCall.ts","./UnitData.ts","./UnitDLPlayer.ts","./UnitDPVPPlayer.ts","./UnitShamPlayer.ts","./UnitSoloBoss.ts","./UnitT20Boss.ts","./UnitT20Player.ts","./UnitTFPlayer.ts","./UnitWorldBoss.ts","./UnitWorldBossPlayer.ts","./EnumDefine.ts","./V2.ts"],(function(t){"use strict";var i,e,n,r,a,s,o,l,d,u,c,f,h,y,p,g,v,U,_,T,L,k,P,I,S,D;return{setters:[function(t){i=t.createForOfIteratorHelperLoose,e=t.createClass},function(t){n=t.cclegacy},function(t){r=t.FixMath},function(t){a=t.default},function(t){s=t.AttribDefine,o=t.MetaAttrib},function(t){l=t.Skill},function(t){d=t.Unit},function(t){u=t.UnitCall},function(t){c=t.UnitData},function(t){f=t.UnitDLPlayer},function(t){h=t.UnitDPVPPlayer},function(t){y=t.UnitShamPlayer},function(t){p=t.UnitSoloBoss},function(t){g=t.UnitT20Boss},function(t){v=t.UnitT20Player},function(t){U=t.UnitTFPlayer},function(t){_=t.UnitWorldBoss},function(t){T=t.UnitWorldBossPlayer},function(t){L=t.SkillType,k=t.StateType,P=t.TargetFilter,I=t.UnityType,S=t.TargetSelectFilter},function(t){D=t.V2}],execute:function(){n._RF.push({},"5bb83O4sptJPbT+JJT4YATA","UnitMgr",void 0);t("UnitMgr",function(){var t=n.prototype;function n(t){this._entitys=new Map,this._entityList=[],this._filterUnitList=[],this.battleMain=void 0,this._tempId=0,this.objectsToDestroy=[],this.interruptUpdate=!1,this.battleMain=t}return t._getValidId=function(){return++this._tempId},t._createUnit=function(t,i,e,n){void 0===e&&(e=0);var a=this._getValidId(),o=new t(this.battleMain);if(o.unitId=a,o.teamId=e,i.unitId=a,i.unitType.att_skill>0){var d=configSkill.getDataByKey(i.unitType.att_skill);i.attack=new l,i.attack.config=d,i.attack.currenCd=r.round(1/i.attribs[s.att_speed].value)}if(i.unitType.counter>0){i.counterAttack=new l;var u=configSkill.getDataByKey(i.unitType.counter);i.counterAttack.config=u}return 0==i.currenHp&&(i.currenHp=i.attribs[s.hp].value),i.maxHp=i.attribs[s.hp].value,o.init(i),this._entitys.set(a,o),this._entityList.push(o),GlobalDefine.DUMP_OBJECT&&o.dump(),o},t._addUnit1=function(t,e,r,a){void 0===r&&(r=0);var s=new c;s.attribs={},s.config=e;for(var l,d=configAttribute.getDataByList("module",1),u=i(d);!(l=u()).done;){var f=l.value,h=new o(f);h.baseValue=e[f.key],s.attribs[f.id]=h}if(s.skillList=[],null!=e.skills)for(var y=0;y<e.skills.length;y++){var p=e.skills[y];n.addSkill(s,p,1)}if(null!=e.passiveSkills)for(var g=0;g<e.passiveSkills.length;g++){var v=e.passiveSkills[g];n.addSkill(s,v,1)}return this._createUnit(t,s,r)},t._addUnit=function(t,i,e){return void 0===e&&(e=0),this._addUnit1(t,configUnit.getDataByKey(i),e)},t.addUnit=function(t,i){return void 0===i&&(i=0),this._addUnit(d,t,i)},t.addUnitMain=function(t,i){return void 0===i&&(i=0),this._addUnit1(d,t,i)},t.addSoloBoss=function(t,i){return void 0===i&&(i=0),this._addUnit(p,t,i)},t.addT20Boss=function(t,i){return void 0===i&&(i=0),this._addUnit1(g,configUnit.getDataByKey(t),i,!1)},t.addWorldBoss=function(t,i){return void 0===i&&(i=0),this._addUnit(_,t,i)},t.addUnitCall=function(t,i){return void 0===i&&(i=0),this._addUnit(u,t,i)},t.addUnitImageCall=function(t,i){return void 0===i&&(i=0),this._createUnit(u,t,i)},n.newSkill=function(t,i){var e=configSkill.getDataByKey(t);if(null==e)throw Error("技能表:["+t+"]缺少配置!");if(e.type!=L.PASSIVE_ADD){var n=new l;if(n.config=e,n.level=i,n.currenPower=e.initialPower,n.currenCd=0,n.checkState(),i>0){var r=configSkill_level.getDataByKeys("id",t,"level",i);if(null==r)throw Error("技能等级表:["+t+"]缺少配置!");n.skillDam=r.skillCoefficient}return n}printLogErr(t+":被动技能属性加成（服务器）")},n.addSkill=function(t,i,e){var n,r=this.newSkill(i,e),a=r.config;if(a.type==L.PASSIVE_EFFECT)t.passiveSkillList=null!=(n=t.passiveSkillList)?n:[],t.passiveSkillList.push(r);else if(a.type==L.PARTNER_SKILL){var s;t.petPassiveSkillList=null!=(s=t.petPassiveSkillList)?s:[],t.petPassiveSkillList.push(r)}else if(a.type==L.FLY_SKILL){var o;t.flyPetPassiveSkillList=null!=(o=t.flyPetPassiveSkillList)?o:[],t.flyPetPassiveSkillList.push(r)}else{var l;t.skillList=null!=(l=t.skillList)?l:[],t.skillList.push(r)}return r},t.addPlayer=function(t,i){return void 0===i&&(i=0),this._createUnit(d,t,i)},t.addTFPlayer=function(t,i){return void 0===i&&(i=0),this._createUnit(U,t,i)},t.addT20Player=function(t,i){return void 0===i&&(i=0),this._createUnit(v,t,i,!GlobalDefine.CLIENT_TYPE)},t.addWorldBossPlayer=function(t,i,e){void 0===i&&(i=0),void 0===e&&(e=!1);var n=this._createUnit(T,t,i,!0);return n.shamUnit=e,n},t.addDLPlayer=function(t,i){return void 0===i&&(i=0),this._createUnit(f,t,i)},t.addDPVPPlayer=function(t,i){return void 0===i&&(i=0),this._createUnit(h,t,i)},t.addShamPlayer=function(t,i){return void 0===i&&(i=0),this._createUnit(y,t,i)},t._onUpdate=function(t,i){for(var e=0;e<this._entityList.length;++e){var n=this._entityList[e];n.isDestroy?(this._entityList.splice(e,1),this._entitys.delete(n.unitId),e--):n[i](t)}},t.updateDepth=function(){a.sort(this._entityList,(function(t,i){var e=r.roundInt(100*t.position.y),n=r.roundInt(100*i.position.y);return t.statectr.currentStateType==k.Skill&&r.roundInt(e+10),i.statectr.currentStateType==k.Skill&&r.roundInt(n+10),e<n}));for(var t=0;t<this._entityList.length;++t){this._entityList[t].depth=t}},t.onUpdate=function(t,i){0!=this._entityList.length&&(this._onUpdate(t,"onThink"),this._onUpdate(t,"onUpdate"),this._onUpdate(t,"onLastUpdate"),this._entityList.length<2||this.updateDepth())},t.battleOver=function(){for(var t=0;t<this._entityList.length;++t){var i=this._entityList[t];i.statectr.lockCurrenState=!1,i.statectr.changeStateType(k.Over)}},t.playerGroupDead=function(t){for(var i=0;i<this._entityList.length;++i){var e=this._entityList[i];e.isDead||e.data.roleId==t&&e.dead()}},t.getUnit=function(t){return this._entitys.get(t)},t.findTarget=function(t,i,e,n,r){var a;void 0===e&&(e=0),void 0===r&&(r=!0);var s=this._filterUnitList;s.length=0,n=null!=(a=n)?a:t.position;for(var o=0;o<this._entityList.length;++o){var l=this._entityList[o];if(!l.isDestroy&&!(l.isDead||r&&l.statectr.currentStateType==k.Born))if(l!=t||0==(i&P.Cast)){if(0!=(i&P.Enemy)&&t.teamId!=l.teamId){if(1==l.data.unitType.target)continue;if(l.shamUnit)continue;this.filterTarget(s,t,l,n,e)}t!=l&&0!=(i&P.CastPartner)&&l.config.type==I.Partner&&t.teamId==l.teamId&&t.data.roleId==l.data.roleId&&this.filterTarget(s,t,l,n,e),t!=l&&0!=(i&P.CastPlayer)&&l.config.type==I.Player&&t.teamId==l.teamId&&t.data.roleId==l.data.roleId&&this.filterTarget(s,t,l,n,e),t!=l&&0!=(i&P.FriendPlayer)&&l.config.type==I.Player&&t.teamId==l.teamId&&t.data.roleId!=l.data.roleId&&this.filterTarget(s,t,l,n,e),t!=l&&0!=(i&P.FriendPartner)&&l.config.type==I.Partner&&t.teamId==l.teamId&&t.data.roleId!=l.data.roleId&&this.filterTarget(s,t,l,n,e),t!=l&&0!=(i&P.Friend)&&t.teamId==l.teamId&&this.filterTarget(s,t,l,n,e),t!=l&&0!=(i&P.EnemyPartner)&&l.config.type==I.Partner&&t.teamId!=l.teamId&&t.data.roleId!=l.data.roleId&&this.filterTarget(s,t,l,n,e)}else s.push(t)}return s},t.filterTarget=function(t,i,e,n,a){void 0===a&&(a=0);var s=0==a;if(a>0){var o=r.distanceX(n,e.position);o=r.round(o-r.roundInt(i.radiusSize+e.radiusSize)),s=(o=r.round(o))<=a}s&&t.push(e)},t.getTargetList=function(t,i,e,n){if(0==i.length)return i;if(e<1||e>0&&e>=i.length&&n!=S.HpSmallTarget&&n!=S.HpBigTarget)return i;switch(n){case S.NotFilter:break;case S.NearTarget:case S.RandomTarget:this.sortTargetListByDistance(t,i,!0);break;case S.FarTarget:this.sortTargetListByDistance(t,i,!1);break;case S.MinHpTarget:this.sortTargetListByHp(t,i,!0);break;case S.MaxHpTarget:this.sortTargetListByHp(t,i,!1);break;case S.HpSmallTarget:this.getTargetListwithHp(t,i,!1);break;case S.HpBigTarget:this.getTargetListwithHp(t,i,!0)}for(var r=e;r<i.length;)i.splice(r,1);return i},t.getTargetListwithHp=function(t,i,e){for(var n=r.roundInt(100*r.round(t.data.currenHp/t.data.getAttrib(s.hp))),a=0;a<i.length;a++){var o=i[a],l=r.roundInt(100*r.round(o.data.currenHp/o.data.getAttrib(s.hp)));e&&n<l||(!e&&n>l||(i.splice(a,1),a--))}},t.sortTargetListByHp=function(t,i,e){a.sort(i,(function(i,n){var a=r.round(i.data.currenHp/i.data.getAttrib(s.hp)),o=r.round(n.data.currenHp/n.data.getAttrib(s.hp));return(a=r.roundInt(100*a))==(o=r.roundInt(100*o))?Math.floor(D.distance(i.position,t.position))>Math.floor(D.distance(n.position,t.position)):e?a>o:o<a}))},t.sortTargetListByDistance=function(t,i,e){a.sort(i,(function(i,e){return Math.floor(D.distance(i.position,t.position))>Math.floor(D.distance(e.position,t.position))}))},t.destroyUnit=function(t){this.objectsToDestroy.push(t)},t.deferredDestroy=function(){for(var t=this.objectsToDestroy,i=t.length,e=0;e<i;++e){t[e].destroyImmediate()}i===t.length?t.length=0:t.splice(0,i)},t.clear=function(){this._tempId=0;for(var t=0;t<this._entityList.length;++t){this._entityList[t].destroy()}this._filterUnitList.length=0,this._entityList.length=0,this._entitys.clear(),this.deferredDestroy()},e(n,[{key:"entityList",get:function(){return this._entityList}}]),n}());n._RF.pop()}}}));

