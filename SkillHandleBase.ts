System.register("chunks:///_virtual/SkillHandleBase.ts",["./rollupPluginModLoBabelHelpers.js","cc","./BaseConfig.ts","./index23.ts","./ListPool.ts","./ObjectPool.ts","./FixMath.ts","./EnumDefine.ts","./V2.ts","./Timer.ts"],(function(t){"use strict";var e,i,n,r,s,a,l,o,u,f,c,h;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy},function(t){n=t.CONFIG_KEY},null,function(t){r=t.ListPool},function(t){s=t.ObjectPool},function(t){a=t.FixMath},function(t){l=t.BattleFlag,o=t.TargetFilter,u=t.TargetSelectFilter,f=t.BindType},function(t){c=t.V2},function(t){h=t.TimerGroup}],execute:function(){i._RF.push({},"0d7ecX5wYlFjIugnDgwvoxO","SkillHandleBase",void 0);var d=new c,g=new r,v=t("SkillEffectTask",function(){function t(){this.id=void 0,this.config=void 0,this.runner=void 0,this.handle=void 0,this.target=void 0,this.totalTime=0,this.curTotalTime=0,this.delayTime=0,this.duration=0,this.curTime=0,this.pos=new c,this.effect=void 0,this.isStop=void 0}var e=t.prototype;return e.onUpdate=function(t){if(!this.isStop){if(this.delayTime>0)return this.delayTime=a.round(this.delayTime-t),void(this.delayTime<=0&&this.handle.onExecuteEffectAction(this));if(0!=this.totalTime){if(this.curTime>=this.duration&&(this.handle.onExecuteEffectAction(this),this.curTime=a.round(this.curTime-this.duration)),this.totalTime>0&&this.curTotalTime>=this.totalTime)return this.handle.onExecuteEffectAction(this,!0),void(this.isStop=!0);this.curTotalTime=a.round(this.curTotalTime+t),this.curTime=a.round(this.curTime+t)}else this.isStop=!0}},e.cacheReset=function(){this.isStop=!1,this.curTotalTime=0,this.curTime=0,this.totalTime=0,this.duration=0,this.handle=null,this.runner=null,this.target=null,this.delayTime=0,null!=this.effect&&(this.effect.free(),this.effect=null)},t}()),p=new s(v,50);t("SkillHandleBase",function(){function t(t){this.runner=void 0,this.taskList=void 0,this._skillEffectId=0,this._timerId=0,this.timers=void 0,this._stopTimer=!1,this.runner=t}var i=t.prototype;return i.onModelEnd=function(){},i.onActTargetAction=function(t,e){},i.onDeadTargetAction=function(t){},i.onBeHitAction=function(t,e,i){},i.checkBuff=function(t,i){var r=t.config;if(0!=r.buffGroup.length&&0!=r.buffRate.length)for(var s,l=e(r.buffRate);!(s=l()).done;){var o=s.value,u=t.runner.battleMain.random.randomInt(0,1e4);if(t.runner.battleMain.printLogFlag&&t.runner.battleMain.printLogDebug("随机BUFF: index: "+u),!(u>a.roundInt(1e4*o[1])))for(var f=0;f<r.buffGroup.length;f++){var c,h=r.buffGroup[f];if(h[0]==o[0]){var d=r.skillPar.length>f?r.skillPar[f]:1,g=null!=(c=t.runner.useSkill.skillDam[d-1])?c:1e4^n;g=a.round((g^n)/1e4),t.runner.addBuff(i,h[1],this.runner.cast.data.getSkillFactAttrValue(h[3],this.runner.useSkill.config.id,1041),g)}}}},i.execSkillEffect=function(t,e){this.execHitAction(t,e)},i.addTask=function(t,e,i,n){var r=configSkilleffcet.getDataByKey(t);if(null==r)throw Error("技能："+i.useSkill.config.id+" 效果ID："+t+" 没找到!");return this._addTask(r,e,i,n)},i._addTask=function(t,e,i,n){var r;this.taskList=null!=(r=this.taskList)?r:[],this._skillEffectId++;var s=p.alloc();s.config=t,s.id=this._skillEffectId,s.handle=this,s.target=n,s.pos.set(e);var o=0;if(t.execute.length>0){var u=i.cast.data.getSkillFactAttrValue(t.execute[1],this.runner.useSkill.config.id,1041);s.totalTime=u,s.duration=t.execute[0],o=u}if(t.soundid>0&&this.runner.playSound(t.soundid),t.effectDelay>0&&(s.delayTime=a.round(t.effectDelay/1e3)),s.runner=i,0==s.totalTime&&0==t.effectDelay)return s.isStop=!0,void this.execHitAction(n,s);if(this.runner.pushRun(),this.taskList.push(s),0==t.effctId)return s;var f=this.runner.battleMain;if(!(f.battleFlag&l.OPEN_GRAPHIC))return s;if(f.battleFlag&l.UI_MASK)return s;var c=configEffect.getDataByKey(t.effctId);if(c&&c.is_ban&&f.battleFlag&l.SIMP_MODEL)return s;var h=f.renderMgr.allocEffect(t.effctId,null,o);return h.position=s.pos,i.cast.position.x==s.pos.x?h.dir=i.cast.direction:h.dir=i.cast.position.x>s.pos.x?-1:1,h.scale*=f.effectScale,0!=o&&(s.effect=h),s},i.execEffectTarget=function(t,i){var n=i.config.skillEffect;if(0!=n.length)for(var r,s=e(n);!(r=s()).done;){var a=r.value;if(a==i.config.id)throw Error("技能效果死循环!!:"+a);this.addTask(a,i.pos,i.runner,t)}},i._skillEffect1=function(){var t=this.runner;if(t.cast.isDead)this._timerId>0&&(this.timers.stop(this._timerId),this._timerId=0);else{var i=t.useSkill.config,n=t.lockTarget;if(null==n||n.isDead)if(i.autoDis>0){var r=t.getTargets(o.Enemy,i.autoDis,t.cast.position,1,u.NearTarget);if(0==r.length){var s=t.battleMain.random.randomInt(100,300);t.battleMain.printLogFlag&&t.battleMain.printLogDebug("技能效果1-1: offsetX: "+s);var l=t.cast.position.x+a.roundInt(t.cast.direction*s);d.set(l,t.cast.position.y)}else d.set(r[0].position)}else{var f=t.battleMain.random.randomInt(100,300);t.battleMain.printLogFlag&&t.battleMain.printLogDebug("技能效果1-2: offsetX: "+f);var c=t.cast.position.x+a.roundInt(t.cast.direction*f);d.set(c,t.cast.position.y)}else d.set(n.position);if(0!=i.targetType.length){var h=i.skillEffect1;if(0!=h.length){var g=d,v=t.getTargets(i.targetType[0],i.targetRange,g,i.targetType[1],i.targetType[2]);if(v.length>0&&i.targetType[0]<4&&d.set(v[0].position),i.bullet>0)for(var p,T=e(v);!(p=T()).done;){var k=p.value;t.addBullet(k,i.bullet).param.push("skillEffect1")}else for(var m,E=e(h);!(m=E()).done;){var y=m.value;this.addTask(y,g,t,n)}}}}},i._skillEffect2=function(){var t=this.runner,i=t.useSkill.config;if(null!=i.rangeType&&0!=i.rangeType.length){var n=i.skillEffect2;if(0!=n.length)for(var r=t.cast.direction,s=0;s<i.rangeType.length;s+=2){var l=t.cast.position.x+a.round(a.round(r*i.rangeType[s+0])*i.rangeType[s+1]);if(d.set(l,t.cast.position.y),i.bullet>0)t.addBulletToPos(d,t.cast.getBindPos(f.bp_lead),i.bullet).param.push("skillEffect2");else for(var o,u=e(n);!(o=u()).done;){var c=o.value;this.addTask(c,d,t,null)}}}},i.execBeginAction=function(){var t=this,e=this.runner,i=e.useSkill.config;if(i.releaseTime>0){var n=a.roundInt(i.releaseTime/i.releaseInterval);e.useSkill.currenRelease=0,this._timerId=this.addTimer(i.releaseInterval,n,(function(){i.releaseInterval>i.releaseTime||(t._skillEffect1(),t._skillEffect2())}))}else e.resetPower();this._skillEffect1(),this._skillEffect2()},i.execHitAction=function(t,i){var r,s=i.config,l=s.skillPar.length>0?s.skillPar[0]:1,o=null!=(r=i.runner.useSkill.skillDam[l-1])?r:1e4^n;if(o=a.round((o^n)/1e4),s.trapId&&s.trapId.length>0)for(var u,f=e(s.trapId);!(u=f()).done;){var c=u.value;this.runner.addTrap(c,i.pos,o)}if(1==s.shake&&this.runner.shake(10,100,.2),s.buffGroup2&&s.buffGroup2.length>0)for(var h,d=e(s.buffGroup2);!(h=d()).done;){var g=h.value;this.runner.addBuffByPos(i.pos,g[0],g[1],o)}null!=t&&(this.checkBuff(i,t),this.execEffectTarget(t,i))},i.onExecuteEffectAction=function(t,i){void 0===i&&(i=!1);var n=this.runner;if(!i){var r=t.config,s=t.pos;if(r.targetType.length>0){var a=n.getTargets(r.targetType[0],r.targetRange,s,r.targetType[1],r.targetType[2]),l=r.skillEffect_rate,o=g.alloc();if(l.length>0)for(var u,f=e(l);!(u=f()).done;){var c=u.value;t.runner.battleMain.random.randomInt(0,1e4)>c[1]||o.push(c[0])}for(var h,d=e(a);!(h=d()).done;){var v=h.value;this.execSkillEffect(v,t);for(var p,T=e(o);!(p=T()).done;){var k=p.value;if(k==t.config.id)throw Error("技能效果死循环!!:"+k);this.addTask(k,t.pos,t.runner,v)}}g.free(o)}else null!=t.target&&this.execSkillEffect(t.target,t)}},i.onBulletAction=function(t,i,n,r){if(null!=r&&0!=r.length)if("skillEffect1"!==r[0])if("skillEffect2"!==r[0])this.execHitAction(i,r[0]);else for(var s,a=this.runner.useSkill.config.skillEffect2,l=e(a);!(s=l()).done;){var o=s.value;this.addTask(o,n,this.runner,i)}else for(var u,f=this.runner.useSkill.config.skillEffect1,c=e(f);!(u=c()).done;){var h=u.value;this.addTask(h,i.position,this.runner,i)}},i.onUpdate=function(t){var e=this,i=this.runner;this.timers&&(this._timerId>0&&(i.useSkill.currenRelease=a.round(i.useSkill.currenRelease+t)),(!this._stopTimer||this._stopTimer&&!this.runner.cast.battleMain.runningToPart)&&this.timers.update(t,(function(t){e.runner.popRun(),t.id==e._timerId&&(e._timerId=0,i.useSkill.currenRelease=0,i.resetPower())})));var n=this.taskList;if(null!=n)for(var r=0;r<n.length;r++){var s=n[r];s.isStop?(n.splice(r,1),r--,i.popRun(),p.free(s)):s.onUpdate(t)}},i.addTimer=function(t,e,i,n){var r;void 0===e&&(e=1),this.timers=null!=(r=this.timers)?r:new h("");var s=this.timers.start(t,e,i);return this.runner.pushRun(),s},i.destroy=function(){var t=this.taskList;if(null!=t){for(var e=0;e<t.length;e++){var i=t[e];p.free(i),this.runner.popRun()}t.length=0}this.timers&&this.timers.clear(),this._timerId>0&&(this._timerId=0,this.runner.resetPower())},t}());i._RF.pop()}}}));

