System.register("chunks:///_virtual/ActivityFPSGameView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./AudioMgr.ts","./NodeUtil.ts","./StringUtil.ts","./TimeUtil.ts","./index57.ts","./SpineSkeleton.ts","./UIEffectAsset.ts","./MessageView.ts","./ActivityDefine.ts","./ActivityFPSDataCache.ts","./BaseView.ts"],(function(e){"use strict";var t,i,n,s,o,a,d,h,l,r,c,p,f,m,u,v,S,y,I,g,C;return{setters:[function(e){t=e.inheritsLoose,i=e.createForOfIteratorHelperLoose},function(e){n=e.cclegacy,s=e.UITransform,o=e.Label,a=e.ProgressBar,d=e.Vec2,h=e.Button,l=e.v2,r=e.Vec3,c=e.Node},function(e){p=e.audioMgr},function(e){f=e.default},function(e){m=e.default},function(e){u=e.default},null,function(e){v=e.SpineSkeleton},function(e){S=e.UIEffectAsset},function(e){y=e.default},function(e){I=e.ActivityEventDefine},function(e){g=e.default},function(e){C=e.BaseView}],execute:function(){n._RF.push({},"fe075fyXC5AAp1RCivIukHv","ActivityFPSGameView",void 0);e("default",function(e){function n(){var t;return(t=e.call(this)||this).sampleUnit=void 0,t.nodeUnitParent=void 0,t.nodeCenter=void 0,t.nodeModel=void 0,t.mapUt=void 0,t.nodeTime=void 0,t.txtTime=void 0,t.txtDesc=void 0,t.txtScore=void 0,t.txtChapter=void 0,t.completeGame=void 0,t.pauseGame=void 0,t.time=0,t.curTime=void 0,t.player=void 0,t.curHP=void 0,t.HPList=[],t.isUsingSkill=void 0,t.enemyGapTime=void 0,t.enemyGapNum=void 0,t.curEnemyGapNum=void 0,t.bossTime=void 0,t.isBossLevel=void 0,t.isBossCycle=void 0,t.curEnemyIndex=void 0,t.enemyList=[],t.energy=0,t.score=0,t.nodeSkillEffect=void 0,t.btnSkill=void 0,t.pbEnergy=void 0,t.nodeFloat=void 0,t.imgHeart=void 0,t.imgTime=void 0,t.txtFloat=void 0,t.imgSkill=void 0,t.skillEffectId=void 0,t.TouchPos=new d,t.FPSEffect=void 0,t.name="ActivityFPSGameView",t.url="ui/module/activityFPS/ActivityFPSGameView",t.poolTime=0,t}t(n,e);var r=n.prototype;return r.onInit=function(){var e=this;this.nodeUnitParent=this.findChild("map/UnitParent"),this.sampleUnit=this.findChild("map/UnitParent/Unit"),this.nodeCenter=this.findChild("map/nodeCenter"),this.nodeModel=this.findChild("map/nodeCenter/nodeModel"),this.mapUt=this.findChildComponent("map",s),this.nodeTime=this.findChild("top/nodeTime"),this.txtTime=this.findChildComponent("top/nodeTime/txtTime",o),this.txtDesc=this.findChildComponent("top/txtDesc",o),this.txtScore=this.findChildComponent("top/nodeScore/txtScore",o),this.txtChapter=this.findChildComponent("top/title/txtChapter",o);for(var t=1;t<=IS(g).levelInfo.guard_point;t++)this.HPList[t]=this.findChild("top/HP/hp"+t+"/HP"+t);this.nodeSkillEffect=this.findChild("skill/nodeSkillEffect"),this.btnSkill=this.findChild("skill/btnSkill"),this.pbEnergy=this.findChildComponent("skill/pbEnergy",a),this.nodeFloat=this.findChild("float"),this.imgHeart=this.findChild("float/imgHeart"),this.imgTime=this.findChild("float/imgTime"),this.txtFloat=this.findChildComponent("float/txtFloat",o),this.imgSkill=this.findChild("skill/btnSkill/imgSkill"),IS(g).mapEdge={left:-this.mapUt.contentSize.x/2,right:this.mapUt.contentSize.x/2,top:this.mapUt.contentSize.y/2,bottom:-this.mapUt.contentSize.y/2},IS(g).MoleMapCenter=new d(this.nodeCenter.position.x,this.nodeCenter.position.y);var i=this.findChild("bottom/btnClose");this.addComponentCallbackListener(i,h.EventType.CLICK,(function(){e.pauseGame=!0,uiMgr.openView("ActivityFPSGameConfirmView")}));var n=this.findChild("bottom/btnGuide");this.addComponentCallbackListener(n,h.EventType.CLICK,(function(){e.pauseGame=!0,uiMgr.openView("ActivityFPSGameGuideView",1)})),this.btnSkill=this.findChild("skill/btnSkill"),this.addComponentCallbackListener(this.btnSkill,h.EventType.CLICK,(function(){e.energy<IS(g).skillEnergy?y.showFlyTip(GetLanguage(201795)):e.isUsingSkill||e.pauseGame||e.completeGame||(e.isUsingSkill=!0,e.pauseGame=!0,uiMgr.openView("ActivityFPSGameMaskView",2))}))},r.registerUpdateHandler=function(){this.addEvent(I.OnTangMoleGameContinue,this.OnGameContinue,this),this.addEvent(I.OnTangMoleAfterSkill,this.OnSkillUse,this),this.addEvent(I.OnTangMoleAfterBoss,this.CreateBoss,this)},r.onAfterOpen=function(){this.FPSEffect=S.alloc("prefab/ui-effect/MX_tx_bsw_dadishushouji_dny",this.nodeModel,-1),this.OnLevelInit()},r.onBeforeClose=function(){for(var e,t=i(this.enemyList);!(e=t()).done;){var n=e.value;n&&(this.enemyList[n.getEnemyId()]=null,n.destroy())}this.enemyList=[],this.player.destroy(),IS(g).checkCurLevel()},r.onDestroy=function(){for(var e,t=i(this.enemyList);!(e=t()).done;){var n=e.value;n&&(this.enemyList[n.getEnemyId()]=null,n.destroy())}this.enemyList=[],this.player.destroy(),IS(g).checkCurLevel()},r.onUpdate=function(e){var t=this;if(!this.completeGame&&!this.pauseGame){this.time+=e,IS(g).curChallengeLevelStage>0?IS(g).curChallengeLevelStage<IS(g).challengeLevelStage?this.time>IS(g).levelInfo.time&&(IS(g).curMoleLevelId++,IS(g).updateLevelInfo(),IS(g).curChallengeLevelStage++,this.isBossLevel||1!=IS(g).levelInfo.boss||(this.isBossLevel=1==IS(g).levelInfo.boss,this.bossTime=this.isBossLevel?IS(g).levelInfo.boss_time:0)):this.isBossCycle||this.isBossCycle:(this.time>=1&&(this.curTime--,this.txtTime.string=u.formatTimeStringForSecond(this.curTime),this.time--),0==this.curTime&&(this.completeGame=!0)),this.isBossLevel&&(this.bossTime-=e),this.enemyGapTime-=e,this.enemyGapTime<=0?this.OnEnemyGapRefresh():this.curEnemyGapNum<this.enemyGapNum&&(this.curEnemyGapNum++,this.CreateEnemy(),this.curEnemyIndex++),this.bossTime<0&&!this.pauseGame&&(this.pauseGame=!0,uiMgr.openView("ActivityFPSGameMaskView",1),this.isBossCycle?this.bossTime=IS(g).levelInfo.boss_time:this.bossTime=1==IS(g).levelInfo.boss?IS(g).levelInfo.boss_time:1e3);for(var n,s=function(){var i=n.value;if(i){if(null==i.spine||null==i.node)return"continue";if(i.state==E.Move||i.state==E.UnderGround)i.checkDistance()?i.prepareAttack():i.moveToCenter(e);else if(i.state==E.Hurt)i.onHurtWaiting(e);else if(i.state==E.Prepare)i.onWaitingAttack(e);else if(i.state==E.Attack&&(i.spine.setAnimation(0,"taopao",!0),i.node&&i.node.setScale(-i.node.scale.x,1,0),i.state=E.Excape,t.addTimer(.5,0,(function(){t.enemyList[i.getEnemyId()]=null,i.destroy()})),t.curHP-=i.attack,t.FPSEffect.aniName="skill1",t.addTimer(.18,0,(function(){t.FPSEffect.aniName="idle1"})),t.UpdatePlayerHP(),t.curHP<=0))return t.curHP=0,t.completeGame=!0,"break"}},o=i(this.enemyList);!(n=o()).done;){var a=s();if("continue"!==a&&"break"===a)break}}if(this.completeGame&&!this.pauseGame){if(this.pauseGame=!0,this.curHP>0)this.nodeFloat.active=!0,this.UpdateFloat(2),this.addTimer(3,0,(function(){t.nodeFloat.active=!1,uiMgr.openView("ActivityFPSGameResultView")})),IS(g).levelResult=1;else{var d=IS(g).curMoleLevelId==IS(g).challengeLevelId?4:3;this.nodeFloat.active=!0,this.UpdateFloat(d),this.addTimer(3,0,(function(){t.nodeFloat.active=!1,uiMgr.openView("ActivityFPSGameResultView")})),IS(g).levelResult=0}IS(g).levelScore=this.score,IS(g).leftHP=this.curHP}},r.OnLevelInit=function(){var e=this;this.completeGame=!1,this.pauseGame=!0,this.isUsingSkill=!1,this.curHP=IS(g).levelInfo.guard_point,this.curTime=IS(g).levelInfo.time,this.txtTime.string=u.formatTimeForSecond(this.curTime),this.txtDesc.string=GetLanguage(201748),this.txtDesc.node.active=IS(g).curMoleLevelId==IS(g).challengeLevelId,this.nodeTime.active=IS(g).curMoleLevelId!=IS(g).challengeLevelId,IS(g).curMoleLevelId!=IS(g).challengeLevelId?this.txtChapter.string=m.formatStrWithMirrorDeal(GetLanguage(200797),GetLanguage(200662+IS(g).curMoleLevelId)):this.txtChapter.string=GetLanguage(201715),this.time=0,this.curEnemyIndex=0,this.skillEffectId=-1,this.enemyList=[],this.isBossLevel=1==IS(g).levelInfo.boss,this.isBossCycle=!1,this.bossTime=this.isBossLevel?IS(g).levelInfo.boss_time:0,this.energy=0,this.score=0,this.txtScore.string=this.score.toString(),IS(g).levelKillInfo=[0,0,0,0,0],IS(g).levelScore=0,IS(g).skillCount=0,this.player=new b(this,IS(g).MoleMapCenter),this.OnEnemyGapRefresh(),this.UpdatePlayerHP(),this.UpdateEnergy(),this.UpdateFloat(1),this.addTimer(3,0,(function(){e.nodeFloat.active=!1,e.pauseGame=!1}))},r.OnGameContinue=function(){this.pauseGame=!1},r.OnEnemyGapRefresh=function(){var e=IS(g).levelInfo.enemy_refresh[1]-IS(g).levelInfo.enemy_refresh[0];this.enemyGapTime=IS(g).levelInfo.enemy_refresh[0]+e*Math.random();var t=IS(g).levelInfo.enemy_nub[1]-IS(g).levelInfo.enemy_nub[0]+1;this.enemyGapNum=IS(g).levelInfo.enemy_nub[0]+Math.floor(t*Math.random()),this.curEnemyGapNum=0},r.CreateEnemy=function(){var e=Math.floor(IS(g).levelInfo.monster_id.length*Math.random()),t=IS(g).levelInfo.monster_id[e],i=this.GetEnemyPosition(),n=new k(this.curEnemyIndex,this,t,i);this.enemyList.push(n)},r.CreateBoss=function(){var e=this.GetEnemyPosition(),t=new k(this.curEnemyIndex,this,IS(g).levelInfo.boss_id[0],e);this.enemyList.push(t),this.curEnemyIndex++,this.pauseGame=!1},r.GetEnemyPosition=function(){for(var e=IS(g).MoleMapCenter,t=new d(0,0),i=d.distance(t,e);i<IS(g).radiusSecure;){var n=IS(g).mapEdge.right-IS(g).mapEdge.left,s=IS(g).mapEdge.left+n*Math.random(),o=IS(g).mapEdge.top-IS(g).mapEdge.bottom,a=IS(g).mapEdge.bottom+o*Math.random();t.set(s,a),i=d.distance(t,e)}return t},r.UpdatePlayerHP=function(){for(var e=IS(g).levelInfo.guard_point;e>0;e--)e>this.curHP?this.HPList[e].active=!1:this.HPList[e].active=!0},r.UpdateEnergy=function(){var e=this,t=this.energy<=IS(g).skillEnergy?this.energy:IS(g).skillEnergy;this.imgSkill.active=this.energy<IS(g).skillEnergy,this.energy>=IS(g).skillEnergy?-1==this.skillEffectId&&(this.skillEffectId=this.addUIEffect("prefab/ui-effect/MX_tx_dadishujiemian_baoqi_dny",this.nodeSkillEffect,-1,l(0,-26.732)),this.addTimer(.3,0,(function(){e.getUIEffect(e.skillEffectId).node&&e.getUIEffect(e.skillEffectId).node.getComponent(v).setAnimation(0,"idle1",!0)}))):-1!=this.skillEffectId&&this.getUIEffect(this.skillEffectId)&&(this.removeUIEffect(this.skillEffectId),this.skillEffectId=-1),this.pbEnergy.progress=t/IS(g).skillEnergy},r.UpdateScore=function(){this.txtScore.string=this.score.toString()},r.UpdateFloat=function(e){1==e&&(this.imgHeart.active=!1,this.imgTime.active=!1,this.txtFloat.string=GetLanguage(201744)),2==e&&(this.imgHeart.active=!1,this.imgTime.active=!0,this.txtFloat.string=GetLanguage(201745)),3==e&&(this.imgHeart.active=!0,this.imgTime.active=!1,this.txtFloat.string=GetLanguage(201746)),4==e&&(this.imgHeart.active=!0,this.imgTime.active=!1,this.txtFloat.string=GetLanguage(201747))},r.OnPlayerAttack=function(e){for(var t,n=this,s=!1,o=function(){var i=t.value;i&&i.checkInRange(e,IS(g).hammerInfo.attack_range)&&i.state!=E.UnderGround&&i.state!=E.Dead&&(s||(n.player.spine.setAnimation(0,"skill1",!1),n.player.nodeShow.setPosition(e.x,e.y),n.player.spine.addAnimation(0,"idle",!0),s=!0),i.hp-=IS(g).hammerInfo.attack,i.changeHpBar(IS(g).hammerInfo.attack),i.spine&&(i.spine.setAnimation(0,"hit",!1),n.addTimer(.5,0,(function(){i.spine.setAnimation(0,"run",!0)}))),i.hp<=0?(i.state=E.Dead,n.energy+=i.energy*IS(g).hammerInfo.energy_multiplier,n.UpdateEnergy(),n.score+=i.score*IS(g).hammerInfo.kill_multiplier,n.UpdateScore(),IS(g).levelKillInfo[i.type-1]++,n.addTimer(.5,0,(function(){n.enemyList[i.getEnemyId()]=null,i.destroy()}))):i.getHurt())},a=i(this.enemyList);!(t=a()).done;)o();s&&p.playSound("stbyc_dds_tiechui")},r.OnSkillUse=function(){var e=this;this.player.spine.setAnimation(0,"skill2",!1),this.addTimer(1.1,0,(function(){e.addUIEffect("prefab/ui-effect/MX_tx_chuizi",e.player.nodeSkill,1.5),p.playSound("stbyc_dds_dazhao"),e.pauseGame=!1;for(var t,n=function(){var i=t.value;i&&(i.hp-=IS(g).skillDamage,i.changeHpBar(IS(g).skillDamage),i.spine&&(i.spine.setAnimation(0,"hit",!1),e.addTimer(.5,0,(function(){i.spine.setAnimation(0,"run",!0)}))),i.hp<=0?(i.state=E.Dead,e.energy+=i.energy*IS(g).hammerInfo.energy_multiplier,e.UpdateEnergy(),e.score+=i.score*IS(g).hammerInfo.kill_multiplier,e.UpdateScore(),IS(g).levelKillInfo[i.type-1]++,e.addTimer(.5,0,(function(){e.enemyList[i.getEnemyId()]=null,i.destroy()}))):i.getHurt())},s=i(e.enemyList);!(t=s()).done;)n();e.energy=0,IS(g).skillCount++,e.UpdateEnergy(),e.isUsingSkill=!1}))},n}(C));var E={Appear:0,Move:1,Wait:2,Hurt:3,UnderGround:4,Prepare:5,Attack:6,Excape:7,Dead:8},k=function(){function e(e,t,i,n){var s=this;this.index=void 0,this.type=void 0,this.maxHp=void 0,this.hp=void 0,this.attack=void 0,this.speed=void 0,this.shape=void 0,this.enter=void 0,this.stop=void 0,this.stopTime=void 0,this.wait=void 0,this.waitTime=void 0,this.energy=void 0,this.score=void 0,this.state=void 0,this.node=void 0,this.view=void 0,this.direction=new d(0,0),this.nodeTx=void 0,this.nodeEffect=void 0,this.nodeEffect2=void 0,this.effect=void 0,this.effect2=void 0,this.spine=void 0,this.nodePbNormalHp=void 0,this.pbNormalHp=void 0,this.nodePbBossHp=void 0,this.pbBossHp=void 0,this.pbHp=void 0,this.isSpineLoaded=void 0,this.view=t,this.type=i;var o=configMole_enemy.getDataByKey(i);this.index=e,this.maxHp=o.hp,this.hp=o.hp,this.attack=o.attack,this.speed=o.speed,this.shape=o.shape,this.enter=o.enter,this.stop=o.stop,this.stopTime=0,this.wait=o.wait,this.waitTime=0,this.energy=o.energy,this.score=o.score;var h=this.view;if(this.node=nodeInstantiate.instantiate(h.sampleUnit),this.node.parent=h.nodeUnitParent,this.isSpineLoaded=!1,3==this.enter)this.node.setPosition(n.x,n.y);else{var l=n.x>0?IS(g).mapEdge.right:IS(g).mapEdge.left;this.node.setPosition(l,n.y)}n.x>0&&this.node&&this.node.setScale(-1,1,0),this.state=E.Appear,this.nodePbNormalHp=f.findChild(this.node,"pbNormalHp"),this.pbNormalHp=f.findChildComponent(this.node,"pbNormalHp",a),this.nodePbBossHp=f.findChild(this.node,"pbBossHp"),this.pbBossHp=f.findChildComponent(this.node,"pbBossHp",a),this.nodePbNormalHp.active=IS(g).levelInfo.boss_id[0]!=i,this.nodePbBossHp.active=IS(g).levelInfo.boss_id[0]==i,this.pbHp=this.nodePbNormalHp.active?this.pbNormalHp:this.pbBossHp,this.nodeTx=f.findChild(this.node,"tx"),this.nodeEffect=f.findChild(this.node,"effect"),this.nodeEffect2=f.findChild(this.node,"effect2"),this.effect=this.view.addUIEffect("prefab/ui-effect/"+o.anim,this.nodeEffect,-1,null,1,(function(e){var t=e.node;t.spine=t.getComponent(v),s.spine=t.spine,s.isSpineLoaded=!0,t.spine||console.error("spine load error"),t.spine.needAnimation="chuxian",s.pbHp.node.setPosition(0,150),s.view.addTimer(.6,0,(function(){s.state=2==s.enter?E.UnderGround:E.Move,s.state==E.UnderGround&&(s.node&&s.node.setScale(.8,.8,0),s.pbHp.node&&(s.pbHp.node.active=!1)),s.spine.setAnimation(0,"run",!0)}))}))}var t=e.prototype;return t.moveToCenter=function(e){if(this.state==E.Move||this.state==E.UnderGround){d.subtract(this.direction,IS(g).MoleMapCenter,new d(this.node.position.x,this.node.position.y));var t=d.distance(new d(this.node.position.x,this.node.position.y),IS(g).MoleMapCenter);this.direction=new d(this.direction.x/t,this.direction.y/t),this.node.translate(new r(this.direction.x*e*this.speed,this.direction.y*e*this.speed,0))}},t.checkDistance=function(){return d.distance(new d(this.node.position.x,this.node.position.y),IS(g).MoleMapCenter)<=IS(g).radiusCenter},t.getHurt=function(){this.stop<=0||(this.state=E.Hurt,this.stopTime=this.stop)},t.onHurtWaiting=function(e){this.stopTime>0&&(this.stopTime-=e),this.state=this.stopTime>0?E.Hurt:E.Move},t.prepareAttack=function(){this.state==E.UnderGround&&(this.node&&this.node.setScale(1,1,0),this.pbHp.node.active=!0),this.state=E.Prepare,this.view.addUIEffect("prefab/ui-effect/MX_tx_dadishu_bossyujing",this.nodeEffect2,1),this.spine.setAnimation(0,"skill1",!1),this.waitTime=this.wait},t.onWaitingAttack=function(e){this.waitTime>0&&(this.waitTime-=e),this.state=this.waitTime>0?E.Prepare:E.Attack},t.checkInRange=function(e,t){return d.distance(new d(this.node.position.x,this.node.position.y),e)<t},t.changeHpBar=function(e){var t=this.hp<=0?0:this.hp;this.pbHp.progress=t/this.maxHp},t.getEnemyId=function(){return this.index},t.destroy=function(){this.node&&(this.nodeEffect.destroy(),this.nodeEffect2.destroy(),this.node.destroy(),this.node=null)},e}(),b=function(){function e(e,t){var i=this;this.node=void 0,this.view=void 0,this.nodeShow=void 0,this.nodeEffect=void 0,this.nodeSkill=void 0,this.effect=void 0,this.spine=void 0,this.view=e;var n=this.view;this.node=n.findChild("player"),this.nodeShow=n.findChild("player/nodeShow"),this.nodeEffect=n.findChild("player/nodeShow/nodeEffect"),this.nodeSkill=n.findChild("player/nodeShow/nodeSkill"),this.nodeShow.setPosition(t.x,t.y),this.effect=this.view.addUIEffect("prefab/ui-effect/MX_j_qushugugu",this.nodeEffect,-1,null,1,(function(e){var t=e.node;t.spine=t.getComponent(v),i.spine=t.spine,t.spine.needAnimation="idle"}));var o=new r;n.addComponentCallbackListener(this.node,c.EventType.TOUCH_START,(function(e){var t=e.getUILocation();o.set(t.x,t.y);var n=i.node.getComponent(s).convertToNodeSpaceAR(o);n.z=0,e.preventSwallow=!0,i.Attack(n)}))}var t=e.prototype;return t.Attack=function(e){var t=this.view;t.isUsingSkill||t.pauseGame||t.completeGame||t.OnPlayerAttack(new d(e.x,e.y))},t.destroy=function(){this.node&&(this.nodeEffect.destroy(),this.node.destroy(),this.node=null)},e}();n._RF.pop()}}}));

