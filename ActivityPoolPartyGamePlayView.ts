System.register("chunks:///_virtual/ActivityPoolPartyGamePlayView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./AudioMgr.ts","./NodeUtil.ts","./StringUtil.ts","./index57.ts","./SpineSkeleton.ts","./MathUtil.ts","./ObjectUtil.ts","./MessageView.ts","./ActivityControl.ts","./ActivityDefine.ts","./ActivityPoolPartyDataCache.ts","./BaseView.ts"],(function(t){"use strict";var e,i,n,o,s,a,r,h,d,c,u,l,f,g,m,v,y,I,p,x,C,w,P,b;return{setters:[function(t){e=t.inheritsLoose},function(t){i=t.cclegacy,n=t.Vec2,o=t.Button,s=t.Label,a=t.ProgressBar,r=t.UITransform,h=t.Layout,d=t.Vec3,c=t.Sprite,u=t.Node},function(t){l=t.audioMgr},function(t){f=t.default},function(t){g=t.default},null,function(t){m=t.SpineSkeleton},function(t){v=t.default},function(t){y=t.default},function(t){I=t.default},function(t){p=t.default},function(t){x=t.ActivityEventDefine,C=t.ActivityType,w=t.ActivityState},function(t){P=t.default},function(t){b=t.BaseView}],execute:function(){var R;i._RF.push({},"79ecby3fTROdpoKWYI9aXUN","ActivityPoolPartyGamePlayView",void 0);var B=new n(-283.35,283.35),T=new n(113.3,113.3),M=((R={})[0]=550,R);t("default",function(t){function i(){var e;return(e=t.call(this)||this).curChapterCfg=void 0,e.txtRemainTimes=void 0,e.useCount=0,e.monsterItem=void 0,e.nodeUnitRoot=void 0,e.utUnitRoot=void 0,e.nodeUnitItem=void 0,e.unitItems=void 0,e.targetPosDic={},e.oriPos=void 0,e.curIndex=void 0,e.isMoving=!1,e.beadList=void 0,e.beatMonstarDic={},e.totalBeadIndex=void 0,e.isTouchStart=void 0,e.needRecover=!1,e.nodeBoomEffectRoot=void 0,e.nodeFlyEffectRoot=void 0,e.beadPoolList=void 0,e.effectId=-1,e.name="ActivityPoolPartyGamePlayView",e.url="ui/module/activityPoolParty/ActivityPoolPartyGamePlayView",e.fullScreen=!0,e.banDefeat=!0,e}e(i,t);var b=i.prototype;return b.onInit=function(){var t=this;this.totalBeadIndex=configGgbond_bead.getDatas().length;var e=this.findChild("view/btnClose");this.addComponentCallbackListener(e,o.EventType.CLICK,(function(){t.isMoving?I.showFlyTip(GetLanguage(201210)):I.showBoxTip({tip:GetLanguage(201211),func:function(e){"type_yes"==e&&t.close()}})})),this.txtRemainTimes=this.findChildComponent("view/txt/txtCount",s),this.monsterItem=null;var i=this.findChild("view/enemy");this.monsterItem={node:i,pbHp:f.findChildComponent(i,"pbNormalHp",a),nodeModel:f.findChild(i,"imgGGBond"),monsterId:0,monsterCfg:null},this.nodeUnitRoot=this.findChild("view/map/unitRoot"),this.utUnitRoot=this.nodeUnitRoot.getComponent(r),this.nodeUnitItem=this.findChild("view/map/unitRoot/item"),this.nodeUnitItem.active=!1,this.nodeBoomEffectRoot=this.findChild("view/map/effectRoot/boomEffect"),this.nodeFlyEffectRoot=this.findChild("view/map/effectRoot/flyEffect"),this.dealMirrorLayout(this.findChildComponent("view/txt",h))},b.registerUpdateHandler=function(){this.addEvent(x.OnActivityInfoUpdate,this.updateInfo,this),this.addEvent(x.OnActivityGameResult,this.OnHolloweenChapterResult,this)},b.onAfterOpen=function(){this.curChapterCfg=configGgbond_chapter.getDataByKey(IS(P).curLevelId),this.beadPoolList=new Array;for(var t=configGgbond_bead.getDatas(),e=this.curChapterCfg.bead,i=0;i<t.length;i++)e&&e.includes(t[i].bead_id)&&this.beadPoolList.push(t[i].bead_id);this.totalBeadIndex=this.beadPoolList.length,this.initMonsterShow(),this.initUnitShow(),this.updateRemainTimes()},b.initMonsterShow=function(){var t=this.curChapterCfg.monster[0],e=this.monsterItem;e.monsterId=t,e.monsterCfg=configGgbond_monster.getDataByKey(t),e.curHp=e.monsterCfg.monster_hp,e.pbHp.progress=1;var i=e.monsterCfg.scale/1e4;e.node.active=!0,-1==this.effectId&&(this.effectId=this.addUIEffect(e.monsterCfg.spine,e.nodeModel,-1,null,i,(function(t){var i=t.node;e.spine=f.findChildComponent(i,"model",m),e.spine.setAnimation(0,"idle",!0)})))},b.initUnitShow=function(){var t=this.curChapterCfg.initial_bead;null==this.unitItems&&(this.unitItems=[]),this.beadList=y.clone(t);for(var e=0;e<t.length;e++){var i=this.unitItems[e]||this.newUnitItem();i.setIndex(e+1);var n=this.getPosByIndex(e+1);i.node.position=new d(n.x,n.y,0),i.id=t[e],i.cfg=configGgbond_bead.getDataByKey(i.id),this.loadIcon(i.imgIcon,"act_poolparty_game1",i.cfg.icon),i.node.active=!0,this.unitItems[e]=i}for(var o=t.length;o<this.unitItems.length;o++)this.unitItems[o].hide()},b.newUnitItem=function(){var t=this,e=nodeInstantiate.instantiate(this.nodeUnitItem);e.parent=this.nodeUnitRoot;var i={node:e,imgIcon:f.findChildComponent(e,"imgIcon",c),index:null,hide:function(){i.node.active=!1,i.index=null},setIndex:function(t){i.index=t,i.node.name=String(t)}};return this.addComponentCallbackListener(e,u.EventType.TOUCH_START,(function(e){t.onTouchStart(e,i)})),this.addComponentCallbackListener(e,u.EventType.MOUSE_DOWN,(function(e){t.onTouchStart(e,i)})),this.addComponentCallbackListener(e,u.EventType.TOUCH_MOVE,(function(e){t.onTouchMove(e,i)})),this.addComponentCallbackListener(e,u.EventType.MOUSE_MOVE,(function(e){t.onTouchMove(e,i)})),this.addComponentCallbackListener(e,u.EventType.TOUCH_END,(function(e){t.onTouchEnd(e,i)})),this.addComponentCallbackListener(e,u.EventType.TOUCH_CANCEL,(function(e){t.onTouchEnd(e,i)})),this.addComponentCallbackListener(e,u.EventType.MOUSE_UP,(function(e){t.onTouchEnd(e,i)})),i},b.updateRemainTimes=function(){this.txtRemainTimes.string=g.formatStrWithMirrorDeal(GetLanguage(201209),this.curChapterCfg.limit-this.useCount)},b.updateMonsterHp=function(t,e){if(!this.beatMonstarDic[t]){var i=this.monsterItem,n=i.curHp,o=Math.max(0,i.curHp-e);i.curHp=o,i.pbHp.progress=Math.max(0,i.curHp),i.spine&&(i.spine.setAnimation(0,"hit",!1),i.spine.addAnimation(0,"idle",!0)),normalTween.to(n,o,.3,(function(t,e){i.pbHp.progress=Math.min(1,e/i.monsterCfg.monster_hp)})).call((function(){o<=0&&(i.node.active=!1)})).start(),o<=0&&(this.beatMonstarDic[t]=!0)}},b.checkChapterEnd=function(){if(this.isMoving=!1,this.beatMonstarDic[0]){for(var t=this.curChapterCfg.star_step,e=0,i=0;i<t.length;i++)if(this.useCount<=t[i]){e=3-i;break}return IS(p).send_24_103(C.PoolPartyGame,IS(P).curLevelId,e+100),void uiMgr.openView("ActivityPoolPartyGameResultView",this.useCount,e,C.PoolPartyGame)}this.useCount>=this.curChapterCfg.limit&&(IS(p).send_24_103(C.PoolPartyGame,IS(P).curLevelId,0),uiMgr.openView("ActivityPoolPartyGameResultView",0,0,C.PoolPartyGame))},b.getPosByIndex=function(t){var e=this.getRowColByIndex(t);return this.getPosByRowCol(e.row,e.col)},b.getPosByRowCol=function(t,e){return{x:(e-1)*T.x+B.x,y:B.y-(t-1)*T.y}},b.getRowColByIndex=function(t){var e=Math.ceil(t/6);return{row:e,col:t-6*(e-1)}},b.getIndexByRowCol=function(t,e){return 6*(t-1)+e},b.getItemByIndex=function(t){for(var e=0;e<this.unitItems.length;e++)if(this.unitItems[e].index&&this.unitItems[e].index==t)return this.unitItems[e]},b.setChangeIndex=function(t,e){var i=this;this.isMoving=!0,this.needRecover=!1,this.isTouchStart=!1,this.useCount=this.useCount+1,this.updateRemainTimes();var n=this.getPosByIndex(t),o=this.getPosByIndex(e),s=this.beadList[t-1],a=this.beadList[e-1];this.beadList[e-1]=s,this.beadList[t-1]=a;var r=this.getItemByIndex(t),h=this.getItemByIndex(e);l.playSound("wanshengjie_yidong"),normalTween.to(0,1,.2,(function(t,e){r.node.position=new d(n.x+e*(o.x-n.x),n.y+e*(o.y-n.y),0),h.node.position=new d(o.x+e*(n.x-o.x),o.y+e*(n.y-o.y),0)})).call((function(){r.setIndex(e),h.setIndex(t),i.checkNeedClear()})).start()},b.getClearByList=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i];if(!(i+1>=t.length||i+2>=t.length)){var o=t[i+1],s=t[i+2];if(o==n&&s==n){var a=this.getRowColByIndex(i+1),r=this.getRowColByIndex(i+2),h=this.getRowColByIndex(i+3);a.row==r.row&&r.row==h.row&&e.push([i,i+1,i+2])}var d=i+6,c=i+12;if(!(i+6>=t.length||i+12>=t.length)){var u=t[d],l=t[c];u==n&&l==n&&e.push([i,i+6,i+12])}}}for(var f={},g=0;g<e.length;g++)for(var m=0;m<e[g].length;m++)f[e[g][m]]||(f[e[g][m]]=!0);return f},b.checkNeedClear=function(){var t=this.getClearByList(this.beadList);y.isEmpty(t)?this.checkChapterEnd():this.factClearItem(t)},b.factClearItem=function(t){var e=this,i={},o=function(t){var o=Number(t)+1,s=e.getRowColByIndex(o),a=e.getPosByIndex(o),r=M[0];i[s.col]||(i[s.col]=0),i[s.col]=i[s.col]+1,e.beadList[o-1]=-1;var h=e.getItemByIndex(o);e.addUIEffect("prefab/ui-effect/MX_tx_xiaoxiaole",e.nodeBoomEffectRoot,1,new n(a.x,a.y),1,(function(t){t.node.getComponent(m).needAnimation=h.cfg.effect})),h.hide(),l.playSound("wanshengjie_baozha");var c=e.addUIEffect("prefab/ui-effect/MX_tx_shuqidaxiaojie_zidan",e.nodeFlyEffectRoot,-1,new n(a.x,a.y),1,(function(t){var i=t.node;normalTween.to(0,1,.3,(function(t,e){printLog("x => ",a.x+e*(0-a.x)),i.position=new d(a.x+e*(0-a.x),a.y+e*(r-a.y),0)})).call((function(){e.removeUIEffect(c),e.updateMonsterHp(0,1)})).start()}))};for(var s in t)o(s);var a=[];for(var r in i)for(var h=Number(r),c=1;c<=i[r];c++)a.push(this.getIndexByRowCol(6+c,h));a.sort((function(t,e){return t-e}));for(var u={},f=0;f<a.length;f++){var g=this.getEmptyItem(),v=a[f];g.setIndex(v);var y=this.getPosByIndex(v);g.node.position=new d(y.x,y.y,0),g.node.active=!0;var I={};u[v-1]&&u[v-2]&&u[v-1]==u[v-2]&&(I[u[v-1]]=!0),u[v-6]&&u[v-12]&&u[v-6]==u[v-12]&&(I[u[v-6]]=!0);var p=this.getRandomBeadId(I);g.id=p,u[v]=p,g.cfg=configGgbond_bead.getDataByKey(g.id),this.loadIcon(g.imgIcon,"act_poolparty_game1",g.cfg.icon)}for(var x={},C=0;C<this.beadList.length;C++)if(-1==this.beadList[C]){var w=void 0,P=this.getRowColByIndex(C+1);if(P.row<6)for(var b=P.row+1;b<=6;b++){var R=this.getIndexByRowCol(b,P.col);if(-1!=this.beadList[R-1]&&null==x[R]){w=R,x[R]=C+1,this.beadList[R-1]=-1;break}}if(!w)for(var B=1;B<=i[P.col];B++){var T=this.getIndexByRowCol(6+B,P.col);if(null!=u[T]&&null==x[T]){w=T,x[T]=C+1;break}}}var L=function(t){var i=e.getItemByIndex(Number(t)),n=i.id,o=x[t];i.setIndex(o);var s=e.getPosByIndex(Number(t)),a=e.getPosByIndex(o);normalTween.to(0,1,.3,(function(t,e){i.node.position=new d(s.x+e*(a.x-s.x),s.y+e*(a.y-s.y),0)})).call((function(){e.beadList[o-1]=n})).start()};for(var E in x)L(E);this.addTimer(.4,1,(function(){e.checkNeedClear()}))},b.getRandomBeadId=function(t){var e=v.getRandomInt(1,this.totalBeadIndex+1);if(t&&t[e])for(;t[e];)e=v.getRandomInt(1,this.totalBeadIndex+1);return this.beadPoolList[e-1]},b.getEmptyItem=function(){for(var t=0;t<this.unitItems.length;t++)if(null==this.unitItems[t].index)return this.unitItems[t]},b.onBeforeClose=function(){if(-1!=this.effectId&&(this.removeUIEffect(this.effectId),this.effectId=-1),this.needRecover=!1,this.isMoving=!1,this.useCount=0,this.beatMonstarDic={},this.isTouchStart=!1,this.unitItems)for(var t=0;t<this.unitItems.length;t++)this.unitItems[t].hide()},b.onDestroy=function(){if(this.unitItems){for(var t=0;t<this.unitItems.length;t++)this.unitItems[t].node.destroy();this.unitItems=null}},b.updateInfo=function(t){t.type==C.PoolPartyGame&&t.state!=w.Open&&this.close()},b.OnHolloweenChapterResult=function(t,e,i){if(e==IS(P).curLevelId)if(0!=t){for(var n=this.curChapterCfg.star_step,o=0,s=0;s<n.length;s++)if(i<=n[s]){o=3-s;break}uiMgr.openView("ActivityPoolPartyGameResultView",i,o,C.PoolPartyGame)}else uiMgr.openView("ActivityPoolPartyGameResultView",0,0,C.PoolPartyGame)},b.onTouchStart=function(t,e){if(!this.isMoving){this.isTouchStart=!0;var i=e.index;this.curIndex=i,this.targetPosDic={};var n=t.getUILocation(),o=new d(n.x,n.y,0);this.oriPos=this.utUnitRoot.convertToNodeSpaceAR(o);var s=this.getRowColByIndex(i);s.col-1>0&&(this.targetPosDic.left=this.getPosByRowCol(s.row,s.col-1).x),s.col+1<=6&&(this.targetPosDic.right=this.getPosByRowCol(s.row,s.col+1).x),s.row-1>0&&(this.targetPosDic.up=this.getPosByRowCol(s.row-1,s.col).y),s.row+1<=6&&(this.targetPosDic.down=this.getPosByRowCol(s.row+1,s.col).y),this.needRecover=!0}},b.onTouchMove=function(t,e){if(!this.isMoving&&this.isTouchStart&&e.index==this.curIndex){var i=t.getUILocation(),n=new d(i.x,i.y,0),o=this.utUnitRoot.convertToNodeSpaceAR(n),s=this.getPosByIndex(this.curIndex),a=Math.min(this.getPosByIndex(6).x,Math.max(B.x,s.x+o.x-this.oriPos.x)),r=Math.max(this.getPosByIndex(36).y,Math.min(B.y,s.y+o.y-this.oriPos.y));e.node.position=new d(a,r,0),this.targetPosDic.left&&a<=this.targetPosDic.left?this.setChangeIndex(this.curIndex,this.curIndex-1):this.targetPosDic.right&&a>=this.targetPosDic.right?this.setChangeIndex(this.curIndex,this.curIndex+1):this.targetPosDic.up&&r>=this.targetPosDic.up?this.setChangeIndex(this.curIndex,this.curIndex-6):this.targetPosDic.down&&r<=this.targetPosDic.down&&this.setChangeIndex(this.curIndex,this.curIndex+6)}},b.onTouchEnd=function(t,e){if(!this.isMoving&&this.isTouchStart&&this.needRecover&&e.index==this.curIndex){this.isTouchStart=!1;var i=this.getPosByIndex(this.curIndex);e.node.position=new d(i.x,i.y,0),this.needRecover=!1}},i}(b));i._RF.pop()}}}));

