System.register("chunks:///_virtual/UnitModelObj.ts",["./rollupPluginModLoBabelHelpers.js","cc","./env","./EnumDefine.ts","./AssetPool.ts","./BaseAsset.ts","./NodeUtil.ts","./StringUtil.ts","./SlotEquip.ts","./SpineSkeleton.ts","./ConfigGlobal.ts","./FixMath.ts","./Effect.ts","./MountAsset.ts"],(function(t){"use strict";var i,n,o,e,s,a,l,u,h,r,d,f,c,_,m,p,k,g,v,S;return{setters:[function(t){i=t.inheritsLoose,n=t.createForOfIteratorHelperLoose,o=t.createClass},function(t){e=t.cclegacy,s=t.Color,a=t.isValid,l=t.sp},function(t){u=t.NATIVE},function(t){h=t.AniConfig,r=t.BattleFlag},function(t){d=t.AssetPoolState},function(t){f=t.BaseAsset},function(t){c=t.default},function(t){_=t.default},function(t){m=t.SlotEquip},function(t){p=t.SpineSkeleton},function(t){k=t.ConfigGlobal},function(t){g=t.FixMath},function(t){v=t.Effect},function(t){S=t.MountAsset}],execute:function(){var A;e._RF.push({},"44d17Flxs5FqKxjHrLSqkok","UnitModelObj",void 0),function(t){t[t.Not=0]="Not",t[t.Depth=256]="Depth",t[t.SetMount=512]="SetMount",t[t.All=16777215]="All"}(A||(A={}));var E=t("EnvironmentColor",new s(255,255,255,255)),y={1:"lv",2:"lan",3:"zi",4:"huang"};t("UnitModelObj",function(t){function e(){for(var i,n=arguments.length,o=new Array(n),e=0;e<n;e++)o[e]=arguments[e];return(i=t.call.apply(t,[this].concat(o))||this)._animator=void 0,i._unitId=void 0,i._depth=void 0,i.configModel=void 0,i._mount=0,i._model=void 0,i._bottom=void 0,i._top=void 0,i._mountTop=void 0,i._mountBottom=void 0,i._slotEquip=void 0,i._skins=void 0,i._changeSkins=void 0,i._fateEffect=void 0,i}i(e,t),e.alloc=function(t,i){var n=unitModelPool.alloc(i.path,i.maxNum,i.maxTime);return n._unitId=t,n.parent=battleMain.unitRoot,n.configModel=i,n.visible=!0,battleMain.battleFlag&r.OPEN_GRAPHIC&&n.loadSync(),n.scale=g.round(i.scale/100),a(n._animator)&&n._animator.setColor(E.r,E.g,E.b),n},e.free=function(t){t.free()};var s=e.prototype;return s.onLoadComplete=function(){var t=this._node;this._model=c.findChild(t,"model");var i=this._model.getComponent(p);null==i&&(i=c.findChildComponent(this._model,"spine",p)),this._animator=i,i.setColor(E.r,E.g,E.b),this.configModel.mountPos>0&&(this._bottom=c.findChild(t,"bottom"),this._top=c.findChild(t,"top")),i.__preload()},s.loadMount=function(){var t,i;if(null==(t=this._mountTop)||t.free(),null==(i=this._mountBottom)||i.free(),this._mountTop=null,this._mountBottom=null,this._mount>0){var n=this.configModel,o=configMount.getDataByKey(this._mount);if(!o)return;var e=1/(this._scale/.66);1!=o.type&&3!=o.type||(this._mountTop=S.alloc(this._mount,this._top,this._model,n.mountPos),this._mountTop.scale=e,this._mountTop.aniName="idle_1"),2!=o.type&&3!=o.type||(this._mountBottom=S.alloc(this._mount,this._bottom,null==this._mountTop?this._model:null,n.mountPos),this._mountBottom.scale=e,this._mountBottom.aniName="idle_2")}else{var s;null==(s=this._model)||s.setPosition(0,0,0)}},s.mountAni=function(t){if(void 0===t&&(t=!1),0!=this._mount){if(t)return null!=this._mountTop&&(this._mountTop.aniName="run_1"),void(null!=this._mountBottom&&(this._mountBottom.aniName="run_2"));null!=this._mountTop&&(this._mountTop.aniName="idle_1"),null!=this._mountBottom&&(this._mountBottom.aniName="idle_2")}},s.shenAni=function(t){void 0===t&&(t=!1),this._slotEquip&&this._slotEquip.shenqiAsset&&(this._slotEquip.shenqiAsset.aniName=t?"bigskill":"wuqi")},s.onUpdate=function(i){if(t.prototype.onUpdate.call(this,i),!(this.poolState>d.Useing)){var o=battleMain.unitMgr.getUnit(this._unitId);if(null!=o){var e=this._animator;if(a(e)&&e._skeleton){if(o.data.skinChange){var s;if(o.data.skinChange=!1,k.hide_bowl_cut.includes(o.data.modelConfig.id))try{o.data.skin.ornaments<=0?e.setSkin(o.data.skin.color+""):(e._skeleton.setSkin(null),e._skeleton.setSlotsToSetupPose(),e.invalidAnimationCache())}catch(t){}else try{if(null!=this.configModel.skin&&""!=this.configModel.skin){var r=null;u||(r=new l.spine.Skin("all")),r.addSkin(e._skeleton.data.findSkin(o.data.skin.color+"")),r.addSkin(e._skeleton.data.findSkin(this.configModel.skin)),e._skeleton.setSkin(r),e._skeleton.setSlotsToSetupPose(),e.invalidAnimationCache()}else e.setSkin(o.data.skin.color+"")}catch(t){printLogErr("缺少皮肤！！！",this.url)}var f=this.configModel,c=null!=(s=this._slotEquip)?s:this.node.getComponent(m);if(c.init(e,f.mountPos,!1),c.loadEquip([o.data.skin.weapon,o.data.skin.ornaments,o.data.skin.face,o.data.skin.wing]),this._slotEquip=c,o.data.skin.fate>0){var p=configFate.getDataByKey(o.data.skin.fate);if(null==this._fateEffect||p.effect!=this._fateEffect.config.id){this._fateEffect&&this._fateEffect.free(),this._fateEffect=null;var g=v.alloc(p.effect);g.position=this._pos,p.quality<=4&&(g.aniName=y[p.quality]),this._fateEffect=g}}}if(this._changeSkins)if(this._changeSkins=!1,this._skins.length>1){var S=null;S=new l.spine.Skin("all");for(var A,E=n(this._skins);!(A=E()).done;){var M=A.value;S.addSkin(e._skeleton.data.findSkin(M))}e._skeleton.setSkin(S),e._skeleton.setSlotsToSetupPose(),e.invalidAnimationCache()}else e.setSkin(this._skins[0]);if(o.animatorctr.changeData){o.animatorctr.changeData=!1;var C=o.animatorctr.aniName;e.timeScale=o.animatorctr.timeScale;var b=_.isEmpty(o.animatorctr.aniAddName)?C:C+"_"+o.animatorctr.aniAddName;if(null==e.findAnimation(b))return e.setAnimation(0,_.isEmpty(o.animatorctr.aniAddName)?"idle":"idle_"+o.animatorctr.aniAddName,!0),this.mountAni(!1),void this.shenAni(!1);if(o.animatorctr.aniReset||e.animation!==b){var N=this._mount>0&&"run"==C?"idle":C,q=_.isEmpty(o.animatorctr.aniAddName)?N:N+"_"+o.animatorctr.aniAddName,B=h[N],T=!1;null!=B&&(T=B.loop),this.mountAni("run"==C),this.shenAni(C.includes("skill")),o.animatorctr.aniReset,e.setAnimation(0,q,T)}}}}}},s.onApply=function(t){this._changeValue&A.Depth&&this._node.getSiblingIndex()!=this._depth&&this._node.setSiblingIndex(this._depth||0),this._changeValue&A.SetMount&&this.loadMount(),this._fateEffect&&(this._fateEffect.position=this._pos)},s.flash=function(){var t=this._animator;a(t)&&t.flash()},s.cacheReset=function(){var i;(t.prototype.cacheReset.call(this),this._mount=0,this._depth=-1,this._fateEffect&&this._fateEffect.free(),this._fateEffect=null,a(this.node))&&(this.loadMount(),null==(i=this._slotEquip)||i.unload())},o(e,[{key:"modelPath",get:function(){return this.url}},{key:"direction",get:function(){return this._dir},set:function(t){this.dir=t}},{key:"depth",get:function(){return this._depth},set:function(t){var i=this._depth;a(this._node)&&(i=this._node.getSiblingIndex()),i!=t&&(this._depth=t,this._changeValue=this._changeValue|A.Depth)}},{key:"mount",get:function(){return this._mount},set:function(t){this._mount!=t&&(this._mount=t,this._changeValue=this._changeValue|A.SetMount)}},{key:"skins",set:function(t){var i=this;if(this._skins!=t){if(this._skins&&t&&this._skins.length==t.length&&t.filter((function(t){return!i._skins.includes(t)})))return;this._skins=t,this._changeSkins=!0}}}]),e}(f));e._RF.pop()}}}));

