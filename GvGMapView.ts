System.register("chunks:///_virtual/GvGMapView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./RedPointMgr.ts","./NodeUtil.ts","./StringUtil.ts","./TimeUtil.ts","./BaseView.ts","./SpineSkeleton.ts","./ChatDataCache.ts","./ChatDefine.ts","./MessageView.ts","./GuildDataCache.ts","./GuildDefine.ts","./RoleControl.ts","./RoleDataCache.ts","./RoleDefine.ts","./GvGDataCache.ts","./GvGDefine.ts","./GvGModel.ts"],(function(t){"use strict";var e,n,i,o,a,s,d,h,m,u,p,r,f,c,l,g,C,v,S,I,y,R,G,E,M,x,T,b,_,N,w,D,L,k;return{setters:[function(t){e=t.inheritsLoose},function(t){n=t.cclegacy,i=t.Button,o=t.Vec2,a=t.UITransform,s=t.Label,d=t.NodeEventType,h=t.Sprite,m=t.ProgressBar,u=t.Vec3,p=t.js},function(t){r=t.RedPointMgr},function(t){f=t.default},function(t){c=t.default},function(t){l=t.default},function(t){g=t.BaseView},function(t){C=t.SpineSkeleton},function(t){v=t.ChatDataCache},function(t){S=t.ChatEventDefine,I=t.ChatDefine},function(t){y=t.default},function(t){R=t.default},function(t){G=t.GuildEventDefine,E=t.PermissionType},function(t){M=t.default},function(t){x=t.RoleDataCache},function(t){T=t.RoleEventDefine,b=t.RoleRedPointSystemEnum,_=t.PlayerAttr},function(t){N=t.GvGDataCache},function(t){w=t.GvGPresetId,D=t.GvGEventDefine,L=t.GvGStep},function(t){k=t.GvGModel}],execute:function(){var V;n._RF.push({},"47b53HcY2tI8Knyk6WvwT3Y","GvGMapView",void 0);var P=((V={})[1]="Top",V[2]="Middle",V[3]="Bottom",V);t("default",function(t){function n(){var e;return(e=t.call(this)||this).txtName=void 0,e.content=void 0,e.face=void 0,e.faceOriScale=void 0,e.pbTime=void 0,e.txtStatus=void 0,e.txtTime=void 0,e.txtNameMine=void 0,e.txtNameEnemy=void 0,e.btnReport=void 0,e.spineHomeDefeatMine=void 0,e.spineHomeDefeatEnemy=void 0,e.time=0,e.roadIdToItem={},e.roadToPlayEffect={},e.nodeMap=void 0,e.nodeServerMine=void 0,e.nodeServerEnemy=void 0,e.txtServerMine=void 0,e.txtServerEnemy=void 0,e.btnSeason=void 0,e.btnRanking=void 0,e.btnUp=void 0,e.txtSeason=void 0,e.imgRanking=void 0,e.txtRanking=void 0,e.nodeNoticeNew=void 0,e.nodeNoticeRed=void 0,e.name="GvGMapView",e.url="ui/module/gvg/GvGMapView",e}e(n,t);var g=n.prototype;return g.onInit=function(){var t=this,e=this.findChild("tab/btnClose");this.addComponentCallbackListener(e,i.EventType.CLICK,(function(){uiMgr.close("ChatView"),t.close()}));var n=this.findChild("tab/btnReward");this.addComponentCallbackListener(n,i.EventType.CLICK,(function(){uiMgr.openView("GvGRankRewardView")}));var u=this.findChild("tab/btnRank");this.addComponentCallbackListener(u,i.EventType.CLICK,(function(){uiMgr.openView("GvGRankView")}));var p=this.findChild("tab/btnExchange");IS(r).addRedPoint("gvg_map/btnExchange",p,new o(25,20)),this.addComponentCallbackListener(p,i.EventType.CLICK,(function(){uiMgr.openView("GvGStoreView")}));var c=this.findChild("tab/btnGuild");this.addComponentCallbackListener(c,i.EventType.CLICK,(function(){uiMgr.openView("GvGGuideView")})),this.btnReport=this.findChild("tab/btnReport"),IS(r).addRedPoint("gvg_map/btnReport",this.btnReport,new o(25,20)),this.addComponentCallbackListener(this.btnReport,i.EventType.CLICK,(function(){uiMgr.openView("GvGReportView")}));var g=this.findChild("btnChatRoot");this.addComponentCallbackListener(g,i.EventType.CLICK,(function(){uiMgr.openView("ChatView",2)}));var v=f.findChild(g,"name/messageContent"),S=f.findChildComponent(g,"name",a);this.txtName=f.findChildComponent(g,"name",s),this.txtName.node.on(d.SIZE_CHANGED,(function(){v.setPosition(S.width+7,-1.389)})),this.content=f.findChildComponent(g,"name/messageContent/content",s),this.face=f.findChildComponent(g,"name/messageContent/face",h),this.faceOriScale=this.face.node.scale,this.pbTime=this.findChildComponent("time/pbTime",m),this.txtTime=this.findChildComponent("time/Node/txtTime",s),this.txtStatus=this.findChildComponent("time/Node/txtState",s),this.txtNameMine=this.findChildComponent("mapInfo/homeMine/txtName",s),this.txtNameEnemy=this.findChildComponent("mapInfo/homeEnemy/txtName",s),this.nodeServerMine=this.findChild("mapInfo/homeMine/server"),this.nodeServerEnemy=this.findChild("mapInfo/homeEnemy/server"),this.txtServerMine=this.findChildComponent("mapInfo/homeMine/server/txtServer",s),this.txtServerEnemy=this.findChildComponent("mapInfo/homeEnemy/server/txtServer",s),this.spineHomeDefeatMine=this.findChildComponent("mapInfo/homeMine/MX_tx_baozha",C),this.spineHomeDefeatEnemy=this.findChildComponent("mapInfo/homeEnemy/MX_tx_baozha",C);var I=this.findChild("time/btnTip");this.addComponentCallbackListener(I,i.EventType.CLICK,(function(){uiMgr.openView("GvGRuleTips",[GetLanguage(201643),GetLanguage(2016431),GetLanguage(2016432)])})),this.nodeMap=this.findChild("mapInfo");var y=this.findChild("topButtons/btnPlan");this.addComponentCallbackListener(y,i.EventType.CLICK,(function(){var e=IS(N).endTime;e<=0?t.showLockTips():e-l.serverTime<=0?t.showLockTips():uiMgr.openView("GvGPlanView")}));var R=this.findChild("topButtons/btnNotice");this.addComponentCallbackListener(R,i.EventType.CLICK,(function(){uiMgr.openView("GvGNoticeView")})),this.nodeNoticeNew=this.findChild("topButtons/btnNotice/new"),this.nodeNoticeRed=this.findChild("topButtons/btnNotice/red"),this.btnSeason=this.findChild("topButtons/right/btnSeason"),this.addComponentCallbackListener(this.btnSeason,i.EventType.CLICK,(function(){uiMgr.openView("GvGSeasonMainView")})),this.txtSeason=this.findChildComponent("topButtons/right/btnSeason/txtDesc",s),this.btnRanking=this.findChild("topButtons/right/btnRanking"),this.addComponentCallbackListener(this.btnRanking,i.EventType.CLICK,(function(){uiMgr.openView("GvGGroupView")})),this.imgRanking=this.findChildComponent("topButtons/right/btnRanking/icon",h),this.txtRanking=this.findChildComponent("topButtons/right/btnRanking/txtDesc",s),this.btnUp=this.findChild("topButtons/right/btnUp"),this.addComponentCallbackListener(this.btnUp,i.EventType.CLICK,(function(){IS(N).setMapBtnFold(IS(N).checkMapBtnFold()?0:1),t.updateBtnStatus()})),this.initRoads()},g.showLockTips=function(){var t=IS(x).presetList[w],e=IS(x).getPlanName(t);y.showBoxTip({tip:c.formatStrWithMirrorDeal(GetLanguage(201661),e),btnCnt:1})},g.initRoads=function(){for(var t=this,e=function(e){var n=e,o=P[n],a=t.findChild(p.formatStr("mapInfo/road%sMine",o)),d=t.findChild(p.formatStr("mapInfo/road%sEnemy",o)),m=t.findChild(p.formatStr("mapInfo/roadBattle%s",o));t.roadIdToItem[n]={nodeMine:a,nodeEnemy:d,nodeBattle:m,nodeNumMine:f.findChild(a,"num"),txtNumMine:f.findChildComponent(a,"num/txtNum",s),nodeFlag:f.findChild(a,"imgFlag"),nodeNumEnemy:f.findChild(d,"num"),txtNumEnemy:f.findChildComponent(d,"num/txtNum",s),nodeFighting:f.findChild(m,"fighting"),txtFightingNumMine:f.findChildComponent(m,"fighting/num/txtNumMine",s),txtFightingNumEnemy:f.findChildComponent(m,"fighting/num/txtNumEnemy",s),nodeResult:f.findChild(m,"result"),imgResult:f.findChildComponent(m,"result/imgResult",h),nodeRemind:f.findChild(a,"num/RedPoint"),spineTxDefeatMine:f.findChildComponent(a,"MX_tx_baozha",C),spineTxDefeatEnemy:f.findChildComponent(d,"MX_tx_baozha",C)},t.addComponentCallbackListener(a,i.EventType.CLICK,(function(){t.onMineClick(n)})),t.addComponentCallbackListener(d,i.EventType.CLICK,(function(){t.onEnemyClick(n)})),t.addComponentCallbackListener(m,i.EventType.CLICK,(function(){t.onBattleClick(n)}))},n=1;n<=3;n++)e(n)},g.registerUpdateHandler=function(){this.addEvent(D.GVG_INFO_UPDATE,this.onGvGInfoUpdate,this),this.addEvent(S.InsertNewMsg,this.updateMessage,this),this.addEvent(S.UpdateChatMsg,this.updateMessage,this),this.addEvent(T.ROLE_INFO_UPDATE,this.updateRoleInfo,this),this.addEvent(D.GVG_ROAD_INFO_UPDATE,this.onGvGRoadInfoUpdate,this),this.addEvent(T.ROLE_RED_POINT_LIST_UPDATE,this.onRoleRedPointListUpdate,this),this.addEvent(T.ROLE_RED_DETAIL_UPDATE,this.onRoleRedDetailUpdate,this),this.addEvent(D.GVG_ROAD_PLAY_EFFECT,this.onGvGRoadPlayEffect,this),this.addEvent(G.GUILD_INFO_UPDATE,this.updateNoticeRed,this)},g.onAfterOpen=function(){this.updateTime(),this.updateStatus(),this.showName(),this.showServer(),this.updateHomeStatus(),this.updateRoads(),this.updateRedPoint(),this.updateRankingShow(),this.updateBtnStatus(),this.updateSeasonShow(),this.updateNoticeRed(),IS(N).checkHasOpenGuild()||(uiMgr.openView("GvGGuideView"),IS(N).setOpenGuild()),IS(M).send_role_default_plan_info_c2s()},g.updateRankingShow=function(){var t=IS(N).curRanking;if(t<=0)this.loadIcon(this.imgRanking,"icon_gvg","gvg_icon_qingtong"),this.txtRanking.string=GetLanguage(201570);else{var e=configFamiliybrawl_rank.getDataByKey(t);this.loadIcon(this.imgRanking,"icon_gvg",e.rank_picture),this.txtRanking.string=e.rank_name}},g.updateBtnStatus=function(){var t=IS(N).checkMapBtnFold();this.btnUp.eulerAngles=new u(0,0,t?180:0),this.btnRanking.active=!t},g.updateSeasonShow=function(){this.btnSeason.active=0!=IS(N).curSeason,0!=IS(N).curSeason&&(this.txtSeason.string=c.formatStrWithMirrorDeal(GetLanguage(201559),IS(N).curSeason))},g.updateNoticeRed=function(){this.nodeNoticeRed.active=(null==IS(R).GetGuildInfo().gvg_notice||""==IS(R).GetGuildInfo().gvg_notice)&&IS(R).CheckPermissioByType(E.GVGNotice)},g.updateRedPoint=function(){IS(r).changeValue("gvg_map/btnExchange",IS(x).getRedNumByModule(b.System_Guild,5)),IS(r).changeValue("gvg_map/btnReport",IS(x).getRedNumByModule(b.System_Guild,2)+IS(x).getRedNumByModule(b.System_Guild,3)+IS(x).getRedNumByModule(b.System_Guild,4)),this.nodeNoticeNew.active=IS(x).getRedNumByModule(b.System_Guild,6)>0},g.showName=function(){this.txtNameEnemy.string=IS(N).enemyName;var t=IS(R).GetGuildInfo();this.txtNameMine.string=t.name},g.showServer=function(){this.nodeServerMine.active=1==IS(N).ifCross,this.nodeServerEnemy.active=1==IS(N).ifCross,1==IS(N).ifCross&&(this.txtServerMine.string=p.formatStr("[s%s]",IS(x).GetServerId()),this.txtServerEnemy.string=p.formatStr("[s%s]",IS(N).enemyServerId))},g.updateHomeStatus=function(t){if(!IS(N).waitPlayHomeBreak)return IS(N).step<L.Fighting?(this.spineHomeDefeatMine.setAnimation(0,"empty",!1),void this.spineHomeDefeatEnemy.setAnimation(0,"empty",!1)):void(t?(0==IS(N).status?(this.spineHomeDefeatMine.setAnimation(0,"qizhi_chuxian",!1),this.spineHomeDefeatMine.addAnimation(0,"qizhi_chixu",!0)):this.spineHomeDefeatMine.setAnimation(0,"empty",!1),1==IS(N).status?(this.spineHomeDefeatEnemy.setAnimation(0,"qizhi_chuxian",!1),this.spineHomeDefeatEnemy.addAnimation(0,"qizhi_chixu",!0)):this.spineHomeDefeatEnemy.setAnimation(0,"empty",!1)):(0==IS(N).status?this.spineHomeDefeatMine.setAnimation(0,"qizhi_chixu",!0):this.spineHomeDefeatMine.setAnimation(0,"empty",!1),1==IS(N).status?this.spineHomeDefeatEnemy.setAnimation(0,"qizhi_chixu",!0):this.spineHomeDefeatEnemy.setAnimation(0,"empty",!1)))},g.onUpdate=function(t){this.time=this.time+t,this.time>=1&&(this.updateTime(),this.time=0)},g.updateTime=function(){var t=IS(k).getCurTimeInfo(),e=t?t.end_time:0,n=l.serverTime,i=t?t.start_time:0;this.pbTime.progress=Math.min(1,Math.max(0,(n-i)/(e-i))),this.txtTime.string=l.formatTimeForSecond(Math.max(0,e-n))},g.updateStatus=function(){var t="";switch(IS(N).step){case L.Ready:t=GetLanguage(200391);break;case L.Adjust:t=GetLanguage(200392);break;case L.Waiting:t=GetLanguage(201598);break;case L.Fighting:t=GetLanguage(200393);break;case L.Showing:t=GetLanguage(200394)}this.btnReport.active=IS(N).step>=L.Fighting,this.txtStatus.string=t},g.updateRoads=function(){for(var t in this.roadIdToItem)this.updateSingleRoad(Number(t))},g.updateAllRoadRedPoint=function(){for(var t in this.roadIdToItem)this.updateRoadRedPoint(Number(t))},g.updateRoadRedPoint=function(t){this.roadIdToItem[t].nodeRemind.active=IS(N).getSelectRoadRedPoint()+IS(x).getRedNumByModule(b.System_Guild,1)>0},g.updateSingleRoad=function(t,e){if(!this.roadToPlayEffect[t]){var n=this.roadIdToItem[t],i=IS(k).getRoadInfo(t);if(n.nodeBattle.active=IS(N).step>=L.Fighting,n.nodeFlag.active=t==IS(N).myRoad,null!=i){n.txtNumMine.string=i.num,n.txtNumEnemy.string=i.enemy_num,n.txtFightingNumMine.string=i.num,n.txtFightingNumEnemy.string=i.enemy_num,this.updateRoadRedPoint(t);var o=i.status;IS(N).step<L.Fighting?(n.spineTxDefeatMine.setAnimation(0,"empty",!1),n.spineTxDefeatEnemy.setAnimation(0,"empty",!1)):e?(0==o?(n.spineTxDefeatMine.setAnimation(0,"qizhi_chuxian",!1),n.spineTxDefeatMine.addAnimation(0,"qizhi_chixu",!0)):n.spineTxDefeatMine.setAnimation(0,"empty",!1),1==o?(n.spineTxDefeatEnemy.setAnimation(0,"qizhi_chuxian",!1),n.spineTxDefeatEnemy.addAnimation(0,"qizhi_chixu",!0)):n.spineTxDefeatEnemy.setAnimation(0,"empty",!1)):(0==o?n.spineTxDefeatMine.setAnimation(0,"qizhi_chixu",!0):n.spineTxDefeatMine.setAnimation(0,"empty",!1),1==o?n.spineTxDefeatEnemy.setAnimation(0,"qizhi_chixu",!0):n.spineTxDefeatEnemy.setAnimation(0,"empty",!1)),IS(N).step>=L.Fighting?(n.nodeFighting.active=2==o,n.nodeResult.active=2!=o,n.txtNumMine.string=GetLanguage(200395),n.txtNumEnemy.string=GetLanguage(200395),n.nodeNumMine.active=0==o,n.nodeNumEnemy.active=1==o,2!=o&&this.loadIcon(n.imgResult,"gvg_map",0==o?"gvg_img_map_lose":"gvg_img_map_win")):(n.nodeNumMine.active=!0,n.nodeNumEnemy.active=!0)}}},g.onBeforeClose=function(){this.time=0,this.roadToPlayEffect={}},g.onDestroy=function(){},g.updateMessage=function(t){if(void 0===t&&(t=null),!t||t.channel==I.Channel.Guild){var e=IS(v).GetChatInfo(I.Channel.Guild,0);if(e&&e.length>0){var n=e[e.length-1];if(this.txtName.string=n.name+"：",n.type==I.ChatContentType.Conetnt||n.type==I.ChatContentType.Share||n.type==I.ChatContentType.Pic||n.type==I.ChatContentType.Voice){var i=n.content;this.face.node.active=!1,n.type==I.ChatContentType.Pic?this.content.string=GetLanguage(200179):n.type==I.ChatContentType.Voice?this.content.string=GetLanguage(999000624):this.content.string=i}else if(n.type==I.ChatContentType.Face){this.face.node.active=!0,this.content.string="";var o=IS(v).GetFaceIconByContent(n.content),a=o[0],s=o[1],d=this.faceOriScale.y*s.scale;this.face.node.scale=new u(d,d,d),this.loadIcon(this.face,"icon_chat",a)}this.txtName.node.active=!0}else this.txtName.string="",this.content.string=""}},g.onGvGInfoUpdate=function(){IS(N).step<L.Ready?this.close():(this.updateHomeStatus(),this.updateStatus(),this.updateRoads())},g.updateRoleInfo=function(t){t[_.ROLE_ATTR_GUILD_ID]&&(IS(x).HasGuild()||this.close())},g.onGvGRoadInfoUpdate=function(t){this.updateSingleRoad(t),this.updateAllRoadRedPoint()},g.onRoleRedPointListUpdate=function(){this.updateRoads(),this.updateRedPoint()},g.onRoleRedDetailUpdate=function(t){t==b.System_Guild&&(this.updateRoads(),this.updateRedPoint())},g.onGvGRoadPlayEffect=function(t,e){var n=this;this.roadToPlayEffect[t]=!0;var i="";switch(t){case 1:i=0==e?"a2":"b2";break;case 2:i=0==e?"a3":"b3";break;case 3:i=0==e?"a1":"b1"}this.addUIEffect("prefab/ui-effect/MX_tx_polu",this.nodeMap,1,new o(0,50),1,(function(t){t.node.getComponent(C).needAnimation=i})),this.addTimer(1,1,(function(){n.roadToPlayEffect[t]=!1,n.updateSingleRoad(t,!0),IS(N).waitPlayHomeBreak=!1,n.updateHomeStatus(!0)}))},g.onMineClick=function(t){IS(N).step<=L.Waiting&&uiMgr.openView("GvGRoadInfoView",t)},g.onEnemyClick=function(t){IS(N).step!=L.Ready?IS(N).step!=L.Adjust&&IS(N).step!=L.Waiting||uiMgr.openView("GvGRoadEnemyView",t):y.showFlyTip(GetLanguage(200396))},g.onBattleClick=function(t){var e=IS(k).getRoadInfo(t);e&&(2==e.status?uiMgr.openView("GvGFightInfoView",t):uiMgr.openView("GvGReportView",t))},n}(g));n._RF.pop()}}}));

