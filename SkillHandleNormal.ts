System.register("chunks:///_virtual/SkillHandleNormal.ts",["./rollupPluginModLoBabelHelpers.js","cc","./FixMath.ts","./BuffCtr.ts","./MetaAttrib.ts","./EnumDefine.ts","./EventDefine.ts","./HurtUtil.ts","./V2.ts","./SkillCommonEffectUtil.ts","./SkillHandleBase.ts"],(function(t){"use strict";var e,a,r,i,n,l,s,c,o,u,f,g,T,d,p,h,y,v,A,_,m,k,B,b,C,E,H,N,D,L;return{setters:[function(t){e=t.inheritsLoose,a=t.createForOfIteratorHelperLoose},function(t){r=t.cclegacy},function(t){i=t.FixMath},function(t){n=t.freeBuffList},function(t){l=t.AttribDefine},function(t){s=t.BattleFlag,c=t.SpBuffState,o=t.BuffGroupType,u=t.StateTrigerType,f=t.AttackType,g=t.HealthType,T=t.UnityType,d=t.EffectTriggerType,p=t.TargetFilter,h=t.TargetSelectFilter},function(t){y=t.EventDefine},function(t){v=t.checkCounterAct,A=t.checkHit,_=t.normalDoubleHurt,m=t.normalHurt,k=t.normailHpsteal,B=t.checkNormailHpsteal1,b=t.normailHpsteal1,C=t.checkThrowHit,E=t.checkDizz,H=t.checkDoubleAct},function(t){N=t.V2},function(t){D=t.SkillCommonEffectUtil},function(t){L=t.SkillHandleBase}],execute:function(){r._RF.push({},"59ef4AdJkNMO5oUXhRjhLOO","SkillHandleNormal",void 0);new N,t("SkillHandleNormal",function(t){function r(){return t.apply(this,arguments)||this}e(r,t);var L=r.prototype;return L.beginRun=function(){var t=this,e=this.runner,a="skill1";null!=e.configWeapon&&(a=e.configWeapon.ani);var r=e.getActSpeed(a);e.changeModeAction(!0,a,r),e.nextTriggerAction((function(a){t.triggerAction(e,a,-1)})),e.cast.shamUnit||e.battleMain.battleFlag&s.NOT_HURT||null!=e.configWeapon&&e.playSound(e.configWeapon.soundid)},L.checkCounter=function(t,e){1!=e.data.unitType.target&&null!=t.data.counterAttack&&v(t,e)&&t.addCounter(e)},L.att=function(t,e){var r=this.runner;if(!r.cast.isDestroy&&null!=t&&!t.isDestroy){if(-1==e&&(this.checkCounter(t,r.cast),r.cast.data.getBuffState(c.StateTriger)>0)){for(var s,p=r.cast.buffCtr.getBuffByType(o.STATE_TRIGER),h=a(p);!(s=h()).done;){s.value.onStateTrigger(u.Normal_Act)}n(p)}var v=A(r.cast,t);if(v!=f.Miss){var H=107;if(null!=r.configWeapon&&(H=r.configWeapon.soundid_hit||H),r.playSound(H),e>0){var N=_(r.cast,t,v),D=v==f.Normal?g.Hurt_Double:g.Hurt_Double_Crit,L=this.runner.cast.data.getAttrib(l.boss_dam);t.config.type==T.Boss&&L>0&&(N=i.roundInt(N*i.round(1+L)));var R=r.cast.buffCtr.getBuffByType(o.DOUBLE_TRIGGER);if(R.length>0)for(var S,U=a(R);!(S=U()).done;){S.value.onStateTrigger(u.Double_Act,t)}n(R);for(var M,O=t.buffCtr.getBuffByType(o.FRAGILE_EFFECT),F=a(O);!(M=F()).done;){N+=M.value.calDamage(N,r.cast)}n(O),r.healthTarget(t,N,D,!0);for(var I,K=r.cast.skillctr.skillEffects,W=a(K);!(I=W()).done;){var G=I.value;G.triggerType!=d.DOUBLE_ATTACK&&G.triggerType!=d.NORMAL_DOUBLE_ATTACK&&G.triggerType!=d.ALL_ATTACK||r.cast.skillctr.checkTriggerCount(G.triggerType,G.limit)&&(0==G.useType?this.addTask(G.id,t.position,G.runner):1==G.useType&&r.cast.skillctr.addSkill(G.id))}}else{r.cast.normalActCount++,r.cast.config.type==T.Partner&&r.battleMain.emit(y.UnitHit,r.cast);for(var x,w=m(r.cast,t,v),Z=v==f.Normal?g.Hurt:g.Hurt_Crit,P=r.cast.buffCtr.getBuffByType(o.NORMAL_ACT_NUM_TRIGGER),V=a(P);!(x=V()).done;){w+=x.value.calValue(r.cast.normalActCount)}if(n(P),r.cast.isCallType&&r.cast.parent){for(var j,z=r.cast.parent.buffCtr.getBuffByType(o.UnitCallDamageAdd),J=a(z);!(j=J()).done;){w+=j.value.calDamage(w,t)}n(z)}var X=r.cast.data.getAttrib(l.boss_dam);t.config.type==T.Boss&&X>0&&(w=i.roundInt(w*i.round(1+X)));for(var Y,q=t.buffCtr.getBuffByType(o.FRAGILE_EFFECT),Q=a(q);!(Y=Q()).done;){w+=Y.value.calDamage(w,r.cast)}n(q),r.healthTarget(t,w,Z,!0);var $=k(r.cast,t,w);if($>0&&r.healthTarget(r.cast,$,g.Act_Hpsteal),B(this.runner.cast,t)){var tt=b(r.cast);tt>0&&r.healthTarget(r.cast,tt,g.Act_Hpsteal)}var et=configUnitType.getDataByKey(r.cast.config.type);if(C(r.cast,t)&&r.throwHit(t,et.suspend_time[0],et.suspend_time[1],0),E(r.cast,t)){var at=r.cast.data.getAttrib(l.vertigo_times)*i.round(1-t.data.getAttrib(l.vertigo_res));if((at=i.round(at))>0){r.addBuff(t,et.vertigo_time,at);for(var rt,it=r.cast.skillctr.skillEffects,nt=a(it);!(rt=nt()).done;){var lt=rt.value;lt.triggerType==d.DIZZ&&(r.cast.skillctr.checkTriggerCount(lt.triggerType,lt.limit)&&(0==lt.useType?this.addTask(lt.id,t.position,lt.runner,t):1==lt.useType&&r.cast.skillctr.addSkill(lt.id)))}}}for(var st,ct=r.cast.skillctr.skillEffects,ot=a(ct);!(st=ot()).done;){var ut=st.value;ut.triggerType!=d.NORMAL_ATTACK&&ut.triggerType!=d.NORMAL_DOUBLE_ATTACK&&ut.triggerType!=d.ALL_ATTACK||r.cast.skillctr.checkTriggerCount(ut.triggerType,ut.limit)&&(0==ut.useType?this.addTask(ut.id,t.position,ut.runner,t):1==ut.useType&&r.cast.skillctr.addSkill(ut.id))}if(r.cast.buffCtr.removeBuff(o.DESTROY_WHEN_NORMAL_AFTER),v==f.Cirt)for(var ft,gt=a(ct);!(ft=gt()).done;){var Tt=ft.value;if(Tt.triggerType==d.CRIT_ATTACK&&r.cast.skillctr.checkTriggerCount(Tt.triggerType,Tt.limit)){var dt=1==configSkilleffcet.getDataByKey(Tt.id).targetType[1]?r.cast:t;0==Tt.useType?this.addTask(Tt.id,dt.position,Tt.runner,dt):1==Tt.useType&&r.cast.skillctr.addSkill(Tt.id)}}}}else r.healthTarget(t,0,g.Miss,!0)}},L._addBullet=function(t,e,r,i){var n=t.cast.data.getAttribByInt(l.target_num);if(n>1){for(var s,c=t.getTargets(p.Enemy,0,t.cast.position,n,h.NearTarget),o=a(c);!(s=o()).done;){var u=s.value;t.addBullet1(u,e,r).param.push("normal",i)}return c[0]}var f=D.getLockTarget(t,!0);return D.addBullet(t,f,e,r,"normal",i),f},L._bulletNum=function(t,e,a,r,i){var l=this,s=null;if((s=a>0?t.cast.buffCtr.getBuffByType(o.BULLET_NUM):t.cast.buffCtr.getBuffByType(o.NORMAL_BULLET_NUM))&&s.length>0){var c=s[0].config.param1,u=s[0].config.param2;this.addTimer(u,c-1,(function(){r>0?l._addBullet(t,e,r,a):i&&l.att(i,a)}))}n(s)},L.triggerAction=function(t,e,r){var n=t.cast.config.bullet;null!=t.configWeapon&&(n=t.configWeapon.bullet),t.cast.hurtNumCount++;var c=null;if(0==n){if(t.cast.shamUnit)return;if(t.battleMain.battleFlag&s.NOT_HURT)return;var o=t.cast.data.getAttribByInt(l.target_num);if(o>1){for(var u,f=t.getTargets(p.Enemy,0,t.cast.position,o,h.NearTarget),T=a(f);!(u=T()).done;){var d=u.value;this.att(d,r)}c=f[0]}else(c=D.getLockTarget(t))&&this.att(c,r);this._bulletNum(t,N.ZERO,r,n,c),D.checkTriggerBullet(this,t,c,N.ZERO,n)}else{var y=t.cast.getBindPosByAction(e);if(t.cast.shamUnit||t.battleMain.battleFlag&s.NOT_HURT)return void this._addBullet(t,y,n,r);var v=new N(y);r>0&&(v.x=i.round(y.x+i.round(-30*t.cast.direction)),v.y=i.round(y.y+20)),this._bulletNum(t,v,r,n,c),c=this._addBullet(t,v,n,r),D.checkTriggerBullet(this,t,c,v,n)}!c||c.isDead||-1!=r||t.cast.shamUnit||H(t.cast,c)&&(t.healthTarget(t.cast,0,g.Double_Act),this.triggerAction(t,e,1))},L.onBulletAction=function(t,e,a,r){if(null!=e&&!e.isDestroy){var i=this.runner;i.cast.shamUnit||i.battleMain.battleFlag&s.NOT_HURT||("trigger_bullet"!==r[0]?"normal"===r[0]&&this.att(e,r[1]):D.bulletHurt(i,e,r[1]))}},r}(L));r._RF.pop()}}}));

