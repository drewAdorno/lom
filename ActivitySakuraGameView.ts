System.register("chunks:///_virtual/ActivitySakuraGameView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./AudioMgr.ts","./UIList.ts","./NodeUtil.ts","./StringUtil.ts","./index57.ts","./SpineSkeleton.ts","./ActivitySakuraControl.ts","./ActivitySakuraDataCache.ts","./ActivitySakuraDefine.ts","./BaseView.ts"],(function(t){"use strict";var e,i,o,s,r,n,u,a,h,l,d,c,p,f,g,v,m,b,L,C,T;return{setters:[function(t){e=t.inheritsLoose,i=t.createForOfIteratorHelperLoose},function(t){o=t.cclegacy,s=t.Button,r=t.Label,n=t.ScrollView,u=t.tween,a=t.Sprite,h=t.v2,l=t.ProgressBar},function(t){d=t.audioMgr},function(t){c=t.SelectedType,p=t.ListItem},function(t){f=t.default},function(t){g=t.default},null,function(t){v=t.SpineSkeleton},function(t){m=t.default},function(t){b=t.default,L=t.Route},function(t){C=t.ActivitySakuraEvent},function(t){T=t.BaseView}],execute:function(){var I,S,R,y;o._RF.push({},"a4071ZdJ9xMxZdqccxx49Ui","ActivitySakuraGameView",void 0);var _=0,E=1,k=2,F=3,w=((I={})[_]=k,I[E]=F,I[k]=_,I[F]=E,I),U=((S={})[1]="fhj_ui_dc02",S[2]="fhj_ui_dc01",S[3]="fhj_ui_dp03",S[4]="fhj_ui_dp01",S[5]="fhj_ui_dp02",S),A=((R={})[1]="sdhd_ui_lianjiehui",R[2]="sdhd_ui_lianjiehui02",R[3]="sdhd_ui_lianjiehui03",R[4]="sdhd_ui_lianjiehui04",R),B=((y={})[1]={x:25,y:0},y[2]={x:0,y:0},y[3]={x:15.4,y:15.4},y[4]={x:0,y:-15.4},y),G=(t("default",function(t){function o(){var e;return(e=t.call(this)||this).sourceInited=void 0,e.scroll=void 0,e.gridList=void 0,e.spinNode=void 0,e.floatingQuene=[],e.gameSpin=void 0,e.gameFloat=void 0,e.gameComplete=void 0,e.deleteList=[],e.floatRound=0,e.roundUpdate=void 0,e.actionTime=1,e.txtLevel=void 0,e.name="ActivitySakuraGameView",e.url="ui/module/activitySakura/ActivitySakuraGameView",e.poolTime=3e3,e}e(o,t);var a=o.prototype;return a.onInit=function(){var t=this.findChild("bottom/btnReset");this.addComponentCallbackListener(t,s.EventType.CLICK,(function(){uiMgr.openView("ActivitySakuraGameConfirmView",2)}));var e=this.findChild("bottom/btnClose");this.addComponentCallbackListener(e,s.EventType.CLICK,(function(){uiMgr.openView("ActivitySakuraGameConfirmView",1)}));var i=this.findChild("bottom/btnGuide");this.addComponentCallbackListener(i,s.EventType.CLICK,(function(){uiMgr.openView("ActivitySakuraGameGuideView")})),this.txtLevel=this.findChildComponent("top/nodeLevel/txtLevel",r),this.scroll=this.findChildComponent("scroll",n),this.gridList=this.addUIList(this.scroll,G),this.gridList.selectedMode=c.SINGLE},a.registerUpdateHandler=function(){this.addEvent(C.OnSakuraGameSpin,this.OnGameSpin,this),this.addEvent(C.OnSakuraGameReset,this.ResetLevel,this)},a.onAfterOpen=function(){this.txtLevel.string=g.formatStrWithMirrorDeal(GetLanguage(200797),IS(b).curLevelId),this.InitLevel()},a.onBeforeClose=function(){},a.onDestroy=function(){this.gridList.clearData()},a.onUpdate=function(t){this.sourceInited||49==this.gridList.items.length&&(this.InitSource(),this.sourceInited=!0),this.gameFloat&&(this.roundUpdate&&(this.CheckFloatRound(),this.roundUpdate=!1),this.OnFloating(.1),this.floatRound>=this.floatingQuene.length&&(this.gameFloat=!1,this.UpdateColor(),this.floatingQuene=[],this.gameComplete||this.CheckGameComplete()))},a.ResetLevel=function(){this.gridList.clearData(),this.InitLevel()},a.InitLevel=function(){this.gameSpin=!1,this.gameFloat=!1,this.gameComplete=!1,this.sourceInited=!1;for(var t=configConnect_pipe_grid,e=1;e<=t.getDatas().length;e++){var i=t.getDataByKey(e),o={tree:i.identifier,tube:i.path_way,tubeType:i.type,tubeAngle:i.rotate};IS(b).gridInfo.push(o)}for(var s=configConnect_pipe_chapter.getDataByKey(IS(b).curLevelId),r=[],n=0;n<s.template.length;n++)r.push(IS(b).gridInfo[s.template[n]-1]);this.gridList.datas=r},a.InitSource=function(){IS(b).sourceList=[],IS(b).endList=[],IS(b).routeList=[],IS(b).routeComplete=[];var t=[];this.floatingQuene=[],this.gridList.items.forEach((function(e,i,o){if(e.curTree>0&&e.curTree<3){IS(b).sourceList.push(i);var s=1==e.curTree?1:2,r=new L(i,s);r.addRoute(0,i,-1),t.push([IS(b).routeList.length,i]),IS(b).routeList.push(r),IS(b).routeComplete[i]=!1}else e.curTree>2&&IS(b).endList.push(i)})),this.floatingQuene.push(t),this.InitRoute()},a.InitRoute=function(){for(;!IS(b).CheckRouteComplete();){for(var t,e=[],o=i(IS(b).routeList);!(t=o()).done;){var s=t.value;if(!(IS(b).routeComplete[s.sourceId]||s.routeTrace.length<=0)){for(var r,n=!1,u=!1,a=i(s.routeTrace[s.routeTrace.length-1]);!(r=a()).done;)for(var h=r.value,l=h[0],d=this.gridList.items[l],c=null,p=0;p<4;p++)if(d.openList[p]&&-1!=d.neighbourList[p]){if(d.neighbourList[p]==h[1])continue;if(!(c=this.gridList.items[d.neighbourList[p]]))continue;if(c.curTree>0&&c.curTree<3)continue;if(!c.openList[w[p]]){c.ChangeInput(s.routeColor,w[p],l,s.routeId),c=null;continue}if(s.checkInRoute(d.neighbourList[p],d.id)){c=null;continue}n=!0,c.ChangeInput(s.routeColor,w[p],l,s.routeId),u?s.addRoute(s.routeTrace.length-1,d.neighbourList[p],l):(s.addRoute(s.routeTrace.length,d.neighbourList[p],l),u=!0),e.push([s.routeId,d.neighbourList[p]])}n||(IS(b).routeComplete[s.sourceId]=!0)}}e[0]&&this.floatingQuene.push(e)}null!=this.floatingQuene[0]&&(this.gameFloat=!0,this.floatRound=0,this.roundUpdate=!0)},a.UpdateRoute=function(t,e,i){for(var o=IS(b).routeList[t],s=0;s<o.routeTrace.length;s++)for(var r=0;r<o.routeTrace[s].length;r++){var n=o.routeTrace[s][r][0];if(n==e)for(var u=this.gridList.items[n],a=null,h=0;h<4;h++)if(u.openList[h]&&-1!=u.neighbourList[h]){if(u.neighbourList[h]==o.routeTrace[s][r][1])continue;if(!(a=this.gridList.items[u.neighbourList[h]])){a=null;continue}if(!a.openList[w[h]]){a.ChangeInput(o.routeColor,w[h],n,o.routeId),a=null;continue}if(a.curTree>0&&a.curTree<3){a=null;continue}if(o.checkInRoute(u.neighbourList[h],u.id)){a=null;continue}a.ChangeInput(o.routeColor,w[h],n,o.routeId),o.addRoute(s+1,u.neighbourList[h],n),this.floatingQuene[i]||this.floatingQuene.push([]),this.floatingQuene[i].push([o.routeId,u.neighbourList[h]]),this.UpdateRoute(o.routeId,u.neighbourList[h],i+1)}}null==this.floatingQuene[0]||this.gameFloat||(this.gameFloat=!0,this.floatRound=0,this.roundUpdate=!0)},a.CutRoute=function(t,e,i){for(var o=IS(b).routeList[t].routeTrace,s=i;s<o.length;s++)for(var r=0;r<o[s].length;r++)o[s][r][1]==e&&this.CutRoute(t,o[s][r][0],s),o[s][r][0]==e&&this.deleteList.push([s,r])},a.DeleteRoute=function(t,e){for(var o,s=IS(b).routeList[t].routeTrace,r=i(this.deleteList);!(o=r()).done;){var n=o.value;if(null!=n[0]&&null!=s[n[0]]){var u=s[n[0]][n[1]][0],a=this.gridList.items[u];a.ResetComplete(IS(b).routeList[t].routeColor);for(var h=0;h<4;h++){var l=null;if(null!=(l=this.gridList.items[a.neighbourList[h]])&&a.openList[h])for(var d,c=i(l.input);!(d=c()).done;){var p=d.value;p[2]==u&&p[0]==w[h]&&p[1]==t&&l.DeleteInput(t,u)}}}}for(var f=this.deleteList.length-1;f>=0;f--)s[this.deleteList[f][0]]&&s[this.deleteList[f][0]].splice(this.deleteList[f][1],1);for(var g=s.length-1;g>=0;g--)s[g][0]||s.splice(g)},a.UpdateColor=function(){for(var t,e=i(this.gridList.items);!(t=e()).done;){t.value.ResetColor()}for(var o,s=i(IS(b).routeList);!(o=s()).done;){var r=o.value;if(r.routeTrace[1]){var n=this.gridList.items[r.routeTrace[1][0][0]];this.gridList.items[r.sourceId].changeColor(n.curColor)}else{this.gridList.items[r.sourceId].changeColor(r.routeColor)}}},a.CheckFloatRound=function(){for(var t=[],e=0;e<this.floatingQuene[this.floatRound].length;e++){for(var o,s=this.floatingQuene[this.floatRound][e][0],r=this.floatingQuene[this.floatRound][e][1],n=this.gridList.items[r],u=0,a=i(n.input);!(o=a()).done;){var h=o.value;h[1]==s&&(u=h[3])}0!=u&&(0==n.isFloating?n.isFloating=u:n.isFloating==u?t.push(e):n.isFloating!=u&&(n.isFloating=3,t.push(e)))}t.sort();for(var l=t.length-1;l>=0;l--)this.floatingQuene[this.floatRound].splice(t[l],1)},a.OnFloating=function(t){for(var e,o=!0,s=i(this.floatingQuene[this.floatRound]);!(e=s()).done;){var r=e.value;this.gridList.items[r[1]].Float(t,r[0])||(o=!1)}o&&(this.floatRound++,this.roundUpdate=!0)},a.OnGameSpin=function(t){var e=this;this.gameSpin=!0,this.spinNode=t;var i=this.spinNode.angle-90;u(this.spinNode).to(this.actionTime,{angle:i},{easing:"cubicOut"}).call((function(){e.gameSpin=!1,e.gameComplete||e.CheckGameComplete()})).start()},a.CheckGameComplete=function(){for(var t,e=!0,o=i(IS(b).routeList);!(t=o()).done;){var s=t.value;this.CheckRouteCompleted(s)}for(var r,n=i(IS(b).endList);!(r=n()).done;){var u=r.value;-1==this.gridList.items[u].treeEffectId&&(e=!1)}e&&(this.gameComplete=!0,IS(m).send_24_122(),uiMgr.openView("ActivitySakuraGameResultView"))},a.CheckRouteCompleted=function(t){for(var e=!1,i=this.gridList.items[t.sourceId],o=0;o<t.routeTrace.length;o++)for(var s=0;s<t.routeTrace[o].length;s++){var r=t.routeTrace[o][s][0];if(r!=t.sourceId){var n=this.gridList.items[r],u=!1;n.curTree==n.curColor+2&&(e=!0,u=!0,i.updateTreeEffect(e)),n.updateTreeEffect(u)}}return e||i.updateTreeEffect(e),e},o}(T)),function(t){function o(){for(var e,i=arguments.length,o=new Array(i),s=0;s<i;s++)o[s]=arguments[s];return(e=t.call.apply(t,[this].concat(o))||this).id=void 0,e.curColor=0,e.curTree=0,e.input=[],e.inputComplete=!1,e.outputComplete=!1,e.isFloating=0,e.nodeTube=void 0,e.nodeTubeEffect=void 0,e.nodeTreeEffect=void 0,e.tubeEffectId=-1,e.treeEffectId=-1,e.imgTree=void 0,e.imgBg=void 0,e.tubeList=[],e.openList=[!1,!1,!1,!1],e.neighbourList=[-1,-1,-1,-1],e}e(o,t);var r=o.prototype;return r.onInit=function(){var t=this;this.nodeTube=f.findChild(this.node,"nodeTube"),this.imgTree=f.findChildComponent(this.node,"imgTree",a),this.imgBg=f.findChildComponent(this.node,"nodeTube/imgBg",a),this.nodeTubeEffect=f.findChild(this.node,"nodeTube/nodeTubeEffect"),this.nodeTreeEffect=f.findChild(this.node,"imgTree/nodeTreeEffect");for(var e=0;e<4;e++)this.tubeList[e]=new Q(f.findChild(this.node,"nodeTube/tube"+e));this.view.addComponentCallbackListener(f.findChild(this.node,""),s.EventType.CLICK,(function(){var e=t.view;if(!e.gameSpin&&!e.gameFloat&&!e.gameComplete){normalEvent.emit(C.OnSakuraGameSpin,t.nodeTube),e.deleteList=[];var o=[];if(t.curTree>0&&t.curTree<3)for(var s,r=i(IS(b).routeList);!(s=r()).done;){var n=s.value;if(n.sourceId==t.id){e.CutRoute(n.routeId,n.sourceId,0),e.DeleteRoute(n.routeId,t.id),n.addRoute(0,t.id,-1);var u=[];e.floatingQuene=[],u.push([n.routeId,t.id]),e.floatingQuene.push(u)}}else{for(var a,h=[],l=[],d=[t.openList[3],t.openList[0],t.openList[1],t.openList[2]],c=i(t.input);!(a=c()).done;){var p=a.value;t.openList[p[0]]&&h.push(p),d[p[0]]&&l.push(p)}for(var f=0,g=h;f<g.length;f++){var v=g[f];e.CutRoute(v[1],t.id,0),e.DeleteRoute(v[1],t.id),e.deleteList=[]}for(var m=0,L=l;m<L.length;m++){var T=L[m];o.push([T[1],T[2]])}}IS(b).ResetRouteComplete();var I=t.tubeList[0];if(t.tubeList[0]=t.tubeList[3],t.tubeList[3]=t.tubeList[2],t.tubeList[2]=t.tubeList[1],t.tubeList[1]=I,1!=t.curTree&&2!=t.curTree){for(var S=0;S<4;S++)t.tubeList[S].updateTube(0);t.curColor=0}t.updateOpenList(),e.addTimer(1,0,(function(){e.InitRoute();for(var t,s=i(o);!(t=s()).done;){var r=t.value;e.UpdateRoute(r[0],r[1],0)}e.UpdateColor()}))}}))},r.onRender=function(t,e){if(this.id=e,this.input=[],this.neighbourList[0]=this.id%7==6?-1:this.id+1,this.neighbourList[1]=this.id>=42?-1:this.id+7,this.neighbourList[2]=this.id%7==0?-1:this.id-1,this.neighbourList[3]=this.id<=6?-1:this.id-7,this.imgTree.node.active=0!=t.tree,this.curTree=t.tree,this.curTree>0&&this.curTree<3&&(this.isFloating=this.curTree,this.inputComplete=!0,this.curColor=this.curTree),this.curTree>2&&(this.outputComplete=!0),0!=t.tree){var i=U[t.tree];this.view.loadIcon(this.imgTree,"act_sakura_game2",i)}if(0!=t.tubeType){this.view.loadIcon(this.imgBg,"act_sakura_game2",A[t.tubeType]),this.imgBg.node.setPosition(B[t.tubeType].x,B[t.tubeType].y),this.nodeTube.angle=0;for(var o=0;o<4;o++)this.tubeList[o]=new Q(f.findChild(this.node,"nodeTube/tube"+o));for(var s=t.tubeAngle;s>0;){this.nodeTube.angle-=90,s-=90;var r=this.tubeList[0];this.tubeList[0]=this.tubeList[3],this.tubeList[3]=this.tubeList[2],this.tubeList[2]=this.tubeList[1],this.tubeList[1]=r,this.updateOpenList()}}else this.imgBg.node.active=!1;for(var n=0;n<4;n++)this.tubeList[n].node.active=1==t.tube[n],this.tubeList[n].updateTube(0);this.updateOpenList()},r.updateTreeEffect=function(t){var e=this;t?-1==this.treeEffectId&&(this.curTree<3&&this.curTree>0?(d.playSound("shuangdan_tongdian"),this.treeEffectId=this.view.addUIEffect("prefab/ui-effect/MX_tx_dianchi",this.nodeTreeEffect,-1,h(-.77,.77),1,(function(t){var i=t.node;i.spine=i.getComponent(v),1==e.curTree&&i.spine.setAnimation(0,"lan_1",!0),2==e.curTree&&i.spine.setAnimation(0,"hong_1",!0)}))):this.curTree>2&&(d.playSound("shuangdan_tongdian"),this.treeEffectId=this.view.addUIEffect("prefab/ui-effect/MX_tx_yhj_deng",this.nodeTreeEffect,-1,h(-1.32,-50),1,(function(t){var i=t.node;i.spine=i.getComponent(v),3==e.curTree&&i.spine.setAnimation(0,"lan1",!0),4==e.curTree&&i.spine.setAnimation(0,"hong1",!0),5==e.curTree&&i.spine.setAnimation(0,"huang1",!0)})))):-1!=this.treeEffectId&&(this.view.removeUIEffect(this.treeEffectId),this.treeEffectId=-1)},r.updateOpenList=function(){for(var t=0;t<4;t++)this.openList[t]=this.tubeList[t].node.active},r.changeColor=function(t){if(!(this.curTree>0&&this.curTree<3&&0==t)){3!=t&&0!=t||(this.curColor=t),1==t&&(0!=this.curColor&&3!=this.curColor||(this.curColor=1),2==this.curColor&&(this.curColor=3)),2==t&&(0!=this.curColor&&3!=this.curColor||(this.curColor=2),1==this.curColor&&(this.curColor=3));for(var e=0;e<4;e++)this.tubeList[e].updateTube(this.curColor,1,1)}},r.ResetColor=function(){for(var t=0,e=0;e<4;e++)for(var o,s=i(this.input);!(o=s()).done;){var r=o.value;this.openList[r[0]]&&e==r[0]&&(0==t?t=r[3]:(1==t&&2==r[3]||2==t&&1==r[3])&&(t=3))}this.curTree>2&&-1!=this.treeEffectId&&this.curTree!=t+2&&(this.view.removeUIEffect(this.treeEffectId),this.treeEffectId=-1),0!=this.curColor?this.changeColor(t):this.curColor=t},r.ChangeInput=function(t,e,i,o){this.CheckInput(o,e)||this.input.push([e,o,i,t])},r.CheckInput=function(t,e){for(var o,s=i(this.input);!(o=s()).done;){var r=o.value;if(r[1]==t&&r[0]==e)return!0}return!1},r.DeleteInput=function(t,e){for(var o,s=[],r=i(this.input);!(o=r()).done;){var n=o.value;n[1]==t&&n[2]==e||s.push(n)}this.input=s},r.Float=function(t,e){if(this.inputComplete){if(this.outputComplete)return!0;for(var o=!0,s=0;s<4;s++)this.curTree>0&&this.curTree,this.openList[s]&&!this.tubeList[s].complete&&(o=!1,this.tubeList[s].updateTube(this.curColor,1,t));o&&(this.outputComplete=!0)}else{for(var r=!0,n=0;n<4;n++)for(var u,a=i(this.input);!(u=a()).done;){var h=u.value;h[0]==n&&(h[1]!=e||this.tubeList[n].complete||(r=!1,this.tubeList[n].updateTube(this.isFloating,-1,t),this.curColor!=this.isFloating&&this.changeColor(this.isFloating)))}r&&(this.inputComplete=!0)}return!1},r.ResetComplete=function(t){3==this.isFloating?(1==t?this.isFloating=2:2==t&&(this.isFloating=1),this.curColor=this.isFloating,this.inputComplete=!0,this.outputComplete=!0):this.isFloating==t&&0==this.isFloating?(this.isFloating=0,this.curColor=0,this.inputComplete=!1,this.outputComplete=!1):this.isFloating!=t&&(this.inputComplete=!0,this.outputComplete=!0),this.curTree>0&&this.curTree<3&&(this.inputComplete=!0,this.curColor=this.curTree),this.curTree>2&&(this.outputComplete=!0);for(var e=0;e<4;e++)0==this.isFloating?this.tubeList[e].Reset():this.tubeList[e].updateTube(this.isFloating,1,1)},o}(p)),Q=function(){function t(t){this.node=void 0,this.pbTube=void 0,this.bar1=void 0,this.bar2=void 0,this.bar3=void 0,this.progress=void 0,this.direction=void 0,this.color=void 0,this.complete=void 0,this.node=t,this.pbTube=this.node.getComponent(l),this.bar1=this.node.getChildByName("Bar1"),this.bar2=this.node.getChildByName("Bar2"),this.bar3=this.node.getChildByName("Bar3"),this.progress=0,this.direction=1,this.complete=!1}var e=t.prototype;return e.updateTube=function(t,e,i){if(void 0===e&&(e=this.direction),this.color=t,0==t)return this.bar1.active=!1,this.bar2.active=!1,this.bar3.active=!1,this.progress=0,void(this.complete=!1);this.progress+=i,this.progress>=1&&(this.progress=1),this.direction=e,1==t&&(this.bar1.active=!0,this.bar2.active=!1,this.bar3.active=!1,this.pbTube.barSprite=this.bar1.getComponent(a),this.pbTube.progress=this.progress,this.pbTube.reverse=1!=e),2==t&&(this.bar1.active=!1,this.bar2.active=!0,this.bar3.active=!1,this.pbTube.barSprite=this.bar2.getComponent(a),this.pbTube.progress=this.progress,this.pbTube.reverse=1!=e),3==t&&(this.bar1.active=!1,this.bar2.active=!1,this.bar3.active=!0,this.pbTube.barSprite=this.bar3.getComponent(a),this.pbTube.progress=this.progress,this.pbTube.reverse=1!=e),this.progress>=1?this.complete=!0:this.complete=!1},e.Reset=function(){this.bar1.active=!1,this.bar2.active=!1,this.bar3.active=!1,this.progress=0,this.complete=!1,this.pbTube.progress=0},t}();o._RF.pop()}}}));

