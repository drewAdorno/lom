System.register("chunks:///_virtual/CrosswarMapSceneView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UIList.ts","./NodeUtil.ts","./StringUtil.ts","./TimeUtil.ts","./index57.ts","./SpineSkeleton.ts","./ChapterControl.ts","./ChatDataCache.ts","./ChatDefine.ts","./MessageView.ts","./EquipModel.ts","./RoleDataCache.ts","./CrossWarControl.ts","./CrossWarDatacache.ts","./CrossWarDefine.ts","./CrossWarSceneControl.ts","./CrossWarSceneDataCache.ts","./CrossWarMapScene.ts","./CrossWarSelectMapScene.ts","./BaseView.ts"],(function(e){"use strict";var t,n,i,s,a,o,d,r,h,c,l,p,C,v,f,u,S,m,w,T,g,I,b,y,L,_,k,E,M,P,B,W,A,H,V,x,N;return{setters:[function(e){t=e.inheritsLoose,n=e.assertThisInitialized},function(e){i=e.cclegacy,s=e.Vec2,a=e.Vec3,o=e.Button,d=e.Label,r=e.ProgressBar,h=e.UITransform,c=e.Sprite,l=e.NodeEventType,p=e.isValid,C=e.Node,v=e.ScrollView,f=e.sys},function(e){u=e.ListItem},function(e){S=e.default},function(e){m=e.default},function(e){w=e.default},null,function(e){T=e.SpineSkeleton},function(e){g=e.default},function(e){I=e.ChatDataCache},function(e){b=e.ChatEventDefine,y=e.ChatDefine},function(e){L=e.default,_=e.TYPE_YES},function(e){k=e.EquipModel},function(e){E=e.RoleDataCache},function(e){M=e.default},function(e){P=e.CrossWarDataCache},function(e){B=e.CrossWarEventDefine,W=e.SceneObjState},function(e){A=e.default},function(e){H=e.CrossWarSceneDataCache},function(e){V=e.CrossWarMapScene},function(e){x=e.CrossWarSelectMapScene},function(e){N=e.BaseView}],execute:function(){i._RF.push({},"bef9164UstNQLDucNEjlSXu","CrosswarMapSceneView",void 0);var O=new s,U=new a,D=30,R=30,G=(e("default",function(e){function i(){var t;return(t=e.call(this)||this).miniMap=void 0,t.chatRoot=void 0,t.txtName=void 0,t.content=void 0,t.face=void 0,t.faceOriScale=void 0,t.load=void 0,t.txtServer=void 0,t.txtScore=void 0,t.nodeTime=void 0,t.nodeScore=void 0,t.nodeSendTip=void 0,t.txtTime=void 0,t.pbTime=void 0,t.timerId=0,t.currenPanel=void 0,t.scenePanels={},t.name="CrosswarMapSceneView",t.url="ui/module/crosswar/CrosswarMapSceneView",t.fullScreen=!0,t.scenePanels[2]=new K(n(t)),t.scenePanels[1]=new G(n(t)),D=configCross_war_kv.getDataByKey(14).value[0],R=configCross_war_kv.getDataByKey(13).value[0],t}t(i,e);var s=i.prototype;return s.onInit=function(){var e=this,t=this.findChild("top/btnClose");this.addComponentCallbackListener(t,o.EventType.CLICK,(function(){if(IS(P).serv_id==IS(E).GetServerId())return uiMgr.openView("CrossWarView"),void e.close();L.showBoxTip({tip:GetLanguage(200767),title:GetLanguage(200048),func:function(t){t==_&&(uiMgr.openView("CrossWarView"),IS(A).reqLeave(),IS(A).reqBattleResult(0,0),e.close())}})})),this.load=this.findChild("load"),this.txtServer=this.findChildComponent("top/txtServer",d),this.txtScore=this.findChildComponent("top/score/txtNum",d),this.pbTime=this.findChildComponent("top/time/pbTime",r),this.txtTime=this.findChildComponent("top/time/txtTime",d),this.nodeTime=this.findChild("top/time"),this.nodeScore=this.findChild("top/score"),this.nodeSendTip=this.findChild("top/sendTip");var n=this.findChild("btnChatRoot");this.addComponentCallbackListener(n,o.EventType.CLICK,(function(){uiMgr.openView("ChatView",2)})),this.chatRoot=n;var i=S.findChild(n,"name/messageContent"),s=S.findChildComponent(n,"name",h);for(var a in this.txtName=S.findChildComponent(n,"name",d),this.face=S.findChildComponent(n,"name/messageContent/face",c),this.faceOriScale=this.face.node.scale,this.addComponentCallbackListener(this.txtName.node,l.SIZE_CHANGED,(function(){i.setPosition(s.width+7,-1.389)})),this.scenePanels)this.scenePanels[a].onInit()},s.registerUpdateHandler=function(){for(var e in this.addEvent(b.InsertNewMsg,this.updateMessage,this),this.addEvent(b.UpdateChatMsg,this.updateMessage,this),this.scenePanels)this.scenePanels[e].addEvent()},s.onAfterOpen=function(){var e,t=this,n=IS(P).scene_base;if(5==n&&IS(M).reqHolyOpen(),configScene.getDataByKey(n)){uiMgr.getView("MainView").visible=!1;var i=null!=(e=this.openArgs[0])?e:1;this.toPanel(i),IS(k).setAutoOpen(!1),battleMain.stopChapter(),this.updateScore(),this.timerId>0&&this.removeTimer(this.timerId),this.timerId=0,IS(P).serv_id==IS(E).GetServerId()?(this.nodeTime.active=!1,this.nodeScore.active=!1):(this.nodeTime.active=!0,this.nodeScore.active=!0,this.updateTime(),this.timerId=this.addTimer(1,-1,(function(){t.updateTime()})))}else this.close()},s.onBeforeClose=function(){var e;uiMgr.getView("MainView").visible=!0,null==(e=this.currenPanel)||e.onBeforeClose(),IS(g).reqEnterChapter(0),battleMain.enterChapter(0,!1,!0),2==IS(H).currenSceneType?IS(A).reqLeave():1==IS(H).currenSceneType&&IS(M).reqCrossWarSceneTransferClose(),IS(H).currenSceneType=0},s.toPanel=function(e){var t;this.load.active=!0,null==(t=this.currenPanel)||t.onBeforeClose(),this.currenPanel=this.scenePanels[e],this.currenPanel.onAfterOpen(),this.nodeSendTip&&(this.nodeSendTip.active=1==e)},s.onUpdate=function(e){var t;null==(t=this.currenPanel)||t.onUpdate(e)},s.onDestroy=function(){for(var e in this.scenePanels)this.scenePanels[e].onDestroy()},s.updateScore=function(){this.txtScore.string=m.GetNumString(IS(P).score),this.txtServer.string="s"+IS(P).serv_id},s.updateTime=function(){var e,t=null!=(e=IS(P).end_time-w.serverTime)?e:0;this.txtTime.string=w.getTimeLeft(t);var n=configCross_war_kv.getDataByKey(3).value[0];this.pbTime.progress=t/n},s.updateMessage=function(e){if(void 0===e&&(e=null),(!e||e.channel==y.Channel.Guild)&&p(this.txtName)&&p(this.content)&&p(this.face)){var t=IS(I).GetChatInfo(y.Channel.Guild,0);if(t&&t.length>0){var n=t[t.length-1];if(this.txtName.string=n.name+"ï¼š",n.type==y.ChatContentType.Conetnt||n.type==y.ChatContentType.Share||n.type==y.ChatContentType.Pic||n.type==y.ChatContentType.Voice){var i=n.content;this.face.node.active=!1,n.type==y.ChatContentType.Pic?this.content.string=GetLanguage(200179):n.type==y.ChatContentType.Voice?this.content.string=GetLanguage(999000624):this.content.string=i}else if(n.type==y.ChatContentType.Face){this.face.node.active=!0,this.content.string="";var s=IS(I).GetFaceIconByContent(n.content),o=s[0],d=s[1],r=this.faceOriScale.y*d.scale;this.face.node.scale=new a(r,r,r),this.loadIcon(this.face,"icon_chat",o)}this.txtName.node.active=!0}else this.txtName.string="",this.content.string=""}},i}(N)),function(){function e(e){this.view=void 0,this.mapScene=void 0,this.state=0,this.sendPanel=void 0,this.imgCd=void 0,this.transferCd=0,this.btnBack=void 0,this.view=e,this.mapScene=new x(e)}var t=e.prototype;return t.onInit=function(){var e=this,t=this.view,n=t.findChild("sendPanel");this.sendPanel=n;var i=S.findChild(n,"Node/btnMap");t.addComponentCallbackListener(i,o.EventType.CLICK,(function(){uiMgr.openView("CrossWarMapOverView",1)}));var s=S.findChild(n,"Node/btnBack");t.addComponentCallbackListener(s,o.EventType.CLICK,(function(){IS(M).reqCrossWarSceneEnter(2,{x:0,y:0}),t.toPanel(2)})),this.btnBack=s;var a=S.findChild(n,"btnSend");this.imgCd=S.findChildComponent(a,"imgCd",c),t.addComponentCallbackListener(a,o.EventType.CLICK,(function(){e.mapScene.owner?IS(H).transferCdTime>w.serverTime||e.transferCd>0?L.showFlyTip(GetLanguage(201383)):(e.transferCd=R,IS(M).reqCrossWarSceneEnter(1,e.mapScene.owner.position),t.toPanel(2),5==IS(P).scene_base&&IS(M).reqHolyOpen()):L.showFlyTip(GetLanguage(201382))}))},t.addEvent=function(){var e=this;this.view.addEvent(B.CROSS_WAR_SCENE_INFO_UPDATE,(function(t){e.view.updateScore();var n=IS(H);e.transferCd=0,n.transferCdTime>0&&(e.transferCd=n.transferCdTime-w.serverTime),IS(P).pos?e.btnBack.active=!0:e.btnBack.active=!1}),this,!0)},t.onUpdate=function(e){1==this.state&&(this.mapScene.onUpdate(e),this.transferCd>0?(this.imgCd&&(this.imgCd.fillRange=1-(R-this.transferCd)/R),this.transferCd-=e):this.imgCd&&(this.imgCd.fillRange=0))},t.onAfterOpen=function(){1!=this.state&&(this.state=1,this.sendPanel.active=!0,this.mapScene.open())},t.onBeforeClose=function(){2!=this.state&&(this.state=2,this.sendPanel.active=!1,this.mapScene.close())},t.onDestroy=function(){this.mapScene.destroy()},e}()),K=function(){function e(e){this.view=void 0,this.mapScene=void 0,this.state=0,this.nodeHandle=void 0,this.nodeShow=void 0,this.utShow=void 0,this.utHandle=void 0,this.handleBall=void 0,this.startTouchPos=new a,this.startTouch=!1,this.skillPanel=void 0,this.miniMap=void 0,this.spineAuto=void 0,this.spineAtk=void 0,this._autoBattle=!1,this.imgCd=void 0,this.speedCd=0,this.bossList=void 0,this.btnWanted=void 0,this.view=e,this.mapScene=new V(e)}var t=e.prototype;return t.onInit=function(){var e=this,t=this.view,n=t.findChild("skillPanel");this.skillPanel=n;var i=S.findChild(n,"btnOutline");t.addComponentCallbackListener(i,o.EventType.CLICK,(function(){IS(M).reqCrossWarIdelReward()}));var d=S.findChild(n,"btnMap");t.addComponentCallbackListener(d,o.EventType.CLICK,(function(){uiMgr.openView("CrossWarMapOverView",1)}));var r=S.findChild(n,"btnSend");t.addComponentCallbackListener(r,o.EventType.CLICK,(function(){IS(H).transferCdTime>w.serverTime?L.showFlyTip(GetLanguage(201383)):(5==IS(P).scene_base&&IS(M).reqHolyOpen(),IS(A).leaveScene(1,!0),IS(M).reqCrossWarSceneTransfer(IS(P).scene_base,{x:0,y:0}))}));var l=IS(H),p=S.findChild(n,"btnAuto");this.spineAuto=S.findChildComponent(p,"spine",T),t.addComponentCallbackListener(p,o.EventType.CLICK,(function(){l.autoBattle=!l.autoBattle}));var u=S.findChild(n,"selNode"),m=S.findChild(n,"btnAtkType");t.addComponentCallbackListener(m,o.EventType.CLICK,(function(){u.active=!0}));var g=S.findChild(n,"selNode/btnPlayer");t.addComponentCallbackListener(g,o.EventType.CLICK,(function(){l.atkType=2,u.active=!1,e.refreshAtkTypeShow()}));var I=S.findChild(n,"selNode/btnMonster");t.addComponentCallbackListener(I,o.EventType.CLICK,(function(){l.atkType=3,u.active=!1,e.refreshAtkTypeShow()}));var b=S.findChild(n,"selNode/btnAnyone");t.addComponentCallbackListener(b,o.EventType.CLICK,(function(){l.atkType=1,u.active=!1,e.refreshAtkTypeShow()}));var y=S.findChild(n,"btnSpeed");this.imgCd=S.findChildComponent(y,"imgCd",c),t.addComponentCallbackListener(y,o.EventType.CLICK,(function(){e.speedCd>0||(e.speedCd=D,IS(M).reqSceneSpeed())})),this.nodeHandle=t.findChild("nodeHandle"),this.nodeShow=S.findChild(this.nodeHandle,"nodeShow"),this.utShow=this.nodeShow.getComponent(h),this.utHandle=this.nodeHandle.getComponent(h),this.handleBall=S.findChild(this.nodeHandle,"nodeShow/nodeBall"),t.addComponentCallbackListener(this.nodeHandle,C.EventType.TOUCH_START,(function(t){var n=t.getUILocation();U.set(n.x,n.y);var i=e.utHandle.convertToNodeSpaceAR(U);i.z=0,e.startTouchPos.set(i),e.startTouch=!0,t.preventSwallow=!0})),t.addComponentCallbackListener(this.nodeHandle,C.EventType.TOUCH_MOVE,(function(t){if(e.startTouch){var n=t.getUILocation();if(U.set(n.x,n.y),e.nodeShow.active){var i=e.utShow.convertToNodeSpaceAR(U);i.z=0,t.propagationStopped=!0,t.propagationImmediateStopped=!0;var s=i;return i.length()>50&&(s=i.normalize().multiplyScalar(50)),e.handleBall.position=s,void e.mapScene.moveOwner(O.set(s.x,s.y))}var o=e.utHandle.convertToNodeSpaceAR(U);a.subtract(new a,e.startTouchPos,o).length()>50?(e.nodeShow.active=!0,e.nodeShow.position=e.startTouchPos,e.handleBall.position=a.ZERO,t.propagationStopped=!0,t.propagationImmediateStopped=!0):t.preventSwallow=!0}})),t.addComponentCallbackListener(this.nodeHandle,C.EventType.TOUCH_END,(function(t){if(e.startTouch=!1,e.nodeShow.active)return e.nodeShow.active=!1,t.propagationStopped=!0,t.propagationImmediateStopped=!0,void e.mapScene.moveOwner(s.ZERO);t.preventSwallow=!0})),this.miniMap=t.findChild("miniMap"),t.miniMap=t.findChild("miniMap/mapView/map");var _=t.findChildComponent("bossList",v);this.bossList=this.view.addUIList(_,q,!1,4,4),this.bossList.datas=this.mapScene.bossList,this.btnWanted=t.findChild("btnWanted"),t.addComponentCallbackListener(this.btnWanted,o.EventType.CLICK,(function(){uiMgr.openView("CrossWarWantedView")})),f.uiMirror&&(this.view.loadIcon(d.getComponent(c),"crosswar_scene","wm_btn_map"),this.view.loadIcon(r.getComponent(c),"crosswar_scene","wm_btn_send02"),S.findChild(n,"btnAuto/spine").setScale(-1,1,1),this.view.loadIcon(S.findChildComponent(n,"btnAtkType/imgIcon",c),"crosswar_scene","wm_btn_zhidawanjia"),this.view.loadIcon(S.findChildComponent(n,"btnSpeed/wm_btn_speedUp",c),"crosswar_scene","wm_btn_speedUp"),this.view.loadIcon(S.findChildComponent(n,"btnSpeed/imgCd",c),"crosswar_scene","wm_btn_speedUp"))},t.addEvent=function(){var e=this;this.view.addEvent(B.CROSS_WAR_BATTLE,this.onWarBattle,this,!0),this.view.addEvent(B.CROSS_WAR_LEAVE,(function(t){1!=t?2==t&&e.view.close():e.view.toPanel(1)}),this,!0)},t.refreshAtkTypeShow=function(){S.findChild(this.skillPanel,"selNode").active=!1;var e=S.findChildComponent(this.skillPanel,"btnAtkType/imgIcon",c),t=S.findChildComponent(this.skillPanel,"btnAtkType/imgTitle",d);1==IS(H).atkType?(this.view.loadIcon(e,"crosswar_scene","wm_btn_renyidanwei"),t.string=GetLanguage_UI(999000540)):2==IS(H).atkType?(this.view.loadIcon(e,"crosswar_scene","wm_btn_zhidawanjia"),t.string=GetLanguage_UI(999000048)):3==IS(H).atkType&&(this.view.loadIcon(e,"crosswar_scene","wm_btn_suoyoudanwei"),t.string=GetLanguage_UI(999000539))},t.onWarBattle=function(e){this.mapScene.cancelSelect(),this.nodeShow.active=!1,this.startTouch=!1,0==e&&this.mapScene.owner&&(this.mapScene.owner.info.state=W.Battle),this.view.visible=1==e},t.onUpdate=function(e){if(1==this.state){this.mapScene.onUpdate(e),this.nodeShow&&this.nodeShow.active&&this.mapScene.synMoveToServer();var t=IS(H);this._autoBattle!=t.autoBattle&&(this._autoBattle=t.autoBattle,this.spineAuto&&this.spineAuto.setAnimation(0,t.autoBattle?"run":"idle",!0)),this.speedCd>0&&(this.imgCd&&(this.imgCd.fillRange=1-(D-this.speedCd)/D),this.speedCd-=e),this.bossList&&this.mapScene.updateBossList&&(this.bossList.datas=this.mapScene.bossList);var n=IS(P).serv_id==IS(E).GetServerId()&&this.mapScene.bossList.length<=0;this.btnWanted&&this.btnWanted.active!=n&&(this.btnWanted.active=n)}},t.onAfterOpen=function(){if(1!=this.state){this.state=1,this.onWarBattle(1),this.nodeHandle.active=!0,this.miniMap.active=!0,this.skillPanel.active=!0,this.bossList.node.active=!0,this.mapScene.open();var e=IS(H);this.speedCd=0,e.speedCdTime>0&&(this.speedCd=e.speedCdTime-w.serverTime),this.refreshAtkTypeShow()}},t.onBeforeClose=function(){2!=this.state&&(this.state=2,this.mapScene.close(),this.nodeHandle&&(this.nodeHandle.active=!1,this.miniMap.active=!1,this.skillPanel.active=!1,this.bossList.clearData(),this.bossList.node.active=!1,this.btnWanted.active=!1))},t.onDestroy=function(){this.mapScene.destroy()},e}(),q=function(e){function n(){for(var t,n=arguments.length,i=new Array(n),s=0;s<n;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).data=void 0,t.pbHp=void 0,t.txtHp=void 0,t}t(n,e);var i=n.prototype;return i.onInit=function(){var e=this.node;this.pbHp=S.findChildComponent(e,"pbHp",r),this.txtHp=S.findChildComponent(e,"txtHp",d)},i.onRender=function(e,t){var n=e.info;n&&(this.pbHp.progress=n.hp/1e4,this.txtHp.string=Math.floor(n.hp/100)+"%")},n}(u);i._RF.pop()}}}));

