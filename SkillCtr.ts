System.register("chunks:///_virtual/SkillCtr.ts",["./rollupPluginModLoBabelHelpers.js","cc","./FixMath.ts","./MetaAttrib.ts","./Skill.ts","./SkillRunner.ts","./EnumDefine.ts","./UnitMgr.ts"],(function(t){"use strict";var i,e,n,s,r,a,l,o,f,u;return{setters:[function(t){i=t.createForOfIteratorHelperLoose,e=t.createClass},function(t){n=t.cclegacy},function(t){s=t.FixMath},function(t){r=t.AttribDefine},function(t){a=t.Skill},function(t){l=t.SkillRunner},function(t){o=t.TargetFilter,f=t.UnityType},function(t){u=t.UnitMgr}],execute:function(){n._RF.push({},"3d317GDiNJNcYf6KuyUUdZx","SkillCtr",void 0);t("SkillCtr",function(){function t(){this.list=[],this._owner=void 0,this.skillEffects=[],this._isLoadPassive=!1,this._isLoadPetPassive=!1,this._isLoadFlyPetPassive=!1,this._passiveRunners=[],this._triggerCount=new Map,this._damageRecord=new Map}var n=t.prototype;return n.init=function(t){this._owner=t},n.reset=function(){for(var t=this.list,i=0;i<t.length;++i){var e=t[i];e.stop(),e.destroy()}this.list.length=0,this.skillEffects.length=0,this._triggerCount.clear(),this._isLoadPassive=!1,this._isLoadPetPassive=!1},n._addTriggerCount=function(t){this._triggerCount.has(t)||this._triggerCount.set(t,0),this._triggerCount.set(t,this._triggerCount.get(t)+1)},n.checkTriggerCount=function(t,i){return this._addTriggerCount(t),i<=0||this._triggerCount.get(t)%i==0},n.loadPassiveSkill=function(){if(!this._isLoadPassive){this._isLoadPassive=!0;var t=this._owner.data.passiveSkillList;if(null!=t)for(var e,n=i(t);!(e=n()).done;){var s=e.value,r=new l;r.init(this._owner,s),r.start(!0),this._passiveRunners.push(r),this.addRunner(r)}}},n.setRecordDamage=function(t,i){this._damageRecord[t]=i},n.getRecordDamage=function(t){var i;return null!=(i=this._damageRecord[t])?i:0},n.loadPetPassiveSkill=function(){if(!this._isLoadPetPassive){this._isLoadPetPassive=!0;var t=this._owner.data.petPassiveSkillList;if(null!=t&&0!=t.length)for(var e,n=this._owner.battleMain.unitMgr.findTarget(this._owner,o.CastPartner),s=function(){var t=e.value,i=t.config.addSkill;if(0==i.length)return"continue";var s=i[0];n.forEach((function(e){if(e.config.type==f.Partner&&s.includes(e.config.petrace)){var n=u.addSkill(e.data,i[1],0);n.skillDam=t.skillDam,n.parentSkillId=t.config.id}}))},r=i(t);!(e=r()).done;)s()}},n.loadFlyPetPassiveSkill=function(){if(!this._isLoadFlyPetPassive){this._isLoadFlyPetPassive=!0;var t=this._owner.data.flyPetPassiveSkillList;if(null!=t&&0!=t.length){var e=this._owner.flyPet;if(e)for(var n,s=i(t);!(n=s()).done;){var r=n.value,a=r.config.addSkill;if(0!=a.length){var l=u.addSkill(e.data,a[1],0);l.skillDam=r.skillDam,l.parentSkillId=r.config.id}}}}},n.addChapterBuff=function(t){var i=configSkill.getDataByKey(t);if(null==i)throw Error("副本buff技能ID:"+t+"不存在!!!");var e=new a;e.config=i,e.level=1,e.skillDam=i.skillPar;var n=new l;n.init(this._owner,e),n.start(!0),this.addRunner(n)},n._unloadPet=function(t,i){var e=t.data.skillList;if(null!=e&&0!=e.length)for(var n=0;n<e.length;n++){if(e[n].parentSkillId==i){e.splice(n,1);break}}},n.unloadPetPassiveSkill=function(){var t=this;if(this._isLoadPetPassive){this._isLoadPetPassive=!1;var i=this._owner.data.petPassiveSkillList;if(null!=i&&0!=i.length){var e=this._owner.battleMain.unitMgr.findTarget(this._owner,o.CastPartner);i.forEach((function(i){e.forEach((function(e){e.config.type==f.Partner&&t._unloadPet(e,i.config.id)}))}))}}},n.unloadFlyPetPassiveSkill=function(){var t=this;if(this._isLoadFlyPetPassive){this._isLoadFlyPetPassive=!1;var i=this._owner.data.flyPetPassiveSkillList;if(null!=i&&0!=i.length){var e=this._owner.flyPet;e&&i.forEach((function(i){t._unloadPet(e,i.config.id)}))}}},n.onUpdate=function(t){for(var i=this.list,e=0;e<i.length;++e){var n=i[e];n.onUpdate(t),n.isStop&&(n.stop(),n.destroy(),i.splice(e,1),e--)}this.onSkillUpdate(t)},n.onSkillUpdate=function(t){var i=this._owner.data;if(null!=i.attack&&2==i.attack.state){var e=s.round(1/Math.max(.01,i.getAttrib(r.att_speed)));i.attack.currenCd=s.round(i.attack.currenCd+t),i.attack.currenCd=Math.min(i.attack.currenCd,e),i.attack.state=i.attack.currenCd>=e?0:2}if(null!=i.skillList)for(var n=i.getAttrib(r.power_recovery),a=0;a<i.skillList.length;++a){var l=i.skillList[a];if(2==l.state){var o=s.round(s.round(l.config.powerRecovery*n)*t);o=s.round(o*this._owner.battleMain.skillCd),l.currenPower=s.round(l.currenPower+o),l.currenPower=Math.min(l.currenPower,l.config.maxPower),l.currenCd=0,l.checkState()}}},n._findSkillEffect=function(t){for(var i=0;i<this.skillEffects.length;i++){if(this.skillEffects[i].id==t)return i}return-1},n.addSkillEffect=function(t,i,e,n,s,r){var a,l=this._findSkillEffect(t),o=null!=(a=this.skillEffects[l])?a:{id:t,num:0,bullet:0,runner:i,triggerType:e,limit:n,useType:s,param5:r};if(0==s){var f=configSkilleffcet.getDataByKey(t);o.bullet=f.bullet}o.num++,-1==l&&this.skillEffects.push(o)},n.removeSkillEffect=function(t){var i=this._findSkillEffect(t);if(-1!=i){var e=this.skillEffects[i];e.num--,e.num<=0&&this.skillEffects.splice(i,1)}},n.addRunner=function(t){this._owner.battleMain.printLogFlag&&this._owner.battleMain.printLogDebug("run skill, id "+this._owner.unitId+", skill_id "+t.useSkill.config.id),this.list.push(t)},n.addSkill=function(t){var i=u.newSkill(t,1);i.triggerEffect=!1;var e=new l;return e.init(this._owner,i,!0),e.start(),this.addRunner(e),i},n.interrupt=function(){for(var t=this.list,i=0;i<t.length;++i){t[i].interrupt()}},n.onBeHitAction=function(t,i,e){if(1!=t.data.unitType.target)for(var n=this.list,s=0;s<n.length;++s){n[s].onBeHitAction(t,i,e)}},n.onActTargetAction=function(t,i){for(var e=this.list,n=0;n<e.length;++n){var s=e[n];s.isPassive&&s.onActTargetAction(t,i)}},n.onDeadTargetAction=function(){},e(t,[{key:"isLoadPassive",get:function(){return this._isLoadPassive}}]),t}());n._RF.pop()}}}));

