System.register("chunks:///_virtual/BattleTowerDefInfo.ts",["./rollupPluginModLoBabelHelpers.js","cc","./ChapterTowerDef.ts","./AudioMgr.ts","./CameraMgr.ts","./NodeUtil.ts","./ItemIcon.ts","./ActivityReverseDataCache.ts","./ChapterControl.ts","./ChapterDefine.ts","./IBattleChapterPanel.ts"],(function(t){"use strict";var e,i,n,o,s,a,r,h,c,d,u,m,l,v,f,p,I,g;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy,n=t.Vec3,o=t.Button,s=t.UITransform,a=t.Node,r=t.Vec2,h=t.Rect,c=t.Sprite},function(t){d=t._IdleFormation},function(t){u=t.audioMgr},function(t){m=t.cameraMgr},function(t){l=t.default},function(t){v=t.IconAseetType},function(t){f=t.default},function(t){p=t.default},function(t){I=t.ChapterEventDefine},function(t){g=t.BattleInfoType}],execute:function(){i._RF.push({},"c31b2g/6T1O8Jfzzg0mm0Ks","BattleTowerDefInfo",void 0);var C=new n,w=(t("BattleTowerDefInfo",function(){function t(t,e){this.view=void 0,this.node=void 0,this.type=void 0,this.btnExit=void 0,this.is_auto=void 0,this.startTouchPos=new n,this.startTouch=!1,this.touchItem=void 0,this.monsterItems=[],this.view=t,this.node=e,this.type=g.TowerDef,this.onInit()}var i=t.prototype;return i.onInit=function(){var t=this,i=l.findChildComponent(this.node,"btnExit",o);this.view.addComponentCallbackListener(i.node,o.EventType.CLICK,(function(){u.playMusic("battle"),IS(p).reqEnterChapter(0),battleMain.enterChapter(),normalEvent.emit(I.BATTLE_STATE,battleMain.data.chapterType,!1),uiMgr.openView("ActivityReverseView"),uiMgr.openView("ActivityReverseDungeonView")})),this.btnExit=i,this.touchItem=new w(this.view,l.findChild(this.node,"touch"),1,0),this.touchItem.isMoveItem=!0;for(var h=this.node.getComponent(s),c=l.findChild(this.node,"place"),v=1;v<=10;v++){var f=l.findChild(c,"item"+v),g=new w(this.view,f,v,c.position.y);this.monsterItems.push(g)}var T=l.findChild(this.node,"placeHandle");this.view.addComponentCallbackListener(T,a.EventType.TOUCH_START,(function(i){var n=i.getUILocation();C.set(n.x,n.y);var o=h.convertToNodeSpaceAR(C);o.z=0;for(var s,a=new r(o.x,o.y),c=e(t.monsterItems);!(s=c()).done;){var d=s.value;if(d.monster&&0==d.monster.state&&d.rect.contains(a)){t.touchItem.node.active=!0,t.touchItem.node.setPosition(a.x,a.y),t.touchItem.setData(d.monster),t.startTouch=!0,i.preventSwallow=!0;break}}})),this.view.addComponentCallbackListener(T,a.EventType.TOUCH_MOVE,(function(e){if(t.startTouch){var i=e.getUILocation();C.set(i.x,i.y);var n=h.convertToNodeSpaceAR(C);n.z=0,t.touchItem.node.setPosition(n.x,n.y),e.propagationStopped=!0,e.propagationImmediateStopped=!0}})),this.view.addComponentCallbackListener(T,a.EventType.TOUCH_END,(function(e){if(t.startTouch){t.startTouch=!1;var i=e.getLocation(),o=new n(i.x,i.y,0),s=m.battleCamera.screenToWorld(o);for(var a in C.set(s.x,s.y-640),d)if(C.y<=d[a]+110&&C.y>=d[a]-110){t.touchItem.monster.currenCd=t.touchItem.monster.config.maxCd/1e3,t.touchItem.monster.state=1,u.playSound("nizhuan_shangzhen"),battleMain.chapter.addMosnter(t.touchItem.monster.config.unitId,Number(a),590);break}t.touchItem.node.active=!1,t.touchItem.setData(null),e.propagationStopped=!0,e.propagationImmediateStopped=!0}}))},i.onUpdate=function(t){for(var i,n=e(this.monsterItems);!(i=n()).done;){i.value.onUpdate(t)}},i.reset=function(){this.btnExit.enabled=!0},i.onLoad=function(){this.btnExit.enabled=!1;for(var t=IS(f).getInfo().equip_list,e=0;e<10;e++){var i=this.monsterItems[e],n=t[e+1];if(n){var o=configReversion_war_chess.getDataByKey(n),s={config:o,state:1,currenCd:o.initialCd/1e3};i.setData(s)}else i.setData(null)}},t}()),function(){function t(t,e,i,n){this.node=void 0,this.view=void 0,this.index=void 0,this.ut=void 0,this.rect=void 0,this.nodeExist=void 0,this.imgIcon=void 0,this.imgPower=void 0,this.lastState=-1,this.monster=void 0,this.isMoveItem=!1,this.node=e,this.view=t,this.index=i,this.ut=e.getComponent(s),this.rect=new h(this.node.position.x-this.ut.width/2,this.node.position.y+n-this.ut.height/2,this.ut.width,this.ut.height),this.nodeExist=l.findChild(e,"exist"),this.imgPower=l.findChildComponent(this.nodeExist,"imgPower",c),this.imgPower.fillRange=0,this.imgIcon=l.findChildComponent(this.nodeExist,"imgIcon",c)}var e=t.prototype;return e.setData=function(t){this.monster=t,null==t?this.nodeExist.active=!1:(this.nodeExist.active=!0,this.view.loadIcon(this.imgIcon,"icon_reversion_war",t.config.icon,null,v.ICON_SPRITE),this.view.loadIcon(this.imgPower,"icon_reversion_war",t.config.icon,null,v.ICON_SPRITE)),this.imgPower.fillRange=0},e.onUpdate=function(t){if(!this.isMoveItem&&null!=this.monster){if(this.lastState!=this.monster.state){switch(this.monster.state){case 0:this.imgPower.node.active=!1;break;case 1:this.imgPower.node.active=!0,this.imgPower.fillRange=1}this.lastState=this.monster.state}if(0!=this.monster.state){1==this.monster.state&&(this.monster.currenCd-=t,this.monster.currenCd=Math.max(this.monster.currenCd,0),0==this.monster.currenCd&&(this.monster.state=0));var e=this.monster.currenCd/(this.monster.config.maxCd/1e3);this.imgPower.fillRange=e}}},t}());i._RF.pop()}}}));

