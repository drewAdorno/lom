System.register("chunks:///_virtual/Unit.ts",["./rollupPluginModLoBabelHelpers.js","cc","./ObjectPool.ts","./FixMath.ts","./AnimatorCtr.ts","./BuffCtr.ts","./HatredCtr.ts","./MovementCtr.ts","./SkillCtr.ts","./StateCtr.ts","./EnumDefine.ts","./UnitMgr.ts","./EventDefine.ts","./V2.ts","./MetaAttrib.ts","./SkillRunner.ts","./Target.ts"],(function(t){"use strict";var i,e,n,a,s,r,h,o,l,u,d,c,f,p,g,_,k,v,m,b,T,y,S,C,H,I,M;return{setters:[function(t){i=t.createForOfIteratorHelperLoose,e=t.createClass},function(t){n=t.cclegacy},function(t){a=t.ObjectPool},function(t){s=t.FixMath},function(t){r=t.AnimatorCtr},function(t){h=t.BuffCtr,o=t.freeBuffList},function(t){l=t.HatredCtr},function(t){u=t.MovementCtr},function(t){d=t.SkillCtr},function(t){c=t.StateCtr},function(t){f=t.BindType,p=t.StateType,g=t.BuffGroupType,_=t.SpBuffState,k=t.HealthType,v=t.DmgType,m=t.UnitConfig},function(t){b=t.UnitMgr},function(t){T=t.EventDefine},function(t){y=t.V2},function(t){S=t.AttribDefine},function(t){C=t.SkillRunner},function(t){H=t.TargetPoint,I=t.TargetUnit,M=t.TargetSkill}],execute:function(){n._RF.push({},"e9e28NvhqtHnpebZYLYo2/m","Unit",void 0);var D=new y,A=t("HpAction",(function(){this.attacker_id=void 0,this.defence_id=void 0,this.health=void 0,this.healthType=void 0,this.skillId=void 0})),w=new a(A,50),P=[1,3];t("Unit",function(){function t(t){this.battleMain=void 0,this.unitId=void 0,this.teamId=0,this.modelObj=void 0,this.data=void 0,this.flag=void 0,this._aiRoot=void 0,this.isCallType=!1,this.parent=void 0,this.flyPet=void 0,this.shamUnit=!1,this._dead=!1,this.movectr=void 0,this.statectr=void 0,this.animatorctr=void 0,this.skillctr=void 0,this.hatredCtr=void 0,this.buffCtr=void 0,this.radiusSize=0,this.skillAutoDis=0,this.normalActCount=0,this.currenSkillRunner=void 0,this.tauntValue=0,this._wantTarget=void 0,this._curTarget=void 0,this._nexPoint=void 0,this._wantSkill=void 0,this._curSkill=void 0,this._unlimitSkill=[],this.skillToSkill=void 0,this._stopAI=0,this._destroy=!1,this._healthActions=[],this._counterList=void 0,this._bindPos=void 0,this._curSecond=0,this._hurtCount=0,this.hurtNumCount=0,this.aiTime=0,this.battleMain=t}var n=t.prototype;return n.init=function(t){this.data=t,this._dead=!1,this._destroy=!1;var i=this.battleMain;for(var e in this.modelObj=i.renderMgr.allocUnitModel(this.unitId,t.modelConfig),this.radiusSize=t.modelConfig.radius,this.modelObj.mount=t.mount,this.setHpBar(t),null==this.statectr&&(this.statectr=new c,this.animatorctr=new r,this.movectr=new u,this.skillctr=new d,this.hatredCtr=new l,this.buffCtr=new h),this.statectr.init(this),this.animatorctr.init(this),this.movectr.init(this),this.skillctr.init(this),this.hatredCtr.init(this),this.buffCtr.init(this),this._aiRoot=this.newUnitAI(t),this._aiRoot.cast=this,this._bindPos={},f){var n=t.modelConfig[e];this._bindPos[f[e]]=new y(n[0],n[1])}this.data.modelConfig.chuxian_time>0?this.statectr.changeStateType(p.Born):this.statectr.changeStateType(p.Idle)},n.setHpBar=function(t){t.unitType.bar&&""!=t.unitType.bar&&this.battleMain.renderMgr.addHpBar(this,t.unitType.bar)},n.newUnitAI=function(t){return new aiMap[t.config.ai]},n.onUpdate=function(t){this.animatorctr.onUpdate(t),this.statectr.onUpdate(t),this.movectr.onUpdate(t),this.skillctr.onUpdate(t),this.buffCtr.onUpdate(t)},n.dump=function(t){void 0===t&&(t=null),this.battleMain.printLogDebug("战斗对象, "+this.data.unitId+",单位配置Id:"+this.data.config.id+", 当前血量 "+this.data.currenHp+", 剩余血量百分比 "+100*this.data.currenHp/this.data.attribs[S.hp].value+", 位置 "+this.modelObj.position.x+", "+this.modelObj.position.y);for(var i=S.min;i<=S.max;i++)(null==t||t.includes(i))&&this.data.attribs[i]&&0!=this.data.attribs[i].baseValue&&this.battleMain.printLogDebug("战斗对象, "+this.data.unitId+", 属性, "+i+", 值 "+this.data.attribs[i].value)},n.onLastUpdate=function(t){if(this._onCounterAction(),this._onHpAction(),this.data.currenHp>0&&this._checkSkillCounter(),GlobalDefine.DUMP_OBJECT&&this.dump(),this.skillctr.loadPassiveSkill(),this.skillctr.loadPetPassiveSkill(),this.skillctr.loadFlyPetPassiveSkill(),this.flyPet){for(var i=S.min;i<=S.max;i++)this.flyPet.data.attribs[i].setAttribValue(this.data.attribs[i]);this.data.currenHp>0&&(this.flyPet.data.currenHp=this.data.currenHp)}this._curSecond>=1&&(this._curSecond-=1)},n._onCounterAction=function(){var t=this._counterList;if(null!=t&&0!=t.length){for(var i=0;i<t.length;i++){var e=t[i];if(!e.isDead&&!e.isDestroy){var n=new C;n.init(this,this.data.counterAttack,!0),n.lockTarget=e,n.start(),this.skillctr.addRunner(n)}}t.length=0}},n._checkSkillCounter=function(){for(var t,e=this.buffCtr.getBuffByType(g.SKILL_COUNTER),n=i(e);!(t=n()).done;){var a=t.value,r=a.config.param1,h=a.config.param2,l=1;switch(r){case 1:var u=s.roundInt(1e4*s.round(this._hurtCount/this.data.getAttribByInt(S.hp)));if(u<h)continue;l=s.round(u/h),this._hurtCount=0;break;case 2:if(this.hurtNumCount<h)continue;this.hurtNumCount=s.roundInt(this.hurtNumCount-h)}var d=a.config.param3,c=b.newSkill(d,1);c.counterDamage=l,c.triggerEffect=!1;var f=new C;f.init(this,c,!0),f.start(),this.skillctr.addRunner(f),1==a.config.param4&&a.stop()}o(e)},n.onHpAction=function(t,i){},n.onAddDamage=function(t,i,e){},n._onHpAction=function(){var t=this._healthActions,e=this.data.getAttribByInt(S.hp);if(this._curSecond>=1){var n=s.roundInt(s.round(e*this.data.getAttrib(S.hp_recovery))*this.battleMain.treatDecay);n>0&&(this.data.currenHp=s.round(this.data.currenHp+n),this.data.currenHp=Math.min(this.data.currenHp,e)),n>0&&0==t.length&&this.battleMain.emit(T.UnitHpChange,this,n)}if(1!=this.battleMain.frameCount&&0!=t.length){var a=this.data.currenHp,r=this.data.shieldHp,h=null,l=null,u=null,d=this.buffCtr.getBuffByType(g.BLOCK);r>0&&(h=this.buffCtr.getBuffByType(g.SHIELD)),this.data.getBuffState(_.HpChangeTriger)>0&&(l=this.buffCtr.getBuffByType(g.HP_CHANGE_TRIGER)),this.data.getBuffState(_.TotalDamageTrigger)>0&&(u=this.buffCtr.getBuffByType(g.TOTAL_DAMAGE_TRIGGER));for(var c,f=this.buffCtr.getBuffByType(g.IMMUNE_DEATH),m=this.buffCtr.getBuffByType(g.ATTRIB_CONDITION),b=i(m);!(c=b()).done;){c.value.updateAttrib()}o(m);for(var y,C=0,H=!1,I=i(t);!(y=I()).done;){var M=y.value,D=M.health;switch(M.healthType){case k.Hurt:case k.Hurt_Crit:case k.Hurt_Ret:case k.Hurt_Share_Damage:case k.Hurt_Share_Damage_Crit:case k.Hurt_Double:case k.Hurt_Double_Crit:case k.Hurt_Bleed:if(this.battleMain.runningToPart)continue;if(D=Math.max(s.roundInt(D/this.battleMain.injuryReduce),1),this.battleMain.seasonPveDamAdd>0&&1==this.teamId&&(D=s.roundInt(D*(1+this.battleMain.seasonPveDamAdd))),M.health=D,H=P.includes(M.skillId),this.isCallType||this.battleMain.addLogCount(M.attacker_id,this.config.id,M.healthType,D,this.teamId,M.skillId,this.data.shieldHp),h&&this.data.shieldHp>0){for(var A,B=D,O=i(h);!(A=O()).done;){var L=A.value;if(D=s.roundInt(D-L.onShieldAction(D)),this.data.shieldHp<=0)break}this.isCallType||this.battleMain.addLogCount(M.attacker_id,this.config.id,k.Absorb,B-D,this.teamId,M.skillId,this.data.shieldHp)}if(D>0){if(d&&d.length>0){var x=d[0].onShieldAction(D);D=s.roundInt(D-x),this.isCallType||this.battleMain.addLogCount(M.attacker_id,this.config.id,50,x,this.teamId,M.skillId,this.data.shieldHp)}C=s.roundInt(C+D),this.data.currenHp=s.roundInt(this.data.currenHp-D);for(var U,R=i(f);!(U=R()).done;){U.value.checkTarget(this.data.currenHp)}if(this.data.immuneDeath?this.data.currenHp=Math.max(this.data.currenHp,1):this.data.currenHp=Math.max(this.data.currenHp,0),this.data.totalDamage=s.roundInt(this.data.totalDamage+D),l&&this.data.currenHp>0)for(var j,E=i(l);!(j=E()).done;){j.value.onDamage(this.data.currenHp)}if(u&&this.data.currenHp>0)for(var N,F=i(u);!(N=F()).done;){N.value.onTotalDamage(M.attacker_id)}GlobalDefine.CLIENT_TYPE||this.onAddDamage(M,v.Red,D)}this.battleMain.printLogFlag&&this.battleMain.printLogDebug("addDamage : "+JSON.stringify(M)+", "+D);break;case k.Treat:case k.Treat_Crit:case k.Skill_Hpsteal:case k.Act_Hpsteal:M.healthType==k.Treat&&(D=s.roundInt(D*this.battleMain.treatDecay)),C=s.roundInt(C-D),this.data.currenHp=s.roundInt(this.data.currenHp+D),this.data.currenHp=Math.min(this.data.currenHp,e),this.isCallType||this.battleMain.addLogCount(M.attacker_id,this.config.id,M.healthType,D,this.teamId,M.skillId,this.data.shieldHp),GlobalDefine.CLIENT_TYPE||this.onAddDamage(M,v.Add,D);break;case k.Miss:this.isCallType||this.battleMain.addLogCount(M.attacker_id,this.config.id,M.healthType,0,this.teamId,M.skillId,this.data.shieldHp)}if(this.battleMain.emit(T.FlyNum,this,D,M.healthType),w.free(M),this.data.currenHp<=0)break}t.length=0,o(h),o(l),o(u),o(f),this.data.currenHp=Math.max(this.data.currenHp,0),this.data.currenHp<=0&&!this.isCallType&&this.battleMain.data.recordType>0&&this.battleMain.data.recordWin==this.data.roleId&&(this.data.currenHp=1);var G=s.roundInt(this.data.currenHp-a);if(G<0&&(this._hurtCount=s.roundInt(this._hurtCount+Math.abs(G))),this.battleMain.emit(T.UnitHpChange,this,G),this.onHpAction(C,G),this.data.currenHp<=0)this.dead();else if(this.statectr.notControlled<=0&&G<0){if(this.modelObj.flash(),this.statectr.currentStateType==p.Idle&&H)this.statectr.currentState.freeNum>=2&&this.statectr.changeStateType(p.Hit);this.battleMain.emit(T.UnitHit,this)}this.battleMain.printLogFlag&&this.battleMain.printLogDebug("帧 "+this.battleMain.frameCount+", 战斗对象 "+this.data.unitId+", 血量 "+this.data.currenHp+",总伤害 "+C+" ,状态 "+this.statectr.currentStateType)}},n.idle=function(){this.animatorctr.hasState(m.ANIMATOR_IDLE)||this.animatorctr.changeState(m.ANIMATOR_IDLE),this.statectr.lockCurrenState=!1},n.destroy=function(){this._destroy||(this._destroy=!0,this._dead=!0,this._stop(),this.statectr.reset(),this.animatorctr.reset(),this.skillctr.reset(),this.movectr.reset(),this.hatredCtr.reset(),this.buffCtr.reset(),this.battleMain.unitMgr.destroyUnit(this))},n.destroyImmediate=function(){this.battleMain.renderMgr.freeUnitModel(this.modelObj),this.modelObj=null},n._stop=function(){this.wantSkill=null,this.curSkill=null,this.wantTarget=null,this.curTarget=null,this.nextPoint=null,this.movectr.stopMove(),this.skillctr.interrupt(),this.buffCtr.reset(),this.currenSkillRunner=null},n.throwHit=function(t,i,e){return this.statectr.currentStateType!=p.HitThrow&&(!this.isDead&&(!(this.statectr.invincible>0)&&(!(this.statectr.notControlled>0)&&(this.statectr.changeStateType(p.HitThrow),this.statectr.getState(p.HitThrow).setThrowHit(t,i,e),!0))))},n.lookAt=function(t){if(t&&this.position){var i=s.round(t.x-this.position.x);this.modelObj.direction=i>0?1:-1}},n.dead=function(t){if(void 0===t&&(t=!0),!this._dead){t&&this.skillctr.onDeadTargetAction(),this.battleMain.printLogFlag&&this.battleMain.printLogDebug("帧 "+this.battleMain.frameCount+", 战斗对象死亡 "+this.data.unitId),this._stop(),this._dead=!0;var i=this.battleMain;i.renderMgr.removeHpBar(this),i.emit(T.UnitDead,this),this.changeDeadState(t)}},n.hit=function(t,i,e,n){void 0===n&&(n=0);var a=w.alloc();a.attacker_id=null==t?0:t.unitId,a.defence_id=this.unitId,a.health=i,a.healthType=e,a.skillId=n,this._healthActions.push(a)},n._getBindPos=function(t,i){if(this.data.mount>0){var e=configMount.getDataByKey(this.data.mount).binds[this.data.modelConfig.mountPos-1];return D.add2f(s.round(t*this.direction)+s.round(e[0]*this.direction),s.round(i+e[1]))}return D.add2f(s.round(t*this.direction),i)},n.getBindPos=function(t){if(null==this.modelObj)return D;if(D.set(this.modelObj.position),null!=this._bindPos[t]){var i=this._bindPos[t];return this._getBindPos(i.x,i.y)}return D},n.getBindPosByAction=function(t){if(null==this.modelObj)return D;if(D.set(this.modelObj.position),null!=t)return this._getBindPos(t[0],t[1]);var i=this._bindPos[f.bp_lead];return this._getBindPos(i.x,i.y)},n.addCounter=function(t){var i;this._counterList=null!=(i=this._counterList)?i:[],-1==this._counterList.indexOf(t)&&this._counterList.push(t)},n.changeDeadState=function(t){(void 0===t&&(t=!0),this.statectr.currentStateType!=p.Dead)&&(this.statectr.changeStateType(p.Dead),this.statectr.getState(p.Dead).setParam(t))},n.applySkill=function(t){void 0===t&&(t=!1);var i=this._wantSkill;i&&(this._curSkill=i,this._wantSkill=null),null!=this.curSkill&&null!=this.curSkill.skill&&0!=this.curSkill.skill.state&&(this.curSkill=null),t&&(this._curSkill=null)},n.applyPostion=function(){var t=this._nexPoint;null!=t&&(t.priority!=H.TP_Move&&this.movectr.stopMove(),this.position=t.nextPos,t=null)},n.applyTarget=function(t){void 0===t&&(t=!1);var i=this._wantTarget;null!=i&&(this.curTarget=i,this._wantTarget=null);var e=this._curTarget;if(null!=e){if(null!=e.unit&&(e.unit.isDead||e.unit.isDestroy))return void(this.curTarget=null);t&&e.type==I.T_Position&&e.priority==I.TP_AutoFind&&(this.curTarget=null)}},n.checkTarget=function(){if(null==this.curTarget)return null;if(null!=this.curSkill)return 0!=this.curSkill.skill.state?null:this.curSkill.skill;if(null==this.data.attack)return null;var t=this.curTarget;if(null!=t&&t.type==I.T_Unit){if(t.unit.isDead)return this.curTarget=null,null;if(0!=this.data.attack.state)return null;var i=s.distanceX(this.position,t.unit.position);if((i=s.round(i-s.roundInt(this.radiusSize+t.unit.radiusSize)))<=this.attackDistance&&0==this.statectr.banAct)return this.data.attack}return null},n.onThink=function(t){if(!this._dead){if(this._curSecond=s.round(this._curSecond+t),this.applyPostion(),this.hatredCtr.onUpdate(t),this.aiTime=s.round(this.aiTime+t),this.canThink()&&this.think(t),0==this.statectr.beControlled&&this._unlimitSkill.length>0){for(var e,n=i(this._unlimitSkill);!(e=n()).done;){var a,r=e.value,h=new C;h.init(this,r,!0),h.lockTarget=null==(a=this.curTarget)?void 0:a.unit,h.start(),this.skillctr.addRunner(h),1==this.battleMain.collectRecord&&0==this.teamId&&this.battleMain.curRecord.addCommandSKill(this.unitId,r.config.id)}this._unlimitSkill.length=0}if(null!=this.skillToSkill){var o,l=new C;l.init(this,this.skillToSkill,!0),l.lockTarget=null==(o=this.curTarget)?void 0:o.unit,l.start(),this.skillctr.addRunner(l),this.skillToSkill=null}}},n.canThink=function(){return null!=this._aiRoot&&(!(this._stopAI>0)&&(!(this.statectr.beControlled>0)&&(this.statectr.currentStateType==p.Idle||this.statectr.currentStateType==p.Move)))},n.think=function(t){this._aiRoot.handleAction()},n.addUnlimitSkill=function(t){this.skillctr.isLoadPassive&&(this._unlimitSkill.includes(t)||0==t.state&&this._unlimitSkill.push(t))},e(t,[{key:"attackDistance",get:function(){return this.data.attribs[S.att_range].value}},{key:"config",get:function(){return this.data.config}},{key:"position",get:function(){var t;return null==(t=this.modelObj)?void 0:t.position},set:function(t){null!=this.modelObj&&(this.modelObj.position=t)}},{key:"direction",get:function(){return null==this.modelObj?1:this.modelObj.direction},set:function(t){this.modelObj.direction=t}},{key:"isDestroy",get:function(){return this._destroy}},{key:"isDead",get:function(){return this._dead}},{key:"visible",get:function(){return this.modelObj.visible},set:function(t){this.modelObj.visible=t}},{key:"curSkill",get:function(){return this._curSkill},set:function(t){this._curSkill!=t&&(null!=this._curSkill?(M.free(this.curSkill),this._curSkill=t):this._curSkill=t)}},{key:"wantSkill",get:function(){return this._wantSkill},set:function(t){if(this._wantSkill!=t){if(null!=this._wantSkill)return null==t?(M.free(this._wantSkill),void(this._wantSkill=null)):void(this._wantSkill.priority>t.priority?M.free(t):(M.free(this._wantSkill),this._wantSkill=t));this._wantSkill=t}}},{key:"nextPoint",get:function(){return this._nexPoint},set:function(t){if(this._nexPoint!=t)return null==t?(null!=this._nexPoint&&H.free(this.nextPoint),void(this._nexPoint=null)):void(null!=this._nexPoint?t.priority<this._nexPoint.priority?H.free(t):(H.free(this._nexPoint),this._nexPoint=t):this._nexPoint=t)}},{key:"curTarget",get:function(){return this._curTarget},set:function(t){this._curTarget!=t&&(null!=this._curTarget?(I.free(this._curTarget),this._curTarget=t):this._curTarget=t)}},{key:"wantTarget",get:function(){return this._wantTarget},set:function(t){if(this._wantTarget!=t){if(null!=this._wantTarget)return null==t?(I.free(this._wantTarget),void(this._wantTarget=null)):void(this._wantTarget.priority>t.priority?I.free(t):(I.free(this._wantTarget),this._wantTarget=t));this._wantTarget=t}}},{key:"stopAI",set:function(t){this._stopAI=t,this._stopAI=Math.max(0,this._stopAI),this._stopAI>0&&this._stop()}},{key:"depth",get:function(){return this.modelObj.depth},set:function(t){this.modelObj.depth=t}},{key:"hatredType",get:function(){return this.config.hatred_type}},{key:"weapon",get:function(){return this.data.weaponId>0?this.data.weaponId:null!=this.data.skin?this.data.skin.weapon:void 0}}]),t}());n._RF.pop()}}}));

