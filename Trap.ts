System.register("chunks:///_virtual/Trap.ts",["./rollupPluginModLoBabelHelpers.js","cc","./ListPool.ts","./ObjectPool.ts","./V2.ts","./FixMath.ts","./EnumDefine.ts"],(function(t){"use strict";var e,i,s,r,a,n,c;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy},function(t){s=t.ListPool},function(t){r=t.ObjectPool},function(t){a=t.V2},function(t){n=t.FixMath},function(t){c=t.BattleFlag}],execute:function(){var f;i._RF.push({},"20101b9rn5N5pq7ab84ueB2","Trap",void 0),function(t){t[t.One=0]="One",t[t.RepeatOne=1]="RepeatOne",t[t.Repeat=2]="Repeat"}(f||(f={}));var o=t("Trap",function(){function t(){this.runner=void 0,this.trapConfig=void 0,this.pos=new a,this.curTime=0,this.curTotalTime=0,this.state=-1,this.skillPar=0,this.isStop=!1,this.triggerList=[],this.effect=void 0,this.maxTime=0}t.trigger=function(t,i){var s=t.runner,r=t.trapConfig,a=s.getTargets(r.target[0],r.range,i,r.target[1],r.target[2]);if(0!=a.length){for(var n,c=t.triggerList,o=u.alloc(),l=e(a);!(n=l()).done;){var h=n.value;if(r.type==f.RepeatOne){if(o.push(h.unitId),c.includes(h.unitId))continue;c.push(h.unitId)}for(var g,p=e(r.buffId);!(g=p()).done;){var d=g.value;s.addBuff(h,d[0],s.cast.data.getSkillFactAttrValue(d[1],s.useSkill.config.id,1041),t.skillPar)}}if(r.type==f.RepeatOne)for(var T=0;T<c.length;T++)o.includes(c[T])||(c.splice(T,1),T--);u.free(o)}};var i=t.prototype;return i._triggerAction=function(){var e=this.trapConfig;this.loadEffect(0);var i=this.runner.battleMain;switch(e.type){case f.One:if(this.isStop=!0,!(i.battleFlag&c.OPEN_GRAPHIC))break;if(i.battleFlag&c.UI_MASK)break;if(e.teffectId>0){var s=configEffect.getDataByKey(e.teffectId);if(s&&s.is_ban&&i.battleFlag&c.SIMP_MODEL)break;var r=i.renderMgr.allocEffect(e.teffectId,null);r.position=this.pos,r.scale*=i.effectScale}break;case f.Repeat:this.state=1,this.curTime=0,this.maxTime=0,0==e.execute.length?this.isStop=!0:(this.maxTime=this.runner.cast.data.getSkillFactAttrValue(e.execute[1],this.runner.useSkill.config.id,1041),this.loadEffect(e.teffectId))}t.trigger(this,this.pos)},i.loadEffect=function(t){if(null!=this.effect&&this.effect.free(),this.effect=null,0!=t){var e=this.runner.battleMain;if(e.battleFlag&c.OPEN_GRAPHIC&&!(e.battleFlag&c.UI_MASK)){var i=configEffect.getDataByKey(t);i&&i.is_ban&&e.battleFlag&c.SIMP_MODEL||(this.effect=e.renderMgr.allocEffect(t,null,-1),this.effect.position=this.pos,this.effect.scale*=e.effectScale)}}},i.onUpdate=function(e){if(!this.isStop){-1==this.state&&(this.loadEffect(this.trapConfig.effectId),this.state=0);var i=this.trapConfig,s=this.runner.battleMain;if(0==this.state){s.unitMgr.findTarget(this.runner.cast,i.triggerTarget,i.triggerRange,this.pos).length>0&&this._triggerAction(),this.curTime>=i.duration&&(this.isStop=!0)}else{this.curTime>=i.execute[0]&&(t.trigger(this,this.pos),this.curTime=n.round(this.curTime-i.execute[0]));var r=0!=this.maxTime?this.maxTime:i.execute[1];this.curTotalTime>=r&&(this.isStop=!0),this.curTotalTime=n.round(this.curTotalTime+e)}this.curTime=n.round(this.curTime+e)}},i.cacheReset=function(){this.isStop=!1,this.runner=null,this.curTime=this.curTotalTime=this.skillPar=this.maxTime=0,this.state=-1,this.triggerList.length=0,null!=this.effect&&this.effect.free(),this.effect=null},i.cacheDestroy=function(){this.cacheReset()},t.alloc=function(t,e,i){var s=l.alloc();return s.trapConfig=t,s.skillPar=i,s.pos.set(e),s},t.free=function(t){l.free(t)},t}()),l=new r(o,50),u=new s;i._RF.pop()}}}));

