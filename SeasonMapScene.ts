System.register("chunks:///_virtual/SeasonMapScene.ts",["./rollupPluginModLoBabelHelpers.js","cc","./BattleData.ts","./V2.ts","./NodeUtil.ts","./TimeUtil.ts","./SpineSkeleton.ts","./UIEffectAsset.ts","./ConfigSeason_kv.ts","./SLGMapData.ts","./SLGMapMgr.ts","./ChapterDataCache.ts","./MessageView.ts","./SeasonDefine.ts","./SeasonSceneControl.ts","./SeasonSceneDataCache.ts","./SceneBattle.ts","./SceneBuilding.ts","./SceneCamera4.ts","./SceneLine3.ts","./SceneSelect2.ts"],(function(e){"use strict";var t,i,a,n,s,o,r,d,l,h,c,f,p,u,g,v,m,S,M,C,_,y,w,x,T,I,P,R,b,D,E,F,L,O,U,V;return{setters:[function(e){t=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy,a=e.Rect,n=e.find,s=e.Vec3,o=e.Prefab,r=e.Camera,d=e.Node,l=e.screen,h=e.Vec2,c=e.sys,f=e.Sprite,p=e.Label,u=e.Color},function(e){g=e.ChapterType},function(e){v=e.V2},function(e){m=e.default},function(e){S=e.default},function(e){M=e.SpineSkeleton},function(e){C=e.UIEffectAsset},function(e){_=e.ConfigSeason_kv},function(e){y=e.SLGMapData},function(e){w=e.SLGMapMgr},function(e){x=e.ChapterDataCache},function(e){T=e.default},function(e){I=e.SeasonEventDefine,P=e.RoleUpdateFlag,R=e.MoveUpdateFlag,b=e.SceneObjType},function(e){D=e.default},function(e){E=e.SeasonSceneDataCache},function(e){F=e.SceneBattle},function(e){L=e.SceneBuilding},function(e){O=e.SceneCamera},function(e){U=e.SceneLine},function(e){V=e.SceneSelect}],execute:function(){i._RF.push({},"70fdaxFYhNDvoMuuYnIAhQX","SeasonMapScene",void 0);var j=new a,A=e("_regionColors",[]),G={0:["dhh_icon_fangshou02","dhh_text_fangshou02"],4:["dhh_icon_fangshou01","dhh_text_fangshou01"],3:["dhh_icon_fangshou03","dhh_text_fangshou03"],1:["dhh_icon_fangshou04","dhh_text_fangshou04"],2:["dhh_icon_fangshou05","dhh_text_fangshou05"]};e("SeasonMapScene",function(){function e(e){this.node=void 0,this.view=void 0,this.mapCamera=new O,this.units=[],this.unitMap={},this.regionMap={},this.moveMap={},this.flagMap={},this.flagDefMap={},this.flagRevivie=void 0,this.nodeUnitMap={},this.nodeMap=void 0,this.onLoadViewSuccess=void 0,this.startScreenPos=void 0,this.startCameraPos=void 0,this.selectTarget=void 0,this.selectGrid=void 0,this.battleInfo=void 0,this.cameraTagPos=void 0,this.sendViewTime=void 0,this.updateFlagTime=1,this._objUid=1,this.selfShip=void 0,this.view=e,j.width=3112.5,j.height=1237.5,j.center=h.ZERO;for(var t=_.SEASON_BASE_CAMP_COLOR,i=0;i<t.length;i++)A[i]=u.fromHEX(new u,t[i])}var i=e.prototype;return i.load=function(){var e=this;this.node||(null!=this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/season/scene/MapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),this.onLoadViewSuccess=function(t){if(e.onLoadViewSuccess=null,!t.error&&null!=t.item&&null!=t.item.asset){var i=t.item.asset,a=nodeInstantiate.instantiate(i);a.name="SeasonMapScene",e.node=a,a.setParent(n("UIRoot").parent),a.position=new s(-3e4,0),a.setSiblingIndex(1),e.onInit()}},resourceMgr.loadRes("ui/module/season/scene/MapScene",o,this.onLoadViewSuccess))},i.onInit=function(){for(var e,i=this,a=m.findChild(this.node,"unit"),n=t(a.children);!(e=n()).done;){var o=e.value;this.nodeUnitMap[o.name]=o}this.nodeMap=m.findChild(this.node,"map"),this.mapCamera.nodeCamera=m.findChild(this.node,"SceneCamera"),this.mapCamera.camera=this.mapCamera.nodeCamera.getComponent(r);var f=this.view,p=0,u=0;f.addComponentCallbackListener(this.nodeMap,d.EventType.TOUCH_START,(function(e){var t=e.getLocation();if(t.x<0||t.x>l.windowSize.width)return i.startScreenPos=null,void(u=0);var a=new s(t.x,t.y,0);i.startScreenPos=new h(a.x/l.devicePixelRatio,a.y/l.devicePixelRatio),i.startCameraPos=new s(i.mapCamera.oriPos.x,i.mapCamera.oriPos.y),p=c.now(),u=1,i.sendViewTime=c.now(),i.cameraTagPos=new h(i.mapCamera.oriPos.x,i.mapCamera.oriPos.y),i.mapCamera.toTargetPos(i.mapCamera.oriPos,0)})),f.addComponentCallbackListener(this.nodeMap,d.EventType.TOUCH_MOVE,(function(e){if(!(1!=u&&2!=u||c.now()-p<200)){u=2;var t=e.getLocation();if(!(t.x<0||t.x>l.windowSize.width)){var a=new h;a.x=t.x/l.devicePixelRatio-i.startScreenPos.x,a.y=t.y/l.devicePixelRatio-i.startScreenPos.y;var n=new h(2*-a.x+i.startCameraPos.x,2*-a.y+i.startCameraPos.y);i.mapCamera.toTargetPos(n,0),i.cameraTagPos=n}}})),f.addComponentCallbackListener(this.nodeMap,d.EventType.TOUCH_END,(function(e){if(1==u){u=3;var t=e.getLocation(),a=new h;if(a.x=t.x/l.devicePixelRatio-i.startScreenPos.x,a.y=t.y/l.devicePixelRatio-i.startScreenPos.y,p=0,i.cameraTagPos=null,a.length()<20){var n=new s(t.x,t.y,0),o=i.mapCamera.camera.screenToWorld(n);o.add3f(3e4,0,0),i.checkClick(o)}else{var r=new s(5.5*-a.x+i.startCameraPos.x,5.5*-a.y+i.startCameraPos.y);i.mapCamera.toTargetPos(r,2);var d=new h(i.mapCamera.destPos.x,i.mapCamera.destPos.y),c=y.getPosToCR(d.x,d.y);IS(D).reqSceneView({x:c.x,y:c.y})}}})),this.open()},i.registerEvent=function(){this.view.addEvent(I.SEASON_SCENE_ENTER,this.onSceneEnter,this),this.view.addEvent(I.SEASON_SCENE_QUIT,this.onSceneQuit,this),this.view.addEvent(I.SEASON_SCENE_GOTO,this.onGoto,this),this.view.addEvent(I.SEASON_SCENE_VIEW,this.onCameraView,this)},i.open=function(){if(this.node)return this.registerEvent(),this.node.active||(this.node.active=!0),void this.onAfterOpen();this.load()},i.close=function(){this.node&&this.node.active&&(this.node.active=!1),null!=this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/crosswar/CrosswarMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),IS(w).exitMap(),this.onBeforeClose()},i.destroy=function(){this.close(),this.node&&(this.node.destroy(),resourceMgr.releaseResRef("ui/module/crosswar/CrosswarMapScene"),this.node=null)},i.onAfterOpen=function(){IS(w).exitMap(),IS(w).enterMap("slg_map_s1"),IS(w).curMap.parent=this.nodeMap;var e=IS(w).curMap.box;this.mapCamera.setMapSize(e.width-180,e.height-180);var t=IS(E).viewPos,i=y.getCRToPos(t.x,t.y);this.mapCamera.toTargetPos(i,0),this.activeSelfShip(),uiMgr.close("SeasonMapLoadView")},i.onBeforeClose=function(){for(var e in this.cancelSelect(),this.mapCamera.follow=null,this.moveMap)this.moveMap[e].destroy();for(var t in this.moveMap={},this.unitMap)this.unitMap[t].destroy();for(var i in this.unitMap={},this.units.length=0,this.regionMap)this.regionMap[i].destroy();for(var a in this.regionMap={},this.flagMap)this.flagMap[a].destroy();for(var n in this.flagMap={},this.flagDefMap)this.flagDefMap[n].destroy();this.flagDefMap={},this.flagRevivie&&this.flagRevivie.free(),this.flagRevivie=null,this.updateFlagTime=1,this.selfShip&&this.selfShip.destroy(),this.selfShip=null},i.onDestroy=function(){},i.onCameraView=function(e){var t;if(null!=(t=IS(w).curMap)&&t.root){var i=y.getPosToCR(e.x,e.y),a=new h(i.x,i.y);IS(D).reqSceneView(a),this.mapCamera.toTargetPos(new s(e.x,e.y),0)}},i.checkClick=function(e,t){var i;if(this.selectGrid=null,null!=(i=IS(w).curMap)&&i.root){var a=IS(w).curMap.getData(),n=y.getPosToCR(e.x,e.y),o=new h(n.x,n.y),r=y.getCRToIndex(n.x,n.y);if(0==a.collider[r])return this.cancelSelect(),void T.showFlyTip(GetLanguage(302171));null==this.selectTarget&&(this.selectTarget=new V(this));var d=IS(E).gridMap;this.selectGrid=null!=t?t:d[r];var l=y.getCRToPos(n.x,n.y);this.selectGrid&&(l=y.getIndexToCR(this.selectGrid.id),l=y.getCRToPos(l.x,l.y)),this.selectTarget.position=new v(l.x,l.y),this.selectTarget.refresh(),IS(D).reqSceneView(o),this.mapCamera.toTargetPos(new s(l.x,l.y),1)}},i.cancelSelect=function(){var e;null==(e=this.selectTarget)||e.destroy(),this.selectTarget=null},i.onUpdate=function(e){var t,i,a;if(this.node){if(this.cameraTagPos&&c.now()-this.sendViewTime>=500){var n=y.getPosToCR(this.cameraTagPos.x,this.cameraTagPos.y);IS(D).reqSceneView({x:n.x,y:n.y}),this.cameraTagPos=null}IS(w).update();var s=IS(E);if(IS(w).curMap.root){if(0!=s.gridUpdateFlag&&(s.gridUpdateFlag&P.Add&&this.addSceneObj(),s.gridUpdateFlag&P.Del&&this.delSceneObj()),s.gridUpdateFlag=0,0!=s.moveUpdateFlag&&(s.moveUpdateFlag&R.Add&&this.addMoveObj(),s.moveUpdateFlag&R.Del&&this.delMoveObj()),s.moveUpdateFlag=0,s.teamInfo&&s.teamInfo.born_pos){var o=s.teamInfo.born_pos,r=y.getCRToPos(o.x,o.y);if(!this.flagRevivie||this.flagRevivie.position.x!=r.x||this.flagRevivie.position.y!=r.y){this.flagRevivie&&this.flagRevivie.free(),this.flagRevivie=null;var d=configSeason_building_plot.getDataByKey(s.teamInfo.born_base_id),l=C.alloc("ui/module/season/scene/FlagRevivie",this.nodeUnitMap.flag,-1,(function(e){var t=e.node;m.findChildComponent(t,"spine",M).findBone("biaoji").y=d.height}));l.position=new v(r.x,r.y),l.scale=1,this.flagRevivie=l}}if(this.updateFlagTime<=0){this.updateFlagTime=1;var h=s.gridMap;for(var f in h)h[f].spy_end_time>0&&this.updateFlag(h[f]),h[f].defend_num&&h[f].defend_num>0&&this.updateDefFlag(h[f])}this.updateFlagTime-=e}for(var p=0;p<this.units.length;p++){var u=this.units[p];u.del?(u.destroy(),this.units.splice(p,1),p--):u.update(e)}this.mapCamera.onUpdate(e),null==(t=IS(w).curMap)||t.updateViewCenter(this.mapCamera.oriPos.x,this.mapCamera.oriPos.y),null==(i=this.selectTarget)||i.update(e),null==(a=this.battleInfo)||a.update(e);var S=IS(x),_=S.currentLoadType==g.Main||S.chapterType==g.Main;this.node&&this.node.active!=_&&(this.node.active=_,this.view.visible=_)}},i.onSceneEnter=function(e){var t=y.getCRToPos(e.x,e.y);this.mapCamera.toTargetPos(t,0)},i.onSceneQuit=function(){},i.onGoto=function(e,t,i,a){var n,s=y.getIndexToCR(i),o=y.getCRToPos(s.x,s.y),r={id:i,area_id:0,serv_id:a=null!=(n=a)?n:0};11!=t&&(r.fill_obj={pos:new h(o),obj_id:0,obj_type:1,serv_id:a,base_id:t}),e&&(r.spy_end_time=S.serverTime+30),this.checkClick(o,r)},i._addSceneObj=function(e){if(e){null!=this.battleInfo&&this.battleInfo.info.id==e.id&&(this.battleInfo.destroy(),this.battleInfo=null),2==e.state&&(this.battleInfo&&this.battleInfo.destroy(),this.battleInfo=null,this.battleInfo=new F(this,e));var t=null;if(e.fill_obj){switch(e.fill_obj.obj_type){case b.S1_Base:case b.S1_Rss:case b.S1_Hold:case b.S1_Empire:case b.S1_Monster:case b.S1_Relic:case b.S1_AirDrop:t=new L(this,e,this._objUid),this._objUid++}this.units.push(t),this.unitMap[t.id]=t}else 1==e.state&&e.area_id>0&&this.addRegion(e.id,e.area_id);this.updateFlagTime=1,this.updateFlag(e),this.updateDefFlag(e)}},i.updateFlag=function(e){if(!this.flagMap[e.id]&&e.spy_end_time-S.serverTime>0){var t=11;e.fill_obj&&(t=e.fill_obj.base_id);var i=configSeason_building_plot.getDataByKey(t),a=C.alloc("ui/module/season/scene/Flag",this.nodeUnitMap.flag,-1,(function(e){var t=e.node;m.findChildComponent(t,"spine",M).findBone("biaoji").y=i.height})),n=y.getIndexToCR(e.id);n=y.getCRToPos(n.x,n.y),a.position=new v(n.x,n.y),a.scale=1,this.flagMap[e.id]=a}else this.flagMap[e.id]&&e.spy_end_time-S.serverTime<=0&&(e.spy_end_time=0,this.delFlag(e.id))},i.delFlag=function(e){var t=this.flagMap[e];t&&(t.free(),delete this.flagMap[e])},i.updateDefFlag=function(e){var t=this;if(!this.flagDefMap[e.id]&&e.defend_num>0){var i=C.alloc("ui/module/season/scene/FlagDef",this.nodeUnitMap.flagDef,-1,(function(i){var a=i.node,n=m.findChildComponent(a,"bg",f),s=m.findChildComponent(a,"bg1",f),o=m.findChildComponent(a,"txtNum",p);t.view.loadIcon(n,"season_map",G[e.area_id][0]),t.view.loadIcon(s,"season_map",G[e.area_id][1]),o.string=String(e.defend_num),c.uiMirror&&o.node.setScale(1,1,1)})),a=y.getIndexToCR(e.id);a=y.getCRToPos(a.x,a.y),i.position=new v(a.x,a.y),i.scale=1,this.flagDefMap[e.id]=i}else if(this.flagDefMap[e.id]&&e.defend_num>0){var n=this.flagDefMap[e.id];if(n.node){var s=m.findChildComponent(n.node,"txtNum",p);s.string=String(e.defend_num),c.uiMirror&&s.node.setScale(1,1,1)}}else this.flagDefMap[e.id]&&e.defend_num<=0&&(e.spy_end_time=0,this.delDefFlag(e.id))},i.delDefFlag=function(e){var t=this.flagDefMap[e];t&&(t.free(),delete this.flagDefMap[e])},i.addRegion=function(e,t,i){void 0===i&&(i=0),this.regionMap[e]&&(this.regionMap[e].free(),delete this.regionMap[e]);var a=C.alloc("ui/module/season/scene/Region",IS(w).curMap.region,-1,(function(e){e.node.getComponent(f).color=A[t-1]})),n=y.getIndexToCR(e),s=y.getCRToPos(n.x,n.y);a.position=new v(s.x,s.y),a.scale=1,a._uid_=i,this.regionMap[e]=a},i.delRegion=function(e,t){void 0===t&&(t=0);var i=this.regionMap[e];if(i){if(t>0&&i._uid_!=t)return;i.free(),delete this.regionMap[e]}},i.addSceneObj=function(){for(var e,i=IS(E),a=i.gridMap,n=i.gridActions[P.Add],s=t(n);!(e=s()).done;){var o=e.value,r=a[o];if(this.unitMap[o]){var d=this.unitMap[o];this.units.splice(this.units.indexOf(d),1),this.selectGrid&&this.selectGrid.id==d.id&&(this.selectGrid=r,this.selectTarget&&this.selectTarget.refresh()),d.destroy(),delete this.unitMap[o]}r&&this._addSceneObj(r)}n.clear()},i.delSceneObj=function(){for(var e,i=IS(E).gridActions[P.Del],a=t(i);!(e=a()).done;){var n=e.value;this.delFlag(n),this.delDefFlag(n),this.unitMap[n]?(this.unitMap[n].del=!0,delete this.unitMap[n],null!=this.battleInfo&&this.battleInfo.info.id==n&&(this.battleInfo.destroy(),this.battleInfo=null)):this.delRegion(n)}i.clear()},i.addMoveObj=function(){for(var e,i=IS(E),a=i.moveMap,n=i.moveActions[R.Add],s=t(n);!(e=s()).done;){var o=e.value;if(this.moveMap[o]){var r=this.moveMap[o];this.units.splice(this.units.indexOf(r),1),r.destroy(),delete this.moveMap[o]}var d=a[o];if(d){var l=new U(this,d);this.units.push(l),this.moveMap[l.id]=l}}n.clear()},i.delMoveObj=function(){for(var e,i=IS(E).moveActions[R.Del],a=t(i);!(e=a()).done;){var n=e.value;this.moveMap[n]&&(this.moveMap[n].del=!0,delete this.moveMap[n])}i.clear()},i.activeSelfShip=function(){var e;if(this.node){var t=IS(E).teamInfo;if(null!=t)switch(t.state){case 1:case 2:case 5:this.selfShip||(this.selfShip=new U(this,null));var i=IS(E);if(i.teamInfo&&i.teamInfo.now_pos){var a=y.getCRToPos(i.teamInfo.now_pos.x,i.teamInfo.now_pos.y);this.selfShip.position=new v(a.x,a.y)}break;default:null==(e=this.selfShip)||e.destroy(),this.selfShip=null}}},e}());i._RF.pop()}}}));

