System.register("chunks:///_virtual/UIMgr.ts",["./rollupPluginModLoBabelHelpers.js","cc","./UILabelUpdate.ts","./BaseView.ts","./UIDefine.ts"],(function(e){"use strict";var i,t,n,s,o,r,l,a,h,c,u,p,f,w,v,d;return{setters:[function(e){i=e.createForOfIteratorHelperLoose,t=e.createClass,n=e.asyncToGenerator,s=e.regeneratorRuntime},function(e){o=e.cclegacy,r=e.director,l=e.Director,a=e.sys,h=e.find,c=e.Camera,u=e.Vec3,p=e.Font},function(e){f=e.labelUpdate},function(e){w=e.ViewEvent},function(e){v=e.UIViewState,d=e.ViewType}],execute:function(){o._RF.push({},"a0450zKRhVGo6oVwmi47MGV","UIMgr",void 0);var V=["MainView","BattleHubView"];e("UIMgr",function(){function e(){this.pNodes={},this.uiCamera=void 0,this.openList=[],this.closeList=[],this.closeingList=[],this.openingList=[],this.allViews=new Map,this._renderList=[],this._renderMap=new Map,this._closeProcessing=!1,this.popQueue=[],this.curPopView=void 0,this.viewSort={},this.lastClickObj=void 0,this.isOpenGuide=!1,this.guidePassView="",this.checkView="",this.openFullScreenNum=new Set,this.hideViewList=[],this._UIFont=void 0;var e=h("UIRoot/NormalView"),i=h("UIRoot/TopView");if(this.pNodes[d.NormalView]=e,this.pNodes[d.TopView]=i,this.pNodes[d.GuideView]=h("UIRoot/GuideView"),this.pNodes[d.BattleView]=h("UIRoot/BattleView"),this.pNodes[d.ReconnectView]=h("UIRoot/ReconnectView"),this.uiCamera=h("UIRoot/UICamera").getComponent(c),r.on(l.EVENT_AFTER_DRAW,this.onClearCloseView,this),normalEvent.on(w.ViewClose,this.onViewClose,this),normalEvent.on(w.ViewOpen,this.onViewOpen,this),a.uiMirror)for(var t in this.pNodes)this.pNodes[t].scale=new u(-1,1,1)}var o=e.prototype;return o.clear=function(){this.pNodes={},this.uiCamera=null,this.openList.length=0,this.closeList.length=0,this.allViews.clear(),this.closeingList.length=0,this.popQueue.length=0,f.clear(),r.off(l.EVENT_AFTER_DRAW,this.onClearCloseView,this)},o.addRender=function(e){this._renderMap.has(e)||(this._renderList.push(e),this._renderMap.set(e,!0))},o.createView=function(e){var i=ModuleInclude[e];if(null==i)throw Error(e+" no register class!");return new i},o.CheckOpenView=function(e){return!0},o.openViewByUrl=function(e){var i=this.checkView;if(this.CheckOpenView(i)){var t=this.allViews.get(i);if(null==t)return(t=this.createView(i)).url="ui/module/common/"+e,this.allViews.set(i,t),t.open(),t;for(var n=this.closeList,s=0;s<n.length;s++)if(n[s]==t){n.splice(s,1);break}var o=this.closeingList.indexOf(t);return-1!=o&&this.closeingList.splice(o,1),t.url="ui/module/common/"+e,t.open(),t}},o.openView=function(e){if("ReconnectView"==e||!this.isOpenGuide||"all"==this.guidePassView||this.guidePassView==e){for(var i=this.allViews.get(e),t=arguments.length,n=new Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];if(null==i)return i=this.createView(e),this.allViews.set(e,i),i.open(n),i;for(var o=this.closeList,r=0;r<o.length;r++)if(o[r]==i){o.splice(r,1);break}var l=this.closeingList.indexOf(i);return-1!=l&&this.closeingList.splice(l,1),i.open(n),i}printLogWarn("引导中不能打开界面:",e)},o.GetTopOpenView=function(e){for(var i=this.openList.length-1;i>=0;i--)if(!e.includes(this.openList[i].name))return this.openList[i];for(var t=this.openingList.length-1;t>=0;t--)if(!e.includes(this.openingList[t].name))return this.openingList[t];return null},o.close=function(e){if(this._closeProcessing)printLogErr("正在处理关闭操作，不能调用！",e);else{var i=this.allViews.get(e);null!=i&&i.close()}},o.closeAllView=function(e){void 0===e&&(e=[]);var t=this.allViews.values(),n={};if(e)for(var s,o=i(e);!(s=o()).done;){n[s.value]=!0}for(var r,l=i(t);!(r=l()).done;){var a=r.value;"ReconnectView"!=a.name&&("MainView"!=a.name&&1!=n[a.name]&&a.close())}},o.closeAll=function(){for(var e,t=this.allViews.values(),n=[],s=i(t);!(e=s()).done;){var o=e.value;n.push(o)}n.forEach((function(e){e.close()})),n.length=0,this.allViews.clear(),this.closeList.length=0,this.openList.length=0;for(var r=0;r<this._renderList.length;r++){this._renderList[r].free()}this._renderList.length=0,this._renderMap.clear()},o.addCloseTask=function(e){this.closeingList.includes(e)||(uiMgr.CloseViewSortIdx(e),this.closeingList.push(e))},o.addOpenTask=function(e){this.openingList.includes(e)||this.openingList.push(e)},o.removeOpenTask=function(e){var i=this.openingList.indexOf(e);-1!=i&&this.openingList.splice(i,1)},o.update=function(e){for(var t,n=i(this.openList);!(t=n()).done;){t.value._update(e)}ftime.beginFTime(ftime.UIOpen);for(var s=0;s<this.openingList.length;s++){if(this.openingList[s]._openView(),this.openingList.splice(s,1),s--,ftime.checkPass(ftime.UIOpen))break}for(var o=0;o<this._renderList.length;o++){var r=this._renderList[o];r.isDestroy?(this._renderList.splice(o,1),this._renderMap.delete(r),o--):r.onUpdate(e)}},o.onClearCloseView=function(){this._closeProcessing=!0;for(var e=0;e<this.closeingList.length;e++){this.closeingList[e]._closeView()}this.closeingList.length=0;var i=this.closeList.length,t=a.now();ftime.beginFTime(ftime.UIPoolClear);for(var n=i-1;n>=0;n--){var s=this.closeList[n];if(-1!=s.poolTime){if(t-s.closeTime>s.poolTime){try{s.destroy()}catch(e){printLogException(e,"[ClearCloseView] view:"+s.name)}this.closeList.splice(n,1)}if(ftime.checkPass(ftime.UIPoolClear))break}}this._closeProcessing=!1},o.onViewStateChange=function(e,i){switch(i){case v.Open:case v.OpenTween:this.openList.includes(e)||this.openList.push(e);break;case v.Close:case v.CloseTween:case v.Destroy:var t=this.openList.indexOf(e);-1!=t&&this.openList.splice(t,1)}i==v.Close&&this.closeList.push(e),i==v.Destroy&&this.allViews.delete(e.name)},o.getView=function(e){return this.allViews.get(e)},o.getOpenView=function(e){for(var t,n=i(this.openList);!(t=n()).done;){var s=t.value;if(s.name==e)return s}for(var o,r=i(this.openingList);!(o=r()).done;){var l=o.value;if(l.name==e)return l}return null},o.checkOnlyOpenView=function(e){var t;e=null!=(t=e)?t:V;for(var n,s=0,o=i(this.openList);!(n=o()).done;){var r=n.value;e.includes(r.name)&&r.visible&&s++}for(var l,a=i(this.openingList);!(l=a()).done;){var h=l.value;e.includes(h.name)&&h.visible&&s++}return s==e.length&&s==this.openList.length+this.openingList.length},o.checkFullScreenView=function(){for(var e,t=i(this.openList);!(e=t()).done;){if(e.value.checkFullSrceen())return!0}for(var n,s=i(this.openingList);!(n=s()).done;){if(n.value.checkFullSrceen())return!0}return!1},o.checkBanDefeatView=function(){for(var e,t=i(this.openList);!(e=t()).done;){if(e.value.banDefeat)return!0}for(var n,s=i(this.openingList);!(n=s()).done;){if(n.value.banDefeat)return!0}return!1},o.checkOnlyOpenView2=function(e,i){if(null==i)return this.openList.length>2?null:this.getOpenView(e);for(var t=[],n=0;n<this.openList.length;n++)i[this.openList[n].name]||t.push(this.openList[n]);return t.length>1?null:this.getOpenView(e)},o.checkPopView=function(){var e=this.checkOnlyOpenView();if(e)for(var t,n=this.getOpenView("MainView"),s=i(n.tabTypes);!(t=s()).done;){var o,r=t.value;if(null!=(o=n.getTabPanel(r,!1))&&o.isActive)return}if(this.popQueue.length>0&&null==this.curPopView&&e){this.curPopView=this.popQueue.shift();var l=this.curPopView[0],a=[].concat(this.curPopView);a.shift(),this.openView.apply(this,[l].concat(a))}},o.onViewClose=function(e){null!=this.curPopView&&e==this.curPopView[0]?(this.curPopView=null,this.checkPopView()):this.checkPopView()},o.onViewOpen=function(e){this.checkPopView()},o.addPopView=function(e){for(var i=arguments.length,t=new Array(i>1?i-1:0),n=1;n<i;n++)t[n-1]=arguments[n];var s=[e].concat(t);this.popQueue.push(s),this.checkPopView()},o.ViewIsAddPop=function(e){for(var t,n,s=i(this.popQueue);!(n=s()).done;){if(n.value[0]==e){t=!0;break}}return null!=this.curPopView&&this.curPopView[0]==e&&(t=!0),t},o.OpenViewSortIdx=function(e){var t;if(!e.parentView){this.viewSort[e.viewType]||0==this.viewSort[e.viewType]||(this.viewSort[e.viewType]=0);for(var n,s=((t={})[v.Init]=!0,t[v.Loading]=!0,t[v.Open]=!0,t[v.Opening]=!0,t),o=0,r=i(this.allViews);!(n=r()).done;){var l=n.value,a=(l[0],l[1]);s[a.state]&&a.viewType==e.viewType&&a.sortIdx>o&&(o=a.sortIdx)}this.viewSort[e.viewType]=o+1,e.sortIdx=this.viewSort[e.viewType]}},o.CheckNewSort=function(e){for(var t,n,s=((t={})[v.Open]=!0,t),o=[],r=i(this.allViews);!(n=r()).done;){var l=n.value,a=(l[0],l[1]);!s[a.state]&&a!=e||a.viewType!=e.viewType||o.push(a)}o.sort((function(e,i){return e.sortIdx<i.sortIdx?-1:1}));for(var h=e.sortIdx,c=0;c<o.length;c++)if(o[c]==e){if(o[c+1])h=o[c+1].node.getSiblingIndex()-1;break}return h},o.CloseViewSortIdx=function(e){e.parentView||this.viewSort[e.viewType]&&this.viewSort[e.viewType]--},o.HideAllView=function(e){var t={};if(this.hideViewList=[],e)for(var n=0;n<=e.length;n++)t[e[n]]=!0;for(var s,o=i(this.openList);!(s=o()).done;){var r=s.value;t[r.name]||(this.hideViewList.push(r),r.visible=!1,uiMgr.openFullScreenNum.delete(r.name))}},o.ShowAllHideView=function(){for(var e,t=i(this.hideViewList);!(e=t()).done;){var n=e.value;this.getOpenView(n.name)&&(n.visible=!0,uiMgr.openFullScreenNum.add(n.name))}this.hideViewList=[]},o.InitUIFont=function(){var e=n(s().mark((function e(){var i=this;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,t){console.error("开始加载字体"),resourceMgr.loadBuiltRes("fonts/font",p,(function(t){null!=t.item?(i._UIFont=t.item.asset,e(i._UIFont)):(console.error("字体加载错误"),e(null))}))})));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),t(e,[{key:"UIFont",get:function(){return this._UIFont}}]),e}());o._RF.pop()}}}));

