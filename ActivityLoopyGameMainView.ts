System.register("chunks:///_virtual/ActivityLoopyGameMainView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./ItemGrid.ts","./UIList.ts","./NodeUtil.ts","./StringUtil.ts","./TimeUtil.ts","./index57.ts","./ObjectUtil.ts","./BagModel.ts","./MessageView.ts","./ActivityControl.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./ActivityLoopyControl.ts","./ActivityLoopyDataCache.ts","./ActivityLoopyDefine.ts","./BaseView.ts"],(function(t){"use strict";var e,i,n,a,r,s,o,h,c,d,l,p,u,f,v,C,m,y,g,I,S,L,k,T,w,A,D,G;return{setters:[function(t){e=t.inheritsLoose},function(t){i=t.cclegacy,n=t.Button,a=t.Label,r=t.HorizontalTextAlignment,s=t.ScrollView,o=t.js,h=t.Sprite,c=t.Color},function(t){d=t.ItemGrid},function(t){l=t.SelectedType,p=t.ListItem},function(t){u=t.default},function(t){f=t.default},function(t){v=t.default},null,function(t){C=t.default},function(t){m=t.BagModel},function(t){y=t.default},function(t){g=t.default},function(t){I=t.default},function(t){S=t.ActivityEventDefine,L=t.ActivityType,k=t.ActivityState,T=t.ActivityTaskState},function(t){w=t.default},function(t){A=t.default},function(t){D=t.ActivityLoopyEvent},function(t){G=t.BaseView}],execute:function(){i._RF.push({},"06d96dZ94NPjIcyB9Zf9UDP","ActivityLoopyGameMainView",void 0);t("default",function(t){function i(){var e;return(e=t.call(this)||this).txtLeftTime=void 0,e.taskItems=[],e.scrollChapter=void 0,e.curChapter=void 0,e.time=0,e.endTime=0,e.roundCfg=void 0,e.startTime=0,e.totalLength=void 0,e.name="ActivityLoopyGameMainView",e.url="ui/module/activityLoopy/ActivityLoopyGameMainView",e}e(i,t);var h=i.prototype;return h.onInit=function(){var t=this,e=this.findChild("content/btnClose");this.addComponentCallbackListener(e,n.EventType.CLICK,(function(){t.close()})),this.txtLeftTime=this.findChildComponent("content/view/nodeTime/txtTime",a);var i=this.findChild("content/btnTip");this.addComponentCallbackListener(i,n.EventType.CLICK,(function(){y.showBoxTip({tip:GetLanguage(204004),btnCnt:1,horizontalAlign:r.LEFT})}));var h=this.findChild("content/view/btnStart");this.addComponentCallbackListener(h,n.EventType.CLICK,(function(){t.onStartClick()})),this.taskItems=[];for(var c=function(e){var i=t.findChild(o.formatStr("content/view/task/task%s",e)),r=u.findChild(i,"btnFetch");t.addComponentCallbackListener(r,n.EventType.CLICK,(function(){t.onFetchClick(e)}));var s=u.findChild(i,"rewardContent/item");s.active=!1,t.taskItems.push({node:i,index:e,btnFetch:r,nodeHasFetch:u.findChild(i,"hasFetch"),nodeCantFetch:u.findChild(i,"txtCantFetch"),txtDesc:u.findChildComponent(i,"txtDesc",a),nodeRewardItem:s,nodeRewardContent:u.findChild(i,"rewardContent")})},d=1;d<=3;d++)c(d);var p=this.findChildComponent("content/view/ScrollView",s);this.scrollChapter=this.addUIList(p,x),this.scrollChapter.selectedMode=l.SINGLE},h.registerUpdateHandler=function(){this.addEvent(S.OnActivityInfoUpdate,this.updateInfo,this),this.addEvent(S.OnActivityInfoTaskUpdate,this.updateContent,this),this.addEvent(D.OnLoopyArcheryLevelUpdate,this.OnLoopyArcheryLevelUpdate,this),this.addEvent(D.OnLoopyArcheryStart,this.OnLoopyArcheryStart,this)},h.onAfterOpen=function(){IS(w).send_24_120();var t=IS(I).GetActivityInfo(L.LoopyArchery);if(null!=t&&t.state==k.Open){this.roundCfg=IS(I).GetRoundCfg(L.LoopyArchery,t.round);var e=t.state_time[k.Open];this.endTime=e.end_time,this.startTime=e.start_time,this.curChapter=this.getDefaultSelectChapter();var i=configArchery_chapter.getDatas();this.totalLength=i.length,this.scrollChapter.datas=i;for(var n=0,a=0;a<i.length;a++)if(i[a].id==this.curChapter){n=a;break}this.scrollChapter.scrollTo(n),this.updateContent(),this.updateLeftTime()}else this.close()},h.updateContent=function(){for(var t=this.getTaskListByChapter(this.curChapter),e=0;e<this.taskItems.length;e++)this.updateSingleTask(this.taskItems[e],t[e]);this.updateChapterRed()},h.updateSingleTask=function(t,e){var i=configActivity_task.getDataByKey(e);t.txtDesc.string=i.desc;var n=this.getTaskState(e);t.btnFetch.active=n==T.CanGet,t.nodeHasFetch.active=n==T.HadGet,t.nodeCantFetch.active=n==T.Normal,null==t.rewardList&&(t.rewardList=[]);for(var a=i.reward||[],r=0;r<a.length;r++){var s=t.rewardList[r]||this.newRewardItem(t);s.itemId=a[r][0],s.itemGrid.SetItemId(a[r][0],a[r][1]),s.node.active=!0,t.rewardList[r]=s}for(var o=a.length;o<t.rewardList.length;o++)t.rewardList[o].node.active=!1},h.newRewardItem=function(t){var e=nodeInstantiate.instantiate(t.nodeRewardItem);e.parent=t.nodeRewardContent;var i=u.findChild(e,"itemGrid"),n={node:e,itemGrid:new d(this,i,(function(){IS(m).OpenItemTips(n.itemId,i)})),itemId:0};return n},h.getDefaultSelectChapter=function(){var t=this,e=C.clone(IS(A).openShotLevelList);return e.length<=0?1:(e.sort((function(e,i){var n=t.checkChapterHasTaskState(e,T.CanGet);return n!=t.checkChapterHasTaskState(i,T.CanGet)||t.checkChapterHasTaskState(e,T.Normal)!=t.checkChapterHasTaskState(i,T.Normal)?n?-1:1:i-e})),e[0])},h.getTaskListByChapter=function(t){var e=this.roundCfg.task_list[t-1];return configActivity_task_group.getDataByKey(e).task_list},h.getTaskState=function(t){var e=IS(I).GetActivityInfo(L.LoopyArchery).task_list[t];return null==e?T.Normal:e.state},h.checkChapterHasTaskState=function(t,e){for(var i=this.getTaskListByChapter(t),n=0;n<i.length;n++)if(this.getTaskState(i[n])==e)return!0;return!1},h.onBeforeClose=function(){this.time=0,this.endTime=0,this.startTime=0;for(var t=0;t<this.taskItems.length;t++){var e=this.taskItems[t].rewardList;if(null!=e)for(var i=0;i<e.length;i++)e[i].node.active=!1}},h.onUpdate=function(t){this.time=this.time+t,this.time>=1&&(this.time=0,this.updateLeftTime())},h.updateLeftTime=function(){this.txtLeftTime.string=v.formatTimeStringForSecond(Math.max(0,this.endTime-v.serverTime))},h.onDestroy=function(){for(var t=0;t<this.taskItems.length;t++){var e=this.taskItems[t].rewardList;if(null!=e){for(var i=0;i<e.length;i++)e[i].node.destroy(),delete e[i];this.taskItems[t].rewardList=null}}},h.updateInfo=function(t){t.type!=L.LoopyArchery||t.state==k.Open?this.updateContent():this.close()},h.OnLoopyArcheryLevelUpdate=function(){this.scrollChapter.updateAll()},h.OnLoopyArcheryStart=function(t){t==this.curChapter&&uiMgr.openView("ActivityLoopyShotView",this.curChapter)},h.updateSelect=function(){this.scrollChapter.items.forEach((function(t,e,i){t.updateSelect()}))},h.updateChapterRed=function(){this.scrollChapter.items.forEach((function(t,e,i){t.updateRed(),t.updateStar()}))},h.onStartClick=function(){if(IS(A).checkChapterUnlock(this.curChapter))IS(w).send_24_121(this.curChapter);else{var t=configArchery_chapter.getDataByKey(this.curChapter).open_day;this.getActivityOpenDay()<t?y.showFlyTip(f.formatStrWithMirrorDeal(GetLanguage(201212),t)):y.showFlyTip(GetLanguage(201214))}},h.onFetchClick=function(t){var e=this.getTaskListByChapter(this.curChapter)[t-1];if(this.getTaskState(e)==T.CanGet){var i=this.roundCfg.task_list[this.curChapter-1];IS(g).send_24_15(L.LoopyArchery,e,i)}},h.getActivityOpenDay=function(){var t=v.ServerDate(1e3*this.startTime),e=o.formatStr("%s/%s/%s %s:%s:%s",t.getFullYear(),t.getMonth()+1,t.getDate(),0,0,0),i=v.getServerDateByLocalStr(e).getTime()/1e3,n=v.serverTime-i;return Math.floor(n/86400+1)},i}(G));var x=function(t){function i(){for(var e,i=arguments.length,n=new Array(i),a=0;a<i;a++)n[a]=arguments[a];return(e=t.call.apply(t,[this].concat(n))||this).chapterId=void 0,e.cfg=void 0,e.txtIndex=void 0,e.imgBg=void 0,e.nodeSelect=void 0,e.nodeRed=void 0,e.nodeStars=void 0,e.starItem=[],e}e(i,t);var n=i.prototype;return n.onInit=function(){this.txtIndex=u.findChildComponent(this.node,"txtChapter",a),this.imgBg=u.findChildComponent(this.node,"imgBg",h),this.nodeSelect=u.findChild(this.node,"imgSelect"),this.nodeRed=u.findChild(this.node,"RedPoint"),this.nodeStars=u.findChild(this.node,"stars");for(var t=1;t<=3;t++)this.starItem.push({node:u.findChild(this.node,o.formatStr("stars/star%s/imgStarOk",t)),star:t})},n.onRender=function(t,e){this.cfg=t,this.chapterId=t.id,this.txtIndex.string=String(this.chapterId),this.imgBg.grayscale=!IS(A).checkChapterUnlock(this.chapterId),this.txtIndex.color=IS(A).checkChapterUnlock(this.chapterId)?new c(70,17,8):new c(21,10,1);this.view;this.updateSelect(),this.updateRed(),this.updateStar()},n.updateSelect=function(){var t=this.view;this.nodeSelect.active=t.curChapter==this.chapterId},n.updateStar=function(){if(IS(A).checkChapterUnlock(this.chapterId)){this.nodeStars.active=!0;for(var t=this.view,e=t.getTaskListByChapter(this.chapterId),i=0,n=0;n<e.length;n++)t.getTaskState(e[n])!=T.Normal&&(i+=1);for(var a=0;a<this.starItem.length;a++)this.starItem[a].node.active=this.starItem[a].star<=i}else this.nodeStars.active=!1},n.updateRed=function(){for(var t=this.view,e=t.getTaskListByChapter(this.chapterId),i=!1,n=0;n<e.length;n++)if(t.getTaskState(e[n])==T.CanGet){i=!0;break}this.nodeRed.active=i},n.onItemClick=function(){var t=this.view;if(IS(A).checkChapterUnlock(this.chapterId))t.curChapter!=this.chapterId&&(t.curChapter=this.chapterId,t.updateContent(),t.updateSelect());else{var e=this.cfg.open_day;t.getActivityOpenDay()<e?y.showFlyTip(f.formatStrWithMirrorDeal(GetLanguage(201212),e)):y.showFlyTip(GetLanguage(201214))}},i}(p);i._RF.pop()}}}));

