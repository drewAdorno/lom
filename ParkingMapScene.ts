System.register("chunks:///_virtual/ParkingMapScene.ts",["./rollupPluginModLoBabelHelpers.js","cc","./BattleData.ts","./NodeUtil.ts","./ItemIcon.ts","./PolyNav2D.ts","./ChapterDataCache.ts","./ParkingDataCache.ts","./ParkingDefine.ts","./SceneCamera2.ts","./SceneUnit2.ts"],(function(e){"use strict";var i,n,t,s,o,a,r,d,h,c,u,p,l,f,v,m,g,w,P,C;return{setters:[function(e){i=e.createForOfIteratorHelperLoose},function(e){n=e.cclegacy,t=e.Prefab,s=e.Sprite,o=e.Node,a=e.screen,r=e.Vec3,d=e.find,h=e.Camera},function(e){c=e.ChapterType},function(e){u=e.default},function(e){p=e.IconAseetType},function(e){l=e.PolyNav2D},function(e){f=e.ChapterDataCache},function(e){v=e.ParkingDataCache},function(e){m=e.ParkingEventDefine,g=e.DEC_TYPE},function(e){w=e.SceneCamera},function(e){P=e.SceneDec,C=e.FixedSceneDec}],execute:function(){var T;n._RF.push({},"14f0b8g+ZZKwJ+68v3vTaDS","ParkingMapScene",void 0);e("ParkingMapScene",function(){function e(e){this.units=[],this.fixunits=[],this.node=void 0,this.nodeUnit=void 0,this.nodeUnitFix=void 0,this.nodeUnitHub=void 0,this.mapImg=void 0,this.view=void 0,this.mapCamera=new w,this.polyNav=void 0,this.ut=void 0,this.onLoadViewSuccess=void 0,this.frameNum=0,this.startPosY=void 0,this.modingDecID=0,T=d("SceneRoot"),this.view=e,this.mapCamera.nodeCamera=u.findChild(T,"SceneCamera"),this.mapCamera.camera=this.mapCamera.nodeCamera.getComponent(h),this.mapCamera.camera.orthoHeight=720/a.windowSize.width*a.windowSize.height/2}var n=e.prototype;return n.load=function(){var e=this;this.node||(null!==this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/parking/scene/ParkingMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),this.onLoadViewSuccess=function(i){if(e.onLoadViewSuccess=null,!i.error&&null!==i.item&&null!==i.item.asset){var n=i.item.asset,t=nodeInstantiate.instantiate(n);e.node=t,t.setParent(T),e.onInit()}},resourceMgr.loadRes("ui/module/parking/scene/ParkingMapScene",t,this.onLoadViewSuccess))},n.onInit=function(){var e=this,i=this.view;this.mapImg=u.findChildComponent(this.node,"map_parking/BG1/parking",s),this.nodeUnit=u.findChild(this.node,"unit"),this.nodeUnitFix=u.findChild(this.node,"unitFix"),this.nodeUnitHub=u.findChild(this.node,"unitHub"),this.polyNav=u.findChildComponent(this.node,"polyNav2D",l),this.mapCamera.follow=this.nodeUnitHub,i.addComponentCallbackListener(this.nodeUnitHub,o.EventType.TOUCH_MOVE,(function(i){var n=i.getLocation(),t=1600-720/a.windowSize.width*a.windowSize.height,s=new r(0,Math.max(Math.min(e.mapCamera.oriPos.y-n.y+e.startPosY,t/2),-t/2),10);e.mapCamera.oriPos=s,e.startPosY=n.y})),i.addComponentCallbackListener(this.nodeUnitHub,o.EventType.TOUCH_START,(function(i){var n=i.getLocation();e.startPosY=n.y})),this.open()},n.registerEvent=function(){this.view.addEvent(m.PARKING_SKIN_PREVIEW_ENTER_ITEM,this.loadCurDec,this),this.view.addEvent(m.PARKING_SKIN_PREVIEW_CLICK_TYPE,this.delCurDec,this),this.view.addEvent(m.PARKING_SKIN_INFO_CHANGE,this.reBuildUsingDec,this)},n.loadCurDec=function(e){this.modingDecID=e,this.reBuildUsingDec();for(var n,t=new r(0,0,0),s=IS(v).getUsingFreeDec(),o=i(s);!(n=o()).done;){var a=n.value;if(a.skin_id==this.modingDecID){t=new r(a.x,a.y,0);break}}var d=new P(this,{id:e,pos:t});this.units.unshift(d)},n.delCurDec=function(e){for(var n,t=null,s=0,o=i(this.units.entries());!(n=o()).done;){var a=n.value,r=a[0],d=a[1];if(d.id==e){t=d,s=r;break}}t&&(this.nodeUnit.removeChild(t.effect.node),this.units.splice(s,1),this.modingDecID=0)},n.reBuildUsingDec=function(){this.nodeUnit.removeAllChildren(),this.loadUsingDec(),this.loadBaseDec()},n.loadUsingDec=function(){for(var e,n=IS(v).getUsingFreeDec(),t=i(n);!(e=t()).done;){var s=e.value;if(s.skin_id!=this.modingDecID){var o=new P(this,{id:s.skin_id,pos:new r(s.x,s.y,0)});this.units.push(o)}}},n.open=function(){if(T.active||(T.active=!0),this.node)return this.registerEvent(),void this.onAfterOpen();this.load()},n.close=function(){T.active&&(T.active=!1),null!==this.onLoadViewSuccess&&(resourceMgr.cancelLoadRes("ui/module/parking/scene/ParkingMapScene",this.onLoadViewSuccess),this.onLoadViewSuccess=null),this.onBeforeClose()},n.destroy=function(){this.close(),this.node&&(this.node.destroy(),resourceMgr.releaseResRef("ui/module/parking/scene/ParkingMapScene"),this.node=null)},n.onAfterOpen=function(){this.node.active=!0,this.mapCamera.camera.orthoHeight=720/a.windowSize.width*a.windowSize.height/2,this.loadBaseDec(),this.loadUsingDec()},n.loadBaseDec=function(){this.nodeUnitFix.removeAllChildren();var e=IS(v).getDecUsingInfo(),n=[];n.push({id:e[g.TYPE_FLOOR],pos:new r(-360,-360),type:g.TYPE_SPOT,groupIndex:3}),n.push({id:e[g.TYPE_FLOOR],pos:new r(-360,-60),type:g.TYPE_SPOT,groupIndex:1}),n.push({id:e[g.TYPE_FLOOR],pos:new r(360,-360),scale:new r(-1,1,1),type:g.TYPE_SPOT,groupIndex:4}),n.push({id:e[g.TYPE_FLOOR],pos:new r(360,-60),scale:new r(-1,1,1),type:g.TYPE_SPOT,groupIndex:2}),n.push({id:e[g.TYPE_LIGHT],pos:new r(-360,-180),scale:new r(.5,.5,1),type:g.TYPE_LIGHT}),n.push({id:e[g.TYPE_LIGHT],pos:new r(-360,120),scale:new r(.5,.5,1),type:g.TYPE_LIGHT}),n.push({id:e[g.TYPE_LIGHT],pos:new r(360,-180),scale:new r(-.5,.5,1),type:g.TYPE_LIGHT}),n.push({id:e[g.TYPE_LIGHT],pos:new r(360,120),scale:new r(-.5,.5,1),type:g.TYPE_LIGHT}),n.push({id:e[g.TYPE_FLOOR],pos:new r(-120,-600),type:g.TYPE_STAGE}),n.push({id:e[g.TYPE_FLOOR],pos:new r(-60,-180),type:g.TYPE_BOARD}),n.push({id:e[g.TYPE_FANCE],pos:new r(-360,360),type:g.TYPE_FANCE,scale:new r(.6,.6,1)}),n.push({id:e[g.TYPE_FANCE],pos:new r(360,360),type:g.TYPE_FANCE,scale:new r(-.6,.6,1)}),n.push({id:e[g.TYPE_DOOR],pos:new r(-180,360),type:g.TYPE_DOOR});for(var t,s=i(n.reverse());!(t=s()).done;){var o=t.value;this.fixunits.push(new C(this,o))}var a=configParking_design.getDataByKey(e[g.TYPE_FLOOR]).path;this.view.loadIcon(this.mapImg,"parking_dec",a,null,p.ICON_SPRITE)},n.onBeforeClose=function(){this.node.active=!1,this.mapCamera.follow=null,this.mapCamera.camera.orthoHeight=800},n.onDestroy=function(){},n.onUpdate=function(e){if(this.node){this._updateDepth(),this.mapCamera.onUpdate(),2===this.frameNum?this.frameNum=0:this.frameNum++;var i=IS(f),n=i.currentLoadType==c.Main||i.chapterType==c.Main;T.active!=n&&(T.active=n)}},n._updateDepth=function(){this.units.sort((function(e,i){var n=1,t=0,s=e.effectPosition.y-i.effectPosition.y;return(n-=100*s)-(t+=100*s)}));for(var e=[],i=0;i<this.units.length;++i){var n=this.units[i];n.depth=i,e.push(n.id)}},e}());n._RF.pop()}}}));

