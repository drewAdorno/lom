System.register("chunks:///_virtual/SLGMapLayer.ts",["./rollupPluginModLoBabelHelpers.js","cc","./V2.ts","./UIEffectAsset.ts","./SLGMapData.ts"],(function(t){"use strict";var i,e,s,a,n,r,h;return{setters:[function(t){i=t.createForOfIteratorHelperLoose},function(t){e=t.cclegacy,s=t.Rect,a=t.Vec2},function(t){n=t.V2},function(t){r=t.UIEffectAsset},function(t){h=t.SLGMapData}],execute:function(){e._RF.push({},"51baaGmwkxN1JH8X8toX5UK","SLGMapLayer",void 0);var o=new s;new a;function l(t,i){var e=t.x-i.x/2,s=t.x+i.x/2,a=t.y+i.y/2,n=t.y-i.y/2,r=h.getPosToCR(e,a);return o.xMin=Math.max(r.x,0),o.yMin=Math.max(r.y,0),r=h.getPosToCR(s,n),o.xMax=Math.min(r.x,124),o.yMax=Math.max(r.y,79),o}var c=t("TileObj",function(){function t(t){this.index=0,this.tileX=0,this.tileY=0,this.building=void 0,this.tree=void 0,this.region=void 0,this.data=void 0,this.map=void 0,this.map=t,this.data=t.data}var i=t.prototype;return i.pushObjToPool=function(){this.building&&this.building.free(),this.tree&&this.tree.free(),this.building=null},i.loadObject=function(){var t=this.data.building[this.index];if(t>0){var i=this.data.getGrid(t),e=r.alloc(i.url,this.map.building,-1),s=h.getCRToPos(this.tileX,this.tileY);e.position=new n(s.x,s.y),e.scale=1,this.building=e}if((t=this.data.tree[this.index])>0){var a=this.data.getGrid(t),o=r.alloc(a.url,this.map.tree,-1),l=h.getCRToPos(this.tileX,this.tileY);o.position=new n(l.x,l.y),o.scale=1,this.tree=o}},t}());t("SLGMapLayer",function(){function t(t){this.map=void 0,this._loadList=[],this._removeTileList=[],this._curTileDic={},this._cacheList=[],this._curTileCenter=new a(-2e4,-2e4),this._viewSize=new a,this._tileObjs=[],this._updateTileObj=!1,this.map=t}var e=t.prototype;return e.updateTileCenter=function(t,i,e){if(void 0===e&&(e=!1),e||!(a.distance(this._curTileCenter,t)<=1)){e&&this.refresh();var s=l(t,i);this._curTileCenter.set(t),this._viewSize.set(i),this.doReadData(s)}},e.cacheTileObj=function(t){t.pushObjToPool(),this._cacheList.push(t)},e.refresh=function(){var t=this._removeTileList,i=this._loadList,e=this._curTileDic;for(var s in i.length=0,t.length=0,e){var a=e[s];this.cacheTileObj(a)}this._curTileDic={}},e.doReadData=function(t){var e=t.xMin,s=t.xMax,n=t.yMin,r=t.yMax,o=this._removeTileList,l=this._loadList,c=this._curTileDic;for(var u in o.length=0,c){var d=c[u];(d.tileX<e||d.tileX>s||d.tileY<n||d.tileY>r)&&(this.cacheTileObj(d),o.push(d.index))}for(var f,p=i(o);!(f=p()).done;){delete c[f.value]}o.length=0,l.length=0;for(var v=this.map.data,T=e;T<=s;T++)for(var _=n;_<=r;_++){var x=h.getCRToIndex(T,_);if(!c[x]&&!(v.building[x]<=0&&v.tree[x]<=0)){var g=h.getCRToPos(T,_),b={x:T,y:_,tileId:x,tileDist:a.distance(this._curTileCenter,g)};l.push(b)}}l.sort((function(t,i){return t.tileDist-i.tileDist}))},e.update=function(){ftime.beginFTime(ftime.MapTileLoad);var t=this._loadList,i=this._curTileDic,e=this._cacheList,s=t.length;if(0!=s){for(var a=0;a<s&&!ftime.checkPass(ftime.MapTileLoad);++a){var n=t[a],r=i[n.tileId];r||((r=e.length>0?e.pop():new c(this.map)).index=n.tileId,r.tileX=n.x,r.tileY=n.y,i[n.tileId]=r),r.loadObject(),t.splice(a,1),--a,--s}this._updateTileObj&&(this._updateTileObj=!1,this._updateDepth())}},e._updateDepth=function(){},t}());e._RF.pop()}}}));

