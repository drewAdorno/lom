System.register("chunks:///_virtual/ActivityStrategyDataCache.ts",["./rollupPluginModLoBabelHelpers.js","cc","./RedPointMgr.ts","./StorageUtil.ts","./TimeUtil.ts","./ConfigGlobal.ts","./ObjectUtil.ts","./AdDefine.ts","./BagModel.ts","./ChapterDataCache.ts","./ChapterDefine.ts","./LoginDefine.ts","./RoleControl.ts","./RoleDataCache.ts","./RoleDefine.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./ActivityStrategyControl.ts"],(function(t){"use strict";var e,i,n,o,r,s,a,l,d,h,u,c,f,g,y,p,v,S,I,R,m,A,_,T;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy,n=t.js},function(t){o=t.RedPointMgr},function(t){r=t.default},function(t){s=t.default},function(t){a=t.ConfigGlobal},function(t){l=t.default},function(t){d=t.ADS_TYPE,h=t.AdEventDefine},function(t){u=t.BagModel},function(t){c=t.ChapterDataCache},function(t){f=t.DungeonDefine,g=t.ChapterEventDefine},function(t){y=t.LoginEventDefine},function(t){p=t.default},function(t){v=t.RoleDataCache},function(t){S=t.ClientData,I=t.RoleEventDefine},function(t){R=t.default},function(t){m=t.ActivityType,A=t.ActivityState,_=t.ActivityEventDefine},function(t){T=t.default}],execute:function(){i._RF.push({},"d38ceG4jJVHn4XH2wJWtIEb","ActivityStrategyDataCache",void 0);t("default",function(){var t=i.prototype;function i(){this.equipList=[],this.skillIdToInfo={},this.petIdToInfo={},this.level=0,this.job=0,this.jobRed=0,this.initAttrib=!1,this.unLockMillionStone={},this.milestoneRed={},this.attrIdToValue={},this.battle_pass_id=0,this.hour_reward_id=0,this.dungeonRed=0,this.shopRed=0,this.hour_reward_next_time=0,this.milestoneCheckList=void 0,this.petCfgIdToAttr={},this.skillIdToAttr={},this.timerGroup=void 0,this.timeRewardRed=0,normalEvent.on(y.LOGIN_SUCCESS,this.checkPop,this),normalEvent.on(_.OnActivityListUpdate,this.activityChange,this),normalEvent.on(_.OnActivityInfoUpdate,this.activityChange,this),normalEvent.on(I.ROLE_CLIENT_DATA,this.UpdateMilestoneInfo,this),normalEvent.on(g.DUNGEON_UPDATE,this.UpdateMilestoneInfoByDungeon,this),normalEvent.on(h.AD_INFO_UPDATE,this.checkShopRed,this)}return t.clear=function(){},t.checkPop=function(){var t=IS(R).GetActivityInfo(m.Strategy);t&&t.state==A.Open&&this.checkOpenPopView()},t.activityChange=function(t){if(void 0===t&&(t=null),!t||t.type==m.Strategy){var e=IS(R).GetActivityInfo(m.Strategy);!e||e.state!=A.Open&&e.state!=A.EndShow?e&&e.state!=A.Null||(this.milestoneCheckList=null,this.dungeonRed=0,this.jobRed=0,this.shopRed=0,this.milestoneRed={}):(this.sendProto(),this.checkDungeonRed(),this.UpdateJobRed(),this.RefreshTimeRewardRed(),this.checkShopRed())}},t.sendProto=function(){IS(T).reqActStrategyTabInfo(),IS(T).send_act_strategy_dungeon_info_c2s()},t.checkOpenPopView=function(){var t,e=s.ServerDate(1e3*s.serverTime),i=n.formatStr("#%s#%s#%s",e.getFullYear(),e.getMonth()+1,e.getDate()),o="ActivityStrategyPopView"+IS(v).GetRoleId();(null!=(t=r.get(o))?t:"")!=i&&(uiMgr.ViewIsAddPop("ActivityStrategyPopView")||(uiMgr.addPopView("ActivityStrategyPopView"),r.set(o,i)))},t.checkShopRed=function(t){var e;if(void 0===t&&(t=null),!t||t==d.AD_STRATEGY_ACTIVITY_PAY){this.shopRed=0;var i=s.ServerDate(1e3*s.serverTime),a=n.formatStr("#%s#%s#%s",i.getFullYear(),i.getMonth()+1,i.getDate()),l="ActivityStrategyShopRed"+IS(v).GetRoleId(),h=null!=(e=r.get(l))?e:"",u=IS(R).GetActivityInfo(m.Strategy);h!=a&&u&&u.state==A.Open&&(this.shopRed=1),IS(o).changeValue("ActivityStrategy/shop",this.shopRed),IS(R).UpdateMainRedByActType(m.Strategy)}},t.setShopRed=function(){if(1==this.shopRed){var t;this.shopRed=0;var e=s.ServerDate(1e3*s.serverTime),i=n.formatStr("#%s#%s#%s",e.getFullYear(),e.getMonth()+1,e.getDate()),a="ActivityStrategyShopRed"+IS(v).GetRoleId();t=r.get(a);r.set(a,i),IS(o).changeValue("ActivityStrategy/shop",this.shopRed),IS(R).UpdateMainRedByActType(m.Strategy)}},t.GetShopRed=function(){return this.shopRed},t.checkDungeonRed=function(){var t;this.dungeonRed=0;var e=s.ServerDate(1e3*s.serverTime),i=n.formatStr("#%s#%s#%s",e.getFullYear(),e.getMonth()+1,e.getDate()),a="ActivityStrategyDungeonRed"+IS(v).GetRoleId(),l=null!=(t=r.get(a))?t:"",d=IS(R).GetActivityInfo(m.Strategy);l!=i&&d&&d.state==A.Open&&(this.dungeonRed=1),IS(o).changeValue("ActivityStrategy/dungeon",this.dungeonRed),IS(R).UpdateMainRedByActType(m.Strategy)},t.setDungeonRed=function(){if(1==this.dungeonRed){var t;this.dungeonRed=0;var e=s.ServerDate(1e3*s.serverTime),i=n.formatStr("#%s#%s#%s",e.getFullYear(),e.getMonth()+1,e.getDate()),a="ActivityStrategyDungeonRed"+IS(v).GetRoleId();t=r.get(a);r.set(a,i),IS(o).changeValue("ActivityStrategy/dungeon",this.dungeonRed),IS(R).UpdateMainRedByActType(m.Strategy)}},t.GetDungeonRed=function(){return this.dungeonRed},t.UpdateJobRed=function(){var t=this.jobRed;this.jobRed=0;var e=this.job,i=this.level;if(0==e)return 0;if(null==configJobs.getDataByKey(e))return 0;var n=IS(R).GetActivityInfo(m.Strategy),r=n&&n.state==A.Open,s=a.transfer_job_level[configJobs.getDataByKey(e).change_times];null!=s&&i>=s&&r&&(this.jobRed=1),t!=this.jobRed&&(IS(o).changeValue("ActivityStrategy/changeJob",this.jobRed),IS(R).UpdateMainRedByActType(m.Strategy))},t.GetJobRed=function(){return this.jobRed},t.getCurEquipRebuildCostNum=function(){var t=(IS(c).getDungeonInfoByID(f.CHAPTER_TYPE_STRATEGY_ACTIVITY).max_level||1)-1,e=configStrategy_activity_level.getDatas(),i=0;for(var n in e){t>=e[n].chapter_progress&&e[n].refresh_cost>i&&(i=e[n].refresh_cost)}return i},t.UpdateStrategyDungeonInfo=function(t){this.battle_pass_id=t.battle_pass_id,this.hour_reward_id=t.hour_reward_id,this.hour_reward_next_time=t.next_time,this.UpdateMilestoneInfo(),this.RefreshTimeRewardRed(),normalEvent.emit(_.OnStrategyInfoUpdate)},t.UpdateBattlePass=function(t){this.battle_pass_id=t.battle_pass_id,this.UpdateMilestoneInfo(),normalEvent.emit(_.OnStrategyBattlePassUpdate)},t.UpdateHoureRewardInfo=function(t){this.hour_reward_id=t.hour_reward_id,this.hour_reward_next_time=t.next_time,this.RefreshTimeRewardRed(),normalEvent.emit(_.OnStrategyHoureRewardUpdate)},t.UpdateMilestoneInfoByDungeon=function(t){this.UpdateMilestoneInfo(t,1)},t.UpdateMilestoneInfo=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=null),(!t||1!=e||t.type==f.CHAPTER_TYPE_STRATEGY_ACTIVITY)&&(!t||e||t[S.ActivityStrategyRed])){var i=IS(R).GetActivityInfo(m.Strategy);if(this.unLockMillionStone={},this.milestoneRed={},i&&(i.state==A.Open||i.state==A.EndShow)){var n=IS(c).getDungeonInfoByID(f.CHAPTER_TYPE_STRATEGY_ACTIVITY),r=configStrategy_activity_milestone.getDatas();for(var s in r){var a=r[s];if(1==a.condition[0])IS(u).getGoodsCountByGoodsGtid(1039)>=a.condition[1]&&(this.unLockMillionStone[a.id]=!0);else 2==a.condition[0]?n.max_level-1>=a.condition[1]&&(this.unLockMillionStone[a.id]=!0):this.unLockMillionStone[a.id]=!0;this.unLockMillionStone[a.id]&&a.id==this.battle_pass_id&&!this.GetMillionStoneShowRedData(a.id)&&(this.milestoneRed[a.id]=!0)}}IS(o).changeValue("ActivityStrategy/Milestone",this.GetMillionStoneRed()),IS(R).UpdateMainRedByActType(m.Strategy)}},t.GetMillionStoneShowRedData=function(t){var e=IS(v).getClientDataByNum(S.ActivityStrategyRed,"end_time");if(e&&!this.milestoneCheckList&&e>s.serverTime){configStrategy_activity_milestone.getDataByKey(t);var i=IS(v).getClientData(S.ActivityStrategyRed,"info");this.milestoneCheckList=JSON.parse(i)}return this.milestoneCheckList?this.milestoneCheckList[t]:null},t.SetMillionStoneShowRedData=function(t){void 0===t&&(t=null);var e,i=l.copyObject(this.milestoneRed);if(this.milestoneCheckList||(this.milestoneCheckList={}),t)delete this.milestoneRed[t],this.milestoneCheckList[t]||(e=!0,this.milestoneCheckList[t]=!0);else for(var n in i){var o=Number(n);configStrategy_activity_milestone.getDataByKey(o).get_way.length>0&&(delete this.milestoneRed[o],this.milestoneCheckList[o]||(e=!0),this.milestoneCheckList[o]=!0)}if(e){var r=IS(R).GetActivityInfo(m.Strategy),a=s.serverTime;r&&(a=r.state_time[A.Open].end_time);var d=JSON.stringify(this.milestoneCheckList);IS(p).send_3_29_All(S.ActivityStrategyRed,0,[{k:"end_time",s:a.toString()},{k:"info",s:d}])}},t.GetMillionStoneRed=function(t){if(void 0===t&&(t=null),!t)for(var e in this.milestoneRed)if(this.milestoneRed[e])return 1;return this.milestoneRed[t]?1:0},t.GetMillionStoneUnLock=function(t){return this.unLockMillionStone[t]},t.getRedNum=function(){return this.GetJobRed()+this.GetMillionStoneRed()+this.GetDungeonRed()+this.GetTimeRewardRed()+this.GetShopRed()},t.getEquipWearCountBySuitId=function(t){for(var e,i=0,n=0;n<this.equipList.length;n++){if(0!=this.equipList[n].location)e=this.equipList[n].config_id,configEquipment.getDataByKey(e).suitId==t&&(i+=1)}return i},t.updateRoleAttrByList=function(t){for(var i,n=e(t);!(i=n()).done;){var o=i.value;this.attrIdToValue[o.k]=3.5*o.v}this.initAttrib=!0,normalEvent.emit(_.OnStrategyAttrListUpdate)},t.updateRoleAttrById=function(t,e){this.attrIdToValue[t]=3.5*e,normalEvent.emit(_.OnStrategyAttrUpdate,t)},t.getRoleAttrById=function(t){var e,i=null!=(e=this.attrIdToValue[t])?e:0;return Math.floor(i/3.5)},t.getAttrValue=function(t){var e=configAttribute.getDataByKey(t),i=this.getRoleAttrById(t);if(0==i&&3==e.type&&null!=e.group){var o=this.getRoleAttrById(e.group-1e3),r=this.getRoleAttrById(e.group),s=1;2==e.show_type&&(s=1e4),i=(o-r)/r*s}return 2==e.show_type?n.formatStr("%s%",i/100):3==e.show_type?String(i/1e4):String(i)},t.getEquipByLocation=function(t){for(var e=0;e<this.equipList.length;e++)if(this.equipList[e].location==t)return this.equipList[e]},t.getShowEquipCfgIdByLocation=function(t){var e=this.getEquipByLocation(t);return l.isEmpty(e)?0:e.config_id},t.getSortAllPetList=function(t){var e=[];for(var i in this.petIdToInfo)t&&-1==this.petIdToInfo[i].pos||e.push(this.petIdToInfo[i].pet_id);return e.sort((function(t,e){var i=configPet.getDataByKey(t),n=configPet.getDataByKey(e);return i.quality!=n.quality?i.quality<n.quality?-1:1:t<e?-1:1})),e},t.getPetByPos=function(t){for(var e in this.petIdToInfo){var i=this.petIdToInfo[e];if(i.pos==t)return i}},t.getPetInfoByPetId=function(t){return this.petIdToInfo[t]},t.getPetEmptyPos=function(){for(var t=[],e=1;e<=5;e++)l.isEmpty(this.getPetByPos(e))&&t.push(e);return t.sort((function(t,e){return t<e?-1:1})),t[0]},t.getSkillByPos=function(t){for(var e in this.skillIdToInfo){var i=this.skillIdToInfo[e];if(i.pos_id==t)return i}},t.getSkillInfoBySkillId=function(t){return this.skillIdToInfo[t]},t.getSkillEmptyPos=function(){for(var t=[],e=2;e<=6;e++)l.isEmpty(this.getSkillByPos(e))&&t.push(e);return t.sort((function(t,e){return t<e?-1:1})),t[0]},t.getSortAllSkillList=function(){var t=[];for(var e in this.skillIdToInfo)t.push(this.skillIdToInfo[e].skill_id);return t.sort((function(t,e){var i=configSkill.getDataByKey(t),n=configSkill.getDataByKey(e);return i.quality!=n.quality?i.quality<n.quality?-1:1:t<e?-1:1})),t},t.updateRoleAttrObj=function(t){if(null!=t&&0!=t.length)for(var e,i=0;i<t.length;i++)1==(e=t[i].type)&&this.updatePetAttrInfo(t[i].id,t[i].attr_list),2==e&&this.updateSkillAttrInfo(t[i].id,t[i].attr_list)},t.updatePetAttrInfo=function(t,e){if(!(null==e||e.length<=0)){this.petCfgIdToAttr[t]||(this.petCfgIdToAttr[t]={});for(var i=0;i<e.length;i++)this.petCfgIdToAttr[t][e[i].k]=e[i].v;normalEvent.emit(_.OnStrategyPetAttrUpdate,t)}},t.updateSkillAttrInfo=function(t,e){if(!(null==e||e.length<=0)){this.skillIdToAttr[t]||(this.skillIdToAttr[t]={});for(var i=0;i<e.length;i++)this.skillIdToAttr[t][e[i].k]=e[i].v;normalEvent.emit(_.OnStrategySkillAttrUpdate,t)}},t.getPetAttrInfoByCfgId=function(t){return this.petCfgIdToAttr[t]},t.getPetAttrByAttrId=function(t,e){var i=this.getPetAttrInfoByCfgId(t);return l.isEmpty(i)?0:i[e]||0},t.getPetFactAttrValue=function(t,e,i){var n=t;n=n+this.getPetAttrByAttrId(e,i)+this.getPetAttrByAttrId(0,i);var o=configAttribute.getDataByList("group",i);if(null==o||o.length<=0)return n;for(var r=0;r<o.length;r++)n*=1+(this.getPetAttrByAttrId(e,o[r].id)+this.getPetAttrByAttrId(0,o[r].id))/1e4;return n},t.RefreshTimeRewardRed=function(){var t=this;this.timerGroup&&(normalTimer.stop(this.timerGroup),this.timerGroup=null),this.timeRewardRed=0;var e=IS(R).GetActivityInfo(m.Strategy);e&&e.state==A.Open&&(this.hour_reward_next_time-s.serverTime>0?this.timerGroup=normalTimer.start(this.hour_reward_next_time-s.serverTime,1,(function(){t.hour_reward_next_time-s.serverTime<=0&&(normalTimer.stop(t.timerGroup),t.timerGroup=null,t.RefreshTimeRewardRed())})):this.timeRewardRed=1),IS(o).changeValue("ActivityStrategy/timeReward",this.GetTimeRewardRed()),IS(R).UpdateMainRedByActType(m.Strategy)},t.GetTimeRewardRed=function(){return this.timeRewardRed},i}());i._RF.pop()}}}));

