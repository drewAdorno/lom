System.register("chunks:///_virtual/AssetPool.ts",["./rollupPluginModLoBabelHelpers.js","cc","./ObjectUtil.ts"],(function(e){"use strict";var t,o,i,r;return{setters:[function(e){t=e.createClass},function(e){o=e.cclegacy,i=e.sys},function(e){r=e.default}],execute:function(){o._RF.push({},"91d72q02oVNm4J0dj5EGCvn","AssetPool",void 0);var n=function(){function e(e,t,o){this._freepool=[],this._clazz=void 0,this._maxTime=0,this._maxNum=0,this._clazz=e,this._maxNum=t,this._maxTime=o}var o=e.prototype;return o.alloc=function(){var e;return(e=this._freepool.length<=0?new this._clazz:this._freepool.pop()).cacheUse&&e.cacheUse(),e.poolState=0,e},o.free=function(e){var t=e;t.poolState=l.Pool,t.cacheReset&&t.cacheReset();var o=this._freepool;1==GlobalDefine.CHECK_POOL?-1==o.indexOf(e)?o.push(e):printLogWarn("重复放入缓存队列, key: ",e):o.push(e)},o.clear=function(e){var t,o=this._freepool;if(0!=o.length){e=null!=(t=e)?t:this._maxTime;for(var n=i.now(),l=0;l<o.length&&!(i.now()-n>1);l++){var s=o[l],a=s;0==e?a.destroy():i.now()-s.freeTime>=e&&(a.destroy(),r.fastRemoveAt(o,l),l--)}0==e&&(o.length=0)}},t(e,[{key:"length",get:function(){return this._freepool.length}}]),e}(),l=e("AssetPoolState",{Useing:0,Pool:1,WaitFree:2,Destroy:3}),s=e("assetPools",[]);e("AssetPool",function(){function e(e,t){void 0===t&&(t=1e4),this._pool={},this._clazz=void 0,this.manualTime=void 0,this.waitFreeQueue=[],this._clazz=e,this.manualTime=t,s.push(this)}var t=e.prototype;return t.alloc=function(e,t,o){void 0===t&&(t=10),void 0===o&&(o=1e4);var i=this._pool[e];null==i&&(i=this._pool[e]=new n(this._clazz,t,o));var r=i.alloc();return r.url=e,r.pool=this,r},t.free=function(e){if(null==e)return!1;if(e.pool!=this)return!1;if(e.poolState!=l.Useing)return!1;var t=e.url;null!=this._pool[t]&&(e.poolState=l.WaitFree,this.waitFreeQueue.push(e),e.onAfterCacheFree&&e.onAfterCacheFree())},t.onUpdate=function(){var e=this;for(var t in this._pool){this._pool[t].clear()}this.waitFreeQueue.forEach((function(t){t.freeTime=i.now();var o=t.url,r=e._pool[o];null!=r&&r.free(t)})),this.waitFreeQueue.length=0},t.releaseUnuseRes=function(){for(var e in this._pool){this._pool[e].clear(this.manualTime)}},t.clearPool=function(){for(var e in this.waitFreeQueue.forEach((function(e){e.destroy()})),this.waitFreeQueue.length=0,this._pool){this._pool[e].clear(0)}this._pool={}},e}());o._RF.pop()}}}));

