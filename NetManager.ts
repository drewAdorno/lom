System.register("chunks:///_virtual/NetManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./StringUtil.ts","./TimeUtil.ts","./EventInvoker.ts","./ObjectUtil.ts","./protobuf.mjs_cjs=&original=.js","./MainGame.ts","./LoginDataCache.ts","./LoginDefine.ts","./protoregister.ts","./SocketClient.ts","./protobuf.js"],(function(t){"use strict";var e,n,o,s,i,r,c,a,_,u,h,l,d,f,g;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){n=t.cclegacy,o=t.sys},function(t){s=t.default},function(t){i=t.default},function(t){r=t.EventInvoker},null,null,function(t){c=t.GameState},function(t){a=t.LoginDataCache},function(t){_=t.LoginEventDefine},function(t){u=t.MSG_TO_ID_MAP,h=t.ID_TO_MSG_DICT},function(t){l=t.SocketState,d=t.SocketCode,f=t.SocketClient},function(t){g=t.default}],execute:function(){n._RF.push({},"f7bbaqTDy9BYoDGaW9O2LMD","NetManager",void 0);var v={"login.heart_beat_c2s":!0,"main_chapter.main_chapter_kill_reward_c2s":!0},p={"login.heart_beat_s2c":!0,"main_chapter.main_chapter_kill_reward_s2c":!0};t("NetManager",function(){var t=n.prototype;function n(){this._cnet=void 0,this._connectAddress=void 0,this._bgpConnectAddress=void 0,this._events=void 0,this._protoClass=void 0,this._lastHeartTime=0,this._reconnectTime=0,this._startReconnect=!1,this.protoRoot=void 0,_G("netManager",this),this._protoClass={},this._events=new r("NetManager");var t=new f;t.setOnNetState(this._onNetStateFunc,this),t.setOnNetMsg(this._onNetMsgFunc,this),t.addMsgQueueIgnore(260),t.addMsgQueueIgnore(259),t.addMsgQueueIgnore(258),t.addMsgQueueIgnore(257),this._cnet=t}return t.clear=function(){this.disconnect()},t.setProtoJson=function(t){this.protoRoot=g.Root.fromJSON(t)},t.connectServer=function(t,n){this._connectAddress=t;var o=[];this._bgpConnectAddress={};for(var s,i=e(n);!(s=i()).done;){var r=s.value,c=r.split(":");o.push(c[1]),this._bgpConnectAddress[c[1]]=r}this._cnet.connect(t)},t._reconnect=function(){var t=IS(a);t.reconnectCount++,this._startReconnect=!0,this._reconnectTime=o.now(),printLogErr("reconnectCount:",t.reconnectCount),mainGame.state=c.Reconnecting,normalEvent.emit(_.RECONNECT_START)},t.disconnect=function(){this._startReconnect=!1;var t=this._cnet;null!=t&&t.disconnect()},t._updateHeartBeat=function(){if(o.now()-this._lastHeartTime>=5e3&&mainGame.state>=c.EnterLoading){var t={svr_time:i.serverTime};this.send("login.heart_beat_c2s",t),this._lastHeartTime=o.now()}},t.send=function(t,e,n){void 0===n&&(n=!1);var o=this._cnet;if(o.state==l.Connected){var s=u[t];if(null!=s){var r=e,c=t;n&&(t="json_proto.json_proto_c2s",e={proto_id:s,msg:JSON.stringify(e)},s=u[t]),this._protoClass[t]||(this._protoClass[t]=this.protoRoot.lookup(t));var a,_=this._protoClass[t].encode(this._protoClass[t].create(e)).finish();if(0==GlobalDefine.PRINT_LEVEL&&1!=v[c])a=n?"发送协议[json]：":"发送协议：",printLog(a,c,"["+i.serverTime+"]","\n",r);o.sendMessage(s,_)}else printLogErr("协议不存在：",t)}else printLogWarn("网络未连接，协议发送失败：",t)},t.addEventListener=function(t,e,n){this._events.on(t,e,n)},t.removeEventListener=function(t,e,n){this._events.off(t,e)},t.update=function(t){var e=this._cnet;if(e.update(t),this._startReconnect&&o.now()-this._reconnectTime>3e3)return this._startReconnect=!1,void this._cnet.reconnect(this._connectAddress);e.state==l.Connected&&this._updateHeartBeat()},t.reconnectSucc=function(){IS(a).reconnectCount=0,this._lastHeartTime=0},t._onNetStateFunc=function(t){if(mainGame.state!=c.WaitLogin&&mainGame.state!=c.LoginCentering&&mainGame.state!=c.Disconnect){var e=IS(a);switch(printLogErr("网络状态:",t),t){case d.Connect:if(this._lastHeartTime=0,mainGame.state==c.Reconnecting)return void loginControl.reconnectServer();loginControl.loginGameServer();break;case d.DisconnectByServer:case d.TimeoutDisconnect:case d.ExceptionOnConnect:case d.Exception:case d.Disconnect:case d.ServerNotResponse:if((mainGame.state==c.Reconnecting||mainGame.state==c.Runing||mainGame.state==c.EnterLoading)&&e.reconnectCount<7)this._reconnect();else{if(this.disconnect(),e.reconnectCount>=7||e.reconnectLoginCount<=3)return void loginControl.reconnectLogin();normalEvent.emit(_.RECONNECT_NET_CLOSE)}}}},t._onNetMsgFunc=function(t,e){var n=o.now(),r=h[t],c="json_proto.json_proto_s2c"===r;if(null!=r&&(c||this._events.has(r))){this._protoClass[r]||(this._protoClass[r]=this.protoRoot.lookup(r));var a=this._protoClass[r].decode(e);if(c){if(null==(r=h[a.proto_id]))return;if(!this._events.has(r))return;a=s.isEmpty(a.msg)?{}:JSON.parse(a.msg)}this._events.emit(r,a);var _,u=o.now()-n;if(0==GlobalDefine.PRINT_LEVEL&&1!=p[r])_=c?"服务器协议[json]：":"服务器协议：",printLog(_+"["+u+" ms] "+r+" ["+i.serverTime+"] \n",a)}},n}());n._RF.pop()}}}));

