System.register("chunks:///_virtual/ActivityLoopyDataCache.ts",["./rollupPluginModLoBabelHelpers.js","cc","./RedPointMgr.ts","./StorageUtil.ts","./TimeUtil.ts","./index57.ts","./ConfigGlobal.ts","./BagDefine.ts","./BagModel.ts","./BattlePassControl.ts","./ChapterDefine.ts","./MainViewModel.ts","./PayDataCache.ts","./PayDefine.ts","./RoleDataCache.ts","./ActivityControl.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./HorseCarnivalDataCache.ts","./ActivityLoopyDefine.ts","./BaseView.ts"],(function(t){"use strict";var e,i,n,o,r,a,s,c,d,u,v,p,f,h,y,l,g,I,L,S,A,C,G,w,_;return{setters:[function(t){e=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy,n=t.js},function(t){o=t.RedPointMgr},function(t){r=t.default},function(t){a=t.default},null,function(t){s=t.ConfigGlobal},function(t){c=t.BagEventDefine},function(t){d=t.BagModel},function(t){u=t.default},function(t){v=t.ChapterEventDefine},function(t){p=t.MainViewModel},function(t){f=t.default},function(t){h=t.GiftType,y=t.PayEventDefine},function(t){l=t.RoleDataCache},function(t){g=t.default},function(t){I=t.default},function(t){L=t.ActivityType,S=t.ActivityState,A=t.ActivityTaskState,C=t.ActivityEventDefine},function(t){G=t.HorseCarnivalDataCache},function(t){w=t.ActivityLoopyEvent},function(t){_=t.ViewEvent}],execute:function(){i._RF.push({},"d6c111kdGpGwpq0m2UVsxrQ","ActivityLoopyDataCache",void 0);var R="loopyShotGuide";t("default",function(){var t=i.prototype;function i(){this.sendProList=[{type:L.LoopyFind,send:function(){IS(g).send_24_52(L.LoopyFind)},redCheck:function(){}},{type:L.LoopyCard,send:function(){IS(g).send_collect_info(L.LoopyCard),IS(g).send_collect_show(L.LoopyCard)},redCheck:function(){}}],this.act_day=1,this.curLevelId=1,this.curLevelCfg=void 0,this.openLevelList=[],this.chapterInfo=[],this.sendGiftRed=0,this.newCardMsgRed={},this.preOpenMsgTime={},this.openShotLevelList=[1],this.act_shot_day=1,this.viewList=void 0,this.curOpen=0,this.otherViewNum=0,this.isDungeon=void 0,normalEvent.on(C.OnActivityListUpdate,this.activityChange,this),normalEvent.on(C.OnActivityInfoUpdate,this.activityChange,this),normalEvent.on(_.ViewOpen,this.onViewOpen,this),normalEvent.on(_.ViewClose,this.onViewClose,this),normalEvent.on(v.BATTLE_STATE,this.onBattleState,this),normalEvent.on(C.OnActivityFindUpdate,this.onActivityFindUpdate,this),normalEvent.on(c.GOODS_INFO_UPDATE,this.onBagUpdate,this),normalEvent.on(y.PAY_INFO_UPDATE,this.checkPayIcon,this),normalEvent.on(C.OnActivityCollectInfo,this.UpdateNewMsgRed,this),normalEvent.on(y.PAY_REWARD_UPDATE,this.UpdatePayReward,this),normalEvent.on(C.OnActivityGameInfoUpdate,this.updateGameInfo,this)}return t.clear=function(){},t.updateGameInfo=function(t){if(t.act_type==L.LoopyMusic){this.act_day=t.act_day,this.openLevelList=[],this.chapterInfo=[];for(var i,n=e(t.chapter_info);!(i=n()).done;){var o=i.value;this.openLevelList.push(o.chapter_id),this.chapterInfo.push(o)}this.openLevelList.sort((function(t,e){return t-e})),this.chapterInfo.sort((function(t,e){return t.chapter_id-e.chapter_id})),normalEvent.emit(w.OnActivityLoopyMusicGameLevelUpdate)}},t.activityChange=function(t){void 0===t&&(t=null),this.checkPop(),this.checkPayIcon();for(var e=0;e<this.sendProList.length;e++){var i=this.sendProList[e].type;if(!t||t.type==i){var n=IS(I).GetActivityInfo(i);n&&n.state==S.Open?this.sendProList[e].send():this.sendProList[e].redCheck&&this.sendProList[e].redCheck()}}},t.checkPop=function(){var t=IS(I).GetActivityInfo(L.Loopy);if(t&&t.state==S.Open){var e,i=a.ServerDate(1e3*a.serverTime),o=n.formatStr("#%s#%s#%s",i.getFullYear(),i.getMonth()+1,i.getDate()),s="ActivityLoopyPopView"+IS(l).GetRoleId();if((null!=(e=r.get(s))?e:"")==o)return;uiMgr.ViewIsAddPop("ActivityLoopyPopView")||(uiMgr.addPopView("ActivityLoopyPopView"),r.set(s,o))}},t.checkPayIcon=function(){var t=IS(I).GetActivityInfo(L.LoopyMerge);if(t&&t.state==S.Open){var e,i=IS(f).GetAcivityGift(h.Activity,t.type,t.round)[0];if(i&&(e=IS(f).GetPayGiftInfo(i.id)),e&&e.bought_times&&e.bought_times>=i.buy_times)IS(p).removeIcon(318);else{var n=IS(I).GetEndTime(t)-a.serverTime;n>0&&IS(p).addIcon(318,{leftTime:1==t.activityCfg.countdown?n:0,isPre:t.state==S.Preview})}}else IS(p).removeIcon(318)},t.onViewOpen=function(t){if("ActivityFindIcon"!=t){var i=IS(I).GetActivityInfo(L.LoopyFind);if(i&&i.state==S.Open){if(!this.viewList){this.viewList={};for(var n,o=configMoonfestival_search.getDatas(),r=e(o);!(n=r()).done;){var a=n.value;a.type==i.type&&a.group_id==i.roundCfg.group_id&&(this.viewList[a.system_view]=a.id)}}var s=this.viewList[t];if(s&&s==IS(I).getCurFind(L.LoopyFind))this.curOpen=s,this.isDungeon||uiMgr.openView("ActivityFindIcon",s),this.otherViewNum=0;else if(0!=this.curOpen){var c=uiMgr.getOpenView("ActivityFindIcon");c&&c.close(),this.otherViewNum++}}}},t.onViewClose=function(t){if("ActivityFindIcon"!=t){var i=IS(I).GetActivityInfo(L.LoopyFind);if(i&&i.state==S.Open){if(!this.viewList){this.viewList={};for(var n,o=configMoonfestival_search.getDatas(),r=e(o);!(n=r()).done;){var a=n.value;a.type==i.type&&a.group_id==i.roundCfg.group_id&&(this.viewList[a.system_view]=a.id)}}var s=this.viewList[t];if(s&&s==IS(I).getCurFind(L.LoopyFind)){var c=uiMgr.getOpenView("ActivityFindIcon");c&&c.close(),this.curOpen=0,this.otherViewNum=0}else 0!=this.curOpen&&(this.otherViewNum--,0!=this.otherViewNum||this.isDungeon||uiMgr.openView("ActivityFindIcon",this.curOpen))}}},t.onBattleState=function(t,e){var i=IS(I).GetActivityInfo(L.LoopyFind);if(i&&i.state==S.Open)if(e){this.isDungeon=!0;var n=uiMgr.getOpenView("ActivityFindIcon");n&&n.close()}else this.isDungeon=!1,0!=this.curOpen&&0==this.otherViewNum&&uiMgr.openView("ActivityFindIcon",this.curOpen)},t.onActivityFindUpdate=function(t){if(t&&t.act_type==L.LoopyFind&&t.pig_id==this.curOpen){this.curOpen=0;var e=uiMgr.getOpenView("ActivityFindIcon");e&&e.close()}},t.onBagUpdate=function(t,e){1920==e&&(IS(I).UpdateMainRedByActType(L.LoopyPass),IS(o).changeValue("loopy_pass",this.getPassRedNum())),1919==e&&(IS(I).UpdateMainRedByActType(L.LoopyBox),IS(o).changeValue("loopy_box",this.GetBoxRed()))},t.UpdatePayReward=function(){IS(I).UpdateMainRedByActType(L.LoopyArchery)},t.GetRedNum=function(){var t=0;return t+=this.GetStoreRed(),t+=this.getFindRedNum(),t+=this.getPassRedNum(),t+=this.GetTurnRed(),t+=this.GetBoxRed(),t+=this.getCardRedNum(),t+=this.GetOptionGiftRed(),t+=this.GetGameRed(),t+=IS(I).GetTaskRedNum(L.LoopyMusic)},t.GetLoginRedNum=function(){var t,i=IS(I).GetActivityInfo(L.LoopyLogin);if(!i||i.state!=S.Open)return 0;var n=IS(I).GetSignInfo(L.LoopyLogin);if(!n)return 0;for(var o,r=null!=(t=n.get_day)?t:[],a=configAct_login.getDatas(),s=e(a);!(o=s()).done;){var c=o.value;if(c.act_type==i.type&&c.group_id==i.roundCfg.group_id&&n.day>=c.day&&!r.includes(c.id))return 1}if(7==r.length){var d=i.activityCfg.main_icon;IS(p).removeIcon(d)}return 0},t.GetGameRed=function(){var t=IS(I).GetActivityInfo(L.LoopyArchery);if(t)for(var e in t.task_list)if(t.task_list.hasOwnProperty(e)&&t.task_list[e].state==A.CanGet)return 1;return 0},t.GetStoreRed=function(){var t=IS(I).GetActivityInfo(L.Loopy);if(!t||t.state!=S.Open)return 0;if(t){var e,i=String(t.id)+"#"+String(t.round),n="ActivityLoopyStoreRed"+IS(l).GetRoleId();return(null!=(e=r.get(n))?e:"")==i?0:1}return 0},t.getFindRedNum=function(){var t=IS(I).GetActivityInfo(L.LoopyFind);if(!t||t.state!=S.Open)return 0;var e=IS(I).getFindInfo(L.LoopyFind);if(!e)return 0;var i=e.list;for(var n in i){if(i.hasOwnProperty(n))if(1==i[n])return 1}return 0==e.total_reward&&IS(I).isAllFind(L.LoopyFind)?1:0},t.getPassRedNum=function(){var t=IS(I).GetActivityInfo(L.LoopyPass);if(!t||t.state!=S.Open)return 0;var e=0,i=t.roundCfg.group_id;return e=(e=e+u.checkRewardRP(i)>=0?1:0)+u.checkAddRewardRP(i)>0?1:0,e+=u.checkSpecialRewardRP(i),IS(d).getGoodsCountByGoodsGtid(1920)>0&&e++,e},t.GetTurnRed=function(){var t=IS(I).GetActivityInfo(L.LoopyTurn);if(!t||t.state!=S.Open)return 0;var e=0;return e+=IS(G).getRedNum(L.LoopyTurn),e+=this.GetTurnSelectRed()},t.GetTurnSelectRed=function(){return 0},t.GetBoxRed=function(){var t=IS(I).GetActivityInfo(L.LoopyBox);return t&&t.state==S.Open&&IS(d).getGoodsCountByGoodsGtid(1919)>0?1:0},t.GetOptionGiftRed=function(){var t=IS(I).GetActivityInfo(L.LoopyArchery);if(!t||t.state!=S.Open)return 0;for(var i,n=IS(f).GetAcivityGift(h.Activity,t.type,t.round),o=e(n);!(i=o()).done;){var r=i.value;if(0==r.price){var a=IS(f).GetPayGiftInfo(r.id);if(!a||2!=a.rewardState)return 1}}return 0},t.UpdateNewMsgRed=function(){var t,e,i=IS(I).GetActivityInfo(L.LoopyCard);if(i&&i.state==S.Open){var n=IS(I).getCollectInfo(L.LoopyCard);if(n){var a,s=uiMgr.getOpenView("ActivityLoopyCardMsgView"),c=IS(l).GetRoleId();if(this.newCardMsgRed[1]=0,!(a=this.preOpenMsgTime[1])){var d,u="ActivityLoopyCardMsgCheck_1_"+c;a=null!=(d=r.get(u))?d:0,this.preOpenMsgTime[1]=a}for(var v=0;v<n.send_list.length;v++){var p=n.send_list[v];if((!s||1!=s.curIndex)&&p.start_time>a){this.newCardMsgRed[1]=1;break}}if(this.newCardMsgRed[0]=0,!(a=this.preOpenMsgTime[0])){var f,h="ActivityLoopyCardMsgCheck_0_"+c;a=null!=(f=r.get(h))?f:0,this.preOpenMsgTime[0]=a}for(var y=0;y<n.recv_list.length;y++){var g=n.recv_list[y];if((!s||0!=s.curIndex)&&(g.start_time>a||0==g.state)){this.newCardMsgRed[0]=1;break}}IS(o).changeValue("ActivityLoopyCardMsgCheck_0",null!=(t=this.newCardMsgRed[0])?t:0),IS(o).changeValue("ActivityLoopyCardMsgCheck_1",null!=(e=this.newCardMsgRed[1])?e:0),IS(o).changeValue("ActivityLoopyCardMsgCheck",this.GetNewCardMsgRed()),IS(I).UpdateMainRedByActType(L.LoopyCard)}}},t.GetNewCardMsgRed=function(){return 1==this.newCardMsgRed[0]||1==this.newCardMsgRed[1]?1:0},t.CheckNewMsgRed=function(t){var e="ActivityLoopyCardMsgCheck_"+t+"_"+IS(l).GetRoleId();r.set(e,a.serverTime),this.preOpenMsgTime[t]=a.serverTime,this.newCardMsgRed[t]&&this.newCardMsgRed[t]>0&&this.UpdateNewMsgRed()},t.getCardRedNum=function(){var t=IS(I).GetActivityInfo(L.LoopyCard);if(!t)return 0;if(t.state==S.Open){var e=0;return e+=IS(I).GetTaskRedNum(L.LoopyCard),e+=this.GetNewCardMsgRed()}if(t.state==S.EndShow){var i=s.collect_five_blessing_goods.find((function(t){return t[0]==L.LoopyCard}))[1];return IS(d).getGoodsCountByGoodsGtid(i)>0?1:0}},t.checkHasOpenGuide=function(){var t=IS(l).GetRoleId(),e=r.get(R+t);return null!=e&&""!=e},t.setOpenGuide=function(){var t=IS(l).GetRoleId();r.set(R+t,1)},t.checkChapterUnlock=function(t){for(var e=0;e<this.openShotLevelList.length;e++)if(this.openShotLevelList[e]==t)return!0;return!1},t.getTotalStarNum=function(){var t=0,e=IS(I).GetActivityInfo(L.LoopyArchery);if(null==e)return 0;for(var i=e.task_list,n=IS(I).GetRoundCfg(L.LoopyArchery,e.round).task_list,o=0;o<n.length;o++)for(var r=configActivity_task_group.getDataByKey(n[o]).task_list,a=0;a<r.length;a++){var s=i[r[a]];s&&s.state!=A.Normal&&(t+=1)}return t},i}());i._RF.pop()}}}));

