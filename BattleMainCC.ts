System.register("chunks:///_virtual/BattleMainCC.ts",["./rollupPluginModLoBabelHelpers.js","cc","./env","./BattleData.ts","./BattleMain.ts","./MetaAttrib.ts","./Record.ts","./EnumDefine.ts","./AudioMgr.ts","./CameraMgr.ts","./index23.ts","./MainGame.ts","./BattleDefine.ts","./ChapterControl.ts","./ChapterDataCache.ts","./ChapterDefine.ts","./GvGControl.ts","./LoginDataCache.ts","./RoleDataCache.ts","./index91.ts","./ChapterArtifactGemCC.ts","./ChapterCrossParkPvpCC.ts","./ChapterCrossWarCC.ts","./ChapterCrossWarMonsterCC.ts","./ChapterDoubleLadderCC.ts","./ChapterFateCC.ts","./ChapterGvgCC.ts","./ChapterHalloweenPvpCC.ts","./ChapterIdoBossCC.ts","./ChapterParkPvpCC.ts","./ChapterRoleSoloCC.ts","./ChapterSeasonPvpCC.ts","./ChapterShenQiCC.ts","./ChapterStrategyActivityCC.ts","./ChapterTowerDefCC.ts","./ChapterWingCC.ts","./ChapterWingPreviewCC.ts","./ChapterWorldBossCC.ts","./MapCamera.ts","./index85.ts","./Map2.ts","./RenderMgrCC.ts","./TalkMgr.ts","./ChapterMainCC.ts","./ChapterArenaCC.ts","./ChapterSoloCC.ts","./ChapterCoinCC.ts","./ChapterDiamondCC.ts","./ChapterTeam3CC.ts","./ChapterFarmCC.ts","./ChapterTeam20CC.ts","./ChapterMountCC.ts","./ChapterCrossPvpCC.ts","./ChapterSevenCC.ts","./ChapterSlavePvpCC.ts","./UnitModelObj.ts","./FlyNum.ts","./Timer.ts","./CoroutineMgr.ts"],(function(t){"use strict";var e,a,r,i,o,n,s,h,l,u,c,C,p,d,f,m,v,g,b,S,M,T,R,w,P,y,L,A,E,D,B,I,k,_,x,F,W,G,N,U,O,V,H,K,q,z,Q,j,Y,X,J,Z,$,tt,et,at,rt,it,ot,nt,st,ht,lt,ut,ct,Ct,pt,dt;return{setters:[function(t){e=t.inheritsLoose,a=t.regeneratorRuntime,r=t.createForOfIteratorHelperLoose},function(t){i=t.cclegacy,o=t.sys,n=t.isValid,s=t.find,h=t.director,l=t.Director,u=t.screen,c=t.game},function(t){C=t.EDITOR},function(t){p=t.ChapterType},function(t){d=t.BattleMain},function(t){f=t.AttribDefine},function(t){m=t.Record},function(t){v=t.RunState,g=t.BattleFlag,b=t.RunMode},function(t){S=t.audioMgr},function(t){M=t.cameraMgr},null,function(t){T=t.GameState},function(t){R=t.BattleEventDefine},function(t){w=t.default},function(t){P=t.ChapterDataCache},function(t){y=t.ChapterEventDefine},function(t){L=t.default},function(t){A=t.LoginDataCache},function(t){E=t.RoleDataCache},null,function(t){D=t.ChapterArtifactGemCC},function(t){B=t.ChapterCrossParkPvpCC},function(t){I=t.ChapterCrossWarCC},function(t){k=t.ChapterCrossWarMonsterCC},function(t){_=t.ChapterDoubleLadderCC},function(t){x=t.ChapterFateCC},function(t){F=t.ChapterGvgCC},function(t){W=t.ChapterHalloweenPvpCC},function(t){G=t.ChapterIdoBossCC},function(t){N=t.ChapterParkPvpCC},function(t){U=t.ChapterRoleSoloCC},function(t){O=t.ChapterSeasonPvpCC},function(t){V=t.ChapterShenQiCC},function(t){H=t.ChapterStrategyActivityCC},function(t){K=t.ChapterTowerDefCC},function(t){q=t.ChapterWingCC},function(t){z=t.ChapterWingPreviewCC},function(t){Q=t.ChapterWorldBossCC},function(t){j=t.MapCamera},function(t){Y=t.poolInit},function(t){X=t.Map},function(t){J=t.RenderMgrCC},function(t){Z=t.TalkMgr},function(t){$=t.ChapterMainCC},function(t){tt=t.ChapterArenaCC},function(t){et=t.ChapterSoloCC},function(t){at=t.ChapterCoinCC},function(t){rt=t.ChapterDiamondCC},function(t){it=t.ChapterTeam3CC},function(t){ot=t.ChapterFarmCC},function(t){nt=t.ChapterTeam20CC},function(t){st=t.ChapterMountCC},function(t){ht=t.ChapterCrossPvpCC},function(t){lt=t.ChapterSevenCC},function(t){ut=t.ChapterSlavePvpCC},function(t){ct=t.EnvironmentColor},function(t){Ct=t.flyNumMgr},function(t){pt=t.TimerGroup},function(t){dt=t.CoroutineGroup}],execute:function(){var ft;i._RF.push({},"05285FqfvFA4av7mpiFmwU+","BattleMainCC",void 0);var mt=((ft={})[p.Main]=$,ft[p.Arena]=tt,ft[p.Solo]=et,ft[p.Coin]=at,ft[p.Diamond]=rt,ft[p.Team3]=it,ft[p.Farm]=ot,ft[p.Team20]=nt,ft[p.Mount]=st,ft[p.Fate]=x,ft[p.RoleSolo]=U,ft[p.WorldBoss]=Q,ft[p.Gvg]=F,ft[p.CrossPvp]=ht,ft[p.StrategyActivity]=H,ft[p.CrossWarPvp]=I,ft[p.CrossWarMonster]=k,ft[p.ParkPvp]=N,ft[p.HalloweenPvp]=W,ft[p.ShenQi]=V,ft[p.ArtifactGem]=D,ft[p.Seven]=lt,ft[p.Slave]=ut,ft[p.CrossParkPvp]=B,ft[p.Wing]=q,ft[p.Wing2]=q,ft[p.Wing3]=q,ft[p.TowerDef]=K,ft[p.SeasonPvp]=O,ft[p.DoubleLadder]=_,ft[p.WingPreview]=z,ft[p.IdoBoss]=G,ft),vt=t("BattleMainCC",function(t){function i(){var e;return(e=t.call(this,null)||this).unitRoot=void 0,e.mapRoot=void 0,e.shipRoot=void 0,e.mapTopRoot=void 0,e.effectBottomRoot=void 0,e.effectTopRoot=void 0,e.flyNumRoot=void 0,e.barRoot=void 0,e.shadowRoot=void 0,e.viewRoot=void 0,e.hub=void 0,e.map=void 0,e.battleTimer=void 0,e.switchAction=void 0,e.isLoadFinish=!1,e.talkMgr=void 0,e.battleCoroutine=void 0,e.mapLv=!1,e.fullScreen=!1,e.loadWaitTime=0,e.fullScrennCheckTime=0,e.cheatNum=0,e.logStr="",Y(),e.mapCamera=new j,e.renderMgr=new J,e.battleTimer=new pt("battle"),e.talkMgr=new Z,e.battleCoroutine=new dt,e}e(i,t);var d=i.prototype;return d.now=function(){return o.now()},d.load=a().mark((function t(){var e,r,i,o,s,h,l,u;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=IS(P),null!=this.map&&this.map.destroy(),!(r.speed_scale>2)){t.next=4;break}return t.abrupt("return");case 4:if(null!=i){t.next=10;break}return i=IS(P).battleData,t.next=8,coroutine.wait(.1);case 8:t.next=4;break;case 10:this.roleId=IS(E).GetRoleId(),this.runState=v.LoadMap;case 12:if(n(this.hub.node)){t.next=17;break}return t.next=15,coroutine.wait(.1);case 15:t.next=12;break;case 17:if(battleMain.playerCtrs.length=0,this.openLogCount=GlobalDefine.BATTLE_COUNT,this.openLogCount&&(this.logCountMap=[]),this.data.playerList=i.playerList,this.data.chapterId=i.chapterId,this.data.chapterType=i.chapterType,this.data.chapterMode=i.chapterMode,this.random.seed=i.seed,this.data.recordType=i.recordType,this.data.recordWin=i.recordWin,this.data.passTime=i.passTime,this.data.combatList=i.combatList,this.data.openServerDay=i.openServerDay,this.data.buffs=i.buffs,this.data.monster=i.monster,this.data.playerImage=i.playerImage,this.data.battleCheckout=i.battleCheckout,this.data.seasonPveDamAdd=i.seasonPveDamAdd,this.data.dummy=i.dummy,i.recordType>0?(this.data.source=i.source,this.runMode=b.Record):this.runMode=b.Main,this.hitThrowDis=!0,this.chapter=new mt[this.data.chapterType](this),this.chapter.setChapter(this.data.chapterId,!0),null!=(o=this.chapter.config)){t.next=43;break}throw Error(this.data.chapterId+":关卡配置不存在！");case 43:if(this.resetFactor(),this.battleFlag=g.OPEN_GRAPHIC,s=this.chapter.mapConfig,h=s.path,this.mapLv&&(h="prefab/map/map_lvse"),this.map=new X(h,s.move),ct.set(s.color[0],s.color[1],s.color[2]),this.mapCamera.nextPart(o.part?o.part-1:0),this.mapCamera.startPartMove(0),this.playerAuto=!0,l=this.mapCamera.offsetX,this.frameCount=0,uiMgr.openFullScreenNum.size>0&&(this.battleFlag|=g.UI_MASK),this.printLogFlag=GlobalDefine.BATTLE_LOG&&i.battleCheckout>=2,this.timeScale=r.speed_scale,3==i.battleCheckout&&(this.runMode=b.Check,this.playerAuto=1!=i.manualOperator,this.curRecord=new m(this),1==i.manualOperator&&null!=i.operators&&this.curRecord.fillCommand(i.operators,!0)),this.chapter.init(),this.chapter.loadData(l),this.collectRecord=2==i.battleCheckout?1:0,this.collectRecord>0?(this.curRecord=new m(this),this.curRecord.manual=!this.playerAuto):this.runMode==b.Main&&(this.curRecord=null),!(this.timeScale>2)){t.next=65;break}return t.abrupt("return");case 65:this.renderMgr.init(),this.hub.reset(),this.hub.initBattleEvent(),u=configChapter_type.getDataByKey(this.data.chapterType),1==(null!=(e=null==u?void 0:u.pet_dialogue)?e:0)&&this.talkMgr.init();case 70:if(!(this.battleFlag&g.OPEN_GRAPHIC)||this.map.isLoadFinish){t.next=75;break}return void(t.next=73);case 73:t.next=70;break;case 75:return this.logStr="",normalEvent.emit(R.BATTLE_MASK_OPEN),t.next=79,coroutine.wait(.1);case 79:if(uiMgr.close("BattleLoadView"),this.data.chapterType==IS(P).chapterType){t.next=86;break}return IS(w).reqEnterChapter(0,!0),IS(P).battleData=null,this.enterChapter(),normalEvent.emit(y.BATTLE_STATE,p.Main,!1),t.abrupt("return");case 86:this.data.chapterType==p.Main&&normalEvent.emit(y.BATTLE_STATE,p.Main,!1),this.isLoadFinish=!0,this.runState=v.Running,this.chapter.start(),this.unitMgr.updateDepth(),IS(P).battleData=null;case 92:case"end":return t.stop()}}),t,this)})),d.start=function(t){n(this.unitRoot)||(this.unitRoot=s("BattleRoot/Unit"),this.mapRoot=s("BattleRoot/Map"),this.shipRoot=s("BattleRoot/Ship"),this.mapTopRoot=s("BattleRoot/Map_Top"),this.effectBottomRoot=s("BattleRoot/Effect_Bottom"),this.effectTopRoot=s("BattleRoot/Effect_Top"),this.flyNumRoot=s("BattleRoot/Fly"),this.barRoot=s("BattleRoot/Bar"),this.viewRoot=s("UIRoot/BattleView"),this.shadowRoot=s("BattleRoot/Shadow"),this.hub=uiMgr.openView("BattleHubView"),h.on(l.EVENT_AFTER_DRAW,this.onEndDrawUpdate,this),this.updateCameraOffset()),this.data.playerList={},coroutine.start(this.load(),"battle")},d.stop=function(){var e;this.hub.visible=!1,M.battleCamera.enabled=!1,this.runningToPart=!1,coroutine.stopGroup("battle"),this.battleCoroutine.clearAll(),battleEvent.clear(),this.battleTimer.clear(),t.prototype.stop.call(this),Ct.clear(),Ct.clearPool(),effectPool.clearPool(),hpBarPool.clearPool(),unitModelPool.clearPool(),shipModelPool.clearPool(),null==(e=this.map)||e.destroy(),this.gc()},d.gc=function(){o.garbageCollect()},d._nextPart=a().mark((function t(e){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,coroutine.wait(1);case 2:return this.hub.showNextPartEffect(),t.next=5,coroutine.wait(2);case 5:if(3==this.chapter.nextPartState){t.next=10;break}return t.next=8,coroutine.wait(.1);case 8:t.next=5;break;case 10:this.hub.updatePart();case 11:case"end":return t.stop()}}),t,this)})),d.startNextPart=function(t){this.chapter.toNextPart(t),this.battleCoroutine.start(this._nextPart(t),"battle")},d.checkCheat=function(){for(var t,e=this.mainCtr.units,a=!1,i=r(e);!(t=i()).done;){for(var o=t.value,n=f.att_speed;n<=f.max;n++)if(n!=f.def&&o.data.attribs[n].checkCheat()){a=!0;break}if(a)break}if(a){if(this.data.chapterType==p.Main&&(this.cheatNum++,this.cheatNum%5!=0))return;var s="玩家ID:"+IS(A).roleId+" 服务器:"+IS(A).loginServer.id+" 关卡类型:"+this.data.chapterType+" 关卡ID:"+this.data.chapterId;printLogErr(s),loginControl.apmlog(5006,s)}return a},d.toResult=function(t,e,a,r,i){void 0===r&&(r=!1),void 0===i&&(i=null),normalEvent.emit(y.CHAPTER_BATTLE_RESUTL,t,e,a,this.runMode,r,i),this.openLogCount&&C&&(_global._battle_log_count=this.getLogCountStr()),this.printLogFlag&&IS(L).reqLog(IS(E).GetRoleId(),this.logStr),0==a&&this.checkCheat()},d.updateCameraOffset=function(t){if(void 0===t&&(t=!1),t)this.mapCamera.offsetY=0;else{var e=720/u.windowSize.width*u.windowSize.height,a=((e/=2)-640)/2;this.mapCamera.offsetY=a<2?a-30:a}},d.enterChapter=function(t,e,a){var r=this;void 0===t&&(t=0),void 0===e&&(e=!1),void 0===a&&(a=!1),(a||this.runState!=v.Stop)&&(this.runState=v.Wait,this.fullScreen=e,this.updateCameraOffset(e),this.switchAction=function(){var e;r.runningToPart=!1,coroutine.stopGroup("battle"),r.battleCoroutine.clearAll(),r.unitMgr.battleOver(),battleEvent.clear(),null==(e=r.chapter)||e.destroy(),r.battleTimer.clear(),r.frameTimer.clear(),r.mapCamera.stopMove(),t>0&&S.playSound("bossfight"),r.battleTimer.start(t>0?1.5:.5,1,(function(){r.mapCamera.nextPart(0),r.mapCamera.startPartMove(0),r.unitMgr.clear(),r.renderMgr.clear(),Ct.clear(),r.mainCtr=null,r.start(),r.gc()})),normalEvent.emit(R.BATTLE_MASK_CLOSE,t),r.runState=v.Loading,r.loadWaitTime=5})},d.stopChapter=function(){var t=this;this.runState!=v.Stop&&(this.runState=v.Stop,this.switchAction=function(){t.stop()})},d.onGameLogicUpdate=function(t){var e;this.battleCoroutine.update(t),this.renderMgr.onUpdate(t),Ct.update(t),this.mapCamera.onUpdate(t),null==(e=this.map)||e.onUpdate(t)},d.update=function(t,e){if(void 0===e&&(e=!1),this.battleTimer.update(t),!e){if(0!=IS(A).newRole)return;if(mainGame.state!=T.Runing)return;if(this.runState==v.Stop)return}this.gameLogic(t)},d.onEndDrawUpdate=function(){if(this.runState==v.Loading){if(this.loadWaitTime<=0)return IS(w).reqEnterChapter(0,!0),this.enterChapter(),void normalEvent.emit(y.BATTLE_STATE,p.Main,!1);this.loadWaitTime-=c.deltaTime}if(null!=this.switchAction)return this.switchAction(),void(this.switchAction=null);if(this.runState!=v.Stop){var t=IS(P);if((t.currentLoadType==p.Main||t.chapterType==p.Main)&&uiMgr.openFullScreenNum.size>0){if(o.now()-this.fullScrennCheckTime>5e3&&(this.fullScrennCheckTime=o.now(),!uiMgr.checkFullScreenView()&&!uiMgr.openFullScreenNum.has("LowModeView"))){uiMgr.openFullScreenNum.clear();var e=uiMgr.getView("MainView");e&&(e.visible=!0)}this.battleFlag|=g.UI_MASK,M.battleCamera.enabled=!1,this.hub.visible=!1}else this.battleFlag&=~g.UI_MASK,M.battleCamera.enabled=!0,this.hub.visible=!0;this.runState==v.Running&&this.chapter.onEndDrawUpdate()}},d.printLogDebug=function(t){this.logStr+=t+"\n",printLog(t)},d.printLog=function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}((function(t){this.logStr+=t+"\n",printLog(t)})),d.playSound=function(t){this.battleFlag&g.SIMP_MODEL||this.battleFlag&g.UI_MASK||S.playSoundById(t)},d.on=function(t,e,a,r){battleEvent.on(t,e,a,r)},d.emit=function(t,e,a,r,i,o){battleEvent.emit(t,e,a,r,i,o)},i}(d));_G("battleMain",new vt),i._RF.pop()}}}));

