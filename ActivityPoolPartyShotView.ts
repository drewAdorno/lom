System.register("chunks:///_virtual/ActivityPoolPartyShotView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./AudioMgr.ts","./NodeUtil.ts","./StringUtil.ts","./TimeUtil.ts","./index57.ts","./SpineSkeleton.ts","./MathUtil.ts","./MessageView.ts","./ActivityControl.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./ActivityPoolPartyDataCache.ts","./ActivityPoolPartyDefine.ts","./BaseView.ts"],(function(t){"use strict";var i,e,n,o,h,a,s,r,d,u,c,l,g,f,p,m,v,S,C,y,I,T,w,P,M,E,U,R,_,x,A;return{setters:[function(t){i=t.inheritsLoose},function(t){e=t.cclegacy,n=t.Button,o=t.Label,h=t.RichText,a=t.Widget,s=t.UITransform,r=t.Vec3,d=t.Vec2,u=t.PhysicsSystem2D,c=t.RigidBody2D,l=t.BoxCollider2D,g=t.Contact2DType,f=t.sys,p=t.PHYSICS_2D_PTM_RATIO,m=t.CircleCollider2D},function(t){v=t.audioMgr},function(t){S=t.default},function(t){C=t.default},function(t){y=t.default},null,function(t){I=t.SpineSkeleton},function(t){T=t.default},function(t){w=t.default},function(t){P=t.default},function(t){M=t.default},function(t){E=t.ActivityEventDefine,U=t.ActivityType,R=t.ActivityState},function(t){_=t.default},function(t){x=t.starToResult},function(t){A=t.BaseView}],execute:function(){e._RF.push({},"35b15aO2TVCwqdI+rwOO1e3","ActivityPoolPartyShotView",void 0);var D=["MX_tx_yongchipaidui_fengu","MX_tx_yongchipaidui_langu","MX_tx_yongchipaidui_lvgu"];t("default",function(t){function e(){var i;return(i=t.call(this)||this).banDefeat=!0,i.txtChapter=void 0,i.txtResNum=void 0,i.useStep=0,i.curChapter=0,i.curChapterStateCfg=void 0,i.isMoving=!1,i.isMovingOn=!1,i.nodeUnitParent=void 0,i.nodeUnitItem=void 0,i.unitItems=void 0,i.unitIdToInfo={},i.usingShotCfg=void 0,i.touchList=[],i.curShottingItem=void 0,i.curShottingRig=void 0,i.nodeShottingParent=void 0,i.utShottingParent=void 0,i.time=0,i.txtTime=void 0,i.endTime=0,i.nodeEdge1=void 0,i.nodeEdge2=void 0,i.nodeEdge3=void 0,i.isWatingEnd=!1,i.circleTween=void 0,i.widgetMap=void 0,i.nodeWindTip=void 0,i.txtWind=void 0,i.txtDistance=void 0,i.nodeShot=void 0,i.nodeShottingPoint=void 0,i.name="ActivityPoolPartyShotView",i.url="ui/module/activityPoolParty/ActivityPoolPartyShotView",i}i(e,t);var A=e.prototype;return A.onInit=function(){var t=this,i=this.findChild("bottom/btnClose");this.addComponentCallbackListener(i,n.EventType.CLICK,(function(){t.isMoving?w.showFlyTip(GetLanguage(200758)):w.showBoxTip({tip:GetLanguage(201211),func:function(i){"type_yes"==i&&t.close()}})})),this.nodeEdge1=this.findChild("map/edge1"),this.nodeEdge2=this.findChild("map/edge2"),this.nodeEdge3=this.findChild("map/edge3"),this.nodeEdge1.active=!1,this.nodeEdge2.active=!1,this.nodeEdge3.active=!1,this.nodeWindTip=this.findChild("top/title/wind/imgWind"),this.txtWind=this.findChildComponent("top/title/wind/txtWind",o),this.txtDistance=this.findChildComponent("top/title/txtDistance",o),this.txtTime=this.findChildComponent("top/txtTime",o);var e=this.findChild("bottom/btnGuide");this.addComponentCallbackListener(e,n.EventType.CLICK,(function(){uiMgr.openView("ActivityPoolPartyGameGuideView",1)})),this.txtChapter=this.findChildComponent("top/title/txtChapter",o),this.txtResNum=this.findChildComponent("resRoot/resItem/txtNum",h),this.nodeUnitParent=this.findChild("map/UnitParent"),this.nodeUnitItem=this.findChild("map/UnitParent/Unit"),this.nodeUnitItem.active=!1;var r=this.findChild("map");this.widgetMap=r.getComponent(a),this.widgetMap.scheduleOnce((function(){t.nodeEdge1.active=!0,t.nodeEdge2.active=!0,t.nodeEdge3.active=!0}),0),this.nodeShottingParent=this.findChild("map/shotting"),this.utShottingParent=this.nodeShottingParent.getComponent(s),this.nodeShot=this.findChild("map/ready");var d=this.findChild("map/btnShot");this.addComponentCallbackListener(d,n.EventType.CLICK,(function(){t.onSlingShotClick()})),this.nodeShottingPoint=this.findChild("map/ready/shottingPoint")},A.registerUpdateHandler=function(){this.addEvent(E.OnActivityInfoUpdate,this.updateInfo,this),this.addEvent(E.OnActivityGameResult,this.OnRecvChapterResult,this)},A.onAfterOpen=function(){var t=IS(M).GetActivityInfo(U.PoolPartyEndShotGame);if(null!=t&&t.state==R.Open){var i=t.state_time[R.Open];this.endTime=i.end_time,this.curChapter=IS(_).curLevelId_shot,this.curChapterStateCfg=configArchery_chapter.getDataByKey(this.curChapter),this.updateResShow(),this.updateTime(),this.updateChapter(),this.updateWind(),this.trySetShotTween(!0)}else this.close()},A.trySetShotTween=function(t){var i=this;this.nodeShot.active=t,null!=this.circleTween&&(this.circleTween.stop(),this.circleTween=null),this.nodeShot.eulerAngles=new r(0,0,0),t&&(this.circleTween=this.addTween(0,4,2,(function(t,e){i.nodeShot.eulerAngles=new r(0,0,e<=1?-e*i.curChapterStateCfg.launch_angle:e<=3?(e-2)*i.curChapterStateCfg.launch_angle:(4-e)*i.curChapterStateCfg.launch_angle)})).loop(-1).start())},A.updateChapter=function(){this.txtChapter.string=C.formatStrWithMirrorDeal(GetLanguage(200797),this.curChapter);var t=C.formatStrWithMirrorDeal(GetLanguage(700030196),this.curChapterStateCfg.distance);this.txtDistance.string=C.formatStrWithMirrorDeal(GetLanguage(203963),t),this.updateChapterUnit()},A.updateWind=function(){var t;t=0==this.curChapterStateCfg.wind_direction?T.getRandomInt(0,2):1==this.curChapterStateCfg.wind_direction?0:1,this.nodeWindTip.eulerAngles=new r(0,0,t<=0?180:0);var i=T.getRandomInt(this.curChapterStateCfg.wind_power[0],this.curChapterStateCfg.wind_power[1]+1),e=Math.floor(i/1e3)/10;this.txtWind.string=C.formatStrWithMirrorDeal(GetLanguage(700030197),e);var n=e*p*6,o=new d(t<=0?-n:n,0);u.instance.gravity=o},A.updateChapterUnit=function(){var t=this;this.unitItems||(this.unitItems=[]);for(var i=this.curChapterStateCfg.template,e=0,n=function(n){var o=i[n],h=o[0];null==t.getUnitInfoById(h)&&(t.unitIdToInfo[h]={id:h,unit_id:0,hp:1,max_hp:1,ext:[]});var a=t.unitItems[e]||t.newUnitItem();a.id=h,a.node.active=!0,a.node.name=String(h),a.effect&&(t.removeUIEffect(a.effect),a.effect=null);var s=Math.floor(3*Math.random());a.effect=t.addUIEffect("prefab/ui-effect/"+D[s],a.nodeEffect,-1,null,t.curChapterStateCfg.scale/1e4,(function(i){var e=i.node;a.spine=e.getComponent(I);var n=o[2];a.spine.needAnimation=0!=n?"run":"idle",i.node.getComponent(m).on(g.END_CONTACT,t.onEndContactTarget,t);var h=e.getComponent(c);a.rig=h,h.linearVelocity=new d(0,0);var s=o[3];i.dir=0==s?1:-1;var r=new d(0==s?-n:n,0);h.scheduleOnce((function(){h.applyForceToCenter(r,!0)}))})),a.node.position=new r(o[1][0],o[1][1],0),t.updateSingleUnit(a),t.unitItems[e]=a,e+=1},o=0;o<i.length;o++)n(o);for(var h=e;h<this.unitItems.length;h++)this.hideUnitItem(this.unitItems[h])},A.newUnitItem=function(){var t=nodeInstantiate.instantiate(this.nodeUnitItem);return t.parent=this.nodeUnitParent,{node:t,nodeTx:S.findChild(t,"tx"),nodeEffect:S.findChild(t,"effect")}},A.getUnitInfoById=function(t){return this.unitIdToInfo[t]},A.updateSingleUnitById=function(t){var i=this.getUnitItemById(t);null!=i&&this.updateSingleUnit(i)},A.getUnitItemById=function(t){if(null!=this.unitItems)for(var i=0;i<this.unitItems.length;i++){var e=this.unitItems[i];if(e.id&&e.id==t)return e}},A.updateSingleUnit=function(t){var i=this.getUnitInfoById(t.id);(i?i.hp:1)<=0?this.hideUnitItem(t):t.node.acitve=!0},A.trySetShottingItem=function(t,i,e){var n=this;this.curShottingItem&&(this.removeUIEffect(this.curShottingItem),this.curShottingRig=null,this.curShottingItem=null);var o=this.utShottingParent.convertToNodeSpaceAR(i);this.isMoving=!0,this.useStep=this.useStep+1,this.updateResShow(),this.curShottingItem=this.addUIEffect("prefab/ui-effect/MX_yongchipaidui_zidan",this.nodeShottingParent,-1,new d(o.x,o.y),this.curChapterStateCfg.scale/1e4*.5,(function(i){n.curShottingRig=i.node.getComponent(c),i.node.getComponent(l).on(g.BEGIN_CONTACT,n.onBeginContact,n);var o=new d(t.x*n.curChapterStateCfg.launch_power/10,t.y*n.curChapterStateCfg.launch_power/10);n.curShottingRig.scheduleOnce((function(){n.curShottingRig.linearVelocity=new d(0,0),n.curShottingRig.angularVelocity=10,i.node.active=!0,i.node.eulerAngles=new r(0,0,e),n.curShottingRig.scheduleOnce((function(){n.curShottingRig.applyForceToCenter(o,!0)}))})),n.addTimer(.5,1,(function(){n.isMovingOn=!0}))}))},A.onBeginContact=function(t,i){var e=this,n=i.node.name;if("edge1"==n||"edge2"==n||"edge3"==n)return this.curShottingRig.angularVelocity=0,this.curShottingRig.linearVelocity=new d(0,0),void this.curShottingRig.scheduleOnce((function(){e.onMoveEnd()}));var o=Number(i.node.parent.parent.name);if(null!=o){var h=this.getUnitItemById(o);h&&(h.rig.linearVelocity=new d(0,0),this.curShottingRig.angularVelocity=0,this.curShottingRig.linearVelocity=new d(0,0),v.playSound("xhy_youyongquan"),h.spine.setAnimation(0,"skill1",!1),h.spine.addAnimation(0,"idle",!0),this.touchList.push({k:o,v:1}),this.isWatingEnd=!0,this.curShottingRig.scheduleOnce((function(){e.curShottingRig.node.active=!1})),this.addTimer(2,1,(function(){e.onMoveEnd()})))}},A.onEndContactTarget=function(t,i){var e=i.node.name;if("edge1"==e||"edge2"==e){var n=Number(t.node.parent.parent.name),o=this.getUnitItemById(n),h=this.getUIEffect(o.effect);h.dir=-h.dir}},A.onBeforeClose=function(){if(this.isWatingEnd=!1,this.isMoving=!1,this.isMovingOn=!1,this.unitIdToInfo={},this.usingShotCfg=null,this.touchList=[],this.curShottingRig=null,this.curShottingItem=null,this.time=0,this.endTime=0,this.useStep=0,this.trySetShotTween(!1),this.unitItems)for(var t=0;t<this.unitItems.length;t++)this.hideUnitItem(this.unitItems[t])},A.hideUnitItem=function(t){t.spine=null,this.removeUIEffect(t.effect),t.rig.linearVelocity=new d(0,0),t.id=null,t.node.active=!1},A.onDestroy=function(){if(this.unitItems)for(var t=0;t<this.unitItems.length;t++)this.unitItems[t].node.destroy();this.unitItems=null},A.updateTime=function(){var t=C.formatStrWithMirrorDeal(GetLanguage(200043),y.formatTimeStringForSecond(Math.max(0,this.endTime-y.serverTime)));f.uiMirror&&(t=y.formatTimeStringForSecond(Math.max(0,this.endTime-y.serverTime))),this.txtTime.string=t},A.onUpdate=function(t){this.time=this.time+t,!this.isWatingEnd&&this.isMoving&&this.curShottingRig&&0==this.curShottingRig.node.active&&(this.curShottingRig.node.active=!0),this.time<1||(this.time=0,0!=this.endTime&&this.updateTime())},A.onMoveEnd=function(){if(this.isMoving){for(var t=[],i={},e=0;e<this.touchList.length;e++){var n=this.touchList[e];i[n.k]||(i[n.k]=0),i[n.k]=i[n.k]+n.v}for(var o in i)t.push({k:Number(o),v:i[o]});this.isMoving=!1,this.isMovingOn=!1,this.isWatingEnd=!1,this.trySetShotTween(!0),this.removeUIEffect(this.curShottingItem),this.curShottingRig=null,this.curShottingItem=null,this.touchList=[],this.updateWind();for(var h=0;h<t.length;h++){var a=t[h].k;t[h].v;this.unitIdToInfo[a].hp=0,this.updateSingleUnitById(a)}var s=!0;for(var r in this.unitIdToInfo){if(this.unitIdToInfo[r].hp>0){s=!1;break}}for(var d=this.curChapterStateCfg.star_step,u=0,c=0;c<d.length;c++)if(this.useStep<=d[c]){u=3-c;break}s?IS(P).send_24_103(U.PoolPartyEndShotGame,this.curChapter,x[u]):this.useStep>=this.curChapterStateCfg.limit&&IS(P).send_24_103(U.PoolPartyEndShotGame,this.curChapter,0)}},A.updateResShow=function(){var t=this.curChapterStateCfg.limit-this.useStep;this.txtResNum.string=C.formatStrWithMirrorDeal(GetLanguage(700030198),t,this.curChapterStateCfg.limit)},A.updateInfo=function(t){t.type==U.PoolPartyEndShotGame&&t.state!=R.Open&&this.close()},A.OnRecvChapterResult=function(t){if(t.act_type==U.PoolPartyEndShotGame)if(0!=t.result){for(var i=this.curChapterStateCfg.star_step,e=0,n=0;n<i.length;n++)if(this.useStep<=i[n]){e=3-n;break}uiMgr.openView("ActivityPoolPartyGameResultView",t.result,e,U.PoolPartyEndShotGame)}else uiMgr.openView("ActivityPoolPartyGameResultView",0,0,U.PoolPartyEndShotGame)},A.onSlingShotClick=function(){if(!(this.isMoving||this.useStep>=this.curChapterStateCfg.limit)){var t=this.nodeShot.eulerAngles.z+90,i=new d(Math.cos(t*(Math.PI/180)),Math.sin(t*(Math.PI/180)));this.trySetShottingItem(i,this.nodeShottingPoint.worldPosition,t),this.trySetShotTween(!1),this.isMoving=!0}},e}(A));e._RF.pop()}}}));

