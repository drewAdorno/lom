System.register("chunks:///_virtual/ActivityLoopyMusicGameView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./V2.ts","./AudioMgr.ts","./NodeUtil.ts","./StorageUtil.ts","./StringUtil.ts","./index57.ts","./SpineSkeleton.ts","./ConfigGlobal.ts","./RoleDataCache.ts","./ActivityControl.ts","./ActivityDefine.ts","./ActivityLoopyDataCache.ts","./ActivityLoopyDefine.ts","./BaseView.ts"],(function(e){"use strict";var t,i,n,o,s,d,h,c,r,u,a,l,f,v,m,L,p,g,C,T,y,S,N,b,I,R,x,A,w,G;return{setters:[function(e){t=e.inheritsLoose,i=e.createForOfIteratorHelperLoose},function(e){n=e.cclegacy,o=e.Sprite,s=e.Label,d=e.ProgressBar,h=e.Button,c=e.macro,r=e.Node,u=e.UITransform,a=e.Widget,l=e.UIOpacity,f=e.Quat,v=e.Size},function(e){m=e.V2},function(e){L=e.audioMgr},function(e){p=e.default},function(e){g=e.default},function(e){C=e.default},null,function(e){T=e.SpineSkeleton},function(e){y=e.ConfigGlobal},function(e){S=e.RoleDataCache},function(e){N=e.default},function(e){b=e.ActivityEventDefine,I=e.ActivityType},function(e){R=e.default},function(e){x=e.ActivityLoopyEvent,A=e.NoteResult,w=e.NoteType},function(e){G=e.BaseView}],execute:function(){n._RF.push({},"e2726TO4BFD+oe602smE2zM","ActivityLoopyMusicGameView",void 0);var M=136,_=136,E=600,P=[215,200,190,175],k=1e3,j=1150,U=[-50/j,-15/j,20/j,50/j],O=["shiwu","youxiu","wanmei"],W=["idol_lose","idol_chang","idol_win"],F=(e("default",function(e){function n(){var t;return(t=e.call(this)||this).completeGame=!1,t.pauseGame=!1,t.startGame=!1,t.isTestLevel=!1,t.isChangingTime=!1,t.time=0,t.curTime=0,t.curScore=0,t.txtScore=void 0,t.comboNum=0,t.isNewRecord=!1,t.levelNoteList=[],t.curNoteList=[],t.curNoteIndex=0,t.nodeNote=void 0,t.nodeLine1=void 0,t.nodeLine2=void 0,t.nodeLine3=void 0,t.nodeLine4=void 0,t.showResultTimer=-1,t.nodeShowResult=void 0,t.nodeResultEffect=void 0,t.imgResult=void 0,t.resultSpine=void 0,t.txtTimes=void 0,t.txtCounting=void 0,t.pbGame=void 0,t.nodeLightList=[],t.btnList=[],t.isLineClicked=[!1,!1,!1,!1],t.isLinePressed=[!1,!1,!1,!1],t.isLineSlided=[0,0,0,0],t.nodeTest=void 0,t.btnLeft=void 0,t.btnRight=void 0,t.btnReplay=void 0,t.btnPause=void 0,t.curAdjustLevel=void 0,t.txtLeft=void 0,t.txtRight=void 0,t.name="ActivityLoopyMusicGameView",t.url="ui/module/activityLoopy/ActivityLoopyMusicGameView",t.banDefeat=!0,t.fullScreen=!0,t}t(n,e);var u=n.prototype;return u.onInit=function(){var e=this;this.nodeNote=this.findChild("note"),this.nodeLine1=this.findChild("map/line1"),this.nodeLine2=this.findChild("map/line2"),this.nodeLine3=this.findChild("map/line3"),this.nodeLine4=this.findChild("map/line4"),this.nodeShowResult=this.findChild("showResult"),this.nodeResultEffect=this.findChild("showResult/nodeResultEffect"),this.imgResult=this.findChildComponent("showResult/nodeResultEffect/imgResult",o),this.resultSpine=this.findChildComponent("showResult/nodeResultEffect/MX_tx_loopy_wanmei",T),this.txtTimes=this.findChildComponent("showResult/txtTimes",s),this.txtCounting=this.findChild("txtCounting"),this.pbGame=this.findChildComponent("pbGame",d);for(var t=1;t<=4;t++){var i=this.findChild("map/light"+t);this.nodeLightList.push(i)}this.txtScore=this.findChildComponent("score/txtScore",s);var n=this.findChild("btnClose");this.addComponentCallbackListener(n,h.EventType.CLICK,(function(){e.startGame&&(e.isTestLevel?e.destroy():(e.pauseGame=!0,L.pauseMusic(),uiMgr.openView("ActivityLoopyMusicGameConfirmView")))}));for(var c=function(t){var i=e.findChild("map/btnList/btn"+t);e.addComponentCallbackListener(i,r.EventType.TOUCH_START,(function(i){e.nodeLightList[t-1].active=!0,e.isLinePressed[t-1]=!0,e.isLineClicked[t-1]=!0,e.addTimer(.2,0,(function(){e.isLineClicked[t-1]=!1}))})),e.addComponentCallbackListener(i,r.EventType.TOUCH_CANCEL,(function(i){var n=i.getUILocation().x-i.getUIStartLocation().x;e.nodeLightList[t-1].active=!1,e.isLinePressed[t-1]=!1,0!=n&&(e.isLineSlided[t-1]=n>0?1:-1,e.addTimer(.2,0,(function(){e.isLineSlided[t-1]=0})))})),e.addComponentCallbackListener(i,r.EventType.TOUCH_END,(function(i){e.nodeLightList[t-1].active=!1,e.isLinePressed[t-1]=!1})),e.btnList.push(i)},u=1;u<=4;u++)c(u);this.nodeTest=this.findChild("nodeTest"),this.txtLeft=this.findChildComponent("nodeTest/txtLeft",s),this.txtRight=this.findChildComponent("nodeTest/txtRight",s),this.btnLeft=this.findChild("nodeTest/btnLeft"),this.btnRight=this.findChild("nodeTest/btnRight"),this.btnPause=this.findChild("nodeTest/btnPause"),this.btnReplay=this.findChild("nodeTest/btnReplay"),this.addComponentCallbackListener(this.btnLeft,h.EventType.CLICK,(function(){e.curAdjustLevel-1<1||e.isChangingTime||(e.curAdjustLevel=e.curAdjustLevel-1,g.set("adjustlevel"+IS(S).GetRoleId(),e.curAdjustLevel),e.isChangingTime=!0,e.curTime-=.1,e.addTimer(.5,1,(function(){e.isChangingTime=!1})),e.changeAdjustText())})),this.addComponentCallbackListener(this.btnRight,h.EventType.CLICK,(function(){e.curAdjustLevel+1>21||e.isChangingTime||(e.curAdjustLevel=e.curAdjustLevel+1,g.set("adjustlevel"+IS(S).GetRoleId(),e.curAdjustLevel),e.isChangingTime=!0,e.curTime+=.1,e.addTimer(.5,1,(function(){e.isChangingTime=!1})),e.changeAdjustText())})),this.addComponentCallbackListener(this.btnPause,h.EventType.CLICK,(function(){e.pauseGame||(e.pauseGame=!0,L.pauseMusic(),e.btnPause.active=!1,e.btnReplay.active=!0)})),this.addComponentCallbackListener(this.btnReplay,h.EventType.CLICK,(function(){e.pauseGame=!1,L.restoreMusic(),e.isTestLevel&&(e.btnPause.active=!0,e.btnReplay.active=!1)}))},u.registerUpdateHandler=function(){this.addEvent(x.OnActivityLoopyMusicGameContinue,this.OnGameContinue,this),this.addEvent(b.OnActivityGameResult,this.showResultView)},u.onAfterOpen=function(){var e=this;c.ENABLE_MULTI_TOUCH=!0,L.stopMusic(),1==this.openArgs[0]&&(this.isTestLevel=!0,this.curAdjustLevel=g.get("adjustlevel"+IS(S).GetRoleId()),this.changeAdjustText()),this.initGame(),this.txtCounting.active=!0,this.addTimer(3,0,(function(){e.txtCounting.active=!1,e.startGame=!0,L.playMusic(IS(R).curLevelCfg.bgm,!1),e.nodeTest.active=e.isTestLevel,e.btnPause.active=!0,e.btnReplay.active=!1}))},u.onBeforeClose=function(){c.ENABLE_MULTI_TOUCH=!1,L.playMusic("loopy_mainbgm")},u.onDestroy=function(){for(var e=0;e<this.curNoteList.length;e++)this.curNoteList[e].destroy();this.curNoteList=[]},u.onUpdate=function(e){if(!this.completeGame&&!this.pauseGame&&this.startGame){this.curTime+=e,this.initNote(),this.checkNote(e);for(var t,n=E*e,o=i(this.curNoteList);!(t=o()).done;){var s=t.value;s.isMoving&&s.move(n,e)}if(this.curNoteIndex>this.levelNoteList.length-1&&0==this.curNoteList.length)return this.completeGame=!0,this.pbGame.progress=1,this.isNewRecord=this.curScore>IS(R).chapterInfo[IS(R).curLevelId-1].status,void IS(N).send_24_103(I.LoopyMusic,IS(R).curLevelId,this.curScore);this.pbGame.progress=this.curTime/IS(R).curLevelCfg.time}},u.changeAdjustText=function(){var e=0,t=0;this.curAdjustLevel>11?t=.1*(this.curAdjustLevel-1)-1:this.curAdjustLevel<11&&(e=1-.1*(this.curAdjustLevel-1)),this.txtLeft.string=C.formatStr(GetLanguage(401526),e.toFixed(1)),this.txtRight.string=C.formatStr(GetLanguage(401525),t.toFixed(1))},u.OnGameContinue=function(){var e=this;this.txtCounting.active=!0,this.addTimer(3,0,(function(){e.txtCounting.active=!1,e.pauseGame=!1,L.restoreMusic()}))},u.initGame=function(){for(this.completeGame=!1,this.pauseGame=!1,this.startGame=!1,this.time=0,this.curTime=.1*(g.get("adjustlevel"+IS(S).GetRoleId())-1)-1,this.curScore=0,this.txtScore.string=this.curScore.toString(),this.curNoteIndex=0,this.curNoteList=[],this.getLevelNote();this.curTime>=this.levelNoteList[this.curNoteIndex].appearTime/1e3;)this.curNoteIndex<=this.levelNoteList.length-1&&this.curNoteIndex++},u.getLevelNote=function(){this.levelNoteList=[];var e=configMusic_notes.getDataByList("barrier",IS(R).curLevelId);IS(R).curLevelCfg=configMusic_main.getDataByKey(IS(R).curLevelId);for(var t,n=1,o=i(e);!(t=o()).done;){var s=t.value,d={id:n,type:s.type,appearTime:s.appear_time,line:s.number,clickTime:s.click_time,direction:s.direction};n++,this.levelNoteList.push(d)}this.levelNoteList.sort((function(e,t){return e.appearTime-t.appearTime})),E=1e6/IS(R).curLevelCfg.speed},u.initNote=function(){if(!(this.curNoteIndex>this.levelNoteList.length-1))for(;this.curTime>=this.levelNoteList[this.curNoteIndex].appearTime/1e3;)if(this.createNote(),this.curNoteIndex>this.levelNoteList.length-1)return},u.createNote=function(){var e=nodeInstantiate.instantiate(this.nodeNote),t=new F(e,this,this.levelNoteList[this.curNoteIndex]);this.curNoteList.push(t),this.curNoteIndex++},u.destroyNote=function(e){for(var t=0;t<this.curNoteList.length;t++)this.curNoteList[t].id==e&&(this.curNoteList[t].destroy(),this.curNoteList.splice(t,1))},u.checkNote=function(e){for(var t,n=this,o=function(){var i=t.value;if(i.type==w.SingleNote){var o=i.checkInArea();if(o==A.Miss||i.isFinished)return{v:void 0};n.isLineClicked[i.line-1]&&(i.isTouched=!0,i.isFinished=!0,i.changeAnim(1),i.isMoving=!1,n.addTimer(.2,0,(function(){i.changeAnim(0),n.destroyNote(i.id)})),n.onGetScore(o))}if(i.type==w.SlideNote){var s=i.checkInArea();if(s==A.Miss||i.isFinished)return{v:void 0};n.isLineClicked[i.line-1]&&(i.isTouched=!0),n.isLineSlided[i.line-1]==i.direction&&1==i.isTouched&&(i.isFinished=!0,n.isLineSlided[i.line-1]=0,i.changeAnim(1),n.addTimer(.5,0,(function(){i.changeAnim(0),n.destroyNote(i.id)})),n.onGetScore(s))}if(i.type==w.LongNote){var d=i.checkInArea();if(d==A.Miss||i.isFinished)return{v:void 0};if(n.isLineClicked[i.line-1]&&!i.isTouched)return i.isTouched=!0,i.isPressed=!0,n.comboNum++,i.comboTime=y.ouxiang_changan/1e3,i.changeAnim(2),n.onGetScore(d),{v:void 0};if(!i.isPressed)return{v:void 0};if(n.isLinePressed[i.line-1]||(i.isPressed=!1,i.changeAnim(0)),i.comboTime>0){if(!n.isLinePressed[i.line-1])return i.isFinished=!0,{v:void 0};i.comboTime-=e}else{if(!n.isLinePressed[i.line-1])return i.changeAnim(0),i.isFinished=!0,{v:void 0};n.comboNum++,i.comboTime=y.ouxiang_changan/1e3,n.onGetScore(d)}}},s=i(this.curNoteList);!(t=s()).done;){var d=o();if("object"==typeof d)return d.v}},u.onGetScore=function(e){this.showResult(e),this.curScore+=e==A.Good?y.ouxiang_good_score:y.ouxiang_perfect_score,this.curScore+=this.getBonusScore(),this.txtScore.string=this.curScore.toString()},u.getBonusScore=function(){for(var e=y.ouxiang_num,t=e.length-1;t>=0;t--)if(this.comboNum>=e[t][0])return e[t][2];return 0},u.showResult=function(e){var t=this;this.nodeShowResult.active=!0,L.playSound(W[e>0?2:0]),this.resultSpine.setAnimation(0,O[e],!1),e==A.Miss?this.comboNum=0:this.comboNum++,this.txtTimes.string=this.comboNum>1?this.comboNum.toString():"",-1!=this.showResultTimer&&(this.removeTimer(this.showResultTimer),this.showResultTimer=-1),this.showResultTimer=this.addTimer(.5,0,(function(){t.nodeShowResult.active=!1}))},u.showResultView=function(e){e.act_type==I.LoopyMusic&&uiMgr.openView("ActivityLoopyMusicGameResultView",this.curScore,this.isNewRecord)},n}(G)),function(){function e(e,t,i){this.node=void 0,this.id=void 0,this.type=void 0,this.line=void 0,this.direction=void 0,this.comboTime=0,this.isTouched=!1,this.isPressed=!1,this.isFinished=!1,this.isMoving=!0,this.view=void 0,this.nodeUT=void 0,this.nodeWidget=void 0,this.nodeOpacity=void 0,this.nodeStart=void 0,this.nodeTopLine=void 0,this.nodeLeftLine=void 0,this.nodeRightLine=void 0,this.nodeEffect=void 0,this.modelId=-1,this.node=e,this.view=t,this.nodeUT=p.findChildComponent(this.node,"",u),this.nodeWidget=p.findChildComponent(this.node,"",a),this.nodeOpacity=p.findChildComponent(this.node,"",l),this.nodeStart=p.findChild(this.node,"bottom/start"),this.nodeTopLine=p.findChild(this.node,"topLine"),this.nodeLeftLine=p.findChild(this.node,"bottom/leftLine"),this.nodeRightLine=p.findChild(this.node,"bottom/rightLine"),this.nodeEffect=p.findChild(this.node,"bottom/nodeEffect"),this.id=i.id,this.type=i.type,this.line=i.line,this.direction=1==i.direction?-1:1,this.nodeTopLine.active=this.type==w.LongNote,this.nodeLeftLine.active=this.type==w.SlideNote&&1==i.direction,this.nodeRightLine.active=this.type==w.SlideNote&&4==i.direction,this.nodeTopLine.active&&(this.nodeTopLine.getComponent(u).height=E*i.clickTime/1e3,this.nodeTopLine.setRotation(new f(0,0,.5*U[this.line-1]))),1==this.line&&this.node.setParent(t.nodeLine1),2==this.line&&this.node.setParent(t.nodeLine2),3==this.line&&this.node.setParent(t.nodeLine3),4==this.line&&this.node.setParent(t.nodeLine4),this.nodeWidget.left=P[this.line-1],this.nodeWidget.bottom=k}var t=e.prototype;return t.move=function(e,t){if(this.isPressed)return this.nodeTopLine.getComponent(u).height-=e,void(this.nodeTopLine.getComponent(u).height<3&&this.view.destroyNote(this.id));this.nodeWidget.bottom=this.nodeWidget.bottom-e,this.nodeWidget.left=this.nodeWidget.left+e*U[this.line-1];var i=this.nodeOpacity.opacity+115*e/j;this.nodeOpacity.opacity=i>255?255:i,this.nodeStart.getComponent(u).contentSize=new v(this.nodeStart.getComponent(u).contentSize.x+.5*M*e/j,this.nodeStart.getComponent(u).contentSize.y+.5*_*e/j),this.nodeWidget.bottom<-this.nodeUT.contentSize.y&&this.view.destroyNote(this.id)},t.checkInArea=function(){var e=IS(R).curLevelCfg;if((this.type==w.SingleNote||this.type==w.SlideNote)&&this.nodeWidget.bottom>0){if(this.nodeWidget.bottom<k*e.perfect/e.speed)return A.Perfect;if(this.nodeWidget.bottom<k*e.good/e.speed)return A.Good}if(this.type==w.LongNote)if(this.isTouched){if(this.nodeWidget.bottom>130-this.nodeUT.contentSize.height)return A.Perfect}else if(this.nodeWidget.bottom>0){if(this.nodeWidget.bottom<k*e.perfect/e.speed)return A.Perfect;if(this.nodeWidget.bottom<k*e.good/e.speed)return A.Good}return A.Miss},t.changeAnim=function(e){0==e?(this.nodeEffect.active=!1,-1!=this.modelId&&(this.view.removeUIEffect(this.modelId),this.modelId=-1)):(this.nodeEffect.active=!0,this.modelId=this.view.addUIEffect("prefab/ui-effect/MX_tx_loopyyinyou",this.nodeEffect,-1,new m(0,0),1,(function(t){t.aniName="idle1_"+e})))},t.destroy=function(){this.type==w.LongNote||this.isFinished||this.view.showResult(A.Miss),this.type!=w.LongNote||this.isTouched||this.view.showResult(A.Miss),-1!=this.modelId&&(this.view.removeUIEffect(this.modelId),this.modelId=-1),this.nodeStart.destroy(),this.nodeLeftLine.destroy(),this.nodeTopLine.destroy(),this.nodeRightLine.destroy(),this.node.destroy()},e}());n._RF.pop()}}}));

