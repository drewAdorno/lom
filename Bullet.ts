System.register("chunks:///_virtual/Bullet.ts",["./rollupPluginModLoBabelHelpers.js","cc","./ObjectPool.ts","./FixMath.ts","./EnumDefine.ts","./V2.ts"],(function(t){"use strict";var i,e,s,o,n,r;return{setters:[function(t){i=t.createClass},function(t){e=t.cclegacy},function(t){s=t.ObjectPool},function(t){o=t.FixMath},function(t){n=t.BattleFlag},function(t){r=t.V2}],execute:function(){e._RF.push({},"5a18bwLxspDu6EKyTY/rPt4","Bullet",void 0);var h,a=new r,_=new r;function c(t,i,e,s,n,r,h,a){var _=o.round(1-a),c=_*_*i+2*a*_*s+a*a*r,f=_*_*e+2*a*_*n+a*a*h;t.set(c,f)}!function(t){t[t.Liner=1]="Liner",t[t.Bezier=2]="Bezier"}(h||(h={}));var f=t("Bullet",function(){function t(){this._runner=void 0,this._config=void 0,this._target=void 0,this._stop=!1,this._destroy=!1,this._curPoint=new r,this._startPoint=new r,this._targtPoint=new r,this._handlePos=new r,this._time=void 0,this._effect=void 0,this._shadow=void 0,this._track=!0,this.param=[]}t.alloc=function(i,e,s,o,n){void 0===n&&(n=!0);var r=t._pool.alloc();r._runner=i;var h=configBullet.getDataByKey(e);if(r._config=h,r._target=o,r._curPoint.set(s),null==h)throw new Error("弹道配置不存在！！"+e);return r._targtPoint.set(o.getBindPos(h.end_bind)),r.reset(),r._track=n,r},t.allocToPos=function(i,e,s,o){var n=t._pool.alloc();n._runner=i;var r=configBullet.getDataByKey(e);return n._config=r,n._curPoint.set(s),n._targtPoint.set(o),n.reset(),n};var e=t.prototype;return e.reset=function(){var t=this._config;if(t.type==h.Bezier){this._startPoint.set(this._curPoint),this._time=0,r.add(this._handlePos,this._startPoint,this._targtPoint),this._handlePos.multiplyScalar(.5);var i=o.round(r.distance(this._startPoint,this._targtPoint)/500);this._handlePos.y=o.round(this._handlePos.y+Math.min(t.hegiht,o.round(t.hegiht*i)))}this._track=!1,this._stop=!1,this._destroy=!1,this.loadEffect()},e.loadEffect=function(){if(!this._stop&&!this._effect){var t=this._config,i=this._runner.battleMain;if(i.battleFlag&n.OPEN_GRAPHIC&&!(i.battleFlag&n.UI_MASK)){var e=configEffect.getDataByKey(t.effect);e&&e.is_ban&&i.battleFlag&n.SIMP_MODEL||(this._effect=i.renderMgr.allocEffect(t.effect,null,-1),this._effect.position=this._curPoint,this._effect.scale*=i.effectScale,i.battleFlag&n.SIMP_MODEL||(this._shadow=i.renderMgr.allocEffect(1,i.shadowRoot,-1),this._shadow.position=this._curPoint))}}},e.onUpdate=function(t){if(this._stop)return!1;if(null!=this._target&&this._target.isDestroy)this._stop=!0;else{this.loadEffect();var i=20;this._track&&(this._targtPoint.set(this._target.getBindPos(this._config.end_bind)),i=o.round(i+this._target.data.modelConfig.radius));var e=this._targtPoint;this._config.type==h.Liner?this.moveToPoint(e,i,t)&&(this._runner.onBulletAction(this,this._target,e,this.param),this._stop=!0,this.destroyEffect()):this.moveTo(this._startPoint,e,i,t)&&(this._runner.onBulletAction(this,this._target,e,this.param),this._stop=!0,this.destroyEffect())}},e.destroyEffect=function(){var t=this._runner.battleMain;if(t.battleFlag&n.OPEN_GRAPHIC&&!(t.battleFlag&n.UI_MASK)&&!(t.battleFlag&n.SIMP_MODEL)&&this._config.destroy_effect>0){var i=t.renderMgr.allocEffect(this._config.destroy_effect);i.position=this._curPoint,i.scale*=t.effectScale}},e.cacheReset=function(){this._stop=!0,this._effect&&this._effect.free(),this._shadow&&this._shadow.free(),this._effect=null,this._runner=null,this._target=null,this._shadow=null,this.param.length=0},e.cacheDestroy=function(){this._destroy=!0,this.cacheReset()},e.destroy=function(){this._destroy||(this._destroy=!0,t._pool.free(this))},e.moveToPoint=function(t,i,e){var s=r.distance(t,this._curPoint)-i;a.set(0,0),r.subtract(a,t,this._curPoint),a.normalize(),a.multiplyScalar(Math.min(o.round(this._config.speed*e),s)),this._curPoint.add(a);var n=(s=o.round(r.distance(t,this._curPoint)-i))<=.1;return this._effect&&(this._effect.lookAt(a.x,a.y),this._effect.position=this._curPoint,this._shadow&&(_.set(this._curPoint.x,this._curPoint.y-50),this._shadow.position=_)),n},e.moveTo=function(t,i,e,s){for(var n=this._handlePos,h=this._time,f=1,u=o.round(this._config.speed*s),l=o.round(u*u);o.round(f-h)>.01;){var d=o.round((h+f)/2);c(a,t.x,t.y,n.x,n.y,i.x,i.y,d),a.subtract(this._curPoint),a.lengthSqr()>l?f=d:h=d}var g=!1;this._time=o.round(o.round(h+f)/2);var P=o.round(r.distance(i,this._curPoint)-e)<=.1;return(this._time>=.9999||P)&&(g=!0),c(a,t.x,t.y,n.x,n.y,i.x,i.y,this._time),r.subtract(_,a,this._curPoint),this._curPoint.set(a),null==this._effect||(this._effect.lookAt(_.x,_.y),this._effect.position=this._curPoint,this._shadow&&(_.set(this._curPoint.x,this._curPoint.y-50),this._shadow.position=_)),g},i(t,[{key:"isStop",get:function(){return this._stop}}]),t}());f._pool=new s(f,100),e._RF.pop()}}}));

