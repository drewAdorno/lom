System.register("chunks:///_virtual/ActivitySevenShotView.ts",["./rollupPluginModLoBabelHelpers.js","cc","./AudioMgr.ts","./NodeUtil.ts","./StringUtil.ts","./TimeUtil.ts","./index57.ts","./SpineSkeleton.ts","./ConfigGlobal.ts","./BagModel.ts","./MessageView.ts","./ActivityControl.ts","./ActivityDataCache.ts","./ActivityDefine.ts","./ActivitySevenDataCache.ts","./BaseView.ts"],(function(t){"use strict";var i,e,n,o,s,h,a,d,r,c,u,g,f,l,p,m,v,S,C,I,y,T,M,_,A,b,U,x,E,w,B,L,P;return{setters:[function(t){i=t.inheritsLoose},function(t){e=t.cclegacy,n=t.Button,o=t.Label,s=t.Sprite,h=t.sys,a=t.HorizontalTextAlignment,d=t.RichText,r=t.Widget,c=t.UITransform,u=t.js,g=t.Node,f=t.ProgressBar,l=t.Vec2,p=t.RigidBody2D,m=t.CircleCollider2D,v=t.Contact2DType,S=t.Vec3},function(t){C=t.audioMgr},function(t){I=t.default},function(t){y=t.default},function(t){T=t.default},null,function(t){M=t.SpineSkeleton},function(t){_=t.ConfigGlobal},function(t){A=t.BagModel},function(t){b=t.default},function(t){U=t.default},function(t){x=t.default},function(t){E=t.ActivityEventDefine,w=t.ActivityType,B=t.ActivityState},function(t){L=t.default},function(t){P=t.BaseView}],execute:function(){e._RF.push({},"c703fZ/8zJB07gZdZlPgc7l","ActivitySevenShotView",void 0);_.autumn_strength_dailycap[1];var R=_.autumn_stage_pass_condition,O=[1,2];t("default",function(t){function e(){var i;return(i=t.call(this)||this).txtChapter=void 0,i.txtResNum=void 0,i.useStep=0,i.curChapter=0,i.curChapterCfgId=0,i.curChapterCfg=void 0,i.curChapterStateCfg=void 0,i.isMoving=!1,i.isMovingOn=!1,i.nodeUnitParent=void 0,i.nodeUnitItem=void 0,i.unitItems=void 0,i.unitIdToInfo={},i.usingShotId=0,i.usingShotCfg=void 0,i.touchList=[],i.nodeCancel=void 0,i.nodeCancelOut=void 0,i.nodeCancelIn=void 0,i.cancelPosition=void 0,i.curShottingItem=void 0,i.curShottingRig=void 0,i.nodeShottingParent=void 0,i.utShottingParent=void 0,i.time=0,i.spineSlingShot=void 0,i.boneA=void 0,i.utSlingShot=void 0,i.oriBoneAPosX=void 0,i.oriBoneAPosY=void 0,i.shotIdToItem={},i.txtTime=void 0,i.imgSwitch=void 0,i.oriSpinePos=void 0,i.startTouchMove=!1,i.oriRotation=void 0,i.tempDirX=0,i.endTime=0,i.nodeEdge1=void 0,i.nodeEdge2=void 0,i.nodeEdge3=void 0,i.nodeEdge4=void 0,i.isWatingEnd=!1,i.widgetMap=void 0,i.name="ActivitySevenShotView",i.url="ui/module/activity/ActivitySevenShotView",i}i(e,t);var _=e.prototype;return _.onInit=function(){var t=this,i=this.findChild("bottom/btnClose");this.addComponentCallbackListener(i,n.EventType.CLICK,(function(){t.isMoving?b.showFlyTip(GetLanguage(200758)):b.showBoxTip({tip:GetLanguage(201211),func:function(i){"type_yes"==i&&t.close()}})})),this.nodeEdge1=this.findChild("map/edge1"),this.nodeEdge2=this.findChild("map/edge2"),this.nodeEdge3=this.findChild("map/edge3"),this.nodeEdge4=this.findChild("map/edge4"),this.nodeEdge1.active=!1,this.nodeEdge2.active=!1,this.nodeEdge3.active=!1,this.nodeEdge4.active=!1,this.txtTime=this.findChildComponent("top/txtTime",o);var e=this.findChild("bottom/btnGuild");this.addComponentCallbackListener(e,n.EventType.CLICK,(function(){uiMgr.openView("ActivitySevenShotGuideView")}));var g=this.findChild("map/btnSwitch");this.addComponentCallbackListener(g,n.EventType.CLICK,(function(){t.isMoving?b.showFlyTip(GetLanguage(200758)):uiMgr.openView("ActivitySevenShotSwitchView",t.usingShotId)})),this.imgSwitch=this.findChildComponent("map/btnSwitch/imgIcon",s);var f=this.findChild("top/title/btnTip");this.addComponentCallbackListener(f,n.EventType.CLICK,(function(){b.showBoxTip({tip:GetLanguage(201662),btnCnt:1,horizontalAlign:h.uiMirror?a.RIGHT:a.LEFT})})),this.txtChapter=this.findChildComponent("top/title/txtChapter",o),this.txtResNum=this.findChildComponent("resRoot/resItem/txtNum",d),this.nodeUnitParent=this.findChild("map/UnitParent"),this.nodeUnitItem=this.findChild("map/UnitParent/Unit"),this.nodeUnitItem.active=!1,this.nodeCancel=this.findChild("map/cancelArea"),this.cancelPosition=this.nodeCancel.worldPosition,this.nodeCancelOut=this.findChild("map/cancelArea/cancelArea1"),this.nodeCancelIn=this.findChild("map/cancelArea/cancelArea2");var l=this.findChild("map");this.widgetMap=l.getComponent(r),this.widgetMap.scheduleOnce((function(){t.nodeEdge1.active=!0,t.nodeEdge2.active=!0,t.nodeEdge3.active=!0,t.nodeEdge4.active=!0}),0),this.nodeShottingParent=this.findChild("map/shotting"),this.utShottingParent=this.nodeShottingParent.getComponent(c),this.spineSlingShot=this.findChildComponent("map/MX_tx_dangong",M),this.boneA=this.spineSlingShot.findBone("a"),this.oriBoneAPosX=this.boneA.x,this.oriBoneAPosY=this.boneA.y,this.utSlingShot=this.spineSlingShot.node.getComponent(c),this.oriRotation=this.boneA.data.rotation;for(var p=0;p<2;p++){var m=O[p],v=configSeven_trial_bullet.getDataByKey(m),S=this.findChild(u.formatStr("map/ready%s/%s",p+1,v.effect_name));this.shotIdToItem[m]={node:S,spine:S.getComponent(M),id:m,nodeGuide:I.findChild(S,"guideLine")},this.shotIdToItem[m].nodeGuide.active=!1}this.initTouch()},_.setGuideLineActive=function(t){this.shotIdToItem[this.usingShotId].nodeGuide.active=t},_.initTouch=function(){var t=this,i=this.utSlingShot.node;this.addComponentCallbackListener(i,g.EventType.TOUCH_START,(function(i){t.onTouchStart(i)})),this.addComponentCallbackListener(i,g.EventType.MOUSE_DOWN,(function(i){t.onTouchStart(i)})),this.addComponentCallbackListener(i,g.EventType.TOUCH_MOVE,(function(i){t.onTouchMove(i)})),this.addComponentCallbackListener(i,g.EventType.MOUSE_MOVE,(function(i){t.onTouchMove(i)})),this.addComponentCallbackListener(i,g.EventType.TOUCH_END,(function(i){t.onTouchEnd(i)})),this.addComponentCallbackListener(i,g.EventType.TOUCH_CANCEL,(function(i){t.onTouchEnd(i)})),this.addComponentCallbackListener(i,g.EventType.MOUSE_UP,(function(i){t.onTouchEnd(i)}))},_.registerUpdateHandler=function(){this.addEvent(E.OnActivityInfoUpdate,this.updateInfo,this),this.addEvent(E.OnSevenShotSwitch,this.OnSevenShotSwitch,this),this.addEvent(E.OnSevenChapterResult,this.OnSevenChapterResult,this)},_.onAfterOpen=function(){var t=IS(x).GetActivityInfo(w.SevenGame);if(null!=t&&t.state==B.Open){var i=t.state_time[B.Open];this.endTime=i.end_time,this.curChapter=this.openArgs[0],this.curChapterCfg=configSeven_trial_stage.getDataByKey(this.curChapter),this.curChapterCfgId=this.curChapterCfg.template[0][0],this.curChapterStateCfg=configSeven_trial_stagetemplate.getDataByKey(this.curChapterCfgId),this.nodeCancel.active=!1,this.updateResShow(),this.trySetUsingShot(),this.updateTime(),this.setGuideLineActive(!1),this.updateChapter(),IS(L).checkHasOpenGuide()||(uiMgr.openView("ActivitySevenShotGuideView"),IS(L).setOpenGuide())}else this.close()},_.updateChapter=function(){this.txtChapter.string=y.formatStrWithMirrorDeal(GetLanguage(200797),this.curChapter),this.updateChapterUnit()},_.updateChapterUnit=function(){var t=this;this.unitItems||(this.unitItems=[]);for(var i=this.curChapterStateCfg.arrange,e=0,n=function(n){var o=i[n],s=o[0],h=o[1],a=configSeven_trial_unit.getDataByKey(h),d=t.getUnitInfoById(s);if(null==d&&(t.unitIdToInfo[s]={id:s,unit_id:h,hp:a.enemy_hp,max_hp:a.enemy_hp,ext:[]}),3==a.type&&d&&d.hp<=0)return"continue";var r=t.unitItems[e]||t.newUnitItem();r.id=s,r.node.active=!0,r.cfg=a,r.node.name=String(s),r.effect&&(t.removeUIEffect(r.effect),r.effect=null),r.effect=t.addUIEffect(u.formatStr("prefab/ui-effect/%s",a.effect_name),r.nodeEffect,-1,null,1,(function(t){var i=t.node;r.spine=i.getComponent(M),r.spine.needAnimation="idle"})),r.node.position=new S(o[2][0],o[2][1],0),r.nodePbNormalHp.active=3==a.type&&h!=R,r.nodePbBossHp.active=3==a.type&&h==R,t.updateSingleUnit(r),t.unitItems[e]=r,e+=1},o=0;o<i.length;o++)n(o);for(var s=e;s<this.unitItems.length;s++)this.hideUnitItem(this.unitItems[s])},_.newUnitItem=function(){var t=nodeInstantiate.instantiate(this.nodeUnitItem);return t.parent=this.nodeUnitParent,{node:t,nodeTx:I.findChild(t,"tx"),nodeEffect:I.findChild(t,"effect"),nodePbNormalHp:I.findChild(t,"pbNormalHp"),pbNormalHp:I.findChildComponent(t,"pbNormalHp",f),nodePbBossHp:I.findChild(t,"pbBossHp"),pbBossHp:I.findChildComponent(t,"pbBossHp",f)}},_.getUnitInfoById=function(t){return this.unitIdToInfo[t]},_.updateSingleUnitById=function(t){var i=this.getUnitItemById(t);null!=i&&this.updateSingleUnit(i)},_.getUnitItemById=function(t){if(null!=this.unitItems)for(var i=0;i<this.unitItems.length;i++){var e=this.unitItems[i];if(e.id&&e.id==t)return e}},_.updateSingleUnit=function(t){if(3==t.cfg.type){var i=this.getUnitInfoById(t.id),e=i?i.hp:t.cfg.enemy_hp,n=i?i.max_hp:t.cfg.enemy_hp;t.cfg.id==R?t.pbBossHp.progress=Math.min(1,e/n):t.pbNormalHp.progress=Math.min(1,e/n),e<=0?this.hideUnitItem(t):t.node.acitve=!0}},_.trySetUsingShot=function(){null!=this.usingShotId&&0!=this.usingShotId||(this.usingShotId=1),this.usingShotCfg=configSeven_trial_bullet.getDataByKey(this.usingShotId),this.setUsingStatus()},_.setUsingStatus=function(){for(var t in this.shotIdToItem){var i=this.shotIdToItem[t];i.node.active=i.id==this.usingShotId}this.loadIcon(this.imgSwitch,"autumn_shot",this.usingShotCfg.picture)},_.trySetShottingItem=function(t,i){var e=this;this.curShottingItem&&(this.removeUIEffect(this.curShottingItem),this.curShottingRig=null,this.curShottingItem=null);var n=this.utShottingParent.convertToNodeSpaceAR(i);this.isMoving=!0,this.useStep=this.useStep+1,this.updateResShow(),this.curShottingItem=this.addUIEffect(u.formatStr("prefab/ui-effect/%s",this.usingShotCfg.effect_name),this.nodeShottingParent,-1,new l(n.x,n.y),1,(function(i){i.node.getComponent(M).needAnimation="run",e.curShottingRig=i.node.getComponent(p),i.node.getComponent(m).on(v.BEGIN_CONTACT,e.onBeginContact,e);var n=new l(t.x*e.usingShotCfg.first_force,t.y*e.usingShotCfg.first_force);e.curShottingRig.scheduleOnce((function(){e.curShottingRig.linearVelocity=new l(0,0),i.node.active=!0,e.curShottingRig.scheduleOnce((function(){e.curShottingRig.applyForceToCenter(n,!0)}))})),e.addTimer(.5,1,(function(){e.isMovingOn=!0}))}))},_.onBeginContact=function(t,i){var e=Number(i.node.parent.parent.name),n=this.getUnitItemById(e);if(n)if(2!=n.cfg.type){if(n.spine.setAnimation(0,"hit",!1),n.spine.addAnimation(0,"idle",!0),C.playSound("zhongqiu_jizhong"),1!=n.cfg.type)if(2!=this.usingShotCfg.type){for(var o=this.getUnitInfoById(e),s=o?o.hp:n.cfg.enemy_hp,h=o?o.max_hp:n.cfg.enemy_hp,a=0,d=0;d<this.touchList.length;d++)this.touchList[d].k==e&&(a+=this.touchList[d].v*this.usingShotCfg.demage_num);var r=s-a,c=Math.max(0,r-this.usingShotCfg.demage_num);this.touchList.push({k:e,v:1}),normalTween.to(r,c,.5,(function(t,i){n.cfg.id==R?n.pbBossHp.progress=Math.min(1,i/h):n.pbNormalHp.progress=Math.min(1,i/h)})).call((function(){c<=0&&(n.node.active=!1)})).start()}else this.onBombContact()}else this.curShottingRig.linearVelocity=new l(this.curShottingRig.linearVelocity.x*(n.cfg.speed_effect/1e4),this.curShottingRig.linearVelocity.y*(n.cfg.speed_effect/1e4))},_.onBombContact=function(){var t=this;C.playSound("zhongqiu_shecheng"),this.isWatingEnd=!0,this.curShottingRig.scheduleOnce((function(){t.curShottingRig.node.active=!1}),0);for(var i=function(i){var e=t.unitItems[i],n=e.id;if(!n||0==n)return"continue";if(3!=e.cfg.type)return"continue";var o=t.getUnitInfoById(n),s=o?o.hp:e.cfg.enemy_hp,h=o?o.max_hp:e.cfg.enemy_hp,a=Math.max(0,s-t.usingShotCfg.demage_num);t.touchList.push({k:n,v:1}),t.addUIEffect("prefab/ui-effect/MX_tx_zhadan",e.nodeTx,1),normalTween.to(s,a,.5,(function(t,i){e.cfg.id==R?e.pbBossHp.progress=Math.min(1,i/h):e.pbNormalHp.progress=Math.min(1,i/h)})).call((function(){a<=0&&(e.node.active=!1)})).start()},e=0;e<this.unitItems.length;e++)i(e);this.addTimer(1,1,(function(){t.onMoveEnd()}))},_.onBeforeClose=function(){if(this.isWatingEnd=!1,this.isMoving=!1,this.isMovingOn=!1,this.unitIdToInfo={},this.usingShotId=0,this.usingShotCfg=null,this.touchList=[],this.curShottingRig=null,this.curShottingItem=null,this.time=0,this.endTime=0,this.useStep=0,this.unitItems)for(var t=0;t<this.unitItems.length;t++)this.hideUnitItem(this.unitItems[t])},_.hideUnitItem=function(t){t.spine=null,this.removeUIEffect(t.effect),t.id=null,t.node.active=!1},_.onDestroy=function(){if(this.unitItems)for(var t=0;t<this.unitItems.length;t++)this.unitItems[t].node.destroy();this.unitItems=null},_.updateTime=function(){var t=y.formatStrWithMirrorDeal(GetLanguage(200043),T.formatTimeStringForSecond(Math.max(0,this.endTime-T.serverTime)));h.uiMirror&&(t=T.formatTimeStringForSecond(Math.max(0,this.endTime-T.serverTime))),this.txtTime.string=t},_.onUpdate=function(t){if(this.time=this.time+t,!this.isWatingEnd&&this.isMoving&&this.curShottingRig&&0==this.curShottingRig.node.active&&(this.curShottingRig.node.active=!0),!(this.time<1)&&(this.time=0,0!=this.endTime&&this.updateTime(),this.isMovingOn&&this.curShottingRig)){var i=this.curShottingRig.linearVelocity;i.x*i.x+i.y*i.y<=.3&&this.onMoveEnd()}},_.onMoveEnd=function(){if(this.isMoving){for(var t=[],i={},e=0;e<this.touchList.length;e++){var n=this.touchList[e];i[n.k]||(i[n.k]=0),i[n.k]=i[n.k]+n.v}for(var o in i)t.push({k:Number(o),v:i[o]});this.isMoving=!1,this.isMovingOn=!1,this.isWatingEnd=!1,this.shotIdToItem[this.usingShotId].node.active=!0,this.removeUIEffect(this.curShottingItem),this.curShottingRig=null,this.curShottingItem=null,this.touchList=[];for(var s=0;s<t.length;s++){var h=t[s].k,a=t[s].v;this.unitIdToInfo[h].hp=this.unitIdToInfo[h].hp-a*this.usingShotCfg.demage_num,this.updateSingleUnitById(h)}var d=!0;for(var r in this.unitIdToInfo){if(this.unitIdToInfo[r].hp>0){d=!1;break}}d?IS(U).send_24_105(1,this.curChapter,this.useStep):this.useStep>=this.curChapterCfg.limit&&IS(U).send_24_105(0,this.curChapter,this.useStep)}},_.updateResShow=function(){var t=this.curChapterCfg.limit-this.useStep;this.txtResNum.string=u.formatStr("<b><outline color=#000000 width=1><color=#ffd659>%s</color><color=#ffffff>/%s</color></outline></b>",t,this.curChapterCfg.limit)},_.updateInfo=function(t){t.type==w.SevenGame&&t.state!=B.Open&&this.close()},_.OnSevenChapterResult=function(t,i,e){if(i==this.curChapter)if(0!=t){for(var n=this.curChapterCfg.star_step,o=0,s=0;s<n.length;s++)if(e<=n[s]){o=3-s;break}uiMgr.openView("ActivitySevenGameResultView",{result:t,step:e,star:o})}else uiMgr.openView("ActivitySevenGameResultView",{result:t})},_.OnSevenShotSwitch=function(t){this.usingShotId=t,this.usingShotCfg=configSeven_trial_bullet.getDataByKey(t),this.setUsingStatus()},_.onTouchStart=function(t){if(this.isMoving)b.showFlyTip(GetLanguage(200758));else{var i=this.usingShotCfg.item_cost;if(IS(A).getGoodsCountByGoodsGtid(i[0])<i[1])b.showFlyTip(GetLanguage(200817));else{var e=t.getUILocation(),n=new S(e.x,e.y,0);this.oriSpinePos=this.utSlingShot.convertToNodeSpaceAR(n),this.shotIdToItem[this.usingShotId].spine.setAnimation(0,"idle2",!0),this.spineSlingShot.setAnimation(0,"skill",!0),this.nodeCancel.active=!0,this.setGuideLineActive(!0),C.playSound("zhongqiu_lagong"),this.startTouchMove=!0}}},_.onTouchMove=function(t){if(this.startTouchMove){var i=t.getUILocation(),e=new S(i.x,i.y,0),n=e.x-this.cancelPosition.x,o=e.y-this.cancelPosition.y,s=Math.sqrt(n*n+o*o)<=50;this.nodeCancelIn.active=s,this.nodeCancelOut.active=!s;var h=this.utSlingShot.convertToNodeSpaceAR(e),a=new l(h.x-this.oriSpinePos.x,h.y-this.oriSpinePos.y).normalize(),d=-a.signAngle(l.UNIT_Y)/Math.PI*180+180;if(d>=0&&d<=70||d>=290&&d<=360){this.tempDirX=-a.x;var r=Math.min(150,l.distance(h,this.oriSpinePos));this.boneA.x=this.oriBoneAPosX+a.x*r,this.boneA.y=this.oriBoneAPosY+a.y*r,this.boneA.data.rotation=d}}},_.onTouchEnd=function(t){var i=this;if(this.startTouchMove){var e=t.getUILocation(),n=new S(e.x,e.y,0),o=n.x-this.cancelPosition.x,s=n.y-this.cancelPosition.y,h=Math.sqrt(o*o+s*s)<=50;if(this.nodeCancel.active=!1,this.setGuideLineActive(!1),h)this.shotIdToItem[this.usingShotId].spine.setAnimation(0,"idle",!0),this.spineSlingShot.setAnimation(0,"idle",!0),this.boneA.data.rotation=this.oriRotation;else{var a=this.utSlingShot.convertToNodeSpaceAR(n),d=new l(this.oriSpinePos.x-a.x,this.oriSpinePos.y-a.y).normalize();0==d.x&&0==d.y&&(d.x=0,d.y=1);var r=Math.cos(Math.PI/180*20),c=Math.sin(Math.PI/180*20),u=Math.cos(Math.PI/180*160);d.x>=0&&d.x>r&&(d.x=r,d.y=c),d.x<=0&&d.x<u&&(d.x=u,d.y=c),d.y<c&&(d.y=c,d.x=this.tempDirX>=0?r:u),this.trySetShottingItem(d,this.shotIdToItem[this.usingShotId].node.worldPosition),this.shotIdToItem[this.usingShotId].spine.setAnimation(0,"idle",!0),this.shotIdToItem[this.usingShotId].node.active=!1,this.spineSlingShot.setAnimation(0,"jieshu",!1),this.spineSlingShot.addAnimation(0,"idle",!0),this.addTimer(.5,1,(function(){i.boneA.data.rotation=i.oriRotation}))}this.startTouchMove=!1}},e}(P));e._RF.pop()}}}));

